var requirejs,require,define;(function(){function J(a){return M.call(a)==="[object Function]"}function E(a){return M.call(a)==="[object Array]"}function Z(a,b,c){for(var e in b)!(e in K)&&(!(e in a)||c)&&(a[e]=b[e]);return d}function N(a,b,c){return a=Error(b+"\nhttp://requirejs.org/docs/errors.html#"+a),c&&(a.originalError=c),a}function $(a,b,c){var d,e,f;for(d=0;f=b[d];d++)f=typeof f=="string"?{name:f}:f,e=f.location,c&&(!e||e.indexOf("/")!==0&&e.indexOf(":")===-1)&&(e=c+"/"+(e||f.name)),a[f.name]={name:f.name,location:e||f.name,main:(f.main||"main").replace(da,"").replace(aa,"")}}function V(a,b){a.holdReady?a.holdReady(b):b?a.readyWait+=1:a.ready(!0)}function ea(a){function b(a,b){var c,d;if(a&&a.charAt(0)==="."&&b){t.pkgs[b]?b=[b]:(b=b.split("/"),b=b.slice(0,b.length-1)),c=a=b.concat(a.split("/"));var e;for(d=0;e=c[d];d++)if(e===".")c.splice(d,1),d-=1;else if(e==="..")if(d!==1||c[2]!==".."&&c[0]!=="..")d>0&&(c.splice(d-1,2),d-=2);else break;d=t.pkgs[c=a[0]],a=a.join("/"),d&&a===c+"/"+d.main&&(a=c)}return a}function c(a,c){var d=a?a.indexOf("!"):-1,e=null,f=c?c.name:null,g=a,h,i;return d!==-1&&(e=a.substring(0,d),a=a.substring(d+1,a.length)),e&&(e=b(e,f)),a&&(e?h=(d=x[e])&&d.normalize?d.normalize(a,function(a){return b(a,f)}):b(a,f):(h=b(a,f),i=w[h],i||(i=r.nameToUrl(h,null,c),w[h]=i))),{prefix:e,name:h,parentMap:c,url:i,originalName:g,fullName:e?e+"!"+(h||""):h}}function e(){var a=!0,b=t.priorityWait,c,d;if(b){for(d=0;c=b[d];d++)if(!y[c]){a=!1;break}a&&delete t.priorityWait}return a}function f(a,b,c){return function(){var d=ga.call(arguments,0),e;return c&&J(e=d[d.length-1])&&(e.__requireJsBuild=!0),d.push(b),a.apply(null,d)}}function g(a,b){var c=f(r.require,a,b);return Z(c,{nameToUrl:f(r.nameToUrl,a),toUrl:f(r.toUrl,a),defined:f(r.requireDefined,a),specified:f(r.requireSpecified,a),isBrowser:d.isBrowser}),c}function h(a){var b,e,f;f=a.callback;var g=a.map,h=g.fullName,i=a.deps,j=a.listeners;if(f&&J(f)){if(t.catchError.define)try{e=d.execCb(h,a.callback,i,x[h])}catch(k){b=k}else e=d.execCb(h,a.callback,i,x[h]);h&&(a.cjsModule&&a.cjsModule.exports!==void 0?e=x[h]=a.cjsModule.exports:e===void 0&&a.usingExports?e=x[h]:(x[h]=e,F[h]&&(I[h]=!0)))}else h&&(e=x[h]=f,F[h]&&(I[h]=!0));z[a.id]&&(delete z[a.id],a.isDone=!0,r.waitCount-=1,r.waitCount===0&&(A=[])),delete D[h],d.onResourceLoad&&!a.placeholder&&d.onResourceLoad(r,g,a.depArray);if(b)return e=(h?c(h).url:"")||b.fileName||b.sourceURL,f=b.moduleTree,b=N("defineerror",'Error evaluating module "'+h+'" at location "'+e+'":\n'+b+"\nfileName:"+e+"\nlineNumber: "+(b.lineNumber||b.line),b),b.moduleName=h,b.moduleTree=f,d.onError(b);for(b=0;f=j[b];b++)f(e)}function i(a,b){return function(c){a.depDone[b]||(a.depDone[b]=!0,a.deps[b]=c,a.depCount-=1,a.depCount||h(a))}}function j(a,b){var c=b.map,e=c.fullName,f=c.name,i=E[a]||(E[a]=x[a]),j;b.loading||(b.loading=!0,j=function(a){b.callback=function(){return a},h(b),y[b.id]=!0,s()},j.fromText=function(a,b){var c=O;y[a]=!1,r.scriptCount+=1,r.fake[a]=!0,c&&(O=!1),d.exec(b),c&&(O=!0),r.completeLoad(a)},e in x?j(x[e]):i.load(f,g(c.parentMap,!0),j,t))}function k(a){z[a.id]||(z[a.id]=a,A.push(a),r.waitCount+=1)}function l(a){this.listeners.push(a)}function m(a,b){var d=a.fullName,e=a.prefix,f=e?E[e]||(E[e]=x[e]):null,g,i;return d&&(g=D[d]),!g&&(i=!0,g={id:(e&&!f?C++ +"__p@:":"")+(d||"__r@"+C++),map:a,depCount:0,depDone:[],depCallbacks:[],deps:[],listeners:[],add:l},v[g.id]=!0,d&&(!e||E[e]))&&(D[d]=g),e&&!f?(d=m(c(e),!0),d.add(function(){var b=c(a.originalName,a.parentMap),b=m(b,!0);g.placeholder=!0,b.add(function(a){g.callback=function(){return a},h(g)})})):i&&b&&(y[g.id]=!1,r.paused.push(g),k(g)),g}function n(a,b,d,e){var a=c(a,e),f=a.name,j=a.fullName,l=m(a),n=l.id,o=l.deps,p;if(j){if(j in x||y[n]===!0||j==="jquery"&&t.jQuery&&t.jQuery!==d().fn.jquery)return;v[n]=!0,y[n]=!0,j==="jquery"&&d&&S(d())}l.depArray=b,l.callback=d;for(d=0;d<b.length;d++)if(n=b[d])n=c(n,f?a:e),p=n.fullName,b[d]=p,p==="require"?o[d]=g(a):p==="exports"?(o[d]=x[j]={},l.usingExports=!0):p==="module"?l.cjsModule=o[d]={id:f,uri:f?r.nameToUrl(f,null,e):void 0,exports:x[j]}:!(p in x)||p in z||j in F&&!(j in F&&I[p])?(j in F&&(F[p]=!0,delete x[p],B[n.url]=!1),l.depCount+=1,l.depCallbacks[d]=i(l,d),m(n,!0).add(l.depCallbacks[d])):o[d]=x[p];l.depCount?k(l):h(l)}function o(a){n.apply(null,a)}function p(a,b){if(!a.isDone){var d=a.map.fullName,e=a.depArray,f,g,h,i;if(d){if(b[d])return x[d];b[d]=!0}if(e)for(f=0;f<e.length;f++)if(g=e[f])if((h=c(g).prefix)&&(i=z[h])&&p(i,b),(h=z[g])&&!h.isDone&&y[g])g=p(h,b),a.depCallbacks[f](g);return d?x[d]:void 0}}function q(){var a=t.waitSeconds*1e3,b=a&&r.startTime+a<(new Date).getTime(),a="",c=!1,f=!1,g;if(r.pausedCount<=0){if(t.priorityWait)if(e())s();else return;for(g in y)if(!(g in K)&&(c=!0,!y[g]))if(b)a+=g+" ";else{f=!0;break}if(c||r.waitCount){if(b&&a)return g=N("timeout","Load timeout for modules: "+a),g.requireType="timeout",g.requireModules=a,d.onError(g);if(f||r.scriptCount)(G||ba)&&!W&&(W=setTimeout(function(){W=0,q()},50));else{if(r.waitCount){for(H=0;a=A[H];H++)p(a,{});r.paused.length&&s(),X<5&&(X+=1,q())}X=0,d.checkReadyState()}}}}var r,s,t={waitSeconds:7,baseUrl:"./",paths:{},pkgs:{},catchError:{}},u=[],v={require:!0,exports:!0,module:!0},w={},x={},y={},z={},A=[],B={},C=0,D={},E={},F={},I={},L=0;return S=function(a){!r.jQuery&&(a=a||(typeof jQuery!="undefined"?jQuery:null))&&(!t.jQuery||a.fn.jquery===t.jQuery)&&("holdReady"in a||"readyWait"in a)&&(r.jQuery=a,o(["jquery",[],function(){return jQuery}]),r.scriptCount)&&(V(a,!0),r.jQueryIncremented=!0)},s=function(){var a,b,c,f,g,h;L+=1,r.scriptCount<=0&&(r.scriptCount=0);for(;u.length;){if(a=u.shift(),a[0]===null)return d.onError(N("mismatch","Mismatched anonymous define() module: "+a[a.length-1]));o(a)}if(!t.priorityWait||e())for(;r.paused.length;){g=r.paused,r.pausedCount+=g.length,r.paused=[];for(f=0;a=g[f];f++)b=a.map,c=b.url,h=b.fullName,b.prefix?j(b.prefix,a):!B[c]&&!y[h]&&(d.load(r,h,c),B[c]=!0);r.startTime=(new Date).getTime(),r.pausedCount-=g.length}L===1&&q(),L-=1},r={contextName:a,config:t,defQueue:u,waiting:z,waitCount:0,specified:v,loaded:y,urlMap:w,urlFetched:B,scriptCount:0,defined:x,paused:[],pausedCount:0,plugins:E,needFullExec:F,fake:{},fullExec:I,managerCallbacks:D,makeModuleMap:c,normalize:b,configure:function(a){var b,c,d;a.baseUrl&&a.baseUrl.charAt(a.baseUrl.length-1)!=="/"&&(a.baseUrl+="/"),b=t.paths,d=t.pkgs,Z(t,a,!0);if(a.paths){for(c in a.paths)c in K||(b[c]=a.paths[c]);t.paths=b}if((b=a.packagePaths)||a.packages){if(b)for(c in b)c in K||$(d,b[c],c);a.packages&&$(d,a.packages),t.pkgs=d}a.priority&&(c=r.requireWait,r.requireWait=!1,r.takeGlobalQueue(),s(),r.require(a.priority),s(),r.requireWait=c,t.priorityWait=a.priority),(a.deps||a.callback)&&r.require(a.deps||[],a.callback)},requireDefined:function(a,b){return c(a,b).fullName in x},requireSpecified:function(a,b){return c(a,b).fullName in v},require:function(b,e,f){if(typeof b=="string")return J(e)?d.onError(N("requireargs","Invalid require call")):d.get?d.get(r,b,e):(e=c(b,e),b=e.fullName,b in x?x[b]:d.onError(N("notloaded","Module name '"+e.fullName+"' has not been loaded yet for context: "+a)));(b&&b.length||e)&&n(null,b,e,f);if(!r.requireWait)for(;!r.scriptCount&&r.paused.length;)r.takeGlobalQueue(),s();return r.require},takeGlobalQueue:function(){U.length&&(ha.apply(r.defQueue,[r.defQueue.length-1,0].concat(U)),U=[])},completeLoad:function(a){var b;for(r.takeGlobalQueue();u.length;){if(b=u.shift(),b[0]===null){b[0]=a;break}if(b[0]===a)break;o(b),b=null}b?o(b):o([a,[],a==="jquery"&&typeof jQuery!="undefined"?function(){return jQuery}:null]),S(),d.isAsync&&(r.scriptCount-=1),s(),d.isAsync||(r.scriptCount-=1)},toUrl:function(a,b){var c=a.lastIndexOf("."),d=null;return c!==-1&&(d=a.substring(c,a.length),a=a.substring(0,c)),r.nameToUrl(a,d,b)},nameToUrl:function(a,c,e){var f,g,h,i,j=r.config,a=b(a,e&&e.fullName);if(d.jsExtRegExp.test(a))c=a+(c?c:"");else{f=j.paths,g=j.pkgs,e=a.split("/");for(i=e.length;i>0;i--){if(h=e.slice(0,i).join("/"),f[h]){e.splice(0,i,f[h]);break}if(h=g[h]){a=a===h.name?h.location+"/"+h.main:h.location,e.splice(0,i,a);break}}c=e.join("/")+(c||".js"),c=(c.charAt(0)==="/"||c.match(/^\w+:/)?"":j.baseUrl)+c}return j.urlArgs?c+((c.indexOf("?")===-1?"?":"&")+j.urlArgs):c}},r.jQueryCheck=S,r.resume=s,r}function ia(){var a,b,c;if(m&&m.readyState==="interactive")return m;a=document.getElementsByTagName("script");for(b=a.length-1;b>-1&&(c=a[b]);b--)if(c.readyState==="interactive")return m=c;return null}var ja=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/mg,ka=/require\(\s*["']([^'"\s]+)["']\s*\)/g,da=/^\.\//,aa=/\.js$/,M=Object.prototype.toString,r=Array.prototype,ga=r.slice,ha=r.splice,G=typeof window!="undefined"&&!!navigator&&!!document,ba=!G&&typeof importScripts!="undefined",la=G&&navigator.platform==="PLAYSTATION 3"?/^complete$/:/^(complete|loaded)$/,ca=typeof opera!="undefined"&&opera.toString()==="[object Opera]",K={},u={},U=[],m=null,X=0,O=!1,d,r={},I,w,y,z,v,A,B,H,C,S,W;if(typeof define=="undefined"){if(typeof requirejs!="undefined"){if(J(requirejs))return;r=requirejs,requirejs=void 0}typeof require!="undefined"&&!J(require)&&(r=require,require=void 0),d=requirejs=function(a,b,c){var d="_",e;return!E(a)&&typeof a!="string"&&(e=a,E(b)?(a=b,b=c):a=[]),e&&e.context&&(d=e.context),c=u[d]||(u[d]=ea(d)),e&&c.configure(e),c.require(a,b)},d.config=function(a){return d(a)},require||(require=d),d.toUrl=function(a){return u._.toUrl(a)},d.version="1.0.1",d.jsExtRegExp=/^\/|:|\?|\.js$/,w=d.s={contexts:u,skipAsync:{}};if(d.isAsync=d.isBrowser=G)if(y=w.head=document.getElementsByTagName("head")[0],z=document.getElementsByTagName("base")[0])y=w.head=z.parentNode;d.onError=function(a){throw a},d.load=function(a,b,c){d.resourcesReady(!1),a.scriptCount+=1,d.attach(c,a,b),a.jQuery&&!a.jQueryIncremented&&(V(a.jQuery,!0),a.jQueryIncremented=!0)},define=function(a,b,c){var d,e;typeof a!="string"&&(c=b,b=a,a=null),E(b)||(c=b,b=[]),!b.length&&J(c)&&c.length&&(c.toString().replace(ja,"").replace(ka,function(a,c){b.push(c)}),b=(c.length===1?["require"]:["require","exports","module"]).concat(b)),O&&(d=I||ia())&&(a||(a=d.getAttribute("data-requiremodule")),e=u[d.getAttribute("data-requirecontext")]),(e?e.defQueue:U).push([a,b,c])},define.amd={multiversion:!0,plugins:!0,jQuery:!0},d.exec=function(b){return eval(b)},d.execCb=function(a,b,c,d){return b.apply(d,c)},d.addScriptToDom=function(a){I=a,z?y.insertBefore(a,z):y.appendChild(a),I=null},d.onScriptLoad=function(a){var b=a.currentTarget||a.srcElement,c;if(a.type==="load"||b&&la.test(b.readyState))m=null,a=b.getAttribute("data-requirecontext"),c=b.getAttribute("data-requiremodule"),u[a].completeLoad(c),b.detachEvent&&!ca?b.detachEvent("onreadystatechange",d.onScriptLoad):b.removeEventListener("load",d.onScriptLoad,!1)},d.attach=function(a,b,c,e,f,g){var h;return G?(e=e||d.onScriptLoad,h=b&&b.config&&b.config.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script"),h.type=f||"text/javascript",h.charset="utf-8",h.async=!w.skipAsync[a],b&&h.setAttribute("data-requirecontext",b.contextName),h.setAttribute("data-requiremodule",c),h.attachEvent&&!ca?(O=!0,g?h.onreadystatechange=function(){h.readyState==="loaded"&&(h.onreadystatechange=null,h.attachEvent("onreadystatechange",e),g(h))}:h.attachEvent("onreadystatechange",e)):h.addEventListener("load",e,!1),h.src=a,g||d.addScriptToDom(h),h):(ba&&(importScripts(a),b.completeLoad(c)),null)};if(G){v=document.getElementsByTagName("script");for(H=v.length-1;H>-1&&(A=v[H]);H--){y||(y=A.parentNode);if(B=A.getAttribute("data-main")){r.baseUrl||(v=B.split("/"),A=v.pop(),v=v.length?v.join("/")+"/":"./",r.baseUrl=v,B=A.replace(aa,"")),r.deps=r.deps?r.deps.concat(B):[B];break}}}d.checkReadyState=function(){var a=w.contexts,b;for(b in a)if(!(b in K)&&a[b].waitCount)return;d.resourcesReady(!0)},d.resourcesReady=function(a){var b,c;d.resourcesDone=a;if(d.resourcesDone)for(c in a=w.contexts,a)!(c in K)&&(b=a[c],b.jQueryIncremented)&&(V(b.jQuery,!1),b.jQueryIncremented=!1)},d.pageLoaded=function(){document.readyState!=="complete"&&(document.readyState="complete")},G&&document.addEventListener&&!document.readyState&&(document.readyState="loading",window.addEventListener("load",d.pageLoaded,!1)),d(r),d.isAsync&&typeof setTimeout!="undefined"&&(C=w.contexts[r.context||"_"],C.requireWait=!0,setTimeout(function(){C.requireWait=!1,C.takeGlobalQueue(),C.jQueryCheck(),C.scriptCount||C.resume(),d.checkReadyState()},0))}})(),define("requireLib",function(){}),define("libs/three",[],function(){var a=a||{};return self.Int32Array||(self.Int32Array=Array,self.Float32Array=Array),a.Color=function(a){return a!==void 0&&this.setHex(a),this},a.Color.prototype={constructor:a.Color,r:1,g:1,b:1,copy:function(a){return this.r=a.r,this.g=a.g,this.b=a.b,this},setRGB:function(a,b,c){return this.r=a,this.g=b,this.b=c,this},setHSV:function(a,b,c){var d,e,f;if(c==0)this.r=this.g=this.b=0;else switch(d=Math.floor(a*6),e=a*6-d,a=c*(1-b),f=c*(1-b*e),b=c*(1-b*(1-e)),d){case 1:this.r=f,this.g=c,this.b=a;break;case 2:this.r=a,this.g=c,this.b=b;break;case 3:this.r=a,this.g=f,this.b=c;break;case 4:this.r=b,this.g=a,this.b=c;break;case 5:this.r=c,this.g=a,this.b=f;break;case 6:case 0:this.r=c,this.g=b,this.b=a}return this},setHex:function(a){return a=Math.floor(a),this.r=(a>>16&255)/255,this.g=(a>>8&255)/255,this.b=(a&255)/255,this},getHex:function(){return~~(this.r*255)<<16^~~(this.g*255)<<8^~~(this.b*255)},getContextStyle:function(){return"rgb("+Math.floor(this.r*255)+","+Math.floor(this.g*255)+","+Math.floor(this.b*255)+")"},clone:function(){return(new a.Color).setRGB(this.r,this.g,this.b)}},a.Vector2=function(a,b){this.x=a||0,this.y=b||0},a.Vector2.prototype={constructor:a.Vector2,set:function(a,b){return this.x=a,this.y=b,this},copy:function(a){return this.x=a.x,this.y=a.y,this},clone:function(){return new a.Vector2(this.x,this.y)},add:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this},addSelf:function(a){return this.x+=a.x,this.y+=a.y,this},sub:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this},subSelf:function(a){return this.x-=a.x,this.y-=a.y,this},multiplyScalar:function(a){return this.x*=a,this.y*=a,this},divideScalar:function(a){return a?(this.x/=a,this.y/=a):this.set(0,0),this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(a){var b=this.x-a.x,a=this.y-a.y;return b*b+a*a},setLength:function(a){return this.normalize().multiplyScalar(a)},equals:function(a){return a.x==this.x&&a.y==this.y}},a.Vector3=function(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0},a.Vector3.prototype={constructor:a.Vector3,set:function(a,b,c){return this.x=a,this.y=b,this.z=c,this},setX:function(a){return this.x=a,this},setY:function(a){return this.y=a,this},setZ:function(a){return this.z=a,this},copy:function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this},clone:function(){return new a.Vector3(this.x,this.y,this.z)},add:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this},addSelf:function(a){return this.x+=a.x,this.y+=a.y,this.z+=a.z,this},addScalar:function(a){return this.x+=a,this.y+=a,this.z+=a,this},sub:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this},subSelf:function(a){return this.x-=a.x,this.y-=a.y,this.z-=a.z,this},multiply:function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this},multiplySelf:function(a){return this.x*=a.x,this.y*=a.y,this.z*=a.z,this},multiplyScalar:function(a){return this.x*=a,this.y*=a,this.z*=a,this},divideSelf:function(a){return this.x/=a.x,this.y/=a.y,this.z/=a.z,this},divideScalar:function(a){return a?(this.x/=a,this.y/=a,this.z/=a):this.set(0,0,0),this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.lengthSq())},lengthManhattan:function(){return this.x+this.y+this.z},normalize:function(){return this.divideScalar(this.length())},setLength:function(a){return this.normalize().multiplyScalar(a)},cross:function(a,b){return this.x=a.y*b.z-a.z*b.y,this.y=a.z*b.x-a.x*b.z,this.z=a.x*b.y-a.y*b.x,this},crossSelf:function(a){return this.set(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)},distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(b){return(new a.Vector3).sub(this,b).lengthSq()},setPositionFromMatrix:function(a){this.x=a.n14,this.y=a.n24,this.z=a.n34},setRotationFromMatrix:function(a){var b=Math.cos(this.y);this.y=Math.asin(a.n13),Math.abs(b)>1e-5?(this.x=Math.atan2(-a.n23/b,a.n33/b),this.z=Math.atan2(-a.n12/b,a.n11/b)):(this.x=0,this.z=Math.atan2(a.n21,a.n22))},isZero:function(){return this.lengthSq()<1e-4}},a.Vector4=function(a,b,c,d){this.x=a||0,this.y=b||0,this.z=c||0,this.w=d!==void 0?d:1},a.Vector4.prototype={constructor:a.Vector4,set:function(a,b,c,d){return this.x=a,this.y=b,this.z=c,this.w=d,this},copy:function(a){this.x=a.x,this.y=a.y,this.z=a.z,this.w=a.w!==void 0?a.w:1},clone:function(){return new a.Vector4(this.x,this.y,this.z,this.w)},add:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this.w=a.w+b.w,this},addSelf:function(a){return this.x+=a.x,this.y+=a.y,this.z+=a.z,this.w+=a.w,this},sub:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this.w=a.w-b.w,this},subSelf:function(a){return this.x-=a.x,this.y-=a.y,this.z-=a.z,this.w-=a.w,this},multiplyScalar:function(a){return this.x*=a,this.y*=a,this.z*=a,this.w*=a,this},divideScalar:function(a){return a?(this.x/=a,this.y/=a,this.z/=a,this.w/=a):(this.z=this.y=this.x=0,this.w=1),this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z+this.w*a.w},lengthSq:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},setLength:function(a){return this.normalize().multiplyScalar(a)},lerpSelf:function(a,b){return this.x+=(a.x-this.x)*b,this.y+=(a.y-this.y)*b,this.z+=(a.z-this.z)*b,this.w+=(a.w-this.w)*b,this}},a.Ray=function(b,c){this.origin=b||new a.Vector3,this.direction=c||new a.Vector3},a.Ray.prototype={constructor:a.Ray,intersectScene:function(a){return this.intersectObjects(a.objects)},intersectObjects:function(a){var b,c,d=[];b=0;for(c=a.length;b<c;b++)Array.prototype.push.apply(d,this.intersectObject(a[b]));return d.sort(function(a,b){return a.distance-b.distance}),d},intersectObject:function(b){function c(a,b,c){var d;return d=c.clone().subSelf(a).dot(b),d>0?(a=a.clone().addSelf(b.clone().multiplyScalar(d)),c.distanceTo(a)):null}function d(a,b,c,d){var d=d.clone().subSelf(b),c=c.clone().subSelf(b),e=a.clone().subSelf(b),a=d.dot(d),b=d.dot(c),d=d.dot(e),f=c.dot(c),c=c.dot(e),e=1/(a*f-b*b),f=(f*d-b*c)*e,a=(a*c-b*d)*e;return f>0&&a>0&&f+a<1}if(b instanceof a.Particle){var e=c(this.origin,this.direction,b.matrixWorld.getPosition());return e==null||e>b.scale.x?[]:[{distance:e,point:b.position,face:null,object:b}]}if(b instanceof a.Mesh){e=c(this.origin,this.direction,b.matrixWorld.getPosition());if(e==null||e>b.geometry.boundingSphere.radius*Math.max(b.scale.x,Math.max(b.scale.y,b.scale.z)))return[];var f,g,h,i,j,k,l,m,n,o,p=b.geometry,q=p.vertices,r=[],e=0;for(f=p.faces.length;e<f;e++)if(g=p.faces[e],n=this.origin.clone(),o=this.direction.clone(),k=b.matrixWorld,h=k.multiplyVector3(g.centroid.clone()).subSelf(n),m=h.dot(o),m>0&&(h=k.multiplyVector3(q[g.a].position.clone()),i=k.multiplyVector3(q[g.b].position.clone()),j=k.multiplyVector3(q[g.c].position.clone()),k=g instanceof a.Face4?k.multiplyVector3(q[g.d].position.clone()):null,l=b.matrixRotationWorld.multiplyVector3(g.normal.clone()),m=o.dot(l),b.doubleSided||(b.flipSided?m>0:m<0)))(m=l.dot((new a.Vector3).sub(h,n))/m,n=n.addSelf(o.multiplyScalar(m)),g instanceof a.Face3)?d(n,h,i,j)&&(g={distance:this.origin.distanceTo(n),point:n,face:g,object:b},r.push(g)):g instanceof a.Face4&&(d(n,h,i,k)||d(n,i,j,k))&&(g={distance:this.origin.distanceTo(n),point:n,face:g,object:b},r.push(g));return r.sort(function(a,b){return a.distance-b.distance}),r}return[]}},a.Rectangle=function(){function a(){f=d-b,g=e-c}var b,c,d,e,f,g,h=!0;this.getX=function(){return b},this.getY=function(){return c},this.getWidth=function(){return f},this.getHeight=function(){return g},this.getLeft=function(){return b},this.getTop=function(){return c},this.getRight=function(){return d},this.getBottom=function(){return e},this.set=function(f,g,i,j){h=!1,b=f,c=g,d=i,e=j,a()},this.addPoint=function(f,g){h?(h=!1,b=f,c=g,d=f,e=g):(b=b<f?b:f,c=c<g?c:g,d=d>f?d:f,e=e>g?e:g),a()},this.add3Points=function(f,g,i,j,k,l){h?(h=!1,b=f<i?f<k?f:k:i<k?i:k,c=g<j?g<l?g:l:j<l?j:l,d=f>i?f>k?f:k:i>k?i:k,e=g>j?g>l?g:l:j>l?j:l):(b=f<i?f<k?f<b?f:b:k<b?k:b:i<k?i<b?i:b:k<b?k:b,c=g<j?g<l?g<c?g:c:l<c?l:c:j<l?j<c?j:c:l<c?l:c,d=f>i?f>k?f>d?f:d:k>d?k:d:i>k?i>d?i:d:k>d?k:d,e=g>j?g>l?g>e?g:e:l>e?l:e:j>l?j>e?j:e:l>e?l:e),a()},this.addRectangle=function(f){h?(h=!1,b=f.getLeft(),c=f.getTop(),d=f.getRight(),e=f.getBottom()):(b=b<f.getLeft()?b:f.getLeft(),c=c<f.getTop()?c:f.getTop(),d=d>f.getRight()?d:f.getRight(),e=e>f.getBottom()?e:f.getBottom()),a()},this.inflate=function(f){b-=f,c-=f,d+=f,e+=f,a()},this.minSelf=function(f){b=b>f.getLeft()?b:f.getLeft(),c=c>f.getTop()?c:f.getTop(),d=d<f.getRight()?d:f.getRight(),e=e<f.getBottom()?e:f.getBottom(),a()},this.intersects=function(a){return Math.min(d,a.getRight())-Math.max(b,a.getLeft())>=0&&Math.min(e,a.getBottom())-Math.max(c,a.getTop())>=0},this.empty=function(){h=!0,e=d=c=b=0,a()},this.isEmpty=function(){return h}},a.Matrix3=function(){this.m=[]},a.Matrix3.prototype={constructor:a.Matrix3,transpose:function(){var a,b=this.m;return a=b[1],b[1]=b[3],b[3]=a,a=b[2],b[2]=b[6],b[6]=a,a=b[5],b[5]=b[7],b[7]=a,this},transposeIntoArray:function(a){var b=this.m;return a[0]=b[0],a[1]=b[3],a[2]=b[6],a[3]=b[1],a[4]=b[4],a[5]=b[7],a[6]=b[2],a[7]=b[5],a[8]=b[8],this}},a.Matrix4=function(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){this.set(b!==void 0?b:1,c||0,d||0,e||0,f||0,g!==void 0?g:1,h||0,i||0,j||0,k||0,l!==void 0?l:1,m||0,n||0,o||0,p||0,q!==void 0?q:1),this.flat=Array(16),this.m33=new a.Matrix3},a.Matrix4.prototype={constructor:a.Matrix4,set:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){return this.n11=a,this.n12=b,this.n13=c,this.n14=d,this.n21=e,this.n22=f,this.n23=g,this.n24=h,this.n31=i,this.n32=j,this.n33=k,this.n34=l,this.n41=m,this.n42=n,this.n43=o,this.n44=p,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(a){return this.set(a.n11,a.n12,a.n13,a.n14,a.n21,a.n22,a.n23,a.n24,a.n31,a.n32,a.n33,a.n34,a.n41,a.n42,a.n43,a.n44),this},lookAt:function(b,c,d){var e=a.Matrix4.__v1,f=a.Matrix4.__v2,g=a.Matrix4.__v3;return g.sub(b,c).normalize(),g.length()===0&&(g.z=1),e.cross(d,g).normalize(),e.length()===0&&(g.x+=1e-4,e.cross(d,g).normalize()),f.cross(g,e).normalize(),this.n11=e.x,this.n12=f.x,this.n13=g.x,this.n21=e.y,this.n22=f.y,this.n23=g.y,this.n31=e.z,this.n32=f.z,this.n33=g.z,this},multiplyVector3:function(a){var b=a.x,c=a.y,d=a.z,e=1/(this.n41*b+this.n42*c+this.n43*d+this.n44);return a.x=(this.n11*b+this.n12*c+this.n13*d+this.n14)*e,a.y=(this.n21*b+this.n22*c+this.n23*d+this.n24)*e,a.z=(this.n31*b+this.n32*c+this.n33*d+this.n34)*e,a},multiplyVector4:function(a){var b=a.x,c=a.y,d=a.z,e=a.w;return a.x=this.n11*b+this.n12*c+this.n13*d+this.n14*e,a.y=this.n21*b+this.n22*c+this.n23*d+this.n24*e,a.z=this.n31*b+this.n32*c+this.n33*d+this.n34*e,a.w=this.n41*b+this.n42*c+this.n43*d+this.n44*e,a},rotateAxis:function(a){var b=a.x,c=a.y,d=a.z;return a.x=b*this.n11+c*this.n12+d*this.n13,a.y=b*this.n21+c*this.n22+d*this.n23,a.z=b*this.n31+c*this.n32+d*this.n33,a.normalize(),a},crossVector:function(b){var c=new a.Vector4;return c.x=this.n11*b.x+this.n12*b.y+this.n13*b.z+this.n14*b.w,c.y=this.n21*b.x+this.n22*b.y+this.n23*b.z+this.n24*b.w,c.z=this.n31*b.x+this.n32*b.y+this.n33*b.z+this.n34*b.w,c.w=b.w?this.n41*b.x+this.n42*b.y+this.n43*b.z+this.n44*b.w:1,c},multiply:function(a,b){var c=a.n11,d=a.n12,e=a.n13,f=a.n14,g=a.n21,h=a.n22,i=a.n23,j=a.n24,k=a.n31,l=a.n32,m=a.n33,n=a.n34,o=a.n41,p=a.n42,q=a.n43,r=a.n44,s=b.n11,t=b.n12,u=b.n13,v=b.n14,w=b.n21,x=b.n22,y=b.n23,z=b.n24,A=b.n31,B=b.n32,C=b.n33,D=b.n34,E=b.n41,F=b.n42,G=b.n43,H=b.n44;return this.n11=c*s+d*w+e*A+f*E,this.n12=c*t+d*x+e*B+f*F,this.n13=c*u+d*y+e*C+f*G,this.n14=c*v+d*z+e*D+f*H,this.n21=g*s+h*w+i*A+j*E,this.n22=g*t+h*x+i*B+j*F,this.n23=g*u+h*y+i*C+j*G,this.n24=g*v+h*z+i*D+j*H,this.n31=k*s+l*w+m*A+n*E,this.n32=k*t+l*x+m*B+n*F,this.n33=k*u+l*y+m*C+n*G,this.n34=k*v+l*z+m*D+n*H,this.n41=o*s+p*w+q*A+r*E,this.n42=o*t+p*x+q*B+r*F,this.n43=o*u+p*y+q*C+r*G,this.n44=o*v+p*z+q*D+r*H,this},multiplyToArray:function(a,b,c){return this.multiply(a,b),c[0]=this.n11,c[1]=this.n21,c[2]=this.n31,c[3]=this.n41,c[4]=this.n12,c[5]=this.n22,c[6]=this.n32,c[7]=this.n42,c[8]=this.n13,c[9]=this.n23,c[10]=this.n33,c[11]=this.n43,c[12]=this.n14,c[13]=this.n24,c[14]=this.n34,c[15]=this.n44,this},multiplySelf:function(a){return this.multiply(this,a),this},multiplyScalar:function(a){return this.n11*=a,this.n12*=a,this.n13*=a,this.n14*=a,this.n21*=a,this.n22*=a,this.n23*=a,this.n24*=a,this.n31*=a,this.n32*=a,this.n33*=a,this.n34*=a,this.n41*=a,this.n42*=a,this.n43*=a,this.n44*=a,this},determinant:function(){var a=this.n11,b=this.n12,c=this.n13,d=this.n14,e=this.n21,f=this.n22,g=this.n23,h=this.n24,i=this.n31,j=this.n32,k=this.n33,l=this.n34,m=this.n41,n=this.n42,o=this.n43,p=this.n44;return d*g*j*m-c*h*j*m-d*f*k*m+b*h*k*m+c*f*l*m-b*g*l*m-d*g*i*n+c*h*i*n+d*e*k*n-a*h*k*n-c*e*l*n+a*g*l*n+d*f*i*o-b*h*i*o-d*e*j*o+a*h*j*o+b*e*l*o-a*f*l*o-c*f*i*p+b*g*i*p+c*e*j*p-a*g*j*p-b*e*k*p+a*f*k*p},transpose:function(){var a;return a=this.n21,this.n21=this.n12,this.n12=a,a=this.n31,this.n31=this.n13,this.n13=a,a=this.n32,this.n32=this.n23,this.n23=a,a=this.n41,this.n41=this.n14,this.n14=a,a=this.n42,this.n42=this.n24,this.n24=a,a=this.n43,this.n43=this.n34,this.n43=a,this},clone:function(){var b=new a.Matrix4;return b.n11=this.n11,b.n12=this.n12,b.n13=this.n13,b.n14=this.n14,b.n21=this.n21,b.n22=this.n22,b.n23=this.n23,b.n24=this.n24,b.n31=this.n31,b.n32=this.n32,b.n33=this.n33,b.n34=this.n34,b.n41=this.n41,b.n42=this.n42,b.n43=this.n43,b.n44=this.n44,b},flatten:function(){return this.flat[0]=this.n11,this.flat[1]=this.n21,this.flat[2]=this.n31,this.flat[3]=this.n41,this.flat[4]=this.n12,this.flat[5]=this.n22,this.flat[6]=this.n32,this.flat[7]=this.n42,this.flat[8]=this.n13,this.flat[9]=this.n23,this.flat[10]=this.n33,this.flat[11]=this.n43,this.flat[12]=this.n14,this.flat[13]=this.n24,this.flat[14]=this.n34,this.flat[15]=this.n44,this.flat},flattenToArray:function(a){return a[0]=this.n11,a[1]=this.n21,a[2]=this.n31,a[3]=this.n41,a[4]=this.n12,a[5]=this.n22,a[6]=this.n32,a[7]=this.n42,a[8]=this.n13,a[9]=this.n23,a[10]=this.n33,a[11]=this.n43,a[12]=this.n14,a[13]=this.n24,a[14]=this.n34,a[15]=this.n44,a},flattenToArrayOffset:function(a,b){return a[b]=this.n11,a[b+1]=this.n21,a[b+2]=this.n31,a[b+3]=this.n41,a[b+4]=this.n12,a[b+5]=this.n22,a[b+6]=this.n32,a[b+7]=this.n42,a[b+8]=this.n13,a[b+9]=this.n23,a[b+10]=this.n33,a[b+11]=this.n43,a[b+12]=this.n14,a[b+13]=this.n24,a[b+14]=this.n34,a[b+15]=this.n44,a},setTranslation:function(a,b,c){return this.set(1,0,0,a,0,1,0,b,0,0,1,c,0,0,0,1),this},setScale:function(a,b,c){return this.set(a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1),this},setRotationX:function(a){var b=Math.cos(a),a=Math.sin(a);return this.set(1,0,0,0,0,b,-a,0,0,a,b,0,0,0,0,1),this},setRotationY:function(a){var b=Math.cos(a),a=Math.sin(a);return this.set(b,0,a,0,0,1,0,0,-a,0,b,0,0,0,0,1),this},setRotationZ:function(a){var b=Math.cos(a),a=Math.sin(a);return this.set(b,-a,0,0,a,b,0,0,0,0,1,0,0,0,0,1),this},setRotationAxis:function(a,b){var c=Math.cos(b),d=Math.sin(b),e=1-c,f=a.x,g=a.y,h=a.z,i=e*f,j=e*g;return this.set(i*f+c,i*g-d*h,i*h+d*g,0,i*g+d*h,j*g+c,j*h-d*f,0,i*h-d*g,j*h+d*f,e*h*h+c,0,0,0,0,1),this},setPosition:function(a){return this.n14=a.x,this.n24=a.y,this.n34=a.z,this},getPosition:function(){return this.position||(this.position=new a.Vector3),this.position.set(this.n14,this.n24,this.n34),this.position},getColumnX:function(){return this.columnX||(this.columnX=new a.Vector3),this.columnX.set(this.n11,this.n21,this.n31),this.columnX},getColumnY:function(){return this.columnY||(this.columnY=new a.Vector3),this.columnY.set(this.n12,this.n22,this.n32),this.columnY},getColumnZ:function(){return this.columnZ||(this.columnZ=new a.Vector3),this.columnZ.set(this.n13,this.n23,this.n33),this.columnZ},setRotationFromEuler:function(a,b){var c=a.x,d=a.y,e=a.z,f=Math.cos(c),c=Math.sin(c),g=Math.cos(d),d=Math.sin(d),h=Math.cos(e),e=Math.sin(e);switch(b){case"YXZ":var i=g*h,j=g*e,k=d*h,l=d*e;this.n11=i+l*c,this.n12=k*c-j,this.n13=f*d,this.n21=f*e,this.n22=f*h,this.n23=-c,this.n31=j*c-k,this.n32=l+i*c,this.n33=f*g;break;case"ZXY":i=g*h,j=g*e,k=d*h,l=d*e,this.n11=i-l*c,this.n12=-f*e,this.n13=k+j*c,this.n21=j+k*c,this.n22=f*h,this.n23=l-i*c,this.n31=-f*d,this.n32=c,this.n33=f*g;break;case"ZYX":i=f*h,j=f*e,k=c*h,l=c*e,this.n11=g*h,this.n12=k*d-j,this.n13=i*d+l,this.n21=g*e,this.n22=l*d+i,this.n23=j*d-k,this.n31=-d,this.n32=c*g,this.n33=f*g;break;case"YZX":i=f*g,j=f*d,k=c*g,l=c*d,this.n11=g*h,this.n12=l-i*e,this.n13=k*e+j,this.n21=e,this.n22=f*h,this.n23=-c*h,this.n31=-d*h,this.n32=j*e+k,this.n33=i-l*e;break;case"XZY":i=f*g,j=f*d,k=c*g,l=c*d,this.n11=g*h,this.n12=-e,this.n13=d*h,this.n21=i*e+l,this.n22=f*h,this.n23=j*e-k,this.n31=k*e-j,this.n32=c*h,this.n33=l*e+i;break;default:i=f*h,j=f*e,k=c*h,l=c*e,this.n11=g*h,this.n12=-g*e,this.n13=d,this.n21=j+k*d,this.n22=i-l*d,this.n23=-c*g,this.n31=l-i*d,this.n32=k+j*d,this.n33=f*g}return this},setRotationFromQuaternion:function(a){var b=a.x,c=a.y,d=a.z,e=a.w,f=b+b,g=c+c,h=d+d,a=b*f,i=b*g;b*=h;var j=c*g;return c*=h,d*=h,f*=e,g*=e,e*=h,this.n11=1-(j+d),this.n12=i-e,this.n13=b+g,this.n21=i+e,this.n22=1-(a+d),this.n23=c-f,this.n31=b-g,this.n32=c+f,this.n33=1-(a+j),this},scale:function(a){var b=a.x,c=a.y,a=a.z;return this.n11*=b,this.n12*=c,this.n13*=a,this.n21*=b,this.n22*=c,this.n23*=a,this.n31*=b,this.n32*=c,this.n33*=a,this.n41*=b,this.n42*=c,this.n43*=a,this},compose:function(b,c,d){var e=a.Matrix4.__m1,f=a.Matrix4.__m2;return e.identity(),e.setRotationFromQuaternion(c),f.setScale(d.x,d.y,d.z),this.multiply(e,f),this.n14=b.x,this.n24=b.y,this.n34=b.z,this},decompose:function(b,c,d){var e=a.Matrix4.__v1,f=a.Matrix4.__v2,g=a.Matrix4.__v3;return e.set(this.n11,this.n21,this.n31),f.set(this.n12,this.n22,this.n32),g.set(this.n13,this.n23,this.n33),b=b instanceof a.Vector3?b:new a.Vector3,c=c instanceof a.Quaternion?c:new a.Quaternion,d=d instanceof a.Vector3?d:new a.Vector3,d.x=e.length(),d.y=f.length(),d.z=g.length(),b.x=this.n14,b.y=this.n24,b.z=this.n34,e=a.Matrix4.__m1,e.copy(this),e.n11/=d.x,e.n21/=d.x,e.n31/=d.x,e.n12/=d.y,e.n22/=d.y,e.n32/=d.y,e.n13/=d.z,e.n23/=d.z,e.n33/=d.z,c.setFromRotationMatrix(e),[b,c,d]},extractPosition:function(a){this.n14=a.n14,this.n24=a.n24,this.n34=a.n34},extractRotation:function(a,b){var c=1/b.x,d=1/b.y,e=1/b.z;this.n11=a.n11*c,this.n21=a.n21*c,this.n31=a.n31*c,this.n12=a.n12*d,this.n22=a.n22*d,this.n32=a.n32*d,this.n13=a.n13*e,this.n23=a.n23*e,this.n33=a.n33*e}},a.Matrix4.makeInvert=function(b,c){var d=b.n11,e=b.n12,f=b.n13,g=b.n14,h=b.n21,i=b.n22,j=b.n23,k=b.n24,l=b.n31,m=b.n32,n=b.n33,o=b.n34,p=b.n41,q=b.n42,r=b.n43,s=b.n44;return c===void 0&&(c=new a.Matrix4),c.n11=j*o*q-k*n*q+k*m*r-i*o*r-j*m*s+i*n*s,c.n12=g*n*q-f*o*q-g*m*r+e*o*r+f*m*s-e*n*s,c.n13=f*k*q-g*j*q+g*i*r-e*k*r-f*i*s+e*j*s,c.n14=g*j*m-f*k*m-g*i*n+e*k*n+f*i*o-e*j*o,c.n21=k*n*p-j*o*p-k*l*r+h*o*r+j*l*s-h*n*s,c.n22=f*o*p-g*n*p+g*l*r-d*o*r-f*l*s+d*n*s,c.n23=g*j*p-f*k*p-g*h*r+d*k*r+f*h*s-d*j*s,c.n24=f*k*l-g*j*l+g*h*n-d*k*n-f*h*o+d*j*o,c.n31=i*o*p-k*m*p+k*l*q-h*o*q-i*l*s+h*m*s,c.n32=g*m*p-e*o*p-g*l*q+d*o*q+e*l*s-d*m*s,c.n33=f*k*p-g*i*p+g*h*q-d*k*q-e*h*s+d*i*s,c.n34=g*i*l-e*k*l-g*h*m+d*k*m+e*h*o-d*i*o,c.n41=j*m*p-i*n*p-j*l*q+h*n*q+i*l*r-h*m*r,c.n42=e*n*p-f*m*p+f*l*q-d*n*q-e*l*r+d*m*r,c.n43=f*i*p-e*j*p-f*h*q+d*j*q+e*h*r-d*i*r,c.n44=e*j*l-f*i*l+f*h*m-d*j*m-e*h*n+d*i*n,c.multiplyScalar(1/b.determinant()),c},a.Matrix4.makeInvert3x3=function(a){var b=a.m33,c=b.m,d=a.n33*a.n22-a.n32*a.n23,e=-a.n33*a.n21+a.n31*a.n23,f=a.n32*a.n21-a.n31*a.n22,g=-a.n33*a.n12+a.n32*a.n13,h=a.n33*a.n11-a.n31*a.n13,i=-a.n32*a.n11+a.n31*a.n12,j=a.n23*a.n12-a.n22*a.n13,k=-a.n23*a.n11+a.n21*a.n13,l=a.n22*a.n11-a.n21*a.n12,a=a.n11*d+a.n21*g+a.n31*j;return a==0&&console.error("THREE.Matrix4.makeInvert3x3: Matrix not invertible."),a=1/a,c[0]=a*d,c[1]=a*e,c[2]=a*f,c[3]=a*g,c[4]=a*h,c[5]=a*i,c[6]=a*j,c[7]=a*k,c[8]=a*l,b},a.Matrix4.makeFrustum=function(b,c,d,e,f,g){var h;return h=new a.Matrix4,h.n11=2*f/(c-b),h.n12=0,h.n13=(c+b)/(c-b),h.n14=0,h.n21=0,h.n22=2*f/(e-d),h.n23=(e+d)/(e-d),h.n24=0,h.n31=0,h.n32=0,h.n33=-(g+f)/(g-f),h.n34=-2*g*f/(g-f),h.n41=0,h.n42=0,h.n43=-1,h.n44=0,h},a.Matrix4.makePerspective=function(b,c,d,e){var f,b=d*Math.tan(b*Math.PI/360);return f=-b,a.Matrix4.makeFrustum(f*c,b*c,f,b,d,e)},a.Matrix4.makeOrtho=function(b,c,d,e,f,g){var h,i,j,k;return h=new a.Matrix4,i=c-b,j=d-e,k=g-f,h.n11=2/i,h.n12=0,h.n13=0,h.n14=-((c+b)/i),h.n21=0,h.n22=2/j,h.n23=0,h.n24=-((d+e)/j),h.n31=0,h.n32=0,h.n33=-2/k,h.n34=-((g+f)/k),h.n41=0,h.n42=0,h.n43=0,h.n44=1,h},a.Matrix4.__v1=new a.Vector3,a.Matrix4.__v2=new a.Vector3,a.Matrix4.__v3=new a.Vector3,a.Matrix4.__m1=new a.Matrix4,a.Matrix4.__m2=new a.Matrix4,a.Object3D=function(){this.name="",this.id=a.Object3DCount++,this.parent=void 0,this.children=[],this.up=new a.Vector3(0,1,0),this.position=new a.Vector3,this.rotation=new a.Vector3,this.eulerOrder="XYZ",this.scale=new a.Vector3(1,1,1),this.flipSided=this.doubleSided=this.dynamic=!1,this.renderDepth=null,this.rotationAutoUpdate=!0,this.matrix=new a.Matrix4,this.matrixWorld=new a.Matrix4,this.matrixRotationWorld=new a.Matrix4,this.matrixWorldNeedsUpdate=this.matrixAutoUpdate=!0,this.quaternion=new a.Quaternion,this.useQuaternion=!1,this.boundRadius=0,this.boundRadiusScale=1,this.visible=!0,this.receiveShadow=this.castShadow=!1,this.frustumCulled=!0,this._vector=new a.Vector3},a.Object3D.prototype={constructor:a.Object3D,translate:function(a,b){this.matrix.rotateAxis(b),this.position.addSelf(b.multiplyScalar(a))},translateX:function(a){this.translate(a,this._vector.set(1,0,0))},translateY:function(a){this.translate(a,this._vector.set(0,1,0))},translateZ:function(a){this.translate(a,this._vector.set(0,0,1))},lookAt:function(a){this.matrix.lookAt(a,this.position,this.up),this.rotationAutoUpdate&&this.rotation.setRotationFromMatrix(this.matrix)},add:function(b){if(this.children.indexOf(b)===-1){b.parent!==void 0&&b.parent.removeChild(b),b.parent=this,this.children.push(b);for(var c=this;c.parent!==void 0;)c=c.parent;c!==void 0&&c instanceof a.Scene&&c.addChildRecurse(b)}},remove:function(b){var c=this,d=this.children.indexOf(b);if(d!==-1){b.parent=void 0;for(this.children.splice(d,1);c.parent!==void 0;)c=c.parent;c!==void 0&&c instanceof a.Scene&&c.removeChildRecurse(b)}},getChildByName:function(a,b){var c,d,e;c=0;for(d=this.children.length;c<d;c++){e=this.children[c];if(e.name===a)return e;if(b&&(e=e.getChildByName(a,b),e!==void 0))return e}},updateMatrix:function(){this.matrix.setPosition(this.position),this.useQuaternion?this.matrix.setRotationFromQuaternion(this.quaternion):this.matrix.setRotationFromEuler(this.rotation,this.eulerOrder);if(this.scale.x!==1||this.scale.y!==1||this.scale.z!==1)this.matrix.scale(this.scale),this.boundRadiusScale=Math.max(this.scale.x,Math.max(this.scale.y,this.scale.z));this.matrixWorldNeedsUpdate=!0},update:function(a,b,c){this.matrixAutoUpdate&&this.updateMatrix();if(this.matrixWorldNeedsUpdate||b)a?this.matrixWorld.multiply(a,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixRotationWorld.extractRotation(this.matrixWorld,this.scale),this.matrixWorldNeedsUpdate=!1,b=!0;for(var a=0,d=this.children.length;a<d;a++)this.children[a].update(this.matrixWorld,b,c)},addChild:function(a){console.warn("DEPRECATED: Object3D.addChild() is now Object3D.add()."),this.add(a)},removeChild:function(a){console.warn("DEPRECATED: Object3D.removeChild() is now Object3D.remove()."),this.remove(a)}},a.Object3DCount=0,a.Projector=function(){function b(){var b=j[i]=j[i]||new a.RenderableVertex;return i++,b}function c(a,b){return b.z-a.z}function d(a,b){var c=0,d=1,e=a.z+a.w,f=b.z+b.w,g=-a.z+a.w,h=-b.z+b.w;return e<0||f<0||g<0||h<0?e<0&&f<0||g<0&&h<0?!1:(e<0?c=Math.max(c,e/(e-f)):f<0&&(d=Math.min(d,e/(e-f))),g<0?c=Math.max(c,g/(g-h)):h<0&&(d=Math.min(d,g/(g-h))),d<c?!1:(a.lerpSelf(b,c),b.lerpSelf(a,1-d),!0)):!0}var e,f,g=[],h,i,j=[],k,l,m=[],n,o=[],p,q,r=[],s,t,u=[],v=[],w=[],x=new a.Vector4,y=new a.Vector4,z=new a.Matrix4,A=new a.Matrix4,B=[new a.Vector4,new a.Vector4,new a.Vector4,new a.Vector4,new a.Vector4,new a.Vector4],C=new a.Vector4,D=new a.Vector4;this.projectVector=function(a,b){return z.multiply(b.projectionMatrix,b.matrixWorldInverse),z.multiplyVector3(a),a},this.unprojectVector=function(b,c){return z.multiply(c.matrixWorld,a.Matrix4.makeInvert(c.projectionMatrix)),z.multiplyVector3(b),b},this.pickingRay=function(b,c){var d;return b.z=-1,d=new a.Vector3(b.x,b.y,1),this.unprojectVector(b,c),this.unprojectVector(d,c),d.subSelf(b).normalize(),new a.Ray(b,d)},this.projectObjects=function(b,d,h){var i,j;f=v.length=0,i=b.objects,b=0;for(d=i.length;b<d;b++){j=i[b];var k;if(!(k=!j.visible))if(k=j instanceof a.Mesh)if(k=j.frustumCulled){l:{k=void 0;for(var m=j.matrixWorld,n=-j.geometry.boundingSphere.radius*Math.max(j.scale.x,Math.max(j.scale.y,j.scale.z)),o=0;o<6;o++)if(k=B[o].x*m.n14+B[o].y*m.n24+B[o].z*m.n34+B[o].w,k<=n){k=!1;break l}k=!0}k=!k}k||(k=g[f]=g[f]||new a.RenderableObject,f++,e=k,x.copy(j.position),z.multiplyVector3(x),e.object=j,e.z=x.z,v.push(e))}return h&&v.sort(c),v},this.projectScene=function(e,f,g){var v=f.near,x=f.far,F,I,J,N,O,Q,R,S,T,U,V,W,X,Y,$,_,ba;t=q=n=l=w.length=0,f.matrixAutoUpdate&&f.update(void 0,!0),e.update(void 0,!1,f),z.multiply(f.projectionMatrix,f.matrixWorldInverse),B[0].set(z.n41-z.n11,z.n42-z.n12,z.n43-z.n13,z.n44-z.n14),B[1].set(z.n41+z.n11,z.n42+z.n12,z.n43+z.n13,z.n44+z.n14),B[2].set(z.n41+z.n21,z.n42+z.n22,z.n43+z.n23,z.n44+z.n24),B[3].set(z.n41-z.n21,z.n42-z.n22,z.n43-z.n23,z.n44-z.n24),B[4].set(z.n41-z.n31,z.n42-z.n32,z.n43-z.n33,z.n44-z.n34),B[5].set(z.n41+z.n31,z.n42+z.n32,z.n43+z.n33,z.n44+z.n34);for(F=0;F<6;F++)T=B[F],T.divideScalar(Math.sqrt(T.x*T.x+T.y*T.y+T.z*T.z));T=this.projectObjects(e,f,!0),e=0;for(F=T.length;e<F;e++)if(U=T[e].object,U.visible)if(V=U.matrixWorld,W=U.matrixRotationWorld,X=U.materials,Y=U.overdraw,i=0,U instanceof a.Mesh){$=U.geometry,N=$.vertices,_=$.faces,$=$.faceVertexUvs,I=0;for(J=N.length;I<J;I++)h=b(),h.positionWorld.copy(N[I].position),V.multiplyVector3(h.positionWorld),h.positionScreen.copy(h.positionWorld),z.multiplyVector4(h.positionScreen),h.positionScreen.x/=h.positionScreen.w,h.positionScreen.y/=h.positionScreen.w,h.visible=h.positionScreen.z>v&&h.positionScreen.z<x;N=0;for(I=_.length;N<I;N++){J=_[N];if(J instanceof a.Face3)if(O=j[J.a],Q=j[J.b],R=j[J.c],O.visible&&Q.visible&&R.visible&&(U.doubleSided||U.flipSided!=(R.positionScreen.x-O.positionScreen.x)*(Q.positionScreen.y-O.positionScreen.y)-(R.positionScreen.y-O.positionScreen.y)*(Q.positionScreen.x-O.positionScreen.x)<0))S=m[l]=m[l]||new a.RenderableFace3,l++,k=S,k.v1.copy(O),k.v2.copy(Q),k.v3.copy(R);else continue;else if(J instanceof a.Face4)if(O=j[J.a],Q=j[J.b],R=j[J.c],S=j[J.d],O.visible&&Q.visible&&R.visible&&S.visible&&(U.doubleSided||U.flipSided!=((S.positionScreen.x-O.positionScreen.x)*(Q.positionScreen.y-O.positionScreen.y)-(S.positionScreen.y-O.positionScreen.y)*(Q.positionScreen.x-O.positionScreen.x)<0||(Q.positionScreen.x-R.positionScreen.x)*(S.positionScreen.y-R.positionScreen.y)-(Q.positionScreen.y-R.positionScreen.y)*(S.positionScreen.x-R.positionScreen.x)<0)))ba=o[n]=o[n]||new a.RenderableFace4,n++,k=ba,k.v1.copy(O),k.v2.copy(Q),k.v3.copy(R),k.v4.copy(S);else continue;k.normalWorld.copy(J.normal),W.multiplyVector3(k.normalWorld),k.centroidWorld.copy(J.centroid),V.multiplyVector3(k.centroidWorld),k.centroidScreen.copy(k.centroidWorld),z.multiplyVector3(k.centroidScreen),R=J.vertexNormals,O=0;for(Q=R.length;O<Q;O++)S=k.vertexNormalsWorld[O],S.copy(R[O]),W.multiplyVector3(S);O=0;for(Q=$.length;O<Q;O++)if(ba=$[O][N]){R=0;for(S=ba.length;R<S;R++)k.uvs[O][R]=ba[R]}k.meshMaterials=X,k.faceMaterials=J.materials,k.overdraw=Y,k.z=k.centroidScreen.z,w.push(k)}}else if(U instanceof a.Line){A.multiply(z,V),N=U.geometry.vertices,O=b(),O.positionScreen.copy(N[0].position),A.multiplyVector4(O.positionScreen),I=1;for(J=N.length;I<J;I++)if(O=b(),O.positionScreen.copy(N[I].position),A.multiplyVector4(O.positionScreen),Q=j[i-2],C.copy(O.positionScreen),D.copy(Q.positionScreen),d(C,D))C.multiplyScalar(1/C.w),D.multiplyScalar(1/D.w),V=r[q]=r[q]||new a.RenderableLine,q++,p=V,p.v1.positionScreen.copy(C),p.v2.positionScreen.copy(D),p.z=Math.max(C.z,D.z),p.materials=U.materials,w.push(p)}else U instanceof a.Particle&&(y.set(U.matrixWorld.n14,U.matrixWorld.n24,U.matrixWorld.n34,1),z.multiplyVector4(y),y.z/=y.w,y.z>0&&y.z<1)&&(V=u[t]=u[t]||new a.RenderableParticle,t++,s=V,s.x=y.x/y.w,s.y=y.y/y.w,s.z=y.z,s.rotation=U.rotation.z,s.scale.x=U.scale.x*Math.abs(s.x-(y.x+f.projectionMatrix.n11)/(y.w+f.projectionMatrix.n14)),s.scale.y=U.scale.y*Math.abs(s.y-(y.y+f.projectionMatrix.n22)/(y.w+f.projectionMatrix.n24)),s.materials=U.materials,w.push(s));return g&&w.sort(c),w}},a.Quaternion=function(a,b,c,d){this.set(a||0,b||0,c||0,d!==void 0?d:1)},a.Quaternion.prototype={constructor:a.Quaternion,set:function(a,b,c,d){return this.x=a,this.y=b,this.z=c,this.w=d,this},copy:function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this.w=a.w,this},setFromEuler:function(a){var b=Math.PI/360,c=a.x*b,d=a.y*b,e=a.z*b,a=Math.cos(d),d=Math.sin(d),b=Math.cos(-e),e=Math.sin(-e),f=Math.cos(c),c=Math.sin(c),g=a*b,h=d*e;return this.w=g*f-h*c,this.x=g*c+h*f,this.y=d*b*f+a*e*c,this.z=a*e*f-d*b*c,this},setFromAxisAngle:function(a,b){var c=b/2,d=Math.sin(c);return this.x=a.x*d,this.y=a.y*d,this.z=a.z*d,this.w=Math.cos(c),this},setFromRotationMatrix:function(a){var b=Math.pow(a.determinant(),1/3);return this.w=Math.sqrt(Math.max(0,b+a.n11+a.n22+a.n33))/2,this.x=Math.sqrt(Math.max(0,b+a.n11-a.n22-a.n33))/2,this.y=Math.sqrt(Math.max(0,b-a.n11+a.n22-a.n33))/2,this.z=Math.sqrt(Math.max(0,b-a.n11-a.n22+a.n33))/2,this.x=a.n32-a.n23<0?-Math.abs(this.x):Math.abs(this.x),this.y=a.n13-a.n31<0?-Math.abs(this.y):Math.abs(this.y),this.z=a.n21-a.n12<0?-Math.abs(this.z):Math.abs(this.z),this.normalize(),this},calculateW:function(){return this.w=-Math.sqrt(Math.abs(1-this.x*this.x-this.y*this.y-this.z*this.z)),this},inverse:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return a==0?this.w=this.z=this.y=this.x=0:(a=1/a,this.x*=a,this.y*=a,this.z*=a,this.w*=a),this},multiplySelf:function(a){var b=this.x,c=this.y,d=this.z,e=this.w,f=a.x,g=a.y,h=a.z,a=a.w;return this.x=b*a+e*f+c*h-d*g,this.y=c*a+e*g+d*f-b*h,this.z=d*a+e*h+b*g-c*f,this.w=e*a-b*f-c*g-d*h,this},multiply:function(a,b){return this.x=a.x*b.w+a.y*b.z-a.z*b.y+a.w*b.x,this.y=-a.x*b.z+a.y*b.w+a.z*b.x+a.w*b.y,this.z=a.x*b.y-a.y*b.x+a.z*b.w+a.w*b.z,this.w=-a.x*b.x-a.y*b.y-a.z*b.z+a.w*b.w,this},multiplyVector3:function(a,b){b||(b=a);var c=a.x,d=a.y,e=a.z,f=this.x,g=this.y,h=this.z,i=this.w,j=i*c+g*e-h*d,k=i*d+h*c-f*e,l=i*e+f*d-g*c,c=-f*c-g*d-h*e;return b.x=j*i+c*-f+k*-h-l*-g,b.y=k*i+c*-g+l*-f-j*-h,b.z=l*i+c*-h+j*-g-k*-f,b}},a.Quaternion.slerp=function(a,b,c,d){var e=a.w*b.w+a.x*b.x+a.y*b.y+a.z*b.z;if(Math.abs(e)<1){var f=Math.acos(e),g=Math.sqrt(1-e*e);return Math.abs(g)<.001?(c.w=.5*(a.w+b.w),c.x=.5*(a.x+b.x),c.y=.5*(a.y+b.y),c.z=.5*(a.z+b.z),c):(e=Math.sin((1-d)*f)/g,d=Math.sin(d*f)/g,c.w=a.w*e+b.w*d,c.x=a.x*e+b.x*d,c.y=a.y*e+b.y*d,c.z=a.z*e+b.z*d,c)}return c.w=a.w,c.x=a.x,c.y=a.y,c.z=a.z,c},a.Vertex=function(b){this.position=b||new a.Vector3},a.Face3=function(b,c,d,e,f,g){this.a=b,this.b=c,this.c=d,this.normal=e instanceof a.Vector3?e:new a.Vector3,this.vertexNormals=e instanceof Array?e:[],this.color=f instanceof a.Color?f:new a.Color,this.vertexColors=f instanceof Array?f:[],this.vertexTangents=[],this.materials=g instanceof Array?g:[g],this.centroid=new a.Vector3},a.Face4=function(b,c,d,e,f,g,h){this.a=b,this.b=c,this.c=d,this.d=e,this.normal=f instanceof a.Vector3?f:new a.Vector3,this.vertexNormals=f instanceof Array?f:[],this.color=g instanceof a.Color?g:new a.Color,this.vertexColors=g instanceof Array?g:[],this.vertexTangents=[],this.materials=h instanceof Array?h:[h],this.centroid=new a.Vector3},a.UV=function(a,b){this.u=a||0,this.v=b||0},a.UV.prototype={constructor:a.UV,set:function(a,b){return this.u=a,this.v=b,this},copy:function(a){return this.u=a.u,this.v=a.v,this},clone:function(){return new a.UV(this.u,this.v)}},a.Geometry=function(){this.id=a.GeometryCount++,this.vertices=[],this.colors=[],this.faces=[],this.faceUvs=[[]],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphColors=[],this.skinWeights=[],this.skinIndices=[],this.boundingSphere=this.boundingBox=null,this.dynamic=this.hasTangents=!1},a.Geometry.prototype={constructor:a.Geometry,applyMatrix:function(b){var c=new a.Matrix4;c.extractRotation(b,new a.Vector3(1,1,1));for(var d=0,e=this.vertices.length;d<e;d++)b.multiplyVector3(this.vertices[d].position);d=0;for(e=this.faces.length;d<e;d++){var f=this.faces[d];c.multiplyVector3(f.normal);for(var g=0,h=f.vertexNormals.length;g<h;g++)c.multiplyVector3(f.vertexNormals[g]);b.multiplyVector3(f.centroid)}},computeCentroids:function(){var b,c,d;b=0;for(c=this.faces.length;b<c;b++)d=this.faces[b],d.centroid.set(0,0,0),d instanceof a.Face3?(d.centroid.addSelf(this.vertices[d.a].position),d.centroid.addSelf(this.vertices[d.b].position),d.centroid.addSelf(this.vertices[d.c].position),d.centroid.divideScalar(3)):d instanceof a.Face4&&(d.centroid.addSelf(this.vertices[d.a].position),d.centroid.addSelf(this.vertices[d.b].position),d.centroid.addSelf(this.vertices[d.c].position),d.centroid.addSelf(this.vertices[d.d].position),d.centroid.divideScalar(4))},computeFaceNormals:function(b){var c,d,e,f,g,h,i=new a.Vector3,j=new a.Vector3;e=0;for(f=this.faces.length;e<f;e++){g=this.faces[e];if(b&&g.vertexNormals.length){i.set(0,0,0),c=0;for(d=g.vertexNormals.length;c<d;c++)i.addSelf(g.vertexNormals[c]);i.divideScalar(3)}else c=this.vertices[g.a],d=this.vertices[g.b],h=this.vertices[g.c],i.sub(h.position,d.position),j.sub(c.position,d.position),i.crossSelf(j);i.isZero()||i.normalize(),g.normal.copy(i)}},computeVertexNormals:function(){var b,c,d,e;if(this.__tmpVertices==void 0){e=this.__tmpVertices=Array(this.vertices.length),b=0;for(c=this.vertices.length;b<c;b++)e[b]=new a.Vector3;b=0;for(c=this.faces.length;b<c;b++)(d=this.faces[b],d instanceof a.Face3)?d.vertexNormals=[new a.Vector3,new a.Vector3,new a.Vector3]:d instanceof a.Face4&&(d.vertexNormals=[new a.Vector3,new a.Vector3,new a.Vector3,new a.Vector3])}else{e=this.__tmpVertices,b=0;for(c=this.vertices.length;b<c;b++)e[b].set(0,0,0)}b=0;for(c=this.faces.length;b<c;b++)d=this.faces[b],d instanceof a.Face3?(e[d.a].addSelf(d.normal),e[d.b].addSelf(d.normal),e[d.c].addSelf(d.normal)):d instanceof a.Face4&&(e[d.a].addSelf(d.normal),e[d.b].addSelf(d.normal),e[d.c].addSelf(d.normal),e[d.d].addSelf(d.normal));b=0;for(c=this.vertices.length;b<c;b++)e[b].normalize();b=0;for(c=this.faces.length;b<c;b++)d=this.faces[b],d instanceof a.Face3?(d.vertexNormals[0].copy(e[d.a]),d.vertexNormals[1].copy(e[d.b]),d.vertexNormals[2].copy(e[d.c])):d instanceof a.Face4&&(d.vertexNormals[0].copy(e[d.a]),d.vertexNormals[1].copy(e[d.b]),d.vertexNormals[2].copy(e[d.c]),d.vertexNormals[3].copy(e[d.d]))},computeTangents:function(){function b(a,b,c,d,e,f,g){i=a.vertices[b].position,j=a.vertices[c].position,k=a.vertices[d].position,l=h[e],m=h[f],n=h[g],o=j.x-i.x,p=k.x-i.x,q=j.y-i.y,r=k.y-i.y,s=j.z-i.z,t=k.z-i.z,u=m.u-l.u,v=n.u-l.u,w=m.v-l.v,x=n.v-l.v,y=1/(u*x-v*w),C.set((x*o-w*p)*y,(x*q-w*r)*y,(x*s-w*t)*y),D.set((u*p-v*o)*y,(u*r-v*q)*y,(u*t-v*s)*y),A[b].addSelf(C),A[c].addSelf(C),A[d].addSelf(C),B[b].addSelf(D),B[c].addSelf(D),B[d].addSelf(D)}var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=[],B=[],C=new a.Vector3,D=new a.Vector3,E=new a.Vector3,F=new a.Vector3,G=new a.Vector3;c=0;for(d=this.vertices.length;c<d;c++)A[c]=new a.Vector3,B[c]=new a.Vector3;c=0;for(d=this.faces.length;c<d;c++)g=this.faces[c],h=this.faceVertexUvs[0][c],g instanceof a.Face3?b(this,g.a,g.b,g.c,0,1,2):g instanceof a.Face4&&(b(this,g.a,g.b,g.c,0,1,2),b(this,g.a,g.b,g.d,0,1,3));var H=["a","b","c","d"];c=0;for(d=this.faces.length;c<d;c++){g=this.faces[c];for(e=0;e<g.vertexNormals.length;e++)G.copy(g.vertexNormals[e]),f=g[H[e]],z=A[f],E.copy(z),E.subSelf(G.multiplyScalar(G.dot(z))).normalize(),F.cross(g.vertexNormals[e],z),f=F.dot(B[f]),f=f<0?-1:1,g.vertexTangents[e]=new a.Vector4(E.x,E.y,E.z,f)}this.hasTangents=!0},computeBoundingBox:function(){var a;if(this.vertices.length>0){this.boundingBox={x:[this.vertices[0].position.x,this.vertices[0].position.x],y:[this.vertices[0].position.y,this.vertices[0].position.y],z:[this.vertices[0].position.z,this.vertices[0].position.z]};for(var b=1,c=this.vertices.length;b<c;b++)a=this.vertices[b],a.position.x<this.boundingBox.x[0]?this.boundingBox.x[0]=a.position.x:a.position.x>this.boundingBox.x[1]&&(this.boundingBox.x[1]=a.position.x),a.position.y<this.boundingBox.y[0]?this.boundingBox.y[0]=a.position.y:a.position.y>this.boundingBox.y[1]&&(this.boundingBox.y[1]=a.position.y),a.position.z<this.boundingBox.z[0]?this.boundingBox.z[0]=a.position.z:a.position.z>this.boundingBox.z[1]&&(this.boundingBox.z[1]=a.position.z)}},computeBoundingSphere:function(){for(var a=0,b=0,c=this.vertices.length;b<c;b++)a=Math.max(a,this.vertices[b].position.length());this.boundingSphere={radius:a}},mergeVertices:function(){var b={},c=[],d=[],e,f=Math.pow(10,4),g,h;g=0;for(h=this.vertices.length;g<h;g++)e=this.vertices[g].position,e=[Math.round(e.x*f),Math.round(e.y*f),Math.round(e.z*f)].join("_"),b[e]===void 0?(b[e]=g,c.push(this.vertices[g]),d[g]=c.length-1):d[g]=d[b[e]];g=0;for(h=this.faces.length;g<h;g++)b=this.faces[g],b instanceof a.Face3&&(b.a=d[b.a],b.b=d[b.b],b.c=d[b.c]),b instanceof a.Face4&&(b.a=d[b.a],b.b=d[b.b],b.c=d[b.c],b.d=d[b.d]);this.vertices=c}},a.GeometryCount=0,a.Spline=function(b){function c(a,b,c,d,e,f,g){return a=(c-a)*.5,d=(d-b)*.5,(2*(b-c)+a+d)*g+(-3*(b-c)-2*a-d)*f+a*e+b}this.points=b;var d=[],e={x:0,y:0,z:0},f,g,h,i,j,k,l,m,n;this.initFromArray=function(a){this.points=[];for(var b=0;b<a.length;b++)this.points[b]={x:a[b][0],y:a[b][1],z:a[b][2]}},this.getPoint=function(a){return f=(this.points.length-1)*a,g=Math.floor(f),h=f-g,d[0]=g==0?g:g-1,d[1]=g,d[2]=g>this.points.length-2?g:g+1,d[3]=g>this.points.length-3?g:g+2,k=this.points[d[0]],l=this.points[d[1]],m=this.points[d[2]],n=this.points[d[3]],i=h*h,j=h*i,e.x=c(k.x,l.x,m.x,n.x,h,i,j),e.y=c(k.y,l.y,m.y,n.y,h,i,j),e.z=c(k.z,l.z,m.z,n.z,h,i,j),e},this.getControlPointsArray=function(){var a,b,c=this.points.length,d=[];for(a=0;a<c;a++)b=this.points[a],d[a]=[b.x,b.y,b.z];return d},this.getLength=function(b){var c,d,e=c=c=0,f=new a.Vector3,g=new a.Vector3,h=[],i=0;h[0]=0,b||(b=100),d=this.points.length*b,f.copy(this.points[0]);for(b=1;b<d;b++)c=b/d,position=this.getPoint(c),g.copy(position),i+=g.distanceTo(f),f.copy(position),c*=this.points.length-1,c=Math.floor(c),c!=e&&(h[c]=i,e=c);return h[h.length]=i,{chunks:h,total:i}},this.reparametrizeByArcLength=function(b){var c,d,e,f,g,h,i=[],j=new a.Vector3,k=this.getLength();i.push(j.copy(this.points[0]).clone());for(c=1;c<this.points.length;c++){d=k.chunks[c]-k.chunks[c-1],h=Math.ceil(b*d/k.total),f=(c-1)/(this.points.length-1),g=c/(this.points.length-1);for(d=1;d<h-1;d++)e=f+d*(1/h)*(g-f),position=this.getPoint(e),i.push(j.copy(position).clone());i.push(j.copy(this.points[c]).clone())}this.points=i}},a.Edge=function(a,b,c,d){this.vertices=[a,b],this.vertexIndices=[c,d],this.faces=[],this.faceIndices=[]},a.Camera=function(){if(arguments.length)return console.warn("DEPRECATED: Camera() is now PerspectiveCamera() or OrthographicCamera()."),new a.PerspectiveCamera(arguments[0],arguments[1],arguments[2],arguments[3]);a.Object3D.call(this),this.matrixWorldInverse=new a.Matrix4,this.projectionMatrix=new a.Matrix4},a.Camera.prototype=new a.Object3D,a.Camera.prototype.constructor=a.Camera,a.Camera.prototype.lookAt=function(a){this.matrix.lookAt(this.position,a,this.up),this.rotationAutoUpdate&&this.rotation.setRotationFromMatrix(this.matrix)},a.Camera.prototype.update=function(b,c,d){this.matrixAutoUpdate&&this.updateMatrix();if(c||this.matrixWorldNeedsUpdate)b?this.matrixWorld.multiply(b,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,c=!0,a.Matrix4.makeInvert(this.matrixWorld,this.matrixWorldInverse);for(b=0;b<this.children.length;b++)this.children[b].update(this.matrixWorld,c,d)},a.OrthographicCamera=function(b,c,d,e,f,g){a.Camera.call(this),this.left=b,this.right=c,this.top=d,this.bottom=e,this.near=f!==void 0?f:.1,this.far=g!==void 0?g:2e3,this.updateProjectionMatrix()},a.OrthographicCamera.prototype=new a.Camera,a.OrthographicCamera.prototype.constructor=a.OrthographicCamera,a.OrthographicCamera.prototype.updateProjectionMatrix=function(){this.projectionMatrix=a.Matrix4.makeOrtho(this.left,this.right,this.top,this.bottom,this.near,this.far)},a.PerspectiveCamera=function(b,c,d,e){a.Camera.call(this),this.fov=b!==void 0?b:50,this.aspect=c!==void 0?c:1,this.near=d!==void 0?d:.1,this.far=e!==void 0?e:2e3,this.updateProjectionMatrix()},a.PerspectiveCamera.prototype=new a.Camera,a.PerspectiveCamera.prototype.constructor=a.PerspectiveCamera,a.PerspectiveCamera.prototype.setLens=function(a,b){this.fov=2*Math.atan((b!==void 0?b:43.25)/(a*2)),this.fov*=180/Math.PI,this.updateProjectionMatrix()},a.PerspectiveCamera.prototype.setViewOffset=function(a,b,c,d,e,f){this.fullWidth=a,this.fullHeight=b,this.x=c,this.y=d,this.width=e,this.height=f,this.updateProjectionMatrix()},a.PerspectiveCamera.prototype.updateProjectionMatrix=function(){if(this.fullWidth){var b=this.fullWidth/this.fullHeight,c=Math.tan(this.fov*Math.PI/360)*this.near,d=-c,e=b*d,b=Math.abs(b*c-e),d=Math.abs(c-d);this.projectionMatrix=a.Matrix4.makeFrustum(e+this.x*b/this.fullWidth,e+(this.x+this.width)*b/this.fullWidth,c-(this.y+this.height)*d/this.fullHeight,c-this.y*d/this.fullHeight,this.near,this.far)}else this.projectionMatrix=a.Matrix4.makePerspective(this.fov,this.aspect,this.near,this.far)},a.Light=function(b){a.Object3D.call(this),this.color=new a.Color(b)},a.Light.prototype=new a.Object3D,a.Light.prototype.constructor=a.Light,a.Light.prototype.supr=a.Object3D.prototype,a.AmbientLight=function(b){a.Light.call(this,b)},a.AmbientLight.prototype=new a.Light,a.AmbientLight.prototype.constructor=a.AmbientLight,a.DirectionalLight=function(b,c,d){a.Light.call(this,b),this.position=new a.Vector3(0,1,0),this.intensity=c!==void 0?c:1,this.distance=d!==void 0?d:0},a.DirectionalLight.prototype=new a.Light,a.DirectionalLight.prototype.constructor=a.DirectionalLight,a.PointLight=function(b,c,d){a.Light.call(this,b),this.position=new a.Vector3(0,0,0),this.intensity=c!==void 0?c:1,this.distance=d!==void 0?d:0},a.PointLight.prototype=new a.Light,a.PointLight.prototype.constructor=a.PointLight,a.SpotLight=function(b,c,d,e){a.Light.call(this,b),this.position=new a.Vector3(0,1,0),this.target=new a.Object3D,this.intensity=c!==void 0?c:1,this.distance=d!==void 0?d:0,this.castShadow=e!==void 0?e:!1},a.SpotLight.prototype=new a.Light,a.SpotLight.prototype.constructor=a.SpotLight,a.Material=function(b){this.name="",this.id=a.MaterialCount++,b=b||{},this.opacity=b.opacity!==void 0?b.opacity:1,this.transparent=b.transparent!==void 0?b.transparent:!1,this.blending=b.blending!==void 0?b.blending:a.NormalBlending,this.depthTest=b.depthTest!==void 0?b.depthTest:!0,this.depthWrite=b.depthWrite!==void 0?b.depthWrite:!0,this.polygonOffset=b.polygonOffset!==void 0?b.polygonOffset:!1,this.polygonOffsetFactor=b.polygonOffsetFactor!==void 0?b.polygonOffsetFactor:0,this.polygonOffsetUnits=b.polygonOffsetUnits!==void 0?b.polygonOffsetUnits:0,this.alphaTest=b.alphaTest!==void 0?b.alphaTest:0},a.MaterialCount=0,a.NoShading=0,a.FlatShading=1,a.SmoothShading=2,a.NoColors=0,a.FaceColors=1,a.VertexColors=2,a.NormalBlending=0,a.AdditiveBlending=1,a.SubtractiveBlending=2,a.MultiplyBlending=3,a.AdditiveAlphaBlending=4,a.LineBasicMaterial=function(b){a.Material.call(this,b),b=b||{},this.color=b.color!==void 0?new a.Color(b.color):new a.Color(16777215),this.linewidth=b.linewidth!==void 0?b.linewidth:1,this.linecap=b.linecap!==void 0?b.linecap:"round",this.linejoin=b.linejoin!==void 0?b.linejoin:"round",this.vertexColors=b.vertexColors?b.vertexColors:!1,this.fog=b.fog!==void 0?b.fog:!0},a.LineBasicMaterial.prototype=new a.Material,a.LineBasicMaterial.prototype.constructor=a.LineBasicMaterial,a.MeshBasicMaterial=function(b){a.Material.call(this,b),b=b||{},this.color=b.color!==void 0?new a.Color(b.color):new a.Color(16777215),this.map=b.map!==void 0?b.map:null,this.lightMap=b.lightMap!==void 0?b.lightMap:null,this.envMap=b.envMap!==void 0?b.envMap:null,this.combine=b.combine!==void 0?b.combine:a.MultiplyOperation,this.reflectivity=b.reflectivity!==void 0?b.reflectivity:1,this.refractionRatio=b.refractionRatio!==void 0?b.refractionRatio:.98,this.fog=b.fog!==void 0?b.fog:!0,this.shading=b.shading!==void 0?b.shading:a.SmoothShading,this.wireframe=b.wireframe!==void 0?b.wireframe:!1,this.wireframeLinewidth=b.wireframeLinewidth!==void 0?b.wireframeLinewidth:1,this.wireframeLinecap=b.wireframeLinecap!==void 0?b.wireframeLinecap:"round",this.wireframeLinejoin=b.wireframeLinejoin!==void 0?b.wireframeLinejoin:"round",this.vertexColors=b.vertexColors!==void 0?b.vertexColors:!1,this.skinning=b.skinning!==void 0?b.skinning:!1,this.morphTargets=b.morphTargets!==void 0?b.morphTargets:!1},a.MeshBasicMaterial.prototype=new a.Material,a.MeshBasicMaterial.prototype.constructor=a.MeshBasicMaterial,a.MeshLambertMaterial=function(b){a.Material.call(this,b),b=b||{},this.color=b.color!==void 0?new a.Color(b.color):new a.Color(16777215),this.map=b.map!==void 0?b.map:null,this.lightMap=b.lightMap!==void 0?b.lightMap:null,this.envMap=b.envMap!==void 0?b.envMap:null,this.combine=b.combine!==void 0?b.combine:a.MultiplyOperation,this.reflectivity=b.reflectivity!==void 0?b.reflectivity:1,this.refractionRatio=b.refractionRatio!==void 0?b.refractionRatio:.98,this.fog=b.fog!==void 0?b.fog:!0,this.shading=b.shading!==void 0?b.shading:a.SmoothShading,this.wireframe=b.wireframe!==void 0?b.wireframe:!1,this.wireframeLinewidth=b.wireframeLinewidth!==void 0?b.wireframeLinewidth:1,this.wireframeLinecap=b.wireframeLinecap!==void 0?b.wireframeLinecap:"round",this.wireframeLinejoin=b.wireframeLinejoin!==void 0?b.wireframeLinejoin:"round",this.vertexColors=b.vertexColors!==void 0?b.vertexColors:!1,this.skinning=b.skinning!==void 0?b.skinning:!1,this.morphTargets=b.morphTargets!==void 0?b.morphTargets:!1},a.MeshLambertMaterial.prototype=new a.Material,a.MeshLambertMaterial.prototype.constructor=a.MeshLambertMaterial,a.MeshPhongMaterial=function(b){a.Material.call(this,b),b=b||{},this.color=b.color!==void 0?new a.Color(b.color):new a.Color(16777215),this.ambient=b.ambient!==void 0?new a.Color(b.ambient):new a.Color(328965),this.specular=b.specular!==void 0?new a.Color(b.specular):new a.Color(1118481),this.shininess=b.shininess!==void 0?b.shininess:30,this.map=b.map!==void 0?b.map:null,this.lightMap=b.lightMap!==void 0?b.lightMap:null,this.envMap=b.envMap!==void 0?b.envMap:null,this.combine=b.combine!==void 0?b.combine:a.MultiplyOperation,this.reflectivity=b.reflectivity!==void 0?b.reflectivity:1,this.refractionRatio=b.refractionRatio!==void 0?b.refractionRatio:.98,this.fog=b.fog!==void 0?b.fog:!0,this.shading=b.shading!==void 0?b.shading:a.SmoothShading,this.wireframe=b.wireframe!==void 0?b.wireframe:!1,this.wireframeLinewidth=b.wireframeLinewidth!==void 0?b.wireframeLinewidth:1,this.wireframeLinecap=b.wireframeLinecap!==void 0?b.wireframeLinecap:"round",this.wireframeLinejoin=b.wireframeLinejoin!==void 0?b.wireframeLinejoin:"round",this.vertexColors=b.vertexColors!==void 0?b.vertexColors:!1,this.skinning=b.skinning!==void 0?b.skinning:!1,this.morphTargets=b.morphTargets!==void 0?b.morphTargets:!1},a.MeshPhongMaterial.prototype=new a.Material,a.MeshPhongMaterial.prototype.constructor=a.MeshPhongMaterial,a.MeshDepthMaterial=function(b){a.Material.call(this,b),b=b||{},this.shading=b.shading!==void 0?b.shading:a.SmoothShading,this.wireframe=b.wireframe!==void 0?b.wireframe:!1,this.wireframeLinewidth=b.wireframeLinewidth!==void 0?b.wireframeLinewidth:1},a.MeshDepthMaterial.prototype=new a.Material,a.MeshDepthMaterial.prototype.constructor=a.MeshDepthMaterial,a.MeshNormalMaterial=function(b){a.Material.call(this,b),b=b||{},this.shading=b.shading?b.shading:a.FlatShading,this.wireframe=b.wireframe?b.wireframe:!1,this.wireframeLinewidth=b.wireframeLinewidth?b.wireframeLinewidth:1},a.MeshNormalMaterial.prototype=new a.Material,a.MeshNormalMaterial.prototype.constructor=a.MeshNormalMaterial,a.MeshFaceMaterial=function(){},a.MeshShaderMaterial=function(b){return console.warn("DEPRECATED: MeshShaderMaterial() is now ShaderMaterial()."),new a.ShaderMaterial(b)},a.ParticleBasicMaterial=function(b){a.Material.call(this,b),b=b||{},this.color=b.color!==void 0?new a.Color(b.color):new a.Color(16777215),this.map=b.map!==void 0?b.map:null,this.size=b.size!==void 0?b.size:1,this.sizeAttenuation=b.sizeAttenuation!==void 0?b.sizeAttenuation:!0,this.vertexColors=b.vertexColors!==void 0?b.vertexColors:!1,this.fog=b.fog!==void 0?b.fog:!0},a.ParticleBasicMaterial.prototype=new a.Material,a.ParticleBasicMaterial.prototype.constructor=a.ParticleBasicMaterial,a.ParticleCanvasMaterial=function(b){a.Material.call(this,b),b=b||{},this.color=b.color!==void 0?new a.Color(b.color):new a.Color(16777215),this.program=b.program!==void 0?b.program:function(){}},a.ParticleCanvasMaterial.prototype=new a.Material,a.ParticleCanvasMaterial.prototype.constructor=a.ParticleCanvasMaterial,a.ParticleDOMMaterial=function(b){a.Material.call(this),this.domElement=b},a.ShaderMaterial=function(b){a.Material.call(this,b),b=b||{},this.fragmentShader=b.fragmentShader!==void 0?b.fragmentShader:"void main() {}",this.vertexShader=b.vertexShader!==void 0?b.vertexShader:"void main() {}",this.uniforms=b.uniforms!==void 0?b.uniforms:{},this.attributes=b.attributes,this.shading=b.shading!==void 0?b.shading:a.SmoothShading,this.wireframe=b.wireframe!==void 0?b.wireframe:!1,this.wireframeLinewidth=b.wireframeLinewidth!==void 0?b.wireframeLinewidth:1,this.fog=b.fog!==void 0?b.fog:!1,this.lights=b.lights!==void 0?b.lights:!1,this.vertexColors=b.vertexColors!==void 0?b.vertexColors:!1,this.skinning=b.skinning!==void 0?b.skinning:!1,this.morphTargets=b.morphTargets!==void 0?b.morphTargets:!1},a.ShaderMaterial.prototype=new a.Material,a.ShaderMaterial.prototype.constructor=a.ShaderMaterial,a.Texture=function(b,c,d,e,f,g){this.id=a.TextureCount++,this.image=b,this.mapping=c!==void 0?c:new a.UVMapping,this.wrapS=d!==void 0?d:a.ClampToEdgeWrapping,this.wrapT=e!==void 0?e:a.ClampToEdgeWrapping,this.magFilter=f!==void 0?f:a.LinearFilter,this.minFilter=g!==void 0?g:a.LinearMipMapLinearFilter,this.offset=new a.Vector2(0,0),this.repeat=new a.Vector2(1,1),this.needsUpdate=!1},a.Texture.prototype={constructor:a.Texture,clone:function(){var b=new a.Texture(this.image,this.mapping,this.wrapS,this.wrapT,this.magFilter,this.minFilter);return b.offset.copy(this.offset),b.repeat.copy(this.repeat),b}},a.TextureCount=0,a.MultiplyOperation=0,a.MixOperation=1,a.CubeReflectionMapping=function(){},a.CubeRefractionMapping=function(){},a.LatitudeReflectionMapping=function(){},a.LatitudeRefractionMapping=function(){},a.SphericalReflectionMapping=function(){},a.SphericalRefractionMapping=function(){},a.UVMapping=function(){},a.RepeatWrapping=0,a.ClampToEdgeWrapping=1,a.MirroredRepeatWrapping=2,a.NearestFilter=3,a.NearestMipMapNearestFilter=4,a.NearestMipMapLinearFilter=5,a.LinearFilter=6,a.LinearMipMapNearestFilter=7,a.LinearMipMapLinearFilter=8,a.ByteType=9,a.UnsignedByteType=10,a.ShortType=11,a.UnsignedShortType=12,a.IntType=13,a.UnsignedIntType=14,a.FloatType=15,a.AlphaFormat=16,a.RGBFormat=17,a.RGBAFormat=18,a.LuminanceFormat=19,a.LuminanceAlphaFormat=20,a.DataTexture=function(b,c,d,e,f,g,h,i,j){a.Texture.call(this,null,f,g,h,i,j),this.image={data:b,width:c,height:d},this.format=e!==void 0?e:a.RGBAFormat},a.DataTexture.prototype=new a.Texture,a.DataTexture.prototype.constructor=a.DataTexture,a.DataTexture.prototype.clone=function(){var b=new a.DataTexture(this.data.slice(0),this.mapping,this.wrapS,this.wrapT,this.magFilter,this.minFilter);return b.offset.copy(this.offset),b.repeat.copy(this.repeat),b},a.Particle=function(b){a.Object3D.call(this),this.materials=b instanceof Array?b:[b]},a.Particle.prototype=new a.Object3D,a.Particle.prototype.constructor=a.Particle,a.ParticleSystem=function(b,c){a.Object3D.call(this),this.geometry=b,this.materials=c instanceof Array?c:[c],this.sortParticles=!1},a.ParticleSystem.prototype=new a.Object3D,a.ParticleSystem.prototype.constructor=a.ParticleSystem,a.Line=function(b,c,d){a.Object3D.call(this),this.geometry=b,this.materials=c instanceof Array?c:[c],this.type=d!=void 0?d:a.LineStrip},a.LineStrip=0,a.LinePieces=1,a.Line.prototype=new a.Object3D,a.Line.prototype.constructor=a.Line,a.Mesh=function(b,c){a.Object3D.call(this),this.geometry=b,this.materials=c&&c.length?c:[c],this.overdraw=!1;if(this.geometry&&(this.geometry.boundingSphere||this.geometry.computeBoundingSphere(),this.boundRadius=b.boundingSphere.radius,this.geometry.morphTargets.length)){this.morphTargetBase=-1,this.morphTargetForcedOrder=[],this.morphTargetInfluences=[],this.morphTargetDictionary={};for(var d=0;d<this.geometry.morphTargets.length;d++)this.morphTargetInfluences.push(0),this.morphTargetDictionary[this.geometry.morphTargets[d].name]=d}},a.Mesh.prototype=new a.Object3D,a.Mesh.prototype.constructor=a.Mesh,a.Mesh.prototype.supr=a.Object3D.prototype,a.Mesh.prototype.getMorphTargetIndexByName=function(a){return this.morphTargetDictionary[a]!==void 0?this.morphTargetDictionary[a]:(console.log("THREE.Mesh.getMorphTargetIndexByName: morph target "+a+" does not exist. Returning 0."),0)},a.Bone=function(b){a.Object3D.call(this),this.skin=b,this.skinMatrix=new a.Matrix4,this.hasNoneBoneChildren=!1},a.Bone.prototype=new a.Object3D,a.Bone.prototype.constructor=a.Bone,a.Bone.prototype.supr=a.Object3D.prototype,a.Bone.prototype.update=function(b,c,d){this.matrixAutoUpdate&&(c|=this.updateMatrix());if(c||this.matrixWorldNeedsUpdate)b?this.skinMatrix.multiply(b,this.matrix):this.skinMatrix.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,c=!0;var e,f=this.children.length;if(this.hasNoneBoneChildren){this.matrixWorld.multiply(this.skin.matrixWorld,this.skinMatrix);for(e=0;e<f;e++)b=this.children[e],b instanceof a.Bone?b.update(this.skinMatrix,c,d):b.update(this.matrixWorld,!0,d)}else for(e=0;e<f;e++)this.children[e].update(this.skinMatrix,c,d)},a.Bone.prototype.addChild=function(b){this.children.indexOf(b)===-1&&(b.parent!==void 0&&b.parent.removeChild(b),b.parent=this,this.children.push(b),!(b instanceof a.Bone))&&(this.hasNoneBoneChildren=!0)},a.SkinnedMesh=function(b,c){a.Mesh.call(this,b,c),this.identityMatrix=new a.Matrix4,this.bones=[],this.boneMatrices=[];var d,e,f,g,h,i;if(this.geometry.bones!==void 0){for(d=0;d<this.geometry.bones.length;d++)f=this.geometry.bones[d],g=f.pos,h=f.rotq,i=f.scl,e=this.addBone(),e.name=f.name,e.position.set(g[0],g[1],g[2]),e.quaternion.set(h[0],h[1],h[2],h[3]),e.useQuaternion=!0,i!==void 0?e.scale.set(i[0],i[1],i[2]):e.scale.set(1,1,1);for(d=0;d<this.bones.length;d++)f=this.geometry.bones[d],e=this.bones[d],f.parent===-1?this.addChild(e):this.bones[f.parent].addChild(e);this.boneMatrices=new Float32Array(16*this.bones.length),this.pose()}},a.SkinnedMesh.prototype=new a.Mesh,a.SkinnedMesh.prototype.constructor=a.SkinnedMesh,a.SkinnedMesh.prototype.update=function(b,c,d){if(this.visible){this.matrixAutoUpdate&&(c|=this.updateMatrix());if(c||this.matrixWorldNeedsUpdate)b?this.matrixWorld.multiply(b,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,c=!0;var e,f=this.children.length;for(e=0;e<f;e++)b=this.children[e],b instanceof a.Bone?b.update(this.identityMatrix,!1,d):b.update(this.matrixWorld,c,d);d=this.bones.length,ba=this.bones,bm=this.boneMatrices;for(c=0;c<d;c++)ba[c].skinMatrix.flattenToArrayOffset(bm,c*16)}},a.SkinnedMesh.prototype.addBone=function(b){return b===void 0&&(b=new a.Bone(this)),this.bones.push(b),b},a.SkinnedMesh.prototype.pose=function(){this.update(void 0,!0);for(var b,c=[],d=0;d<this.bones.length;d++)b=this.bones[d],c.push(a.Matrix4.makeInvert(b.skinMatrix)),b.skinMatrix.flattenToArrayOffset(this.boneMatrices,d*16);if(this.geometry.skinVerticesA===void 0){this.geometry.skinVerticesA=[],this.geometry.skinVerticesB=[];var e;for(b=0;b<this.geometry.skinIndices.length;b++){var d=this.geometry.vertices[b].position,f=this.geometry.skinIndices[b].x,g=this.geometry.skinIndices[b].y;e=new a.Vector3(d.x,d.y,d.z),this.geometry.skinVerticesA.push(c[f].multiplyVector3(e)),e=new a.Vector3(d.x,d.y,d.z),this.geometry.skinVerticesB.push(c[g].multiplyVector3(e)),this.geometry.skinWeights[b].x+this.geometry.skinWeights[b].y!==1&&(d=(1-(this.geometry.skinWeights[b].x+this.geometry.skinWeights[b].y))*.5,this.geometry.skinWeights[b].x+=d,this.geometry.skinWeights[b].y+=d)}}},a.Ribbon=function(b,c){a.Object3D.call(this),this.geometry=b,this.materials=c instanceof Array?c:[c]},a.Ribbon.prototype=new a.Object3D,a.Ribbon.prototype.constructor=a.Ribbon,a.LOD=function(){a.Object3D.call(this),this.LODs=[]},a.LOD.prototype=new a.Object3D,a.LOD.prototype.constructor=a.LOD,a.LOD.prototype.supr=a.Object3D.prototype,a.LOD.prototype.addLevel=function(a,b){b===void 0&&(b=0);for(var b=Math.abs(b),c=0;c<this.LODs.length;c++)if(b<this.LODs[c].visibleAtDistance)break;this.LODs.splice(c,0,{visibleAtDistance:b,object3D:a}),this.add(a)},a.LOD.prototype.update=function(a,b,c){this.matrixAutoUpdate&&(b|=this.updateMatrix());if(b||this.matrixWorldNeedsUpdate)a?this.matrixWorld.multiply(a,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,b=!0;if(this.LODs.length>1){a=c.matrixWorldInverse,a=-(a.n31*this.position.x+a.n32*this.position.y+a.n33*this.position.z+a.n34),this.LODs[0].object3D.visible=!0;for(var d=1;d<this.LODs.length;d++){if(a<this.LODs[d].visibleAtDistance)break;this.LODs[d-1].object3D.visible=!1,this.LODs[d].object3D.visible=!0}for(;d<this.LODs.length;d++)this.LODs[d].object3D.visible=!1}for(a=0;a<this.children.length;a++)this.children[a].update(this.matrixWorld,b,c)},a.Sprite=function(b){a.Object3D.call(this),this.color=b.color!==void 0?new a.Color(b.color):new a.Color(16777215),this.map=b.map instanceof a.Texture?b.map:a.ImageUtils.loadTexture(b.map),this.blending=b.blending!==void 0?b.blending:a.NormalBlending,this.useScreenCoordinates=b.useScreenCoordinates!==void 0?b.useScreenCoordinates:!0,this.mergeWith3D=b.mergeWith3D!==void 0?b.mergeWith3D:!this.useScreenCoordinates,this.affectedByDistance=b.affectedByDistance!==void 0?b.affectedByDistance:!this.useScreenCoordinates,this.scaleByViewport=b.scaleByViewport!==void 0?b.scaleByViewport:!this.affectedByDistance,this.alignment=b.alignment instanceof a.Vector2?b.alignment:a.SpriteAlignment.center,this.rotation3d=this.rotation,this.rotation=0,this.opacity=1,this.uvOffset=new a.Vector2(0,0),this.uvScale=new a.Vector2(1,1)},a.Sprite.prototype=new a.Object3D,a.Sprite.prototype.constructor=a.Sprite,a.Sprite.prototype.supr=a.Object3D.prototype,a.Sprite.prototype.updateMatrix=function(){this.matrix.setPosition(this.position),this.rotation3d.set(0,0,this.rotation),this.matrix.setRotationFromEuler(this.rotation3d);if(this.scale.x!==1||this.scale.y!==1)this.matrix.scale(this.scale),this.boundRadiusScale=Math.max(this.scale.x,this.scale.y);this.matrixWorldNeedsUpdate=!0},a.SpriteAlignment={},a.SpriteAlignment.topLeft=new a.Vector2(1,-1),a.SpriteAlignment.topCenter=new a.Vector2(0,-1),a.SpriteAlignment.topRight=new a.Vector2(-1,-1),a.SpriteAlignment.centerLeft=new a.Vector2(1,0),a.SpriteAlignment.center=new a.Vector2(0,0),a.SpriteAlignment.centerRight=new a.Vector2(-1,0),a.SpriteAlignment.bottomLeft=new a.Vector2(1,1),a.SpriteAlignment.bottomCenter=new a.Vector2(0,1),a.SpriteAlignment.bottomRight=new a.Vector2(-1,1),a.Scene=function(){a.Object3D.call(this),this.fog=null,this.matrixAutoUpdate=!1,this.collisions=this.overrideMaterial=null,this.objects=[],this.lights=[],this.__objectsAdded=[],this.__objectsRemoved=[]},a.Scene.prototype=new a.Object3D,a.Scene.prototype.constructor=a.Scene,a.Scene.prototype.supr=a.Object3D.prototype,a.Scene.prototype.add=function(a){this.supr.add.call(this,a),this.addChildRecurse(a)},a.Scene.prototype.addChildRecurse=function(b){if(b instanceof a.Light)this.lights.indexOf(b)===-1&&this.lights.push(b);else if(!(b instanceof a.Camera||b instanceof a.Bone)&&this.objects.indexOf(b)===-1){this.objects.push(b),this.__objectsAdded.push(b);var c=this.__objectsRemoved.indexOf(b);c!==-1&&this.__objectsRemoved.splice(c,1)}for(c=0;c<b.children.length;c++)this.addChildRecurse(b.children[c])},a.Scene.prototype.remove=function(a){this.supr.remove.call(this,a),this.removeChildRecurse(a)},a.Scene.prototype.removeChildRecurse=function(b){if(b instanceof a.Light){var c=this.lights.indexOf(b);c!==-1&&this.lights.splice(c,1)}else b instanceof a.Camera||(c=this.objects.indexOf(b),c!==-1&&(this.objects.splice(c,1),this.__objectsRemoved.push(b),c=this.__objectsAdded.indexOf(b),c!==-1&&this.__objectsAdded.splice(c,1)));for(c=0;c<b.children.length;c++)this.removeChildRecurse(b.children[c])},a.Scene.prototype.addChild=function(a){console.warn("DEPRECATED: Scene.addChild() is now Scene.add()."),this.add(a)},a.Scene.prototype.addObject=function(a){console.warn("DEPRECATED: Scene.addObject() is now Scene.add()."),this.add(a)},a.Scene.prototype.addLight=function(a){console.warn("DEPRECATED: Scene.addLight() is now Scene.add()."),this.add(a)},a.Scene.prototype.removeChild=function(a){console.warn("DEPRECATED: Scene.removeChild() is now Scene.remove()."),this.remove(a)},a.Scene.prototype.removeObject=function(a){console.warn("DEPRECATED: Scene.removeObject() is now Scene.remove()."),this.remove(a)},a.Scene.prototype.removeLight=function(a){console.warn("DEPRECATED: Scene.removeLight() is now Scene.remove()."),this.remove(a)},a.Fog=function(b,c,d){this.color=new a.Color(b),this.near=c!==void 0?c:1,this.far=d!==void 0?d:1e3},a.FogExp2=function(b,c){this.color=new a.Color(b),this.density=c!==void 0?c:25e-5},a.DOMRenderer=function(){a.Renderer.call(this);var b=null,c=new a.Projector,d,e,f,g;this.domElement=document.createElement("div"),this.setSize=function(a,b){d=a,e=b,f=d/2,g=e/2},this.render=function(d,e){var i,j,l,m,n,o,p,q;b=c.projectScene(d,e),i=0;for(j=b.length;i<j;i++)if(n=b[i],n instanceof a.RenderableParticle){p=n.x*f+f,q=n.y*g+g,l=0;for(m=n.material.length;l<m;l++)if(o=n.material[l],o instanceof a.ParticleDOMMaterial)o=o.domElement,o.style.left=p+"px",o.style.top=q+"px"}}},a.CanvasRenderer=function(b){function c(a){r!=a&&(o.globalAlpha=r=a)}function d(b){if(s!=b){switch(b){case a.NormalBlending:o.globalCompositeOperation="source-over";break;case a.AdditiveBlending:o.globalCompositeOperation="lighter";break;case a.SubtractiveBlending:o.globalCompositeOperation="darker"}s=b}}function e(a){t!=a&&(o.strokeStyle=t=a)}function f(a){u!=a&&(o.fillStyle=u=a)}var g=this,h=null,i=new a.Projector,b=b||{},j=b.canvas!==void 0?b.canvas:document.createElement("canvas"),k,l,m,n,o=j.getContext("2d"),p=new a.Color(0),q=0,r=1,s=0,t=null,u=null,v=null,w=null,x=null,y,z,A,B,C=new a.RenderableVertex,D=new a.RenderableVertex,E,F,G,H,I,J,K,L,M,N,O,P,Q=new a.Color(0),R=new a.Color(0),S=new a.Color(0),T=new a.Color(0),U=new a.Color(0),V=[],W,X,Y,Z,$,_,ba,bb,bc,bd,be=new a.Rectangle,bf=new a.Rectangle,bg=new a.Rectangle,bh=!1,bi=new a.Color,bj=new a.Color,bk=new a.Color,bl=new a.Color,bm=new a.Vector3,bn,bo,bp,bq,br,bs,b=16;bn=document.createElement("canvas"),bn.width=bn.height=2,bo=bn.getContext("2d"),bo.fillStyle="rgba(0,0,0,1)",bo.fillRect(0,0,2,2),bp=bo.getImageData(0,0,2,2),bq=bp.data,br=document.createElement("canvas"),br.width=br.height=b,bs=br.getContext("2d"),bs.translate(-b/2,-b/2),bs.scale(b,b),b--,this.domElement=j,this.sortElements=this.sortObjects=this.autoClear=!0,this.info={render:{vertices:0,faces:0}},this.setSize=function(a,b){k=a,l=b,m=Math.floor(k/2),n=Math.floor(l/2),j.width=k,j.height=l,be.set(-m,-n,m,n),bf.set(-m,-n,m,n),r=1,s=0,x=w=v=u=t=null},this.setClearColor=function(a,b){p.copy(a),q=b,bf.set(-m,-n,m,n)},this.setClearColorHex=function(a,b){p.setHex(a),q=b,bf.set(-m,-n,m,n)},this.clear=function(){o.setTransform(1,0,0,-1,m,n),bf.isEmpty()||(bf.minSelf(be),bf.inflate(2),q<1&&o.clearRect(Math.floor(bf.getX()),Math.floor(bf.getY()),Math.floor(bf.getWidth()),Math.floor(bf.getHeight())),q>0&&(d(a.NormalBlending),c(1),f("rgba("+Math.floor(p.r*255)+","+Math.floor(p.g*255)+","+Math.floor(p.b*255)+","+q+")"),o.fillRect(Math.floor(bf.getX()),Math.floor(bf.getY()),Math.floor(bf.getWidth()),Math.floor(bf.getHeight()))),bf.empty())},this.render=function(b,j){function k(b){var c,d,e,f=b.lights;bj.setRGB(0,0,0),bk.setRGB(0,0,0),bl.setRGB(0,0,0),b=0;for(c=f.length;b<c;b++)d=f[b],e=d.color,d instanceof a.AmbientLight?(bj.r+=e.r,bj.g+=e.g,bj.b+=e.b):d instanceof a.DirectionalLight?(bk.r+=e.r,bk.g+=e.g,bk.b+=e.b):d instanceof a.PointLight&&(bl.r+=e.r,bl.g+=e.g,bl.b+=e.b)}function l(b,c,d,e){var f,g,h,i,j=b.lights,b=0;for(f=j.length;b<f;b++)g=j[b],h=g.color,g instanceof a.DirectionalLight?(i=d.dot(g.position),i<=0||(i*=g.intensity,e.r+=h.r*i,e.g+=h.g*i,e.b+=h.b*i)):g instanceof a.PointLight&&(i=d.dot(bm.sub(g.position,c).normalize()),i<=0||(i*=g.distance==0?1:1-Math.min(c.distanceTo(g.position)/g.distance,1),i!=0&&(i*=g.intensity,e.r+=h.r*i,e.g+=h.g*i,e.b+=h.b*i)))}function p(b,g,h){c(h.opacity),d(h.blending);var i,j,k,l,p,q;h instanceof a.ParticleBasicMaterial?h.map&&(l=h.map.image,p=l.width>>1,q=l.height>>1,h=g.scale.x*m,k=g.scale.y*n,i=h*p,j=k*q,bg.set(b.x-i,b.y-j,b.x+i,b.y+j),be.intersects(bg)&&(o.save(),o.translate(b.x,b.y),o.rotate(-g.rotation),o.scale(h,-k),o.translate(-p,-q),o.drawImage(l,0,0),o.restore())):h instanceof a.ParticleCanvasMaterial&&(i=g.scale.x*m,j=g.scale.y*n,bg.set(b.x-i,b.y-j,b.x+i,b.y+j),be.intersects(bg)&&(e(h.color.getContextStyle()),f(h.color.getContextStyle()),o.save(),o.translate(b.x,b.y),o.rotate(-g.rotation),o.scale(i,j),h.program(o),o.restore()))}function q(b,f,g,h){c(h.opacity),d(h.blending),o.beginPath(),o.moveTo(b.positionScreen.x,b.positionScreen.y),o.lineTo(f.positionScreen.x,f.positionScreen.y),o.closePath(),h instanceof a.LineBasicMaterial&&(b=h.linewidth,v!=b&&(o.lineWidth=v=b),b=h.linecap,w!=b&&(o.lineCap=w=b),b=h.linejoin,x!=b&&(o.lineJoin=x=b),e(h.color.getContextStyle()),o.stroke(),bg.inflate(h.linewidth*2))}function r(b,e,f,h,i,k,m,n,o){g.info.render.vertices+=3,g.info.render.faces++,c(n.opacity),d(n.blending),E=b.positionScreen.x,F=b.positionScreen.y,G=e.positionScreen.x,H=e.positionScreen.y,I=f.positionScreen.x,J=f.positionScreen.y,t(E,F,G,H,I,J),n instanceof a.MeshBasicMaterial?n.map?n.map.mapping instanceof a.UVMapping&&(Z=m.uvs[0],bv(E,F,G,H,I,J,Z[h].u,Z[h].v,Z[i].u,Z[i].v,Z[k].u,Z[k].v,n.map)):n.envMap?n.envMap.mapping instanceof a.SphericalReflectionMapping&&(b=j.matrixWorldInverse,bm.copy(m.vertexNormalsWorld[0]),$=(bm.x*b.n11+bm.y*b.n12+bm.z*b.n13)*.5+.5,_=-(bm.x*b.n21+bm.y*b.n22+bm.z*b.n23)*.5+.5,bm.copy(m.vertexNormalsWorld[1]),ba=(bm.x*b.n11+bm.y*b.n12+bm.z*b.n13)*.5+.5,bb=-(bm.x*b.n21+bm.y*b.n22+bm.z*b.n23)*.5+.5,bm.copy(m.vertexNormalsWorld[2]),bc=(bm.x*b.n11+bm.y*b.n12+bm.z*b.n13)*.5+.5,bd=-(bm.x*b.n21+bm.y*b.n22+bm.z*b.n23)*.5+.5,bv(E,F,G,H,I,J,$,_,ba,bb,bc,bd,n.envMap)):n.wireframe?bt(n.color,n.wireframeLinewidth,n.wireframeLinecap,n.wireframeLinejoin):bu(n.color):n instanceof a.MeshLambertMaterial?(n.map&&!n.wireframe&&(n.map.mapping instanceof a.UVMapping&&(Z=m.uvs[0],bv(E,F,G,H,I,J,Z[h].u,Z[h].v,Z[i].u,Z[i].v,Z[k].u,Z[k].v,n.map)),d(a.SubtractiveBlending)),bh?!n.wireframe&&n.shading==a.SmoothShading&&m.vertexNormalsWorld.length==3?(R.r=S.r=T.r=bj.r,R.g=S.g=T.g=bj.g,R.b=S.b=T.b=bj.b,l(o,m.v1.positionWorld,m.vertexNormalsWorld[0],R),l(o,m.v2.positionWorld,m.vertexNormalsWorld[1],S),l(o,m.v3.positionWorld,m.vertexNormalsWorld[2],T),R.r=Math.max(0,Math.min(n.color.r*R.r,1)),R.g=Math.max(0,Math.min(n.color.g*R.g,1)),R.b=Math.max(0,Math.min(n.color.b*R.b,1)),S.r=Math.max(0,Math.min(n.color.r*S.r,1)),S.g=Math.max(0,Math.min(n.color.g*S.g,1)),S.b=Math.max(0,Math.min(n.color.b*S.b,1)),T.r=Math.max(0,Math.min(n.color.r*T.r,1)),T.g=Math.max(0,Math.min(n.color.g*T.g,1)),T.b=Math.max(0,Math.min(n.color.b*T.b,1)),U.r=(S.r+T.r)*.5,U.g=(S.g+T.g)*.5,U.b=(S.b+T.b)*.5,Y=bx(R,S,T,U),bw(E,F,G,H,I,J,0,0,1,0,0,1,Y)):(bi.r=bj.r,bi.g=bj.g,bi.b=bj.b,l(o,m.centroidWorld,m.normalWorld,bi),Q.r=Math.max(0,Math.min(n.color.r*bi.r,1)),Q.g=Math.max(0,Math.min(n.color.g*bi.g,1)),Q.b=Math.max(0,Math.min(n.color.b*bi.b,1)),n.wireframe?bt(Q,n.wireframeLinewidth,n.wireframeLinecap,n.wireframeLinejoin):bu(Q)):n.wireframe?bt(n.color,n.wireframeLinewidth,n.wireframeLinecap,n.wireframeLinejoin):bu(n.color)):n instanceof a.MeshDepthMaterial?(W=j.near,X=j.far,R.r=R.g=R.b=1-by(b.positionScreen.z,W,X),S.r=S.g=S.b=1-by(e.positionScreen.z,W,X),T.r=T.g=T.b=1-by(f.positionScreen.z,W,X),U.r=(S.r+T.r)*.5,U.g=(S.g+T.g)*.5,U.b=(S.b+T.b)*.5,Y=bx(R,S,T,U),bw(E,F,G,H,I,J,0,0,1,0,0,1,Y)):n instanceof a.MeshNormalMaterial&&(Q.r=bz(m.normalWorld.x),Q.g=bz(m.normalWorld.y),Q.b=bz(m.normalWorld.z),n.wireframe?bt(Q,n.wireframeLinewidth,n.wireframeLinecap,n.wireframeLinejoin):bu(Q))}function s(b,e,f,h,i,k,m,n,o){g.info.render.vertices+=4,g.info.render.faces++,c(n.opacity),d(n.blending),n.map||n.envMap?(r(b,e,h,0,1,3,m,n,o),r(i,f,k,1,2,3,m,n,o)):(E=b.positionScreen.x,F=b.positionScreen.y,G=e.positionScreen.x,H=e.positionScreen.y,I=f.positionScreen.x,J=f.positionScreen.y,K=h.positionScreen.x,L=h.positionScreen.y,M=i.positionScreen.x,N=i.positionScreen.y,O=k.positionScreen.x,P=k.positionScreen.y,n instanceof a.MeshBasicMaterial)?(u(E,F,G,H,I,J,K,L),n.wireframe?bt(n.color,n.wireframeLinewidth,n.wireframeLinecap,n.wireframeLinejoin):bu(n.color)):n instanceof a.MeshLambertMaterial?bh?!n.wireframe&&n.shading==a.SmoothShading&&m.vertexNormalsWorld.length==4?(R.r=S.r=T.r=U.r=bj.r,R.g=S.g=T.g=U.g=bj.g,R.b=S.b=T.b=U.b=bj.b,l(o,m.v1.positionWorld,m.vertexNormalsWorld[0],R),l(o,m.v2.positionWorld,m.vertexNormalsWorld[1],S),l(o,m.v4.positionWorld,m.vertexNormalsWorld[3],T),l(o,m.v3.positionWorld,m.vertexNormalsWorld[2],U),R.r=Math.max(0,Math.min(n.color.r*R.r,1)),R.g=Math.max(0,Math.min(n.color.g*R.g,1)),R.b=Math.max(0,Math.min(n.color.b*R.b,1)),S.r=Math.max(0,Math.min(n.color.r*S.r,1)),S.g=Math.max(0,Math.min(n.color.g*S.g,1)),S.b=Math.max(0,Math.min(n.color.b*S.b,1)),T.r=Math.max(0,Math.min(n.color.r*T.r,1)),T.g=Math.max(0,Math.min(n.color.g*T.g,1)),T.b=Math.max(0,Math.min(n.color.b*T.b,1)),U.r=Math.max(0,Math.min(n.color.r*U.r,1)),U.g=Math.max(0,Math.min(n.color.g*U.g,1)),U.b=Math.max(0,Math.min(n.color.b*U.b,1)),Y=bx(R,S,T,U),t(E,F,G,H,K,L),bw(E,F,G,H,K,L,0,0,1,0,0,1,Y),t(M,N,I,J,O,P),bw(M,N,I,J,O,P,1,0,1,1,0,1,Y)):(bi.r=bj.r,bi.g=bj.g,bi.b=bj.b,l(o,m.centroidWorld,m.normalWorld,bi),Q.r=Math.max(0,Math.min(n.color.r*bi.r,1)),Q.g=Math.max(0,Math.min(n.color.g*bi.g,1)),Q.b=Math.max(0,Math.min(n.color.b*bi.b,1)),u(E,F,G,H,I,J,K,L),n.wireframe?bt(Q,n.wireframeLinewidth,n.wireframeLinecap,n.wireframeLinejoin):bu(Q)):(u(E,F,G,H,I,J,K,L),n.wireframe?bt(n.color,n.wireframeLinewidth,n.wireframeLinecap,n.wireframeLinejoin):bu(n.color)):n instanceof a.MeshNormalMaterial?(Q.r=bz(m.normalWorld.x),Q.g=bz(m.normalWorld.y),Q.b=bz(m.normalWorld.z),u(E,F,G,H,I,J,K,L),n.wireframe?bt(Q,n.wireframeLinewidth,n.wireframeLinecap,n.wireframeLinejoin):bu(Q)):n instanceof a.MeshDepthMaterial&&(W=j.near,X=j.far,R.r=R.g=R.b=1-by(b.positionScreen.z,W,X),S.r=S.g=S.b=1-by(e.positionScreen.z,W,X),T.r=T.g=T.b=1-by(h.positionScreen.z,W,X),U.r=U.g=U.b=1-by(f.positionScreen.z,W,X),Y=bx(R,S,T,U),t(E,F,G,H,K,L),bw(E,F,G,H,K,L,0,0,1,0,0,1,Y),t(M,N,I,J,O,P),bw(M,N,I,J,O,P,1,0,1,1,0,1,Y))}function t(a,b,c,d,e,f){o.beginPath(),o.moveTo(a,b),o.lineTo(c,d),o.lineTo(e,f),o.lineTo(a,b),o.closePath()}function u(a,b,c,d,e,f,g,h){o.beginPath(),o.moveTo(a,b),o.lineTo(c,d),o.lineTo(e,f),o.lineTo(g,h),o.lineTo(a,b),o.closePath()}function bt(a,b,c,d){v!=b&&(o.lineWidth=v=b),w!=c&&(o.lineCap=w=c),x!=d&&(o.lineJoin=x=d),e(a.getContextStyle()),o.stroke(),bg.inflate(b*2)}function bu(a){f(a.getContextStyle()),o.fill()}function bv(b,c,d,e,g,h,i,j,k,l,m,n,p){if(p.image.width!=0){if(p.needsUpdate==1||V[p.id]==void 0){var q=p.wrapS==a.RepeatWrapping,r=p.wrapT==a.RepeatWrapping;V[p.id]=o.createPattern(p.image,q&&r?"repeat":q&&!r?"repeat-x":!q&&r?"repeat-y":"no-repeat"),p.needsUpdate=!1}f(V[p.id]);var q=p.offset.x/p.repeat.x,r=p.offset.y/p.repeat.y,s=(p.image.width-1)*p.repeat.x,p=(p.image.height-1)*p.repeat.y,i=(i+q)*s,j=(j+r)*p,k=(k+q)*s,l=(l+r)*p,m=(m+q)*s,n=(n+r)*p;d-=b,e-=c,g-=b,h-=c,k-=i,l-=j,m-=i,n-=j,q=1/(k*n-m*l),p=(n*d-l*g)*q,l=(n*e-l*h)*q,d=(k*g-m*d)*q,e=(k*h-m*e)*q,b=b-p*i-d*j,c=c-l*i-e*j,o.save(),o.transform(p,l,d,e,b,c),o.fill(),o.restore()}}function bw(a,b,c,d,e,f,g,h,i,j,k,l,m){var n,p;n=m.width-1,p=m.height-1,g*=n,h*=p,i*=n,j*=p,k*=n,l*=p,c-=a,d-=b,e-=a,f-=b,i-=g,j-=h,k-=g,l-=h,p=1/(i*l-k*j),n=(l*c-j*e)*p,j=(l*d-j*f)*p,c=(i*e-k*c)*p,d=(i*f-k*d)*p,a=a-n*g-c*h,b=b-j*g-d*h,o.save(),o.transform(n,j,c,d,a,b),o.clip(),o.drawImage(m,0,0),o.restore()}function bx(a,b,c,d){var e=~~(a.r*255),f=~~(a.g*255),a=~~(a.b*255),g=~~(b.r*255),h=~~(b.g*255),b=~~(b.b*255),i=~~(c.r*255),j=~~(c.g*255),c=~~(c.b*255),k=~~(d.r*255),l=~~(d.g*255),d=~~(d.b*255);return bq[0]=e<0?0:e>255?255:e,bq[1]=f<0?0:f>255?255:f,bq[2]=a<0?0:a>255?255:a,bq[4]=g<0?0:g>255?255:g,bq[5]=h<0?0:h>255?255:h,bq[6]=b<0?0:b>255?255:b,bq[8]=i<0?0:i>255?255:i,bq[9]=j<0?0:j>255?255:j,bq[10]=c<0?0:c>255?255:c,bq[12]=k<0?0:k>255?255:k,bq[13]=l<0?0:l>255?255:l,bq[14]=d<0?0:d>255?255:d,bo.putImageData(bp,0,0),bs.drawImage(bn,0,0),br}function by(a,b,c){return a=(a-b)/(c-b),a*a*(3-2*a)}function bz(a){return a=(a+1)*.5,a<0?0:a>1?1:a}function bA(a,b){var c=b.x-a.x,d=b.y-a.y,e=c*c+d*d;e!=0&&(e=1/Math.sqrt(e),c*=e,d*=e,b.x+=c,b.y+=d,a.x-=c,a.y-=d)}var bB,bC,bD,bE,bF,bG,bH,bI;this.autoClear?this.clear():o.setTransform(1,0,0,-1,m,n),g.info.render.vertices=0,g.info.render.faces=0,h=i.projectScene(b,j,this.sortElements),(bh=b.lights.length>0)&&k(b),bB=0;for(bC=h.length;bB<bC;bB++){bD=h[bB],bg.empty();if(bD instanceof a.RenderableParticle){y=bD,y.x*=m,y.y*=n,bE=0;for(bF=bD.materials.length;bE<bF;)bI=bD.materials[bE++],bI.opacity!=0&&p(y,bD,bI,b)}else if(bD instanceof a.RenderableLine){if(y=bD.v1,z=bD.v2,y.positionScreen.x*=m,y.positionScreen.y*=n,z.positionScreen.x*=m,z.positionScreen.y*=n,bg.addPoint(y.positionScreen.x,y.positionScreen.y),bg.addPoint(z.positionScreen.x,z.positionScreen.y),be.intersects(bg)){bE=0;for(bF=bD.materials.length;bE<bF;)bI=bD.materials[bE++],bI.opacity!=0&&q(y,z,bD,bI,b)}}else if(bD instanceof a.RenderableFace3){if(y=bD.v1,z=bD.v2,A=bD.v3,y.positionScreen.x*=m,y.positionScreen.y*=n,z.positionScreen.x*=m,z.positionScreen.y*=n,A.positionScreen.x*=m,A.positionScreen.y*=n,bD.overdraw&&(bA(y.positionScreen,z.positionScreen),bA(z.positionScreen,A.positionScreen),bA(A.positionScreen,y.positionScreen)),bg.add3Points(y.positionScreen.x,y.positionScreen.y,z.positionScreen.x,z.positionScreen.y,A.positionScreen.x,A.positionScreen.y),be.intersects(bg)){bE=0;for(bF=bD.meshMaterials.length;bE<bF;)if(bI=bD.meshMaterials[bE++],bI instanceof a.MeshFaceMaterial){bG=0;for(bH=bD.faceMaterials.length;bG<bH;)(bI=bD.faceMaterials[bG++])&&bI.opacity!=0&&r(y,z,A,0,1,2,bD,bI,b)}else bI.opacity!=0&&r(y,z,A,0,1,2,bD,bI,b)}}else if(bD instanceof a.RenderableFace4&&(y=bD.v1,z=bD.v2,A=bD.v3,B=bD.v4,y.positionScreen.x*=m,y.positionScreen.y*=n,z.positionScreen.x*=m,z.positionScreen.y*=n,A.positionScreen.x*=m,A.positionScreen.y*=n,B.positionScreen.x*=m,B.positionScreen.y*=n,C.positionScreen.copy(z.positionScreen),D.positionScreen.copy(B.positionScreen),bD.overdraw&&(bA(y.positionScreen,z.positionScreen),bA(z.positionScreen,B.positionScreen),bA(B.positionScreen,y.positionScreen),bA(A.positionScreen,C.positionScreen),bA(A.positionScreen,D.positionScreen)),bg.addPoint(y.positionScreen.x,y.positionScreen.y),bg.addPoint(z.positionScreen.x,z.positionScreen.y),bg.addPoint(A.positionScreen.x,A.positionScreen.y),bg.addPoint(B.positionScreen.x,B.positionScreen.y),be.intersects(bg))){bE=0;for(bF=bD.meshMaterials.length;bE<bF;)if(bI=bD.meshMaterials[bE++],bI instanceof a.MeshFaceMaterial){bG=0;for(bH=bD.faceMaterials.length;bG<bH;)(bI=bD.faceMaterials[bG++])&&bI.opacity!=0&&s(y,z,A,B,C,D,bD,bI,b)}else bI.opacity!=0&&s(y,z,A,B,C,D,bD,bI,b)}bf.addRectangle(bg)}o.setTransform(1,0,0,1,0,0)}},a.SVGRenderer=function(){function b(b,c,d){var e,f,g,h;e=0;for(f=b.lights.length;e<f;e++)g=b.lights[e],g instanceof a.DirectionalLight?(h=c.normalWorld.dot(g.position)*g.intensity,h>0&&(d.r+=g.color.r*h,d.g+=g.color.g*h,d.b+=g.color.b*h)):g instanceof a.PointLight&&(B.sub(g.position,c.centroidWorld),B.normalize(),h=c.normalWorld.dot(B)*g.intensity,h>0&&(d.r+=g.color.r*h,d.g+=g.color.g*h,d.b+=g.color.b*h))}function c(c,d,h,i,k,l){g.info.render.vertices+=3,g.info.render.faces++,E=e(F++),E.setAttribute("d","M "+c.positionScreen.x+" "+c.positionScreen.y+" L "+d.positionScreen.x+" "+d.positionScreen.y+" L "+h.positionScreen.x+","+h.positionScreen.y+"z"),k instanceof a.MeshBasicMaterial?v.copy(k.color):k instanceof a.MeshLambertMaterial?u?(w.r=x.r,w.g=x.g,w.b=x.b,b(l,i,w),v.r=Math.max(0,Math.min(k.color.r*w.r,1)),v.g=Math.max(0,Math.min(k.color.g*w.g,1)),v.b=Math.max(0,Math.min(k.color.b*w.b,1))):v.copy(k.color):k instanceof a.MeshDepthMaterial?(A=1-k.__2near/(k.__farPlusNear-i.z*k.__farMinusNear),v.setRGB(A,A,A)):k instanceof a.MeshNormalMaterial&&v.setRGB(f(i.normalWorld.x),f(i.normalWorld.y),f(i.normalWorld.z)),k.wireframe?E.setAttribute("style","fill: none; stroke: "+v.getContextStyle()+"; stroke-width: "+k.wireframeLinewidth+"; stroke-opacity: "+k.opacity+"; stroke-linecap: "+k.wireframeLinecap+"; stroke-linejoin: "+k.wireframeLinejoin):E.setAttribute("style","fill: "+v.getContextStyle()+"; fill-opacity: "+k.opacity),j.appendChild(E)}function d(c,d,h,i,k,l,m){g.info.render.vertices+=4,g.info.render.faces++,E=e(F++),E.setAttribute("d","M "+c.positionScreen.x+" "+c.positionScreen.y+" L "+d.positionScreen.x+" "+d.positionScreen.y+" L "+h.positionScreen.x+","+h.positionScreen.y+" L "+i.positionScreen.x+","+i.positionScreen.y+"z"),l instanceof a.MeshBasicMaterial?v.copy(l.color):l instanceof a.MeshLambertMaterial?u?(w.r=x.r,w.g=x.g,w.b=x.b,b(m,k,w),v.r=Math.max(0,Math.min(l.color.r*w.r,1)),v.g=Math.max(0,Math.min(l.color.g*w.g,1)),v.b=Math.max(0,Math.min(l.color.b*w.b,1))):v.copy(l.color):l instanceof a.MeshDepthMaterial?(A=1-l.__2near/(l.__farPlusNear-k.z*l.__farMinusNear),v.setRGB(A,A,A)):l instanceof a.MeshNormalMaterial&&v.setRGB(f(k.normalWorld.x),f(k.normalWorld.y),f(k.normalWorld.z)),l.wireframe?E.setAttribute("style","fill: none; stroke: "+v.getContextStyle()+"; stroke-width: "+l.wireframeLinewidth+"; stroke-opacity: "+l.opacity+"; stroke-linecap: "+l.wireframeLinecap+"; stroke-linejoin: "+l.wireframeLinejoin):E.setAttribute("style","fill: "+v.getContextStyle()+"; fill-opacity: "+l.opacity),j.appendChild(E)}function e(a){return C[a]==null&&(C[a]=document.createElementNS("http://www.w3.org/2000/svg","path"),H==0&&C[a].setAttribute("shape-rendering","crispEdges")),C[a]}function f(a){return a=(a+1)*.5,a<0?0:a>1?1:a}var g=this,h=null,i=new a.Projector,j=document.createElementNS("http://www.w3.org/2000/svg","svg"),k,l,m,n,o,p,q,r,s=new a.Rectangle,t=new a.Rectangle,u=!1,v=new a.Color(16777215),w=new a.Color(16777215),x=new a.Color(0),y=new a.Color(0),z=new a.Color(0),A,B=new a.Vector3,C=[],D=[],E,F,G,H=1;this.domElement=j,this.sortElements=this.sortObjects=this.autoClear=!0,this.info={render:{vertices:0,faces:0}},this.setQuality=function(a){switch(a){case"high":H=1;break;case"low":H=0}},this.setSize=function(a,b){k=a,l=b,m=k/2,n=l/2,j.setAttribute("viewBox",-m+" "+ -n+" "+k+" "+l),j.setAttribute("width",k),j.setAttribute("height",l),s.set(-m,-n,m,n)},this.clear=function(){for(;j.childNodes.length>0;)j.removeChild(j.childNodes[0])},this.render=function(b,e){var f,k,l,v,w,A,B,C;this.autoClear&&this.clear(),g.info.render.vertices=0,g.info.render.faces=0,h=i.projectScene(b,e,this.sortElements),G=F=0;if(u=b.lights.length>0){B=b.lights,x.setRGB(0,0,0),y.setRGB(0,0,0),z.setRGB(0,0,0),f=0;for(k=B.length;f<k;f++)l=B[f],v=l.color,l instanceof a.AmbientLight?(x.r+=v.r,x.g+=v.g,x.b+=v.b):l instanceof a.DirectionalLight?(y.r+=v.r,y.g+=v.g,y.b+=v.b):l instanceof a.PointLight&&(z.r+=v.r,z.g+=v.g,z.b+=v.b)}f=0;for(k=h.length;f<k;f++)if(B=h[f],t.empty(),B instanceof a.RenderableParticle){o=B,o.x*=m,o.y*=-n,l=0;for(v=B.materials.length;l<v;)l++}else if(B instanceof a.RenderableLine){if(o=B.v1,p=B.v2,o.positionScreen.x*=m,o.positionScreen.y*=-n,p.positionScreen.x*=m,p.positionScreen.y*=-n,t.addPoint(o.positionScreen.x,o.positionScreen.y),t.addPoint(p.positionScreen.x,p.positionScreen.y),s.intersects(t)){l=0;for(v=B.materials.length;l<v;)if((C=B.materials[l++])&&C.opacity!=0){w=o,A=p;var I=G++;D[I]==null&&(D[I]=document.createElementNS("http://www.w3.org/2000/svg","line"),H==0&&D[I].setAttribute("shape-rendering","crispEdges")),E=D[I],E.setAttribute("x1",w.positionScreen.x),E.setAttribute("y1",w.positionScreen.y),E.setAttribute("x2",A.positionScreen.x),E.setAttribute("y2",A.positionScreen.y),C instanceof a.LineBasicMaterial&&(E.setAttribute("style","fill: none; stroke: "+C.color.getContextStyle()+"; stroke-width: "+C.linewidth+"; stroke-opacity: "+C.opacity+"; stroke-linecap: "+C.linecap+"; stroke-linejoin: "+C.linejoin),j.appendChild(E))}}}else if(B instanceof a.RenderableFace3){if(o=B.v1,p=B.v2,q=B.v3,o.positionScreen.x*=m,o.positionScreen.y*=-n,p.positionScreen.x*=m,p.positionScreen.y*=-n,q.positionScreen.x*=m,q.positionScreen.y*=-n,t.addPoint(o.positionScreen.x,o.positionScreen.y),t.addPoint(p.positionScreen.x,p.positionScreen.y),t.addPoint(q.positionScreen.x,q.positionScreen.y),s.intersects(t)){l=0;for(v=B.meshMaterials.length;l<v;)if(C=B.meshMaterials[l++],C instanceof a.MeshFaceMaterial){w=0;for(A=B.faceMaterials.length;w<A;)(C=B.faceMaterials[w++])&&C.opacity!=0&&c(o,p,q,B,C,b)}else C&&C.opacity!=0&&c(o,p,q,B,C,b)}}else if(B instanceof a.RenderableFace4&&(o=B.v1,p=B.v2,q=B.v3,r=B.v4,o.positionScreen.x*=m,o.positionScreen.y*=-n,p.positionScreen.x*=m,p.positionScreen.y*=-n,q.positionScreen.x*=m,q.positionScreen.y*=-n,r.positionScreen.x*=m,r.positionScreen.y*=-n,t.addPoint(o.positionScreen.x,o.positionScreen.y),t.addPoint(p.positionScreen.x,p.positionScreen.y),t.addPoint(q.positionScreen.x,q.positionScreen.y),t.addPoint(r.positionScreen.x,r.positionScreen.y),s.intersects(t))){l=0;for(v=B.meshMaterials.length;l<v;)if(C=B.meshMaterials[l++],C instanceof a.MeshFaceMaterial){w=0;for(A=B.faceMaterials.length;w<A;)(C=B.faceMaterials[w++])&&C.opacity!=0&&d(o,p,q,r,B,C,b)}else C&&C.opacity!=0&&d(o,p,q,r,B,C,b)}}},a.ShaderChunk={fog_pars_fragment:"#ifdef USE_FOG\nuniform vec3 fogColor;\n#ifdef FOG_EXP2\nuniform float fogDensity;\n#else\nuniform float fogNear;\nuniform float fogFar;\n#endif\n#endif",fog_fragment:"#ifdef USE_FOG\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#ifdef FOG_EXP2\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\n#else\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\n#endif\ngl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\nvarying vec3 vReflect;\nuniform float reflectivity;\nuniform samplerCube envMap;\nuniform int combine;\n#endif",envmap_fragment:"#ifdef USE_ENVMAP\nvec4 cubeColor = textureCube( envMap, vec3( -vReflect.x, vReflect.yz ) );\nif ( combine == 1 ) {\ngl_FragColor = vec4( mix( gl_FragColor.xyz, cubeColor.xyz, reflectivity ), opacity );\n} else {\ngl_FragColor = gl_FragColor * cubeColor;\n}\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\nvarying vec3 vReflect;\nuniform float refractionRatio;\nuniform bool useRefract;\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\nvec4 mPosition = objectMatrix * vec4( position, 1.0 );\nvec3 nWorld = mat3( objectMatrix[ 0 ].xyz, objectMatrix[ 1 ].xyz, objectMatrix[ 2 ].xyz ) * normal;\nif ( useRefract ) {\nvReflect = refract( normalize( mPosition.xyz - cameraPosition ), normalize( nWorld.xyz ), refractionRatio );\n} else {\nvReflect = reflect( normalize( mPosition.xyz - cameraPosition ), normalize( nWorld.xyz ) );\n}\n#endif",map_particle_pars_fragment:"#ifdef USE_MAP\nuniform sampler2D map;\n#endif",map_particle_fragment:"#ifdef USE_MAP\ngl_FragColor = gl_FragColor * texture2D( map, gl_PointCoord );\n#endif",map_pars_vertex:"#ifdef USE_MAP\nvarying vec2 vUv;\nuniform vec4 offsetRepeat;\n#endif",map_pars_fragment:"#ifdef USE_MAP\nvarying vec2 vUv;\nuniform sampler2D map;\n#endif",map_vertex:"#ifdef USE_MAP\nvUv = uv * offsetRepeat.zw + offsetRepeat.xy;\n#endif",map_fragment:"#ifdef USE_MAP\ngl_FragColor = gl_FragColor * texture2D( map, vUv );\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\nvarying vec2 vUv2;\nuniform sampler2D lightMap;\n#endif",lightmap_pars_vertex:"#ifdef USE_LIGHTMAP\nvarying vec2 vUv2;\n#endif",lightmap_fragment:"#ifdef USE_LIGHTMAP\ngl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );\n#endif",lightmap_vertex:"#ifdef USE_LIGHTMAP\nvUv2 = uv2;\n#endif",lights_pars_vertex:"uniform bool enableLighting;\nuniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#endif",lights_vertex:"if ( !enableLighting ) {\nvLightWeighting = vec3( 1.0 );\n} else {\nvLightWeighting = ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nfor( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nfloat directionalLightWeighting = max( dot( transformedNormal, normalize( lDirection.xyz ) ), 0.0 );\nvLightWeighting += directionalLightColor[ i ] * directionalLightWeighting;\n}\n#endif\n#if MAX_POINT_LIGHTS > 0\nfor( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\nfloat pointLightWeighting = max( dot( transformedNormal, lVector ), 0.0 );\nvLightWeighting += pointLightColor[ i ] * pointLightWeighting * lDistance;\n}\n#endif\n}",lights_phong_pars_vertex:"#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\nvarying vec4 vPointLight[ MAX_POINT_LIGHTS ];\n#endif",lights_phong_vertex:"#if MAX_POINT_LIGHTS > 0\nfor( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\nvPointLight[ i ] = vec4( lVector, lDistance );\n}\n#endif",lights_pars_fragment:"uniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nvarying vec4 vPointLight[ MAX_POINT_LIGHTS ];\n#endif\nvarying vec3 vViewPosition;\nvarying vec3 vNormal;",lights_fragment:"vec3 normal = normalize( vNormal );\nvec3 viewPosition = normalize( vViewPosition );\n#if MAX_POINT_LIGHTS > 0\nvec3 pointDiffuse  = vec3( 0.0 );\nvec3 pointSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec3 pointVector = normalize( vPointLight[ i ].xyz );\nvec3 pointHalfVector = normalize( vPointLight[ i ].xyz + viewPosition );\nfloat pointDistance = vPointLight[ i ].w;\nfloat pointDotNormalHalf = dot( normal, pointHalfVector );\nfloat pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );\nfloat pointSpecularWeight = 0.0;\nif ( pointDotNormalHalf >= 0.0 )\npointSpecularWeight = pow( pointDotNormalHalf, shininess );\npointDiffuse  += diffuse * pointLightColor[ i ] * pointDiffuseWeight * pointDistance;\npointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDistance;\n}\n#endif\n#if MAX_DIR_LIGHTS > 0\nvec3 dirDiffuse  = vec3( 0.0 );\nvec3 dirSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\nvec3 dirHalfVector = normalize( lDirection.xyz + viewPosition );\nfloat dirDotNormalHalf = dot( normal, dirHalfVector );\nfloat dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );\nfloat dirSpecularWeight = 0.0;\nif ( dirDotNormalHalf >= 0.0 )\ndirSpecularWeight = pow( dirDotNormalHalf, shininess );\ndirDiffuse  += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;\ndirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight;\n}\n#endif\nvec3 totalDiffuse = vec3( 0.0 );\nvec3 totalSpecular = vec3( 0.0 );\n#if MAX_DIR_LIGHTS > 0\ntotalDiffuse += dirDiffuse;\ntotalSpecular += dirSpecular;\n#endif\n#if MAX_POINT_LIGHTS > 0\ntotalDiffuse += pointDiffuse;\ntotalSpecular += pointSpecular;\n#endif\ngl_FragColor.xyz = gl_FragColor.xyz * totalDiffuse + totalSpecular + ambientLightColor * ambient;",color_pars_fragment:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_fragment:"#ifdef USE_COLOR\ngl_FragColor = gl_FragColor * vec4( vColor, opacity );\n#endif",color_pars_vertex:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\nvColor = color;\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\nuniform mat4 boneGlobalMatrices[ MAX_BONES ];\n#endif",skinning_vertex:"#ifdef USE_SKINNING\ngl_Position  = ( boneGlobalMatrices[ int( skinIndex.x ) ] * skinVertexA ) * skinWeight.x;\ngl_Position += ( boneGlobalMatrices[ int( skinIndex.y ) ] * skinVertexB ) * skinWeight.y;\ngl_Position  = projectionMatrix * viewMatrix * objectMatrix * gl_Position;\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\nuniform float morphTargetInfluences[ 8 ];\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\nvec3 morphed = vec3( 0.0, 0.0, 0.0 );\nmorphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\nmorphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\nmorphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\nmorphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\nmorphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\nmorphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\nmorphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\nmorphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\nmorphed += position;\ngl_Position = projectionMatrix * modelViewMatrix * vec4( morphed, 1.0 );\n#endif",default_vertex:"#ifndef USE_MORPHTARGETS\n#ifndef USE_SKINNING\ngl_Position = projectionMatrix * mvPosition;\n#endif\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\nuniform sampler2D shadowMap[ MAX_SHADOWS ];\nuniform float shadowDarkness;\nuniform float shadowBias;\nvarying vec4 vShadowCoord[ MAX_SHADOWS ];\nfloat unpackDepth( const in vec4 rgba_depth ) {\nconst vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );\nfloat depth = dot( rgba_depth, bit_shift );\nreturn depth;\n}\n#endif",shadowmap_fragment:"#ifdef USE_SHADOWMAP\n#ifdef SHADOWMAP_SOFT\nconst float xPixelOffset = 1.0 / SHADOWMAP_WIDTH;\nconst float yPixelOffset = 1.0 / SHADOWMAP_HEIGHT;\n#endif\nvec4 shadowColor = vec4( 1.0 );\nfor( int i = 0; i < MAX_SHADOWS; i ++ ) {\nvec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;\nshadowCoord.z += shadowBias;\nif ( shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0 ) {\n#ifdef SHADOWMAP_SOFT\nfloat shadow = 0.0;\nfor ( float y = -1.25; y <= 1.25; y += 1.25 )\nfor ( float x = -1.25; x <= 1.25; x += 1.25 ) {\nvec4 rgbaDepth = texture2D( shadowMap[ i ], vec2( x * xPixelOffset, y * yPixelOffset ) + shadowCoord.xy );\nfloat fDepth = unpackDepth( rgbaDepth );\nif ( fDepth < shadowCoord.z )\nshadow += 1.0;\n}\nshadow /= 9.0;\nshadowColor = shadowColor * vec4( vec3( ( 1.0 - shadowDarkness * shadow ) ), 1.0 );\n#else\nvec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );\nfloat fDepth = unpackDepth( rgbaDepth );\nif ( fDepth < shadowCoord.z )\nshadowColor = shadowColor * vec4( vec3( shadowDarkness ), 1.0 );\n#endif\n}\n}\ngl_FragColor = gl_FragColor * shadowColor;\n#endif",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\nvarying vec4 vShadowCoord[ MAX_SHADOWS ];\nuniform mat4 shadowMatrix[ MAX_SHADOWS ];\n#endif",shadowmap_vertex:"#ifdef USE_SHADOWMAP\nfor( int i = 0; i < MAX_SHADOWS; i ++ ) {\nvShadowCoord[ i ] = shadowMatrix[ i ] * objectMatrix * vec4( position, 1.0 );\n}\n#endif",alphatest_fragment:"#ifdef ALPHATEST\nif ( gl_FragColor.a < ALPHATEST ) discard;\n#endif"},a.UniformsUtils={merge:function(a){var b,c,d,e={};for(b=0;b<a.length;b++)for(c in d=this.clone(a[b]),d)e[c]=d[c];return e},clone:function(b){var c,d,e,f={};for(c in b)for(d in f[c]={},b[c])e=b[c][d],f[c][d]=e instanceof a.Color||e instanceof a.Vector2||e instanceof a.Vector3||e instanceof a.Vector4||e instanceof a.Matrix4||e instanceof a.Texture?e.clone():e instanceof Array?e.slice():e;return f}},a.UniformsLib={common:{diffuse:{type:"c",value:new a.Color(15658734)},opacity:{type:"f",value:1},map:{type:"t",value:0,texture:null},offsetRepeat:{type:"v4",value:new a.Vector4(0,0,1,1)},lightMap:{type:"t",value:2,texture:null},envMap:{type:"t",value:1,texture:null},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0}},fog:{fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new a.Color(16777215)}},lights:{enableLighting:{type:"i",value:1},ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]}},particle:{psColor:{type:"c",value:new a.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:0,texture:null},fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new a.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:6,texture:[]},shadowMatrix:{type:"m4v",value:[]},shadowBias:{type:"f",value:.0039},shadowDarkness:{type:"f",value:.2}}},a.ShaderLib={sprite:{vertexShader:"uniform int useScreenCoordinates;\nuniform int affectedByDistance;\nuniform vec3 screenPosition;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform float rotation;\nuniform vec2 scale;\nuniform vec2 alignment;\nuniform vec2 uvOffset;\nuniform vec2 uvScale;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvoid main() {\nvUV = uvOffset + uv * uvScale;\nvec2 alignedPosition = position + alignment;\nvec2 rotatedPosition;\nrotatedPosition.x = ( cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y ) * scale.x;\nrotatedPosition.y = ( sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y ) * scale.y;\nvec4 finalPosition;\nif( useScreenCoordinates != 0 ) {\nfinalPosition = vec4( screenPosition.xy + rotatedPosition, screenPosition.z, 1.0 );\n} else {\nfinalPosition = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\nfinalPosition.xy += rotatedPosition * ( affectedByDistance == 1 ? 1.0 : finalPosition.z );\n}\ngl_Position = finalPosition;\n}",fragmentShader:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 color;\nuniform sampler2D map;\nuniform float opacity;\nvarying vec2 vUV;\nvoid main() {\nvec4 texture = texture2D( map, vUV );\ngl_FragColor = vec4( color * texture.xyz, texture.a * opacity );\n}"},depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2e3},opacity:{type:"f",value:1}},vertexShader:"void main() {\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform float mNear;\nuniform float mFar;\nuniform float opacity;\nvoid main() {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat color = 1.0 - smoothstep( mNear, mFar, depth );\ngl_FragColor = vec4( vec3( color ), opacity );\n}"},normal:{uniforms:{opacity:{type:"f",value:1}},vertexShader:"varying vec3 vNormal;\nvoid main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvNormal = normalize( normalMatrix * normal );\ngl_Position = projectionMatrix * mvPosition;\n}",fragmentShader:"uniform float opacity;\nvarying vec3 vNormal;\nvoid main() {\ngl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, opacity );\n}"},basic:{uniforms:a.UniformsUtils.merge([a.UniformsLib.common,a.UniformsLib.fog,a.UniformsLib.shadowmap]),vertexShader:[a.ShaderChunk.map_pars_vertex,a.ShaderChunk.lightmap_pars_vertex,a.ShaderChunk.envmap_pars_vertex,a.ShaderChunk.color_pars_vertex,a.ShaderChunk.skinning_pars_vertex,a.ShaderChunk.morphtarget_pars_vertex,a.ShaderChunk.shadowmap_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",a.ShaderChunk.map_vertex,a.ShaderChunk.lightmap_vertex,a.ShaderChunk.envmap_vertex,a.ShaderChunk.color_vertex,a.ShaderChunk.skinning_vertex,a.ShaderChunk.morphtarget_vertex,a.ShaderChunk.default_vertex,a.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;",a.ShaderChunk.color_pars_fragment,a.ShaderChunk.map_pars_fragment,a.ShaderChunk.lightmap_pars_fragment,a.ShaderChunk.envmap_pars_fragment,a.ShaderChunk.fog_pars_fragment,a.ShaderChunk.shadowmap_pars_fragment,"void main() {\ngl_FragColor = vec4( diffuse, opacity );",a.ShaderChunk.map_fragment,a.ShaderChunk.alphatest_fragment,a.ShaderChunk.lightmap_fragment,a.ShaderChunk.color_fragment,a.ShaderChunk.envmap_fragment,a.ShaderChunk.shadowmap_fragment,a.ShaderChunk.fog_fragment,"}"].join("\n")},lambert:{uniforms:a.UniformsUtils.merge([a.UniformsLib.common,a.UniformsLib.fog,a.UniformsLib.lights,a.UniformsLib.shadowmap]),vertexShader:["varying vec3 vLightWeighting;",a.ShaderChunk.map_pars_vertex,a.ShaderChunk.lightmap_pars_vertex,a.ShaderChunk.envmap_pars_vertex,a.ShaderChunk.lights_pars_vertex,a.ShaderChunk.color_pars_vertex,a.ShaderChunk.skinning_pars_vertex,a.ShaderChunk.morphtarget_pars_vertex,a.ShaderChunk.shadowmap_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",a.ShaderChunk.map_vertex,a.ShaderChunk.lightmap_vertex,a.ShaderChunk.envmap_vertex,a.ShaderChunk.color_vertex,"vec3 transformedNormal = normalize( normalMatrix * normal );",a.ShaderChunk.lights_vertex,a.ShaderChunk.skinning_vertex,a.ShaderChunk.morphtarget_vertex,a.ShaderChunk.default_vertex,a.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;\nvarying vec3 vLightWeighting;",a.ShaderChunk.color_pars_fragment,a.ShaderChunk.map_pars_fragment,a.ShaderChunk.lightmap_pars_fragment,a.ShaderChunk.envmap_pars_fragment,a.ShaderChunk.fog_pars_fragment,a.ShaderChunk.shadowmap_pars_fragment,"void main() {\ngl_FragColor = vec4( diffuse, opacity );",a.ShaderChunk.map_fragment,a.ShaderChunk.alphatest_fragment,"gl_FragColor = gl_FragColor * vec4( vLightWeighting, 1.0 );",a.ShaderChunk.lightmap_fragment,a.ShaderChunk.color_fragment,a.ShaderChunk.envmap_fragment,a.ShaderChunk.shadowmap_fragment,a.ShaderChunk.fog_fragment,"}"].join("\n")},phong:{uniforms:a.UniformsUtils.merge([a.UniformsLib.common,a.UniformsLib.fog,a.UniformsLib.lights,a.UniformsLib.shadowmap,{ambient:{type:"c",value:new a.Color(328965)},specular:{type:"c",value:new a.Color(1118481)},shininess:{type:"f",value:30}}]),vertexShader:["varying vec3 vViewPosition;\nvarying vec3 vNormal;",a.ShaderChunk.map_pars_vertex,a.ShaderChunk.lightmap_pars_vertex,a.ShaderChunk.envmap_pars_vertex,a.ShaderChunk.lights_phong_pars_vertex,a.ShaderChunk.color_pars_vertex,a.ShaderChunk.skinning_pars_vertex,a.ShaderChunk.morphtarget_pars_vertex,a.ShaderChunk.shadowmap_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",a.ShaderChunk.map_vertex,a.ShaderChunk.lightmap_vertex,a.ShaderChunk.envmap_vertex,a.ShaderChunk.color_vertex,"#ifndef USE_ENVMAP\nvec4 mPosition = objectMatrix * vec4( position, 1.0 );\n#endif\nvViewPosition = -mvPosition.xyz;\nvec3 transformedNormal = normalize( normalMatrix * normal );\nvNormal = transformedNormal;",a.ShaderChunk.lights_phong_vertex,a.ShaderChunk.skinning_vertex,a.ShaderChunk.morphtarget_vertex,a.ShaderChunk.default_vertex,a.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;\nuniform vec3 ambient;\nuniform vec3 specular;\nuniform float shininess;",a.ShaderChunk.color_pars_fragment,a.ShaderChunk.map_pars_fragment,a.ShaderChunk.lightmap_pars_fragment,a.ShaderChunk.envmap_pars_fragment,a.ShaderChunk.fog_pars_fragment,a.ShaderChunk.lights_pars_fragment,a.ShaderChunk.shadowmap_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3 ( 1.0 ), opacity );",a.ShaderChunk.map_fragment,a.ShaderChunk.alphatest_fragment,a.ShaderChunk.lights_fragment,a.ShaderChunk.lightmap_fragment,a.ShaderChunk.color_fragment,a.ShaderChunk.envmap_fragment,a.ShaderChunk.shadowmap_fragment,a.ShaderChunk.fog_fragment,"}"].join("\n")},particle_basic:{uniforms:a.UniformsUtils.merge([a.UniformsLib.particle,a.UniformsLib.shadowmap]),vertexShader:["uniform float size;\nuniform float scale;",a.ShaderChunk.color_pars_vertex,a.ShaderChunk.shadowmap_pars_vertex,"void main() {",a.ShaderChunk.color_vertex,"vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n#ifdef USE_SIZEATTENUATION\ngl_PointSize = size * ( scale / length( mvPosition.xyz ) );\n#else\ngl_PointSize = size;\n#endif\ngl_Position = projectionMatrix * mvPosition;",a.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 psColor;\nuniform float opacity;",a.ShaderChunk.color_pars_fragment,a.ShaderChunk.map_particle_pars_fragment,a.ShaderChunk.fog_pars_fragment,a.ShaderChunk.shadowmap_pars_fragment,"void main() {\ngl_FragColor = vec4( psColor, opacity );",a.ShaderChunk.map_particle_fragment,a.ShaderChunk.alphatest_fragment,a.ShaderChunk.color_fragment,a.ShaderChunk.shadowmap_fragment,a.ShaderChunk.fog_fragment,"}"].join("\n")},depthRGBA:{uniforms:{},vertexShader:[a.ShaderChunk.morphtarget_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",a.ShaderChunk.morphtarget_vertex,a.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:"vec4 pack_depth( const in float depth ) {\nconst vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );\nconst vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );\nvec4 res = fract( depth * bit_shift );\nres -= res.xxyz * bit_mask;\nreturn res;\n}\nvoid main() {\ngl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );\n}"}},a.WebGLRenderer=function(b){function c(a,b,c){var d,e,f,g=a.vertices,h=g.length,i=a.colors,j=i.length,k=a.__vertexArray,l=a.__colorArray,m=a.__sortArray,n=a.__dirtyVertices,o=a.__dirtyColors,p=a.__webglCustomAttributes,q,r;if(p)for(q in p)p[q].offset=0;if(c.sortParticles){bb.multiplySelf(c.matrixWorld);for(d=0;d<h;d++)e=g[d].position,be.copy(e),bb.multiplyVector3(be),m[d]=[be.z,d];m.sort(function(a,b){return b[0]-a[0]});for(d=0;d<h;d++)e=g[m[d][1]].position,f=d*3,k[f]=e.x,k[f+1]=e.y,k[f+2]=e.z;for(d=0;d<j;d++)f=d*3,color=i[m[d][1]],l[f]=color.r,l[f+1]=color.g,l[f+2]=color.b;if(p)for(q in p){d=p[q],i=d.value.length;for(f=0;f<i;f++){index=m[f][1],j=d.offset;if(d.size===1){if(d.boundTo===void 0||d.boundTo==="vertices")d.array[j]=d.value[index]}else{if(d.boundTo===void 0||d.boundTo==="vertices")r=d.value[index];d.size===2?(d.array[j]=r.x,d.array[j+1]=r.y):d.size===3?d.type==="c"?(d.array[j]=r.r,d.array[j+1]=r.g,d.array[j+2]=r.b):(d.array[j]=r.x,d.array[j+1]=r.y,d.array[j+2]=r.z):(d.array[j]=r.x,d.array[j+1]=r.y,d.array[j+2]=r.z,d.array[j+3]=r.w)}d.offset+=d.size}}}else{if(n)for(d=0;d<h;d++)e=g[d].position,f=d*3,k[f]=e.x,k[f+1]=e.y,k[f+2]=e.z;if(o)for(d=0;d<j;d++)color=i[d],f=d*3,l[f]=color.r,l[f+1]=color.g,l[f+2]=color.b;if(p)for(q in p)if(d=p[q],d.__original.needsUpdate){i=d.value.length;for(f=0;f<i;f++){j=d.offset;if(d.size===1){if(d.boundTo===void 0||d.boundTo==="vertices")d.array[j]=d.value[f]}else{if(d.boundTo===void 0||d.boundTo==="vertices")r=d.value[f];d.size===2?(d.array[j]=r.x,d.array[j+1]=r.y):d.size===3?d.type==="c"?(d.array[j]=r.r,d.array[j+1]=r.g,d.array[j+2]=r.b):(d.array[j]=r.x,d.array[j+1]=r.y,d.array[j+2]=r.z):(d.array[j]=r.x,d.array[j+1]=r.y,d.array[j+2]=r.z,d.array[j+3]=r.w)}d.offset+=d.size}}}if(n||c.sortParticles)J.bindBuffer(J.ARRAY_BUFFER,a.__webglVertexBuffer),J.bufferData(J.ARRAY_BUFFER,k,b);if(o||c.sortParticles)J.bindBuffer(J.ARRAY_BUFFER,a.__webglColorBuffer),J.bufferData(J.ARRAY_BUFFER,l,b);if(p)for(q in p)if(d=p[q],d.__original.needsUpdate||c.sortParticles)J.bindBuffer(J.ARRAY_BUFFER,d.buffer),J.bufferData(J.ARRAY_BUFFER,d.array,b)}function d(b,c,d,e,f){e.program||I.initMaterial(e,c,d,f);if(e.morphTargets&&!f.__webglMorphTargetInfluences){f.__webglMorphTargetInfluences=new Float32Array(I.maxMorphTargets);for(var g=0,h=I.maxMorphTargets;g<h;g++)f.__webglMorphTargetInfluences[g]=0}var i=!1,g=e.program,h=g.uniforms,j=e.uniforms;g!=L&&(J.useProgram(g),L=g,i=!0),e.id!=N&&(N=e.id,i=!0);if(i){J.uniformMatrix4fv(h.projectionMatrix,!1,bc),d&&e.fog&&((j.fogColor.value=d.color,d instanceof a.Fog)?(j.fogNear.value=d.near,j.fogFar.value=d.far):d instanceof a.FogExp2&&(j.fogDensity.value=d.density));if(e instanceof a.MeshPhongMaterial||e instanceof a.MeshLambertMaterial||e.lights){for(var k,l,m=0,n=0,o=0,p,q,r,s=bf,t=s.directional.colors,u=s.directional.positions,v=s.point.colors,w=s.point.positions,x=s.point.distances,y=0,z=0,d=k=r=0,i=c.length;d<i;d++)(k=c[d],l=k.color,p=k.position,q=k.intensity,r=k.distance,k instanceof a.AmbientLight)?(m+=l.r,n+=l.g,o+=l.b):k instanceof a.DirectionalLight?(r=y*3,t[r]=l.r*q,t[r+1]=l.g*q,t[r+2]=l.b*q,u[r]=p.x,u[r+1]=p.y,u[r+2]=p.z,y+=1):k instanceof a.SpotLight?(r=y*3,t[r]=l.r*q,t[r+1]=l.g*q,t[r+2]=l.b*q,l=1/p.length(),u[r]=p.x*l,u[r+1]=p.y*l,u[r+2]=p.z*l,y+=1):k instanceof a.PointLight&&(k=z*3,v[k]=l.r*q,v[k+1]=l.g*q,v[k+2]=l.b*q,w[k]=p.x,w[k+1]=p.y,w[k+2]=p.z,x[z]=r,z+=1);d=y*3;for(i=t.length;d<i;d++)t[d]=0;d=z*3;for(i=v.length;d<i;d++)v[d]=0;s.point.length=z,s.directional.length=y,s.ambient[0]=m,s.ambient[1]=n,s.ambient[2]=o,c=bf,j.enableLighting.value=c.directional.length+c.point.length,j.ambientLightColor.value=c.ambient,j.directionalLightColor.value=c.directional.colors,j.directionalLightDirection.value=c.directional.positions,j.pointLightColor.value=c.point.colors,j.pointLightPosition.value=c.point.positions,j.pointLightDistance.value=c.point.distances}if(e instanceof a.MeshBasicMaterial||e instanceof a.MeshLambertMaterial||e instanceof a.MeshPhongMaterial)j.diffuse.value=e.color,j.opacity.value=e.opacity,(j.map.texture=e.map)&&j.offsetRepeat.value.set(e.map.offset.x,e.map.offset.y,e.map.repeat.x,e.map.repeat.y),j.lightMap.texture=e.lightMap,j.envMap.texture=e.envMap,j.reflectivity.value=e.reflectivity,j.refractionRatio.value=e.refractionRatio,j.combine.value=e.combine,j.useRefract.value=e.envMap&&e.envMap.mapping instanceof a.CubeRefractionMapping;e instanceof a.LineBasicMaterial?(j.diffuse.value=e.color,j.opacity.value=e.opacity):e instanceof a.ParticleBasicMaterial?(j.psColor.value=e.color,j.opacity.value=e.opacity,j.size.value=e.size,j.scale.value=bg.height/2,j.map.texture=e.map):e instanceof a.MeshPhongMaterial?(j.ambient.value=e.ambient,j.specular.value=e.specular,j.shininess.value=e.shininess):e instanceof a.MeshDepthMaterial?(j.mNear.value=b.near,j.mFar.value=b.far,j.opacity.value=e.opacity):e instanceof a.MeshNormalMaterial&&(j.opacity.value=e.opacity);if(f.receiveShadow&&!e._shadowPass&&j.shadowMatrix){for(c=0;c<bo.length;c++)j.shadowMatrix.value[c]=bo[c],j.shadowMap.texture[c]=I.shadowMap[c];j.shadowDarkness.value=I.shadowMapDarkness,j.shadowBias.value=I.shadowMapBias}c=e.uniformsList,j=0;for(d=c.length;j<d;j++)if(n=g.uniforms[c[j][1]])if(m=c[j][0],o=m.type,i=m.value,o=="i")J.uniform1i(n,i);else if(o=="f")J.uniform1f(n,i);else if(o=="v2")J.uniform2f(n,i.x,i.y);else if(o=="v3")J.uniform3f(n,i.x,i.y,i.z);else if(o=="v4")J.uniform4f(n,i.x,i.y,i.z,i.w);else if(o=="c")J.uniform3f(n,i.r,i.g,i.b);else if(o=="fv1")J.uniform1fv(n,i);else if(o=="fv")J.uniform3fv(n,i);else if(o=="v3v"){m._array||(m._array=new Float32Array(3*i.length)),o=0;for(p=i.length;o<p;o++)s=o*3,m._array[s]=i[o].x,m._array[s+1]=i[o].y,m._array[s+2]=i[o].z;J.uniform3fv(n,m._array)}else if(o=="m4")m._array||(m._array=new Float32Array(16)),i.flattenToArray(m._array),J.uniformMatrix4fv(n,!1,m._array);else if(o=="m4v"){m._array||(m._array=new Float32Array(16*i.length)),o=0;for(p=i.length;o<p;o++)i[o].flattenToArrayOffset(m._array,o*16);J.uniformMatrix4fv(n,!1,m._array)}else if(o=="t"){if(J.uniform1i(n,i),n=m.texture)if(n.image instanceof Array&&n.image.length==6){if(m=n,m.image.length==6)if(m.needsUpdate){m.image.__webglTextureCube||(m.image.__webglTextureCube=J.createTexture()),J.activeTexture(J.TEXTURE0+i),J.bindTexture(J.TEXTURE_CUBE_MAP,m.image.__webglTextureCube);for(i=0;i<6;i++)J.texImage2D(J.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,J.RGBA,J.RGBA,J.UNSIGNED_BYTE,m.image[i]);B(J.TEXTURE_CUBE_MAP,m,m.image[0]),m.needsUpdate=!1}else J.activeTexture(J.TEXTURE0+i),J.bindTexture(J.TEXTURE_CUBE_MAP,m.image.__webglTextureCube)}else n instanceof a.WebGLRenderTargetCube?(m=n,J.activeTexture(J.TEXTURE0+i),J.bindTexture(J.TEXTURE_CUBE_MAP,m.__webglTexture)):C(n,i)}else if(o=="tv"){if(!m._array){m._array=[],o=0;for(p=m.texture.length;o<p;o++)m._array[o]=i+o}J.uniform1iv(n,m._array),o=0;for(p=m.texture.length;o<p;o++)(n=m.texture[o])&&C(n,m._array[o])}(e instanceof a.ShaderMaterial||e instanceof a.MeshPhongMaterial||e.envMap)&&h.cameraPosition!==null&&J.uniform3f(h.cameraPosition,b.position.x,b.position.y,b.position.z),(e instanceof a.MeshPhongMaterial||e instanceof a.MeshLambertMaterial||e instanceof a.ShaderMaterial||e.skinning)&&h.viewMatrix!==null&&J.uniformMatrix4fv(h.viewMatrix,!1,bd),e.skinning&&(J.uniformMatrix4fv(h.cameraInverseMatrix,!1,bd),J.uniformMatrix4fv(h.boneGlobalMatrices,!1,f.boneMatrices))}return J.uniformMatrix4fv(h.modelViewMatrix,!1,f._modelViewMatrixArray),h.normalMatrix&&J.uniformMatrix3fv(h.normalMatrix,!1,f._normalMatrixArray),(e instanceof a.ShaderMaterial||e.envMap||e.skinning||f.receiveShadow)&&h.objectMatrix!==null&&J.uniformMatrix4fv(h.objectMatrix,!1,f._objectMatrixArray),g}function e(b,c,e,f,g,h){if(f.opacity!=0){var i,e=d(b,c,e,f,h),b=e.attributes,c=!1,e=g.id*16777215+e.id;e!=O&&(O=e,c=!0);if(!f.morphTargets&&b.position>=0)c&&(J.bindBuffer(J.ARRAY_BUFFER,g.__webglVertexBuffer),J.vertexAttribPointer(b.position,3,J.FLOAT,!1,0,0));else if(h.morphTargetBase){e=f.program.attributes,h.morphTargetBase!==-1?(J.bindBuffer(J.ARRAY_BUFFER,g.__webglMorphTargetsBuffers[h.morphTargetBase]),J.vertexAttribPointer(e.position,3,J.FLOAT,!1,0,0)):e.position>=0&&(J.bindBuffer(J.ARRAY_BUFFER,g.__webglVertexBuffer),J.vertexAttribPointer(e.position,3,J.FLOAT,!1,0,0));if(h.morphTargetForcedOrder.length)for(var j=0,k=h.morphTargetForcedOrder,l=h.morphTargetInfluences;j<f.numSupportedMorphTargets&&j<k.length;)J.bindBuffer(J.ARRAY_BUFFER,g.__webglMorphTargetsBuffers[k[j]]),J.vertexAttribPointer(e["morphTarget"+j],3,J.FLOAT,!1,0,0),h.__webglMorphTargetInfluences[j]=l[k[j]],j++;else{var k=[],m=-1,n=0,l=h.morphTargetInfluences,o,p=l.length,j=0;for(h.morphTargetBase!==-1&&(k[h.morphTargetBase]=!0);j<f.numSupportedMorphTargets;){for(o=0;o<p;o++)!k[o]&&l[o]>m&&(n=o,m=l[n]);J.bindBuffer(J.ARRAY_BUFFER,g.__webglMorphTargetsBuffers[n]),J.vertexAttribPointer(e["morphTarget"+j],3,J.FLOAT,!1,0,0),h.__webglMorphTargetInfluences[j]=m,k[n]=1,m=-1,j++}}f.program.uniforms.morphTargetInfluences!==null&&J.uniform1fv(f.program.uniforms.morphTargetInfluences,h.__webglMorphTargetInfluences)}if(c){if(g.__webglCustomAttributes)for(i in g.__webglCustomAttributes)b[i]>=0&&(e=g.__webglCustomAttributes[i],J.bindBuffer(J.ARRAY_BUFFER,e.buffer),J.vertexAttribPointer(b[i],e.size,J.FLOAT,!1,0,0));b.color>=0&&(J.bindBuffer(J.ARRAY_BUFFER,g.__webglColorBuffer),J.vertexAttribPointer(b.color,3,J.FLOAT,!1,0,0)),b.normal>=0&&(J.bindBuffer(J.ARRAY_BUFFER,g.__webglNormalBuffer),J.vertexAttribPointer(b.normal,3,J.FLOAT,!1,0,0)),b.tangent>=0&&(J.bindBuffer(J.ARRAY_BUFFER,g.__webglTangentBuffer),J.vertexAttribPointer(b.tangent,4,J.FLOAT,!1,0,0)),b.uv>=0&&(g.__webglUVBuffer?(J.bindBuffer(J.ARRAY_BUFFER,g.__webglUVBuffer),J.vertexAttribPointer(b.uv,2,J.FLOAT,!1,0,0),J.enableVertexAttribArray(b.uv)):J.disableVertexAttribArray(b.uv)),b.uv2>=0&&(g.__webglUV2Buffer?(J.bindBuffer(J.ARRAY_BUFFER,g.__webglUV2Buffer),J.vertexAttribPointer(b.uv2,2,J.FLOAT,!1,0,0),J.enableVertexAttribArray(b.uv2)):J.disableVertexAttribArray(b.uv2)),f.skinning&&b.skinVertexA>=0&&b.skinVertexB>=0&&b.skinIndex>=0&&b.skinWeight>=0&&(J.bindBuffer(J.ARRAY_BUFFER,g.__webglSkinVertexABuffer),J.vertexAttribPointer(b.skinVertexA,4,J.FLOAT,!1,0,0),J.bindBuffer(J.ARRAY_BUFFER,g.__webglSkinVertexBBuffer),J.vertexAttribPointer(b.skinVertexB,4,J.FLOAT,!1,0,0),J.bindBuffer(J.ARRAY_BUFFER,g.__webglSkinIndicesBuffer),J.vertexAttribPointer(b.skinIndex,4,J.FLOAT,!1,0,0),J.bindBuffer(J.ARRAY_BUFFER,g.__webglSkinWeightsBuffer),J.vertexAttribPointer(b.skinWeight,4,J.FLOAT,!1,0,0))}h instanceof a.Mesh?(f.wireframe?(J.lineWidth(f.wireframeLinewidth),c&&J.bindBuffer(J.ELEMENT_ARRAY_BUFFER,g.__webglLineBuffer),J.drawElements(J.LINES,g.__webglLineCount,J.UNSIGNED_SHORT,0)):(c&&J.bindBuffer(J.ELEMENT_ARRAY_BUFFER,g.__webglFaceBuffer),J.drawElements(J.TRIANGLES,g.__webglFaceCount,J.UNSIGNED_SHORT,0)),I.info.render.calls++,I.info.render.vertices+=g.__webglFaceCount,I.info.render.faces+=g.__webglFaceCount/3):h instanceof a.Line?(h=h.type==a.LineStrip?J.LINE_STRIP:J.LINES,J.lineWidth(f.linewidth),J.drawArrays(h,0,g.__webglLineCount),I.info.render.calls++):h instanceof a.ParticleSystem?(J.drawArrays(J.POINTS,0,g.__webglParticleCount),I.info.render.calls++):h instanceof a.Ribbon&&(J.drawArrays(J.TRIANGLE_STRIP,0,g.__webglVertexCount),I.info.render.calls++)}}function f(b,c,d){b.__webglVertexBuffer||(b.__webglVertexBuffer=J.createBuffer()),b.__webglNormalBuffer||(b.__webglNormalBuffer=J.createBuffer()),b.hasPos&&(J.bindBuffer(J.ARRAY_BUFFER,b.__webglVertexBuffer),J.bufferData(J.ARRAY_BUFFER,b.positionArray,J.DYNAMIC_DRAW),J.enableVertexAttribArray(c.attributes.position),J.vertexAttribPointer(c.attributes.position,3,J.FLOAT,!1,0,0));if(b.hasNormal){J.bindBuffer(J.ARRAY_BUFFER,b.__webglNormalBuffer);if(d==a.FlatShading){var e,f,g,h,i,j,k,l,m,n,o=b.count*3;for(n=0;n<o;n+=9)d=b.normalArray,e=d[n],f=d[n+1],g=d[n+2],h=d[n+3],j=d[n+4],l=d[n+5],i=d[n+6],k=d[n+7],m=d[n+8],e=(e+h+i)/3,f=(f+j+k)/3,g=(g+l+m)/3,d[n]=e,d[n+1]=f,d[n+2]=g,d[n+3]=e,d[n+4]=f,d[n+5]=g,d[n+6]=e,d[n+7]=f,d[n+8]=g}J.bufferData(J.ARRAY_BUFFER,b.normalArray,J.DYNAMIC_DRAW),J.enableVertexAttribArray(c.attributes.normal),J.vertexAttribPointer(c.attributes.normal,3,J.FLOAT,!1,0,0)}J.drawArrays(J.TRIANGLES,0,b.count),b.count=0}function h(a){Q!=a.doubleSided&&(a.doubleSided?J.disable(J.CULL_FACE):J.enable(J.CULL_FACE),Q=a.doubleSided),R!=a.flipSided&&(a.flipSided?J.frontFace(J.CW):J.frontFace(J.CCW),R=a.flipSided)}function i(a){T!=a&&(a?J.enable(J.DEPTH_TEST):J.disable(J.DEPTH_TEST),T=a)}function j(a){U!=a&&(J.depthMask(a),U=a)}function k(a,b,c){V!=a&&(a?J.enable(J.POLYGON_OFFSET_FILL):J.disable(J.POLYGON_OFFSET_FILL),V=a),a&&(W!=b||X!=c)&&(J.polygonOffset(b,c),W=b,X=c)}function m(a){ba[0].set(a.n41-a.n11,a.n42-a.n12,a.n43-a.n13,a.n44-a.n14),ba[1].set(a.n41+a.n11,a.n42+a.n12,a.n43+a.n13,a.n44+a.n14),ba[2].set(a.n41+a.n21,a.n42+a.n22,a.n43+a.n23,a.n44+a.n24),ba[3].set(a.n41-a.n21,a.n42-a.n22,a.n43-a.n23,a.n44-a.n24),ba[4].set(a.n41-a.n31,a.n42-a.n32,a.n43-a.n33,a.n44-a.n34),ba[5].set(a.n41+a.n31,a.n42+a.n32,a.n43+a.n33,a.n44+a.n34);for(var b,a=0;a<6;a++)b=ba[a],b.divideScalar(Math.sqrt(b.x*b.x+b.y*b.y+b.z*b.z))}function n(a){for(var b=a.matrixWorld,c=-a.geometry.boundingSphere.radius*Math.max(a.scale.x,Math.max(a.scale.y,a.scale.z)),d=0;d<6;d++)if(a=ba[d].x*b.n14+ba[d].y*b.n24+ba[d].z*b.n34+ba[d].w,a<=c)return!1;return!0}function o(a,b){a.list[a.count]=b,a.count+=1}function p(a){var b,c,d=a.object,e=a.opaque,f=a.transparent;f.count=0,a=e.count=0;for(b=d.materials.length;a<b;a++)c=d.materials[a],c.transparent?o(f,c):o(e,c)}function q(b){var c,d,e,f,g=b.object,h=b.buffer,i=b.opaque,j=b.transparent;j.count=0,b=i.count=0;for(e=g.materials.length;b<e;b++)if(c=g.materials[b],c instanceof a.MeshFaceMaterial){c=0;for(d=h.materials.length;c<d;c++)(f=h.materials[c])&&(f.transparent?o(j,f):o(i,f))}else(f=c)&&(f.transparent?o(j,f):o(i,f))}function r(a,b){return b.z-a.z}function s(b){var c,g,j,k=0,l,o,p,q,r=b.lights;bn||(bn=new a.PerspectiveCamera(I.shadowCameraFov,I.shadowMapWidth/I.shadowMapHeight,I.shadowCameraNear,I.shadowCameraFar)),c=0;for(g=r.length;c<g;c++)if(j=r[c],j instanceof a.SpotLight&&j.castShadow){N=-1,I.shadowMap[k]||(I.shadowMap[k]=new a.WebGLRenderTarget(I.shadowMapWidth,I.shadowMapHeight,{minFilter:a.LinearFilter,magFilter:a.LinearFilter,format:a.RGBAFormat})),bo[k]||(bo[k]=new a.Matrix4),l=I.shadowMap[k],o=bo[k],bn.position.copy(j.position),bn.lookAt(j.target.position),bn.update(void 0,!0),b.update(void 0,!1,bn),o.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),o.multiplySelf(bn.projectionMatrix),o.multiplySelf(bn.matrixWorldInverse),bn.matrixWorldInverse.flattenToArray(bd),bn.projectionMatrix.flattenToArray(bc),bb.multiply(bn.projectionMatrix,bn.matrixWorldInverse),m(bb),I.initWebGLObjects(b),D(l),J.clearColor(1,1,1,1),I.clear(),J.clearColor(bk.r,bk.g,bk.b,bl),o=b.__webglObjects.length,j=b.__webglObjectsImmediate.length;for(l=0;l<o;l++)p=b.__webglObjects[l],q=p.object,q.visible&&q.castShadow?q instanceof a.Mesh&&!!q.frustumCulled&&!n(q)?p.render=!1:(q.matrixWorld.flattenToArray(q._objectMatrixArray),u(q,bn,!1),p.render=!0):p.render=!1;i(!0),A(a.NormalBlending);for(l=0;l<o;l++)if(p=b.__webglObjects[l],p.render)q=p.object,buffer=p.buffer,h(q),p=q.customDepthMaterial?q.customDepthMaterial:q.geometry.morphTargets.length?br:bq,e(bn,r,null,p,buffer,q);for(l=0;l<j;l++)p=b.__webglObjectsImmediate[l],q=p.object,q.visible&&q.castShadow&&(q.matrixAutoUpdate&&q.matrixWorld.flattenToArray(q._objectMatrixArray),O=-1,u(q,bn,!1),h(q),program=d(bn,r,null,bq,q),q.immediateRenderCallback?q.immediateRenderCallback(program,J,ba):q.render(function(a){f(a,program,bq.shading)}));k++}}function t(a,b){var c,d,e;c=bu.attributes;var f=bu.uniforms,g=_/$,h,i=[],j=$*.5,k=_*.5,l=!0;J.useProgram(bu.program),L=bu.program,O=T=S=-1,bv||(J.enableVertexAttribArray(bu.attributes.position),J.enableVertexAttribArray(bu.attributes.uv),bv=!0),J.disable(J.CULL_FACE),J.enable(J.BLEND),J.depthMask(!0),J.bindBuffer(J.ARRAY_BUFFER,bu.vertexBuffer),J.vertexAttribPointer(c.position,2,J.FLOAT,!1,16,0),J.vertexAttribPointer(c.uv,2,J.FLOAT,!1,16,8),J.bindBuffer(J.ELEMENT_ARRAY_BUFFER,bu.elementBuffer),J.uniformMatrix4fv(f.projectionMatrix,!1,bc),J.activeTexture(J.TEXTURE0),J.uniform1i(f.map,0),c=0;for(d=a.__webglSprites.length;c<d;c++)if(e=a.__webglSprites[c],e.visible&&e.opacity!=0)e.useScreenCoordinates?e.z=-e.position.z:(e._modelViewMatrix.multiplyToArray(b.matrixWorldInverse,e.matrixWorld,e._modelViewMatrixArray),e.z=-e._modelViewMatrix.n34);a.__webglSprites.sort(r),c=0;for(d=a.__webglSprites.length;c<d;c++)e=a.__webglSprites[c],e.visible&&e.opacity!=0&&e.map&&e.map.image&&e.map.image.width&&(e.useScreenCoordinates?(J.uniform1i(f.useScreenCoordinates,1),J.uniform3f(f.screenPosition,(e.position.x-j)/j,(k-e.position.y)/k,Math.max(0,Math.min(1,e.position.z)))):(J.uniform1i(f.useScreenCoordinates,0),J.uniform1i(f.affectedByDistance,e.affectedByDistance?1:0),J.uniformMatrix4fv(f.modelViewMatrix,!1,e._modelViewMatrixArray)),h=e.map.image.width/(e.scaleByViewport?_:1),i[0]=h*g*e.scale.x,i[1]=h*e.scale.y,J.uniform2f(f.uvScale,e.uvScale.x,e.uvScale.y),J.uniform2f(f.uvOffset,e.uvOffset.x,e.uvOffset.y),J.uniform2f(f.alignment,e.alignment.x,e.alignment.y),J.uniform1f(f.opacity,e.opacity),J.uniform3f(f.color,e.color.r,e.color.g,e.color.b),J.uniform1f(f.rotation,e.rotation),J.uniform2fv(f.scale,i),e.mergeWith3D&&!l?(J.enable(J.DEPTH_TEST),l=!0):!e.mergeWith3D&&l&&(J.disable(J.DEPTH_TEST),l=!1),A(e.blending),C(e.map,0),J.drawElements(J.TRIANGLES,6,J.UNSIGNED_SHORT,0));J.enable(J.CULL_FACE),J.enable(J.DEPTH_TEST),J.depthMask(U)}function u(b,c,d){b._modelViewMatrix.multiplyToArray(c.matrixWorldInverse,b.matrixWorld,b._modelViewMatrixArray),d&&a.Matrix4.makeInvert3x3(b._modelViewMatrix).transposeIntoArray(b._normalMatrixArray)}function v(a){var b,c,d,e;e=a.__materials,a=0;for(c=e.length;a<c;a++)if(d=e[a],d.attributes)for(b in d.attributes)if(d.attributes[b].needsUpdate)return!0;return!1}function w(a){var b,c,d,e;e=a.__materials,a=0;for(c=e.length;a<c;a++)if(d=e[a],d.attributes)for(b in d.attributes)d.attributes[b].needsUpdate=!1}function x(a,b){var c;for(c=a.length-1;c>=0;c--)a[c].object==b&&a.splice(c,1)}function y(b){function c(a){var b=[];d=0;for(e=a.length;d<e;d++)a[d]==void 0?b.push("undefined"):b.push(a[d].id);return b.join("_")}var d,e,f,g,h,i,j,k,l={},m=b.morphTargets!==void 0?b.morphTargets.length:0;b.geometryGroups={},f=0;for(g=b.faces.length;f<g;f++)h=b.faces[f],i=h.materials,j=c(i),l[j]==void 0&&(l[j]={hash:j,counter:0}),k=l[j].hash+"_"+l[j].counter,b.geometryGroups[k]==void 0&&(b.geometryGroups[k]={faces:[],materials:i,vertices:0,numMorphTargets:m}),h=h instanceof a.Face3?3:4,b.geometryGroups[k].vertices+h>65535&&(l[j].counter+=1,k=l[j].hash+"_"+l[j].counter,b.geometryGroups[k]==void 0&&(b.geometryGroups[k]={faces:[],materials:i,vertices:0,numMorphTargets:m})),b.geometryGroups[k].faces.push(f),b.geometryGroups[k].vertices+=h;b.geometryGroupsList=[];for(var n in b.geometryGroups)b.geometryGroups[n].id=P++,b.geometryGroupsList.push(b.geometryGroups[n])}function z(a,b,c){a.push({buffer:b,object:c,opaque:{list:[],count:0},transparent:{list:[],count:0}})}function A(b){if(b!=S){switch(b){case a.AdditiveBlending:J.blendEquation(J.FUNC_ADD),J.blendFunc(J.SRC_ALPHA,J.ONE);break;case a.SubtractiveBlending:J.blendEquation(J.FUNC_ADD),J.blendFunc(J.ZERO,J.ONE_MINUS_SRC_COLOR);break;case a.MultiplyBlending:J.blendEquation(J.FUNC_ADD),J.blendFunc(J.ZERO,J.SRC_COLOR);break;default:J.blendEquationSeparate(J.FUNC_ADD,J.FUNC_ADD),J.blendFuncSeparate(J.SRC_ALPHA,J.ONE_MINUS_SRC_ALPHA,J.ONE,J.ONE_MINUS_SRC_ALPHA)}S=b}}function B(a,b,c){(c.width&c.width-1)==0&&(c.height&c.height-1)==0?(J.texParameteri(a,J.TEXTURE_WRAP_S,H(b.wrapS)),J.texParameteri(a,J.TEXTURE_WRAP_T,H(b.wrapT)),J.texParameteri(a,J.TEXTURE_MAG_FILTER,H(b.magFilter)),J.texParameteri(a,J.TEXTURE_MIN_FILTER,H(b.minFilter)),J.generateMipmap(a)):(J.texParameteri(a,J.TEXTURE_WRAP_S,J.CLAMP_TO_EDGE),J.texParameteri(a,J.TEXTURE_WRAP_T,J.CLAMP_TO_EDGE),J.texParameteri(a,J.TEXTURE_MAG_FILTER,G(b.magFilter)),J.texParameteri(a,J.TEXTURE_MIN_FILTER,G(b.minFilter)))}function C(b,c){b.needsUpdate?(b.__webglInit||(b.__webglInit=!0,b.__webglTexture=J.createTexture(),I.info.memory.textures++),J.activeTexture(J.TEXTURE0+c),J.bindTexture(J.TEXTURE_2D,b.__webglTexture),b instanceof a.DataTexture?J.texImage2D(J.TEXTURE_2D,0,H(b.format),b.image.width,b.image.height,0,H(b.format),J.UNSIGNED_BYTE,b.image.data):J.texImage2D(J.TEXTURE_2D,0,J.RGBA,J.RGBA,J.UNSIGNED_BYTE,b.image),B(J.TEXTURE_2D,b,b.image),b.needsUpdate=!1):(J.activeTexture(J.TEXTURE0+c),J.bindTexture(J.TEXTURE_2D,b.__webglTexture))}function D(b){var c=b instanceof a.WebGLRenderTargetCube;if(b&&!b.__webglFramebuffer){b.depthBuffer===void 0&&(b.depthBuffer=!0),b.stencilBuffer===void 0&&(b.stencilBuffer=!0),b.__webglRenderbuffer=J.createRenderbuffer(),b.__webglTexture=J.createTexture();if(c){J.bindTexture(J.TEXTURE_CUBE_MAP,b.__webglTexture),B(J.TEXTURE_CUBE_MAP,b,b),b.__webglFramebuffer=[];for(var d=0;d<6;d++)b.__webglFramebuffer[d]=J.createFramebuffer(),J.texImage2D(J.TEXTURE_CUBE_MAP_POSITIVE_X+d,0,H(b.format),b.width,b.height,0,H(b.format),H(b.type),null)}else b.__webglFramebuffer=J.createFramebuffer(),J.bindTexture(J.TEXTURE_2D,b.__webglTexture),B(J.TEXTURE_2D,b,b),J.texImage2D(J.TEXTURE_2D,0,H(b.format),b.width,b.height,0,H(b.format),H(b.type),null);J.bindRenderbuffer(J.RENDERBUFFER,b.__webglRenderbuffer);if(c)for(d=0;d<6;++d)J.bindFramebuffer(J.FRAMEBUFFER,b.__webglFramebuffer[d]),J.framebufferTexture2D(J.FRAMEBUFFER,J.COLOR_ATTACHMENT0,J.TEXTURE_CUBE_MAP_POSITIVE_X+d,b.__webglTexture,0);else J.bindFramebuffer(J.FRAMEBUFFER,b.__webglFramebuffer),J.framebufferTexture2D(J.FRAMEBUFFER,J.COLOR_ATTACHMENT0,J.TEXTURE_2D,b.__webglTexture,0);b.depthBuffer&&!b.stencilBuffer?(J.renderbufferStorage(J.RENDERBUFFER,J.DEPTH_COMPONENT16,b.width,b.height),J.framebufferRenderbuffer(J.FRAMEBUFFER,J.DEPTH_ATTACHMENT,J.RENDERBUFFER,b.__webglRenderbuffer)):b.depthBuffer&&b.stencilBuffer?(J.renderbufferStorage(J.RENDERBUFFER,J.DEPTH_STENCIL,b.width,b.height),J.framebufferRenderbuffer(J.FRAMEBUFFER,J.DEPTH_STENCIL_ATTACHMENT,J.RENDERBUFFER,b.__webglRenderbuffer)):J.renderbufferStorage(J.RENDERBUFFER,J.RGBA4,b.width,b.height),c?J.bindTexture(J.TEXTURE_CUBE_MAP,null):J.bindTexture(J.TEXTURE_2D,null),J.bindRenderbuffer(J.RENDERBUFFER,null),J.bindFramebuffer(J.FRAMEBUFFER,null)}var e,f;b?(c=c?b.__webglFramebuffer[b.activeCubeFace]:b.__webglFramebuffer,d=b.width,b=b.height,f=e=0):(c=null,d=$,b=_,e=Y,f=Z),c!=M&&(J.bindFramebuffer(J.FRAMEBUFFER,c),J.viewport(e,f,d,b),M=c)}function E(b){b instanceof a.WebGLRenderTargetCube?(J.bindTexture(J.TEXTURE_CUBE_MAP,b.__webglTexture),J.generateMipmap(J.TEXTURE_CUBE_MAP),J.bindTexture(J.TEXTURE_CUBE_MAP,null)):(J.bindTexture(J.TEXTURE_2D,b.__webglTexture),J.generateMipmap(J.TEXTURE_2D),J.bindTexture(J.TEXTURE_2D,null))}function F(a,b){var c;return a=="fragment"?c=J.createShader(J.FRAGMENT_SHADER):a=="vertex"&&(c=J.createShader(J.VERTEX_SHADER)),J.shaderSource(c,b),J.compileShader(c),J.getShaderParameter(c,J.COMPILE_STATUS)?c:(console.error(J.getShaderInfoLog(c)),console.error(b),null)}function G(b){switch(b){case a.NearestFilter:case a.NearestMipMapNearestFilter:case a.NearestMipMapLinearFilter:return J.NEAREST;default:return J.LINEAR}}function H(b){switch(b){case a.RepeatWrapping:return J.REPEAT;case a.ClampToEdgeWrapping:return J.CLAMP_TO_EDGE;case a.MirroredRepeatWrapping:return J.MIRRORED_REPEAT;case a.NearestFilter:return J.NEAREST;case a.NearestMipMapNearestFilter:return J.NEAREST_MIPMAP_NEAREST;case a.NearestMipMapLinearFilter:return J.NEAREST_MIPMAP_LINEAR;case a.LinearFilter:return J.LINEAR;case a.LinearMipMapNearestFilter:return J.LINEAR_MIPMAP_NEAREST;case a.LinearMipMapLinearFilter:return J.LINEAR_MIPMAP_LINEAR;case a.ByteType:return J.BYTE;case a.UnsignedByteType:return J.UNSIGNED_BYTE;case a.ShortType:return J.SHORT;case a.UnsignedShortType:return J.UNSIGNED_SHORT;case a.IntType:return J.INT;case a.UnsignedShortType:return J.UNSIGNED_INT;case a.FloatType:return J.FLOAT;case a.AlphaFormat:return J.ALPHA;case a.RGBFormat:return J.RGB;case a.RGBAFormat:return J.RGBA;case a.LuminanceFormat:return J.LUMINANCE;case a.LuminanceAlphaFormat:return J.LUMINANCE_ALPHA}return 0}var I=this,J,K=[],L=null,M=null,N=-1,O=null,P=0,Q=null,R=null,S=null,T=null,U=null,V=null,W=null,X=null,Y=0,Z=0,$=0,_=0,ba=[new a.Vector4,new a.Vector4,new a.Vector4,new a.Vector4,new a.Vector4,new a.Vector4],bb=new a.Matrix4,bc=new Float32Array(16),bd=new Float32Array(16),be=new a.Vector4,bf={ambient:[0,0,0],directional:{length:0,colors:[],positions:[]},point:{length:0,colors:[],positions:[],distances:[]}},b=b||{},bg=b.canvas!==void 0?b.canvas:document.createElement("canvas"),bh=b.stencil!==void 0?b.stencil:!0,bi=b.preserveDrawingBuffer!==void 0?b.preserveDrawingBuffer:!1,bj=b.antialias!==void 0?b.antialias:!1,bk=b.clearColor!==void 0?new a.Color(b.clearColor):new a.Color(0),bl=b.clearAlpha!==void 0?b.clearAlpha:0,bm=b.maxLights!==void 0?b.maxLights:4;this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0}},this.maxMorphTargets=8,this.domElement=bg,this.sortObjects=this.autoClearStencil=this.autoClearDepth=this.autoClearColor=this.autoClear=!0,this.shadowMapBias=.0039,this.shadowMapDarkness=.5,this.shadowMapHeight=this.shadowMapWidth=512,this.shadowCameraNear=1,this.shadowCameraFar=5e3,this.shadowCameraFov=50,this.shadowMap=[],this.shadowMapEnabled=!1,this.shadowMapSoft=!0;var bn,bo=[],b=a.ShaderLib.depthRGBA,bp=a.UniformsUtils.clone(b.uniforms),bq=new a.ShaderMaterial({fragmentShader:b.fragmentShader,vertexShader:b.vertexShader,uniforms:bp}),br=new a.ShaderMaterial({fragmentShader:b.fragmentShader,vertexShader:b.vertexShader,uniforms:bp,morphTargets:!0});bq._shadowPass=!0,br._shadowPass=!0;try{if(!(J=bg.getContext("experimental-webgl",{antialias:bj,stencil:bh,preserveDrawingBuffer:bi})))throw"Error creating WebGL context.";console.log(navigator.userAgent+" | "+J.getParameter(J.VERSION)+" | "+J.getParameter(J.VENDOR)+" | "+J.getParameter(J.RENDERER)+" | "+J.getParameter(J.SHADING_LANGUAGE_VERSION))}catch(bs){console.error(bs)}J.clearColor(0,0,0,1),J.clearDepth(1),J.clearStencil(0),J.enable(J.DEPTH_TEST),J.depthFunc(J.LEQUAL),J.frontFace(J.CCW),J.cullFace(J.BACK),J.enable(J.CULL_FACE),J.enable(J.BLEND),J.blendEquation(J.FUNC_ADD),J.blendFunc(J.SRC_ALPHA,J.ONE_MINUS_SRC_ALPHA),J.clearColor(bk.r,bk.g,bk.b,bl),this.context=J;var bt=J.getParameter(J.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0,bu={};bu.vertices=new Float32Array(16),bu.faces=new Uint16Array(6),bh=0,bu.vertices[bh++]=-1,bu.vertices[bh++]=-1,bu.vertices[bh++]=0,bu.vertices[bh++]=1,bu.vertices[bh++]=1,bu.vertices[bh++]=-1,bu.vertices[bh++]=1,bu.vertices[bh++]=1,bu.vertices[bh++]=1,bu.vertices[bh++]=1,bu.vertices[bh++]=1,bu.vertices[bh++]=0,bu.vertices[bh++]=-1,bu.vertices[bh++]=1,bu.vertices[bh++]=0,bh=bu.vertices[bh++]=0,bu.faces[bh++]=0,bu.faces[bh++]=1,bu.faces[bh++]=2,bu.faces[bh++]=0,bu.faces[bh++]=2,bu.faces[bh++]=3,bu.vertexBuffer=J.createBuffer(),bu.elementBuffer=J.createBuffer(),J.bindBuffer(J.ARRAY_BUFFER,bu.vertexBuffer),J.bufferData(J.ARRAY_BUFFER,bu.vertices,J.STATIC_DRAW),J.bindBuffer(J.ELEMENT_ARRAY_BUFFER,bu.elementBuffer),J.bufferData(J.ELEMENT_ARRAY_BUFFER,bu.faces,J.STATIC_DRAW),bu.program=J.createProgram(),J.attachShader(bu.program,F("fragment",a.ShaderLib.sprite.fragmentShader)),J.attachShader(bu.program,F("vertex",a.ShaderLib.sprite.vertexShader)),J.linkProgram(bu.program),bu.attributes={},bu.uniforms={},bu.attributes.position=J.getAttribLocation(bu.program,"position"),bu.attributes.uv=J.getAttribLocation(bu.program,"uv"),bu.uniforms.uvOffset=J.getUniformLocation(bu.program,"uvOffset"),bu.uniforms.uvScale=J.getUniformLocation(bu.program,"uvScale"),bu.uniforms.rotation=J.getUniformLocation(bu.program,"rotation"),bu.uniforms.scale=J.getUniformLocation(bu.program,"scale"),bu.uniforms.alignment=J.getUniformLocation(bu.program,"alignment"),bu.uniforms.color=J.getUniformLocation(bu.program,"color"),bu.uniforms.map=J.getUniformLocation(bu.program,"map"),bu.uniforms.opacity=J.getUniformLocation(bu.program,"opacity"),bu.uniforms.useScreenCoordinates=J.getUniformLocation(bu.program,"useScreenCoordinates"),bu.uniforms.affectedByDistance=J.getUniformLocation(bu.program,"affectedByDistance"),bu.uniforms.screenPosition=J.getUniformLocation(bu.program,"screenPosition"),bu.uniforms.modelViewMatrix=J.getUniformLocation(bu.program,"modelViewMatrix"),bu.uniforms.projectionMatrix=J.getUniformLocation(bu.program,"projectionMatrix");var bv=!1;this.setSize=function(a,b){bg.width=a,bg.height=b,this.setViewport(0,0,bg.width,bg.height)},this.setViewport=function(a,b,c,d){Y=a,Z=b,$=c,_=d,J.viewport(Y,Z,$,_)},this.setScissor=function(a,b,c,d){J.scissor(a,b,c,d)},this.enableScissorTest=function(a){a?J.enable(J.SCISSOR_TEST):J.disable(J.SCISSOR_TEST)},this.setClearColorHex=function(a,b){bk.setHex(a),bl=b,J.clearColor(bk.r,bk.g,bk.b,bl)},this.setClearColor=function(a,b){bk.copy(a),bl=b,J.clearColor(bk.r,bk.g,bk.b,bl)},this.getClearColor=function(){return bk},this.getClearAlpha=function(){return bl},this.clear=function(a,b,c){var d=0;if(a==void 0||a)d|=J.COLOR_BUFFER_BIT;if(b==void 0||b)d|=J.DEPTH_BUFFER_BIT;if(c==void 0||c)d|=J.STENCIL_BUFFER_BIT;J.clear(d)},this.getContext=function(){return J},this.deallocateObject=function(b){if(b.__webglInit)if(b.__webglInit=!1,delete b._modelViewMatrix,delete b._normalMatrixArray,delete b._modelViewMatrixArray,delete b._objectMatrixArray,b instanceof a.Mesh)for(g in b.geometry.geometryGroups){var c=b.geometry.geometryGroups[g];J.deleteBuffer(c.__webglVertexBuffer),J.deleteBuffer(c.__webglNormalBuffer),J.deleteBuffer(c.__webglTangentBuffer),J.deleteBuffer(c.__webglColorBuffer),J.deleteBuffer(c.__webglUVBuffer),J.deleteBuffer(c.__webglUV2Buffer),J.deleteBuffer(c.__webglSkinVertexABuffer),J.deleteBuffer(c.__webglSkinVertexBBuffer),J.deleteBuffer(c.__webglSkinIndicesBuffer),J.deleteBuffer(c.__webglSkinWeightsBuffer),J.deleteBuffer(c.__webglFaceBuffer),J.deleteBuffer(c.__webglLineBuffer);if(c.numMorphTargets)for(var d=0,e=c.numMorphTargets;d<e;d++)J.deleteBuffer(c.__webglMorphTargetsBuffers[d]);I.info.memory.geometries--}else b instanceof a.Ribbon?(b=b.geometry,J.deleteBuffer(b.__webglVertexBuffer),J.deleteBuffer(b.__webglColorBuffer),I.info.memory.geometries--):b instanceof a.Line?(b=b.geometry,J.deleteBuffer(b.__webglVertexBuffer),J.deleteBuffer(b.__webglColorBuffer),I.info.memory.geometries--):b instanceof a.ParticleSystem&&(b=b.geometry,J.deleteBuffer(b.__webglVertexBuffer),J.deleteBuffer(b.__webglColorBuffer),I.info.memory.geometries--)},this.deallocateTexture=function(a){a.__webglInit&&(a.__webglInit=!1,J.deleteTexture(a.__webglTexture),I.info.memory.textures--)},this.initMaterial=function(b,c,d,e){var f,g,h,i;b instanceof a.MeshDepthMaterial?i="depth":b instanceof a.MeshNormalMaterial?i="normal":b instanceof a.MeshBasicMaterial?i="basic":b instanceof a.MeshLambertMaterial?i="lambert":b instanceof a.MeshPhongMaterial?i="phong":b instanceof a.LineBasicMaterial?i="basic":b instanceof a.ParticleBasicMaterial&&(i="particle_basic");if(i){var j=a.ShaderLib[i];b.uniforms=a.UniformsUtils.clone(j.uniforms),b.vertexShader=j.vertexShader,b.fragmentShader=j.fragmentShader}var k,l,m;k=m=j=0;for(l=c.length;k<l;k++)h=c[k],h instanceof a.SpotLight&&m++,h instanceof a.DirectionalLight&&m++,h instanceof a.PointLight&&j++;j+m>bm?(k=Math.ceil(bm*m/(j+m)),j=bm-k):k=m,h={directional:k,point:j},j=m=0;for(k=c.length;j<k;j++)l=c[j],l instanceof a.SpotLight&&l.castShadow&&m++;var n=50;e!==void 0&&e instanceof a.SkinnedMesh&&(n=e.bones.length);var o;p:{k=b.fragmentShader,l=b.vertexShader;var j=b.uniforms,c=b.attributes,d={map:!!b.map,envMap:!!b.envMap,lightMap:!!b.lightMap,vertexColors:b.vertexColors,fog:d,useFog:b.fog,sizeAttenuation:b.sizeAttenuation,skinning:b.skinning,morphTargets:b.morphTargets,maxMorphTargets:this.maxMorphTargets,maxDirLights:h.directional,maxPointLights:h.point,maxBones:n,shadowMapEnabled:this.shadowMapEnabled&&e.receiveShadow,shadowMapSoft:this.shadowMapSoft,shadowMapWidth:this.shadowMapWidth,shadowMapHeight:this.shadowMapHeight,maxShadows:m,alphaTest:b.alphaTest},q,e=[];i?e.push(i):(e.push(k),e.push(l));for(q in d)e.push(q),e.push(d[q]);i=e.join(),q=0;for(e=K.length;q<e;q++)if(K[q].code==i){o=K[q].program;break p}q=J.createProgram(),e=[bt?"#define VERTEX_TEXTURES":"","#define MAX_DIR_LIGHTS "+d.maxDirLights,"#define MAX_POINT_LIGHTS "+d.maxPointLights,"#define MAX_SHADOWS "+d.maxShadows,"#define MAX_BONES "+d.maxBones,d.map?"#define USE_MAP":"",d.envMap?"#define USE_ENVMAP":"",d.lightMap?"#define USE_LIGHTMAP":"",d.vertexColors?"#define USE_COLOR":"",d.skinning?"#define USE_SKINNING":"",d.morphTargets?"#define USE_MORPHTARGETS":"",d.shadowMapEnabled?"#define USE_SHADOWMAP":"",d.shadowMapSoft?"#define SHADOWMAP_SOFT":"",d.sizeAttenuation?"#define USE_SIZEATTENUATION":"","uniform mat4 objectMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 cameraPosition;\nuniform mat4 cameraInverseMatrix;\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nattribute vec2 uv2;\n#ifdef USE_COLOR\nattribute vec3 color;\n#endif\n#ifdef USE_MORPHTARGETS\nattribute vec3 morphTarget0;\nattribute vec3 morphTarget1;\nattribute vec3 morphTarget2;\nattribute vec3 morphTarget3;\nattribute vec3 morphTarget4;\nattribute vec3 morphTarget5;\nattribute vec3 morphTarget6;\nattribute vec3 morphTarget7;\n#endif\n#ifdef USE_SKINNING\nattribute vec4 skinVertexA;\nattribute vec4 skinVertexB;\nattribute vec4 skinIndex;\nattribute vec4 skinWeight;\n#endif\n"].join("\n"),h=["#ifdef GL_ES\nprecision highp float;\n#endif","#define MAX_DIR_LIGHTS "+d.maxDirLights,"#define MAX_POINT_LIGHTS "+d.maxPointLights,"#define MAX_SHADOWS "+d.maxShadows,d.alphaTest?"#define ALPHATEST "+d.alphaTest:"",d.useFog&&d.fog?"#define USE_FOG":"",d.useFog&&d.fog instanceof a.FogExp2?"#define FOG_EXP2":"",d.map?"#define USE_MAP":"",d.envMap?"#define USE_ENVMAP":"",d.lightMap?"#define USE_LIGHTMAP":"",d.vertexColors?"#define USE_COLOR":"",d.shadowMapEnabled?"#define USE_SHADOWMAP":"",d.shadowMapSoft?"#define SHADOWMAP_SOFT":"",d.shadowMapSoft?"#define SHADOWMAP_WIDTH "+d.shadowMapWidth.toFixed(1):"",d.shadowMapSoft?"#define SHADOWMAP_HEIGHT "+d.shadowMapHeight.toFixed(1):"","uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n"].join("\n"),J.attachShader(q,F("fragment",h+k)),J.attachShader(q,F("vertex",e+l)),J.linkProgram(q),J.getProgramParameter(q,J.LINK_STATUS)||console.error("Could not initialise shader\nVALIDATE_STATUS: "+J.getProgramParameter(q,J.VALIDATE_STATUS)+", gl error ["+J.getError()+"]"),q.uniforms={},q.attributes={};var r,e=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","objectMatrix","cameraPosition","cameraInverseMatrix","boneGlobalMatrices","morphTargetInfluences"];for(r in j)e.push(r);r=e,e=0;for(j=r.length;e<j;e++)k=r[e],q.uniforms[k]=J.getUniformLocation(q,k);e=["position","normal","uv","uv2","tangent","color","skinVertexA","skinVertexB","skinIndex","skinWeight"];for(r=0;r<d.maxMorphTargets;r++)e.push("morphTarget"+r);for(o in c)e.push(o);o=e,r=0;for(c=o.length;r<c;r++)d=o[r],q.attributes[d]=J.getAttribLocation(q,d);q.id=K.length,K.push({program:q,code:i}),I.info.memory.programs=K.length,o=q}b.program=o,o=b.program.attributes,o.position>=0&&J.enableVertexAttribArray(o.position),o.color>=0&&J.enableVertexAttribArray(o.color),o.normal>=0&&J.enableVertexAttribArray(o.normal),o.tangent>=0&&J.enableVertexAttribArray(o.tangent),b.skinning&&o.skinVertexA>=0&&o.skinVertexB>=0&&o.skinIndex>=0&&o.skinWeight>=0&&(J.enableVertexAttribArray(o.skinVertexA),J.enableVertexAttribArray(o.skinVertexB),J.enableVertexAttribArray(o.skinIndex),J.enableVertexAttribArray(o.skinWeight));if(b.attributes)for(g in b.attributes)o[g]!==void 0&&o[g]>=0&&J.enableVertexAttribArray(o[g]);if(b.morphTargets)for(g=b.numSupportedMorphTargets=0;g<this.maxMorphTargets;g++)r="morphTarget"+g,o[r]>=0&&(J.enableVertexAttribArray(o[r]),b.numSupportedMorphTargets++);b.uniformsList=[];for(f in b.uniforms)b.uniformsList.push([b.uniforms[f],f])},this.clearTarget=function(a,b,c,d){D(a),this.clear(b,c,d)},this.render=function(b,c,g,l){var o,v,w,x,y,z,B,C,F=b.lights,G=b.fog;N=-1,this.shadowMapEnabled&&s(b,c),I.info.render.calls=0,I.info.render.vertices=0,I.info.render.faces=0,c.matrixAutoUpdate&&c.update(void 0,!0),b.update(void 0,!1,c),c.matrixWorldInverse.flattenToArray(bd),c.projectionMatrix.flattenToArray(bc),bb.multiply(c.projectionMatrix,c.matrixWorldInverse),m(bb),this.initWebGLObjects(b),D(g),(this.autoClear||l)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),y=b.__webglObjects.length;for(l=0;l<y;l++)if(o=b.__webglObjects[l],B=o.object,B.visible){if(B instanceof a.Mesh&&!!B.frustumCulled&&!n(B))o.render=!1;else if(B.matrixWorld.flattenToArray(B._objectMatrixArray),u(B,c,!0),q(o),o.render=!0,this.sortObjects)o.object.renderDepth?o.z=o.object.renderDepth:(be.copy(B.position),bb.multiplyVector3(be),o.z=be.z)}else o.render=!1;this.sortObjects&&b.__webglObjects.sort(r),z=b.__webglObjectsImmediate.length;for(l=0;l<z;l++)o=b.__webglObjectsImmediate[l],B=o.object,B.visible&&(B.matrixAutoUpdate&&B.matrixWorld.flattenToArray(B._objectMatrixArray),u(B,c,!0),p(o));if(b.overrideMaterial){i(b.overrideMaterial.depthTest),A(b.overrideMaterial.blending);for(l=0;l<y;l++)if(o=b.__webglObjects[l],o.render)B=o.object,C=o.buffer,h(B),e(c,F,G,b.overrideMaterial,C,B);for(l=0;l<z;l++)o=b.__webglObjectsImmediate[l],B=o.object,B.visible&&(O=-1,h(B),v=d(c,F,G,b.overrideMaterial,B),B.immediateRenderCallback?B.immediateRenderCallback(v,J,ba):B.render(function(a){f(a,v,b.overrideMaterial.shading)}))}else{A(a.NormalBlending);for(l=y-1;l>=0;l--)if(o=b.__webglObjects[l],o.render){B=o.object,C=o.buffer,w=o.opaque,h(B);for(o=0;o<w.count;o++)x=w.list[o],i(x.depthTest),j(x.depthWrite),k(x.polygonOffset,x.polygonOffsetFactor,x.polygonOffsetUnits),e(c,F,G,x,C,B)}for(l=0;l<z;l++)if(o=b.__webglObjectsImmediate[l],B=o.object,B.visible){O=-1,w=o.opaque,h(B);for(o=0;o<w.count;o++)x=w.list[o],i(x.depthTest),j(x.depthWrite),k(x.polygonOffset,x.polygonOffsetFactor,x.polygonOffsetUnits),v=d(c,F,G,x,B),B.immediateRenderCallback?B.immediateRenderCallback(v,J,ba):B.render(function(a){f(a,v,x.shading)})}for(l=0;l<y;l++)if(o=b.__webglObjects[l],o.render){B=o.object,C=o.buffer,w=o.transparent,h(B);for(o=0;o<w.count;o++)x=w.list[o],A(x.blending),i(x.depthTest),j(x.depthWrite),k(x.polygonOffset,x.polygonOffsetFactor,x.polygonOffsetUnits),e(c,F,G,x,C,B)}for(l=0;l<z;l++)if(o=b.__webglObjectsImmediate[l],B=o.object,B.visible){O=-1,w=o.transparent,h(B);for(o=0;o<w.count;o++)x=w.list[o],A(x.blending),i(x.depthTest),j(x.depthWrite),k(x.polygonOffset,x.polygonOffsetFactor,x.polygonOffsetUnits),v=d(c,F,G,x,B),B.immediateRenderCallback?B.immediateRenderCallback(v,J,ba):B.render(function(a){f(a,v,x.shading)})}}b.__webglSprites.length&&t(b,c),g&&g.minFilter!==a.NearestFilter&&g.minFilter!==a.LinearFilter&&E(g)},this.initWebGLObjects=function(b){b.__webglObjects||(b.__webglObjects=[],b.__webglObjectsImmediate=[],b.__webglSprites=[]);for(;b.__objectsAdded.length;){var d=b.__objectsAdded[0],e=b,f=void 0,g=void 0,h=void 0;if(!d.__webglInit)if(d.__webglInit=!0,d._modelViewMatrix=new a.Matrix4,d._normalMatrixArray=new Float32Array(9),d._modelViewMatrixArray=new Float32Array(16),d._objectMatrixArray=new Float32Array(16),d.matrixWorld.flattenToArray(d._objectMatrixArray),d instanceof a.Mesh){for(f in g=d.geometry,g.geometryGroups==void 0&&y(g),g.geometryGroups)if(h=g.geometryGroups[f],!h.__webglVertexBuffer){var i=h;i.__webglVertexBuffer=J.createBuffer(),i.__webglNormalBuffer=J.createBuffer(),i.__webglTangentBuffer=J.createBuffer(),i.__webglColorBuffer=J.createBuffer(),i.__webglUVBuffer=J.createBuffer(),i.__webglUV2Buffer=J.createBuffer(),i.__webglSkinVertexABuffer=J.createBuffer(),i.__webglSkinVertexBBuffer=J.createBuffer(),i.__webglSkinIndicesBuffer=J.createBuffer(),i.__webglSkinWeightsBuffer=J.createBuffer(),i.__webglFaceBuffer=J.createBuffer(),i.__webglLineBuffer=J.createBuffer();if(i.numMorphTargets){var j=void 0,k=void 0;i.__webglMorphTargetsBuffers=[],j=0;for(k=i.numMorphTargets;j<k;j++)i.__webglMorphTargetsBuffers.push(J.createBuffer())}I.info.memory.geometries++;for(var i=d,m=void 0,n=void 0,o=void 0,p=o=void 0,q=void 0,r=void 0,s=r=j=0,t=o=n=void 0,o=k=t=n=m=void 0,p=i.geometry,q=p.faces,t=h.faces,m=0,n=t.length;m<n;m++)o=t[m],o=q[o],o instanceof a.Face3?(j+=3,r+=1,s+=3):o instanceof a.Face4&&(j+=4,r+=2,s+=4);for(var m=h,n=i,u=t=q=void 0,A=void 0,u=void 0,o=[],q=0,t=n.materials.length;q<t;q++)if(u=n.materials[q],u instanceof a.MeshFaceMaterial){u=0;for(l=m.materials.length;u<l;u++)(A=m.materials[u])&&o.push(A)}else(A=u)&&o.push(A);m=o,h.__materials=m;B:{q=n=void 0,t=m.length;for(n=0;n<t;n++)if(q=m[n],q.map||q.lightMap||q instanceof a.ShaderMaterial){n=!0;break B}n=!1}B:{t=q=void 0,o=m.length;for(q=0;q<o;q++)if(t=m[q],!(t instanceof a.MeshBasicMaterial&&!t.envMap||t instanceof a.MeshDepthMaterial)){t=t&&t.shading!=void 0&&t.shading==a.SmoothShading?a.SmoothShading:a.FlatShading;break B}t=!1}B:{o=q=void 0,u=m.length;for(q=0;q<u;q++)if(o=m[q],o.vertexColors){o=o.vertexColors;break B}o=!1}h.__vertexArray=new Float32Array(j*3),t&&(h.__normalArray=new Float32Array(j*3)),p.hasTangents&&(h.__tangentArray=new Float32Array(j*4)),o&&(h.__colorArray=new Float32Array(j*3));if(n){if(p.faceUvs.length>0||p.faceVertexUvs.length>0)h.__uvArray=new Float32Array(j*2);if(p.faceUvs.length>1||p.faceVertexUvs.length>1)h.__uv2Array=new Float32Array(j*2)}i.geometry.skinWeights.length&&i.geometry.skinIndices.length&&(h.__skinVertexAArray=new Float32Array(j*4),h.__skinVertexBArray=new Float32Array(j*4),h.__skinIndexArray=new Float32Array(j*4),h.__skinWeightArray=new Float32Array(j*4)),h.__faceArray=new Uint16Array(r*3+(i.geometry.edgeFaces?i.geometry.edgeFaces.length*6:0)),h.__lineArray=new Uint16Array(s*2);if(h.numMorphTargets){h.__morphTargetsArrays=[],p=0;for(q=h.numMorphTargets;p<q;p++)h.__morphTargetsArrays.push(new Float32Array(j*3))}h.__needsSmoothNormals=t==a.SmoothShading,h.__uvType=n,h.__vertexColorType=o,h.__normalType=t,h.__webglFaceCount=r*3+(i.geometry.edgeFaces?i.geometry.edgeFaces.length*6:0),h.__webglLineCount=s*2,p=0;for(q=m.length;p<q;p++)if(n=m[p],n.attributes){h.__webglCustomAttributes===void 0&&(h.__webglCustomAttributes={});for(B in n.attributes){o=n.attributes[B],t={};for(k in o)t[k]=o[k];if(!t.__webglInitialized||t.createUniqueBuffers)t.__webglInitialized=!0,r=1,t.type==="v2"?r=2:t.type==="v3"?r=3:t.type==="v4"?r=4:t.type==="c"&&(r=3),t.size=r,t.array=new Float32Array(j*r),t.buffer=J.createBuffer(),t.buffer.belongsToAttribute=B,o.needsUpdate=!0,t.__original=o;h.__webglCustomAttributes[B]=t}}h.__inittedArrays=!0,g.__dirtyVertices=!0,g.__dirtyMorphTargets=!0,g.__dirtyElements=!0,g.__dirtyUvs=!0,g.__dirtyNormals=!0,g.__dirtyTangents=!0,g.__dirtyColors=!0}}else if(d instanceof a.Ribbon){if(g=d.geometry,!g.__webglVertexBuffer)h=g,h.__webglVertexBuffer=J.createBuffer(),h.__webglColorBuffer=J.createBuffer(),I.info.memory.geometries++,h=g,i=h.vertices.length,h.__vertexArray=new Float32Array(i*3),h.__colorArray=new Float32Array(i*3),h.__webglVertexCount=i,g.__dirtyVertices=!0,g.__dirtyColors=!0}else if(d instanceof a.Line){if(g=d.geometry,!g.__webglVertexBuffer)h=g,h.__webglVertexBuffer=J.createBuffer(),h.__webglColorBuffer=J.createBuffer(),I.info.memory.geometries++,h=g,i=h.vertices.length,h.__vertexArray=new Float32Array(i*3),h.__colorArray=new Float32Array(i*3),h.__webglLineCount=i,g.__dirtyVertices=!0,g.__dirtyColors=!0}else if(d instanceof a.ParticleSystem&&(g=d.geometry,!g.__webglVertexBuffer)){h=g,h.__webglVertexBuffer=J.createBuffer(),h.__webglColorBuffer=J.createBuffer(),I.info.geometries++,h=g,i=d,j=h.vertices.length,h.__vertexArray=new Float32Array(j*3),h.__colorArray=new Float32Array(j*3),h.__sortArray=[],h.__webglParticleCount=j,h.__materials=i.materials,s=r=k=void 0,k=0;for(r=i.materials.length;k<r;k++)if(s=i.materials[k],s.attributes){h.__webglCustomAttributes===void 0&&(h.__webglCustomAttributes={});for(B in s.attributes){originalAttribute=s.attributes[B],attribute={};for(property in originalAttribute)attribute[property]=originalAttribute[property];if(!attribute.__webglInitialized||attribute.createUniqueBuffers)attribute.__webglInitialized=!0,size=1,attribute.type==="v2"?size=2:attribute.type==="v3"?size=3:attribute.type==="v4"?size=4:attribute.type==="c"&&(size=3),attribute.size=size,attribute.array=new Float32Array(j*size),attribute.buffer=J.createBuffer(),attribute.buffer.belongsToAttribute=B,originalAttribute.needsUpdate=!0,attribute.__original=originalAttribute;h.__webglCustomAttributes[B]=attribute}}g.__dirtyVertices=!0,g.__dirtyColors=!0}if(!d.__webglActive){if(d instanceof a.Mesh)for(f in g=d.geometry,g.geometryGroups)h=g.geometryGroups[f],z(e.__webglObjects,h,d);else d instanceof a.Ribbon||d instanceof a.Line||d instanceof a.ParticleSystem?(g=d.geometry,z(e.__webglObjects,g,d)):a.MarchingCubes!==void 0&&d instanceof a.MarchingCubes||d.immediateRenderCallback?e.__webglObjectsImmediate.push({object:d,opaque:{list:[],count:0},transparent:{list:[],count:0}}):d instanceof a.Sprite&&e.__webglSprites.push(d);d.__webglActive=!0}b.__objectsAdded.splice(0,1)}for(;b.__objectsRemoved.length;){d=b.__objectsRemoved[0],e=b;if(d instanceof a.Mesh||d instanceof a.ParticleSystem||d instanceof a.Ribbon||d instanceof a.Line)x(e.__webglObjects,d);else if(d instanceof a.Sprite){e=e.__webglSprites,f=d,g=void 0;for(g=e.length-1;g>=0;g--)e[g]==f&&e.splice(g,1)}else(d instanceof a.MarchingCubes||d.immediateRenderCallback)&&x(e.__webglObjectsImmediate,d);d.__webglActive=!1,b.__objectsRemoved.splice(0,1)}d=0;for(e=b.__webglObjects.length;d<e;d++)if(g=b.__webglObjects[d].object,k=h=f=void 0,g instanceof a.Mesh){f=g.geometry,i=0;for(j=f.geometryGroupsList.length;i<j;i++)if(h=f.geometryGroupsList[i],k=v(h),f.__dirtyVertices||f.__dirtyMorphTargets||f.__dirtyElements||f.__dirtyUvs||f.__dirtyNormals||f.__dirtyColors||f.__dirtyTangents||k)if(k=h,r=J.DYNAMIC_DRAW,s=!f.dynamic,k.__inittedArrays){var C=m=p=void 0,D=void 0,E=C=void 0,F=void 0,G=void 0,H=void 0,K=A=u=o=t=q=n=void 0,L=void 0,M=void 0,N=D=H=D=G=F=void 0,O=void 0,P=O=N=F=void 0,Q=void 0,R=P=O=N=C=C=E=H=D=P=O=N=Q=P=O=N=Q=P=O=N=void 0,S=0,T=0,U=0,V=0,W=0,X=0,Y=0,Z=0,$=0,_=0,ba=0,P=N=0,P=void 0,bb=k.__vertexArray,bc=k.__uvArray,bd=k.__uv2Array,be=k.__normalArray,bf=k.__tangentArray,bg=k.__colorArray,bh=k.__skinVertexAArray,bi=k.__skinVertexBArray,bj=k.__skinIndexArray,bk=k.__skinWeightArray,bl=k.__morphTargetsArrays,bm=k.__webglCustomAttributes,O=void 0,bn=k.__faceArray,bo=k.__lineArray,bp=k.__needsSmoothNormals,q=k.__vertexColorType,n=k.__uvType,t=k.__normalType,bq=g.geometry,br=bq.__dirtyVertices,bs=bq.__dirtyElements,bt=bq.__dirtyUvs,bu=bq.__dirtyNormals,bv=bq.__dirtyTangents,bw=bq.__dirtyColors,bx=bq.__dirtyMorphTargets,by=bq.vertices,bz=k.faces,bA=bq.faces,bB=bq.faceVertexUvs[0],bC=bq.faceVertexUvs[1],bD=bq.skinVerticesA,bE=bq.skinVerticesB,bF=bq.skinIndices,bG=bq.skinWeights,bH=bq.morphTargets;if(bm)for(R in bm)bm[R].offset=0,bm[R].offsetSrc=0;p=0;for(m=bz.length;p<m;p++)if(C=bz[p],D=bA[C],bB&&(o=bB[C]),bC&&(u=bC[C]),C=D.vertexNormals,E=D.normal,F=D.vertexColors,G=D.color,H=D.vertexTangents,D instanceof a.Face3){br&&(A=by[D.a].position,K=by[D.b].position,L=by[D.c].position,bb[T]=A.x,bb[T+1]=A.y,bb[T+2]=A.z,bb[T+3]=K.x,bb[T+4]=K.y,bb[T+5]=K.z,bb[T+6]=L.x,bb[T+7]=L.y,bb[T+8]=L.z,T+=9);if(bm)for(R in bm)if(O=bm[R],O.__original.needsUpdate)N=O.offset,P=O.offsetSrc,O.size===1?(O.boundTo===void 0||O.boundTo==="vertices"?(O.array[N]=O.value[D.a],O.array[N+1]=O.value[D.b],O.array[N+2]=O.value[D.c]):O.boundTo==="faces"?(P=O.value[P],O.array[N]=P,O.array[N+1]=P,O.array[N+2]=P,O.offsetSrc++):O.boundTo==="faceVertices"&&(O.array[N]=O.value[P],O.array[N+1]=O.value[P+1],O.array[N+2]=O.value[P+2],O.offsetSrc+=3),O.offset+=3):(O.boundTo===void 0||O.boundTo==="vertices"?(A=O.value[D.a],K=O.value[D.b],L=O.value[D.c]):O.boundTo==="faces"?(L=K=A=P=O.value[P],O.offsetSrc++):O.boundTo==="faceVertices"&&(A=O.value[P],K=O.value[P+1],L=O.value[P+2],O.offsetSrc+=3),O.size===2?(O.array[N]=A.x,O.array[N+1]=A.y,O.array[N+2]=K.x,O.array[N+3]=K.y,O.array[N+4]=L.x,O.array[N+5]=L.y,O.offset+=6):O.size===3?(O.type==="c"?(O.array[N]=A.r,O.array[N+1]=A.g,O.array[N+2]=A.b,O.array[N+3]=K.r,O.array[N+4]=K.g,O.array[N+5]=K.b,O.array[N+6]=L.r,O.array[N+7]=L.g,O.array[N+8]=L.b):(O.array[N]=A.x,O.array[N+1]=A.y,O.array[N+2]=A.z,O.array[N+3]=K.x,O.array[N+4]=K.y,O.array[N+5]=K.z,O.array[N+6]=L.x,O.array[N+7]=L.y,O.array[N+8]=L.z),O.offset+=9):(O.array[N]=A.x,O.array[N+1]=A.y,O.array[N+2]=A.z,O.array[N+3]=A.w,O.array[N+4]=K.x,O.array[N+5]=K.y,O.array[N+6]=K.z,O.array[N+7]=K.w,O.array[N+8]=L.x,O.array[N+9]=L.y,O.array[N+10]=L.z,O.array[N+11]=L.w,O.offset+=12));if(bx){N=0;for(O=bH.length;N<O;N++)A=bH[N].vertices[D.a].position,K=bH[N].vertices[D.b].position,L=bH[N].vertices[D.c].position,P=bl[N],P[ba]=A.x,P[ba+1]=A.y,P[ba+2]=A.z,P[ba+3]=K.x,P[ba+4]=K.y,P[ba+5]=K.z,P[ba+6]=L.x,P[ba+7]=L.y,P[ba+8]=L.z;ba+=9}bG.length&&(N=bG[D.a],O=bG[D.b],P=bG[D.c],bk[_]=N.x,bk[_+1]=N.y,bk[_+2]=N.z,bk[_+3]=N.w,bk[_+4]=O.x,bk[_+5]=O.y,bk[_+6]=O.z,bk[_+7]=O.w,bk[_+8]=P.x,bk[_+9]=P.y,bk[_+10]=P.z,bk[_+11]=P.w,N=bF[D.a],O=bF[D.b],P=bF[D.c],bj[_]=N.x,bj[_+1]=N.y,bj[_+2]=N.z,bj[_+3]=N.w,bj[_+4]=O.x,bj[_+5]=O.y,bj[_+6]=O.z,bj[_+7]=O.w,bj[_+8]=P.x,bj[_+9]=P.y,bj[_+10]=P.z,bj[_+11]=P.w,N=bD[D.a],O=bD[D.b],P=bD[D.c],bh[_]=N.x,bh[_+1]=N.y,bh[_+2]=N.z,bh[_+3]=1,bh[_+4]=O.x,bh[_+5]=O.y,bh[_+6]=O.z,bh[_+7]=1,bh[_+8]=P.x,bh[_+9]=P.y,bh[_+10]=P.z,bh[_+11]=1,N=bE[D.a],O=bE[D.b],P=bE[D.c],bi[_]=N.x,bi[_+1]=N.y,bi[_+2]=N.z,bi[_+3]=1,bi[_+4]=O.x,bi[_+5]=O.y,bi[_+6]=O.z,bi[_+7]=1,bi[_+8]=P.x,bi[_+9]=P.y,bi[_+10]=P.z,bi[_+11]=1,_+=12),bw&&q&&(F.length==3&&q==a.VertexColors?(D=F[0],N=F[1],O=F[2]):O=N=D=G,bg[$]=D.r,bg[$+1]=D.g,bg[$+2]=D.b,bg[$+3]=N.r,bg[$+4]=N.g,bg[$+5]=N.b,bg[$+6]=O.r,bg[$+7]=O.g,bg[$+8]=O.b,$+=9),bv&&bq.hasTangents&&(F=H[0],G=H[1],D=H[2],bf[Y]=F.x,bf[Y+1]=F.y,bf[Y+2]=F.z,bf[Y+3]=F.w,bf[Y+4]=G.x,bf[Y+5]=G.y,bf[Y+6]=G.z,bf[Y+7]=G.w,bf[Y+8]=D.x,bf[Y+9]=D.y,bf[Y+10]=D.z,bf[Y+11]=D.w,Y+=12);if(bu&&t)if(C.length==3&&bp)for(H=0;H<3;H++)E=C[H],be[X]=E.x,be[X+1]=E.y,be[X+2]=E.z,X+=3;else for(H=0;H<3;H++)be[X]=E.x,be[X+1]=E.y,be[X+2]=E.z,X+=3;if(bt&&o!==void 0&&n)for(H=0;H<3;H++)C=o[H],bc[U]=C.u,bc[U+1]=C.v,U+=2;if(bt&&u!==void 0&&n)for(H=0;H<3;H++)C=u[H],bd[V]=C.u,bd[V+1]=C.v,V+=2;bs&&(bn[W]=S,bn[W+1]=S+1,bn[W+2]=S+2,W+=3,bo[Z]=S,bo[Z+1]=S+1,bo[Z+2]=S,bo[Z+3]=S+2,bo[Z+4]=S+1,bo[Z+5]=S+2,Z+=6,S+=3)}else if(D instanceof a.Face4){br&&(A=by[D.a].position,K=by[D.b].position,L=by[D.c].position,M=by[D.d].position,bb[T]=A.x,bb[T+1]=A.y,bb[T+2]=A.z,bb[T+3]=K.x,bb[T+4]=K.y,bb[T+5]=K.z,bb[T+6]=L.x,bb[T+7]=L.y,bb[T+8]=L.z,bb[T+9]=M.x,bb[T+10]=M.y,bb[T+11]=M.z,T+=12);if(bm)for(R in bm)if(O=bm[R],O.__original.needsUpdate)N=O.offset,P=O.offsetSrc,O.size===1?(O.boundTo===void 0||O.boundTo==="vertices"?(O.array[N]=O.value[D.a],O.array[N+1]=O.value[D.b],O.array[N+2]=O.value[D.c],O.array[N+3]=O.value[D.d]):O.boundTo==="faces"?(P=O.value[P],O.array[N]=P,O.array[N+1]=P,O.array[N+2]=P,O.array[N+3]=P,O.offsetSrc++):O.boundTo==="faceVertices"&&(O.array[N]=O.value[P],O.array[N+1]=O.value[P+1],O.array[N+2]=O.value[P+2],O.array[N+3]=O.value[P+3],O.offsetSrc+=4),O.offset+=4):(O.boundTo===void 0||O.boundTo==="vertices"?(A=O.value[D.a],K=O.value[D.b],L=O.value[D.c],M=O.value[D.d]):O.boundTo==="faces"?(M=L=K=A=P=O.value[P],O.offsetSrc++):O.boundTo==="faceVertices"&&(A=O.value[P],K=O.value[P+1],L=O.value[P+2],M=O.value[P+3],O.offsetSrc+=4),O.size===2?(O.array[N]=A.x,O.array[N+1]=A.y,O.array[N+2]=K.x,O.array[N+3]=K.y,O.array[N+4]=L.x,O.array[N+5]=L.y,O.array[N+6]=M.x,O.array[N+7]=M.y,O.offset+=8):O.size===3?(O.type==="c"?(O.array[N]=A.r,O.array[N+1]=A.g,O.array[N+2]=A.b,O.array[N+3]=K.r,O.array[N+4]=K.g,O.array[N+5]=K.b,O.array[N+6]=L.r,O.array[N+7]=L.g,O.array[N+8]=L.b,O.array[N+9]=M.r,O.array[N+10]=M.g,O.array[N+11]=M.b):(O.array[N]=A.x,O.array[N+1]=A.y,O.array[N+2]=A.z,O.array[N+3]=K.x,O.array[N+4]=K.y,O.array[N+5]=K.z,O.array[N+6]=L.x,O.array[N+7]=L.y,O.array[N+8]=L.z,O.array[N+9]=M.x,O.array[N+10]=M.y,O.array[N+11]=M.z),O.offset+=12):(O.array[N]=A.x,O.array[N+1]=A.y,O.array[N+2]=A.z,O.array[N+3]=A.w,O.array[N+4]=K.x,O.array[N+5]=K.y,O.array[N+6]=K.z,O.array[N+7]=K.w,O.array[N+8]=L.x,O.array[N+9]=L.y,O.array[N+10]=L.z,O.array[N+11]=L.w,O.array[N+12]=M.x,O.array[N+13]=M.y,O.array[N+14]=M.z,O.array[N+15]=M.w,O.offset+=16));if(bx){N=0;for(O=bH.length;N<O;N++)A=bH[N].vertices[D.a].position,K=bH[N].vertices[D.b].position,L=bH[N].vertices[D.c].position,M=bH[N].vertices[D.d].position,P=bl[N],P[ba]=A.x,P[ba+1]=A.y,P[ba+2]=A.z,P[ba+3]=K.x,P[ba+4]=K.y,P[ba+5]=K.z,P[ba+6]=L.x,P[ba+7]=L.y,P[ba+8]=L.z,P[ba+9]=M.x,P[ba+10]=M.y,P[ba+11]=M.z;ba+=12}bG.length&&(N=bG[D.a],O=bG[D.b],P=bG[D.c],Q=bG[D.d],bk[_]=N.x,bk[_+1]=N.y,bk[_+2]=N.z,bk[_+3]=N.w,bk[_+4]=O.x,bk[_+5]=O.y,bk[_+6]=O.z,bk[_+7]=O.w,bk[_+8]=P.x,bk[_+9]=P.y,bk[_+10]=P.z,bk[_+11]=P.w,bk[_+12]=Q.x,bk[_+13]=Q.y,bk[_+14]=Q.z,bk[_+15]=Q.w,N=bF[D.a],O=bF[D.b],P=bF[D.c],Q=bF[D.d],bj[_]=N.x,bj[_+1]=N.y,bj[_+2]=N.z,bj[_+3]=N.w,bj[_+4]=O.x,bj[_+5]=O.y,bj[_+6]=O.z,bj[_+7]=O.w,bj[_+8]=P.x,bj[_+9]=P.y,bj[_+10]=P.z,bj[_+11]=P.w,bj[_+12]=Q.x,bj[_+13]=Q.y,bj[_+14]=Q.z,bj[_+15]=Q.w,N=bD[D.a],O=bD[D.b],P=bD[D.c],Q=bD[D.d],bh[_]=N.x,bh[_+1]=N.y,bh[_+2]=N.z,bh[_+3]=1,bh[_+4]=O.x,bh[_+5]=O.y,bh[_+6]=O.z,bh[_+7]=1,bh[_+8]=P.x,bh[_+9]=P.y,bh[_+10]=P.z,bh[_+11]=1,bh[_+12]=Q.x,bh[_+13]=Q.y,bh[_+14]=Q.z,bh[_+15]=1,N=bE[D.a],O=bE[D.b],P=bE[D.c],D=bE[D.d],bi[_]=N.x,bi[_+1]=N.y,bi[_+2]=N.z,bi[_+3]=1,bi[_+4]=O.x,bi[_+5]=O.y,bi[_+6]=O.z,bi[_+7]=1,bi[_+8]=P.x,bi[_+9]=P.y,bi[_+10]=P.z,bi[_+11]=1,bi[_+12]=D.x,bi[_+13]=D.y,bi[_+14]=D.z,bi[_+15]=1,_+=16),bw&&q&&(F.length==4&&q==a.VertexColors?(D=F[0],N=F[1],O=F[2],F=F[3]):F=O=N=D=G,bg[$]=D.r,bg[$+1]=D.g,bg[$+2]=D.b,bg[$+3]=N.r,bg[$+4]=N.g,bg[$+5]=N.b,bg[$+6]=O.r,bg[$+7]=O.g,bg[$+8]=O.b,bg[$+9]=F.r,bg[$+10]=F.g,bg[$+11]=F.b,$+=12),bv&&bq.hasTangents&&(F=H[0],G=H[1],D=H[2],H=H[3],bf[Y]=F.x,bf[Y+1]=F.y,bf[Y+2]=F.z,bf[Y+3]=F.w,bf[Y+4]=G.x,bf[Y+5]=G.y,bf[Y+6]=G.z,bf[Y+7]=G.w,bf[Y+8]=D.x,bf[Y+9]=D.y,bf[Y+10]=D.z,bf[Y+11]=D.w,bf[Y+12]=H.x,bf[Y+13]=H.y,bf[Y+14]=H.z,bf[Y+15]=H.w,Y+=16);if(bu&&t)if(C.length==4&&bp)for(H=0;H<4;H++)E=C[H],be[X]=E.x,be[X+1]=E.y,be[X+2]=E.z,X+=3;else for(H=0;H<4;H++)be[X]=E.x,be[X+1]=E.y,be[X+2]=E.z,X+=3;if(bt&&o!==void 0&&n)for(H=0;H<4;H++)C=o[H],bc[U]=C.u,bc[U+1]=C.v,U+=2;if(bt&&u!==void 0&&n)for(H=0;H<4;H++)C=u[H],bd[V]=C.u,bd[V+1]=C.v,V+=2;bs&&(bn[W]=S,bn[W+1]=S+1,bn[W+2]=S+3,bn[W+3]=S+1,bn[W+4]=S+2,bn[W+5]=S+3,W+=6,bo[Z]=S,bo[Z+1]=S+1,bo[Z+2]=S,bo[Z+3]=S+3,bo[Z+4]=S+1,bo[Z+5]=S+2,bo[Z+6]=S+2,bo[Z+7]=S+3,Z+=8,S+=4)}br&&(J.bindBuffer(J.ARRAY_BUFFER,k.__webglVertexBuffer),J.bufferData(J.ARRAY_BUFFER,bb,r));if(bm)for(R in bm)O=bm[R],O.__original.needsUpdate&&(J.bindBuffer(J.ARRAY_BUFFER,O.buffer),J.bufferData(J.ARRAY_BUFFER,O.array,r));if(bx){N=0;for(O=bH.length;N<O;N++)J.bindBuffer(J.ARRAY_BUFFER,k.__webglMorphTargetsBuffers[N]),J.bufferData(J.ARRAY_BUFFER,bl[N],r)}bw&&$>0&&(J.bindBuffer(J.ARRAY_BUFFER,k.__webglColorBuffer),J.bufferData(J.ARRAY_BUFFER,bg,r)),bu&&(J.bindBuffer(J.ARRAY_BUFFER,k.__webglNormalBuffer),J.bufferData(J.ARRAY_BUFFER,be,r)),bv&&bq.hasTangents&&(J.bindBuffer(J.ARRAY_BUFFER,k.__webglTangentBuffer),J.bufferData(J.ARRAY_BUFFER,bf,r)),bt&&U>0&&(J.bindBuffer(J.ARRAY_BUFFER,k.__webglUVBuffer),J.bufferData(J.ARRAY_BUFFER,bc,r)),bt&&V>0&&(J.bindBuffer(J.ARRAY_BUFFER,k.__webglUV2Buffer),J.bufferData(J.ARRAY_BUFFER,bd,r)),bs&&(J.bindBuffer(J.ELEMENT_ARRAY_BUFFER,k.__webglFaceBuffer),J.bufferData(J.ELEMENT_ARRAY_BUFFER,bn,r),J.bindBuffer(J.ELEMENT_ARRAY_BUFFER,k.__webglLineBuffer),J.bufferData(J.ELEMENT_ARRAY_BUFFER,bo,r)),_>0&&(J.bindBuffer(J.ARRAY_BUFFER,k.__webglSkinVertexABuffer),J.bufferData(J.ARRAY_BUFFER,bh,r),J.bindBuffer(J.ARRAY_BUFFER,k.__webglSkinVertexBBuffer),J.bufferData(J.ARRAY_BUFFER,bi,r),J.bindBuffer(J.ARRAY_BUFFER,k.__webglSkinIndicesBuffer),J.bufferData(J.ARRAY_BUFFER,bj,r),J.bindBuffer(J.ARRAY_BUFFER,k.__webglSkinWeightsBuffer),J.bufferData(J.ARRAY_BUFFER,bk,r)),s&&(delete k.__inittedArrays,delete k.__colorArray,delete k.__normalArray,delete k.__tangentArray,delete k.__uvArray,delete k.__uv2Array,delete k.__faceArray,delete k.__vertexArray,delete k.__lineArray,delete k.__skinVertexAArray,delete k.__skinVertexBArray,delete k.__skinIndexArray,delete k.__skinWeightArray)}f.__dirtyVertices=!1,f.__dirtyMorphTargets=!1,f.__dirtyElements=!1,f.__dirtyUvs=!1,f.__dirtyNormals=!1,f.__dirtyTangents=!1,f.__dirtyColors=!1,w(h)}else if(g instanceof a.Ribbon){f=g.geometry;if(f.__dirtyVertices||f.__dirtyColors){g=f,h=J.DYNAMIC_DRAW,i=p=s=s=void 0,m=g.vertices,j=g.colors,n=m.length,k=j.length,q=g.__vertexArray,r=g.__colorArray,t=g.__dirtyColors;if(g.__dirtyVertices){for(s=0;s<n;s++)p=m[s].position,i=s*3,q[i]=p.x,q[i+1]=p.y,q[i+2]=p.z;J.bindBuffer(J.ARRAY_BUFFER,g.__webglVertexBuffer),J.bufferData(J.ARRAY_BUFFER,q,h)}if(t){for(s=0;s<k;s++)color=j[s],i=s*3,r[i]=color.r,r[i+1]=color.g,r[i+2]=color.b;J.bindBuffer(J.ARRAY_BUFFER,g.__webglColorBuffer),J.bufferData(J.ARRAY_BUFFER,r,h)}}f.__dirtyVertices=!1,f.__dirtyColors=!1}else if(g instanceof a.Line){f=g.geometry;if(f.__dirtyVertices||f.__dirtyColors){g=f,h=J.DYNAMIC_DRAW,i=p=s=s=void 0,m=g.vertices,j=g.colors,n=m.length,k=j.length,q=g.__vertexArray,r=g.__colorArray,t=g.__dirtyColors;if(g.__dirtyVertices){for(s=0;s<n;s++)p=m[s].position,i=s*3,q[i]=p.x,q[i+1]=p.y,q[i+2]=p.z;J.bindBuffer(J.ARRAY_BUFFER,g.__webglVertexBuffer),J.bufferData(J.ARRAY_BUFFER,q,h)}if(t){for(s=0;s<k;s++)color=j[s],i=s*3,r[i]=color.r,r[i+1]=color.g,r[i+2]=color.b;J.bindBuffer(J.ARRAY_BUFFER,g.__webglColorBuffer),J.bufferData(J.ARRAY_BUFFER,r,h)}}f.__dirtyVertices=!1,f.__dirtyColors=!1}else g instanceof a.ParticleSystem&&(f=g.geometry,k=v(f),(f.__dirtyVertices||f.__dirtyColors||g.sortParticles||k)&&c(f,J.DYNAMIC_DRAW,g),f.__dirtyVertices=!1,f.__dirtyColors=!1,w(f))},this.setFaceCulling=function(a,b){a?(!b||b=="ccw"?J.frontFace(J.CCW):J.frontFace(J.CW),a=="back"?J.cullFace(J.BACK):a=="front"?J.cullFace(J.FRONT):J.cullFace(J.FRONT_AND_BACK),J.enable(J.CULL_FACE)):J.disable(J.CULL_FACE)},this.supportsVertexTextures=function(){return bt}},a.WebGLRenderTarget=function(b,c,d){this.width=b,this.height=c,d=d||{},this.wrapS=d.wrapS!==void 0?d.wrapS:a.ClampToEdgeWrapping,this.wrapT=d.wrapT!==void 0?d.wrapT:a.ClampToEdgeWrapping,this.magFilter=d.magFilter!==void 0?d.magFilter:a.LinearFilter,this.minFilter=d.minFilter!==void 0?d.minFilter:a.LinearMipMapLinearFilter,this.offset=new a.Vector2(0,0),this.repeat=new a.Vector2(1,1),this.format=d.format!==void 0?d.format:a.RGBAFormat,this.type=d.type!==void 0?d.type:a.UnsignedByteType,this.depthBuffer=d.depthBuffer!==void 0?d.depthBuffer:!0,this.stencilBuffer=d.stencilBuffer!==void 0?d.stencilBuffer:!0},a.WebGLRenderTarget.prototype.clone=function(){var b=new a.WebGLRenderTarget(this.width,this.height);return b.wrapS=this.wrapS,b.wrapT=this.wrapT,b.magFilter=this.magFilter,b.minFilter=this.minFilter,b.offset.copy(this.offset),b.repeat.copy(this.repeat),b.format=this.format,b.type=this.type,b.depthBuffer=this.depthBuffer,b.stencilBuffer=this.stencilBuffer,b},a.WebGLRenderTargetCube=function(b,c,d){a.WebGLRenderTarget.call(this,b,c,d),this.activeCubeFace=0},a.WebGLRenderTargetCube.prototype=new a.WebGLRenderTarget,a.WebGLRenderTargetCube.prototype.constructor=a.WebGLRenderTargetCube,a.RenderableVertex=function(){this.positionWorld=new a.Vector3,this.positionScreen=new a.Vector4,this.visible=!0},a.RenderableVertex.prototype.copy=function(a){this.positionWorld.copy(a.positionWorld),this.positionScreen.copy(a.positionScreen)},a.RenderableFace3=function(){this.v1=new a.RenderableVertex,this.v2=new a.RenderableVertex,this.v3=new a.RenderableVertex,this.centroidWorld=new a.Vector3,this.centroidScreen=new a.Vector3,this.normalWorld=new a.Vector3,this.vertexNormalsWorld=[new a.Vector3,new a.Vector3,new a.Vector3],this.faceMaterials=this.meshMaterials=null,this.overdraw=!1,this.uvs=[[]],this.z=null},a.RenderableFace4=function(){this.v1=new a.RenderableVertex,this.v2=new a.RenderableVertex,this.v3=new a.RenderableVertex,this.v4=new a.RenderableVertex,this.centroidWorld=new a.Vector3,this.centroidScreen=new a.Vector3,this.normalWorld=new a.Vector3,this.vertexNormalsWorld=[new a.Vector3,new a.Vector3,new a.Vector3,new a.Vector3],this.faceMaterials=this.meshMaterials=null,this.overdraw=!1,this.uvs=[[]],this.z=null},a.RenderableObject=function(){this.z=this.object=null},a.RenderableParticle=function(){this.rotation=this.z=this.y=this.x=null,this.scale=new a.Vector2,this.materials=null},a.RenderableLine=function(){this.z=null,this.v1=new a.RenderableVertex,this.v2=new a.RenderableVertex,this.materials=null},a.ColorUtils={adjustHSV:function(b,c,d,e){var f=a.ColorUtils.__hsv;a.ColorUtils.rgbToHsv(b,f),f.h=a.ColorUtils.clamp(f.h+c,0,1),f.s=a.ColorUtils.clamp(f.s+d,0,1),f.v=a.ColorUtils.clamp(f.v+e,0,1),b.setHSV(f.h,f.s,f.v)},rgbToHsv:function(a,b){var c=a.r,d=a.g,e=a.b,f=Math.max(Math.max(c,d),e),g=Math.min(Math.min(c,d),e);if(g==f)g=c=0;else{var h=f-g,g=h/f,c=c==f?(d-e)/h:d==f?2+(e-c)/h:4+(c-d)/h;c/=6,c<0&&(c+=1),c>1&&(c-=1)}return b===void 0&&(b={h:0,s:0,v:0}),b.h=c,b.s=g,b.v=f,b},clamp:function(a,b,c){return a<b?b:a>c?c:a}},a.ColorUtils.__hsv={h:0,s:0,v:0},a.GeometryUtils={merge:function(b,c){var d,e,f=b.vertices.length,g=c instanceof a.Mesh?c.geometry:c,h=b.vertices,i=g.vertices,j=b.faces,k=g.faces,l=b.faceVertexUvs[0],g=g.faceVertexUvs[0];c instanceof a.Mesh&&(c.matrixAutoUpdate&&c.updateMatrix(),d=c.matrix,e=new a.Matrix4,e.extractRotation(d,c.scale));for(var m=0,n=i.length;m<n;m++){var o=new a.Vertex(i[m].position.clone());d&&d.multiplyVector3(o.position),h.push(o)}m=0;for(n=k.length;m<n;m++){var o=k[m],p,q,r=o.vertexNormals,s=o.vertexColors;o instanceof a.Face3?p=new a.Face3(o.a+f,o.b+f,o.c+f):o instanceof a.Face4&&(p=new a.Face4(o.a+f,o.b+f,o.c+f,o.d+f)),p.normal.copy(o.normal),e&&e.multiplyVector3(p.normal),h=0;for(i=r.length;h<i;h++)q=r[h].clone(),e&&e.multiplyVector3(q),p.vertexNormals.push(q);p.color.copy(o.color),h=0;for(i=s.length;h<i;h++)q=s[h],p.vertexColors.push(q.clone());p.materials=o.materials.slice(),p.centroid.copy(o.centroid),d&&d.multiplyVector3(p.centroid),j.push(p)}m=0;for(n=g.length;m<n;m++){d=g[m],e=[],h=0;for(i=d.length;h<i;h++)e.push(new a.UV(d[h].u,d[h].v));l.push(e)}},clone:function(b){var c=new a.Geometry,d,e=b.vertices,f=b.faces,g=b.faceVertexUvs[0],b=0;for(d=e.length;b<d;b++){var h=new a.Vertex(e[b].position.clone());c.vertices.push(h)}b=0;for(d=f.length;b<d;b++){var i=f[b],j,k,l=i.vertexNormals,m=i.vertexColors;i instanceof a.Face3?j=new a.Face3(i.a,i.b,i.c):i instanceof a.Face4&&(j=new a.Face4(i.a,i.b,i.c,i.d)),j.normal.copy(i.normal),e=0;for(h=l.length;e<h;e++)k=l[e],j.vertexNormals.push(k.clone());j.color.copy(i.color),e=0;for(h=m.length;e<h;e++)k=m[e],j.vertexColors.push(k.clone());j.materials=i.materials.slice(),j.centroid.copy(i.centroid),c.faces.push(j)}b=0;for(d=g.length;b<d;b++){f=g[b],j=[],e=0;for(h=f.length;e<h;e++)j.push(new a.UV(f[e].u,f[e].v));c.faceVertexUvs[0].push(j)}return c},randomPointInTriangle:function(b,c,d){var e,f,g,h=new a.Vector3,i=a.GeometryUtils.__v1;return e=a.GeometryUtils.random(),f=a.GeometryUtils.random(),e+f>1&&(e=1-e,f=1-f),g=1-e-f,h.copy(b),h.multiplyScalar(e),i.copy(c),i.multiplyScalar(f),h.addSelf(i),i.copy(d),i.multiplyScalar(g),h.addSelf(i),h},randomPointInFace:function(b,c,d){var e,f,g;if(b instanceof a.Face3)return e=c.vertices[b.a].position,f=c.vertices[b.b].position,g=c.vertices[b.c].position,a.GeometryUtils.randomPointInTriangle(e,f,g);if(b instanceof a.Face4){e=c.vertices[b.a].position,f=c.vertices[b.b].position,g=c.vertices[b.c].position;var c=c.vertices[b.d].position,h;return d?b._area1&&b._area2?(d=b._area1,h=b._area2):(d=a.GeometryUtils.triangleArea(e,f,c),h=a.GeometryUtils.triangleArea(f,g,c),b._area1=d,b._area2=h):(d=a.GeometryUtils.triangleArea(e,f,c),h=a.GeometryUtils.triangleArea(f,g,c)),a.GeometryUtils.random()*(d+h)<d?a.GeometryUtils.randomPointInTriangle(e,f,c):a.GeometryUtils.randomPointInTriangle(f,g,c)}},randomPointsInGeometry:function(b,c){function d(a){function b(c,d){if(d<c)return c;var e=c+Math.floor((d-c)/2);return k[e]>a?b(c,e-1):k[e]<a?b(e+1,d):e}return b(0,k.length-1)}var e,f,g=b.faces,h=b.vertices,i=g.length,j=0,k=[],l,m,n,o;for(f=0;f<i;f++)e=g[f],e instanceof a.Face3?(l=h[e.a].position,m=h[e.b].position,n=h[e.c].position,e._area=a.GeometryUtils.triangleArea(l,m,n)):e instanceof a.Face4&&(l=h[e.a].position,m=h[e.b].position,n=h[e.c].position,o=h[e.d].position,e._area1=a.GeometryUtils.triangleArea(l,m,o),e._area2=a.GeometryUtils.triangleArea(m,n,o),e._area=e._area1+e._area2),j+=e._area,k[f]=j;e=[],h={};for(f=0;f<c;f++)i=a.GeometryUtils.random()*j,i=d(i),e[f]=a.GeometryUtils.randomPointInFace(g[i],b,!0),h[i]?h[i]+=1:h[i]=1;return e},triangleArea:function(b,c,d){var e,f=a.GeometryUtils.__v1;return f.sub(b,c),e=f.length(),f.sub(b,d),b=f.length(),f.sub(c,d),d=f.length(),c=.5*(e+b+d),Math.sqrt(c*(c-e)*(c-b)*(c-d))},random16:function(){return(65280*Math.random()+255*Math.random())/65535},center:function(b){b.computeBoundingBox();var c=new a.Matrix4;c.setTranslation(-0.5*(b.boundingBox.x[1]+b.boundingBox.x[0]),-0.5*(b.boundingBox.y[1]+b.boundingBox.y[0]),-0.5*(b.boundingBox.z[1]+b.boundingBox.z[0])),b.applyMatrix(c),b.computeBoundingBox()}},a.GeometryUtils.random=a.GeometryUtils.random16,a.GeometryUtils.__v1=new a.Vector3,a.ImageUtils={loadTexture:function(b,c,d){var e=new Image,f=new a.Texture(e,c);return e.onload=function(){f.needsUpdate=!0,d&&d(this)},e.crossOrigin="",e.src=b,f},loadTextureCube:function(b,c,d){var e,f=[],g=new a.Texture(f,c),c=f.loadCount=0;for(e=b.length;c<e;++c)f[c]=new Image,f[c].onload=function(){f.loadCount+=1,f.loadCount==6&&(g.needsUpdate=!0),d&&d(this)},f[c].crossOrigin="",f[c].src=b[c];return g},getNormalMap:function(a,b){var c=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return[a[0]/b,a[1]/b,a[2]/b]};b|=1;var d=a.width,e=a.height,f=document.createElement("canvas");f.width=d,f.height=e;var g=f.getContext("2d");g.drawImage(a,0,0);for(var h=g.getImageData(0,0,d,e).data,i=g.createImageData(d,e),j=i.data,k=0;k<d;k++)for(var l=1;l<e;l++){var m=l-1<0?e-1:l-1,n=(l+1)%e,o=k-1<0?d-1:k-1,p=(k+1)%d,q=[],r=[0,0,h[(l*d+k)*4]/255*b];q.push([-1,0,h[(l*d+o)*4]/255*b]),q.push([-1,-1,h[(m*d+o)*4]/255*b]),q.push([0,-1,h[(m*d+k)*4]/255*b]),q.push([1,-1,h[(m*d+p)*4]/255*b]),q.push([1,0,h[(l*d+p)*4]/255*b]),q.push([1,1,h[(n*d+p)*4]/255*b]),q.push([0,1,h[(n*d+k)*4]/255*b]),q.push([-1,1,h[(n*d+o)*4]/255*b]),m=[],o=q.length;for(n=0;n<o;n++){var p=q[n],s=q[(n+1)%o],p=[p[0]-r[0],p[1]-r[1],p[2]-r[2]],s=[s[0]-r[0],s[1]-r[1],s[2]-r[2]];m.push(c([p[1]*s[2]-p[2]*s[1],p[2]*s[0]-p[0]*s[2],p[0]*s[1]-p[1]*s[0]]))}q=[0,0,0];for(n=0;n<m.length;n++)q[0]+=m[n][0],q[1]+=m[n][1],q[2]+=m[n][2];q[0]/=m.length,q[1]/=m.length,q[2]/=m.length,r=(l*d+k)*4,j[r]=(q[0]+1)/2*255|0,j[r+1]=(q[1]+.5)*255|0,j[r+2]=q[2]*255|0,j[r+3]=255}return g.putImageData(i,0,0),f}},a.SceneUtils={showHierarchy:function(b,c){a.SceneUtils.traverseHierarchy(b,function(a){a.visible=c})},traverseHierarchy:function(b,c){var d,e,f=b.children.length;for(e=0;e<f;e++)d=b.children[e],c(d),a.SceneUtils.traverseHierarchy(d,c)}},a.WebGLRenderer&&(a.ShaderUtils={lib:{fresnel:{uniforms:{mRefractionRatio:{type:"f",value:1.02},mFresnelBias:{type:"f",value:.1},mFresnelPower:{type:"f",value:2},mFresnelScale:{type:"f",value:1},tCube:{type:"t",value:1,texture:null}},fragmentShader:"uniform samplerCube tCube;\nvarying vec3 vReflect;\nvarying vec3 vRefract[3];\nvarying float vReflectionFactor;\nvoid main() {\nvec4 reflectedColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );\nvec4 refractedColor = vec4( 1.0, 1.0, 1.0, 1.0 );\nrefractedColor.r = textureCube( tCube, vec3( -vRefract[0].x, vRefract[0].yz ) ).r;\nrefractedColor.g = textureCube( tCube, vec3( -vRefract[1].x, vRefract[1].yz ) ).g;\nrefractedColor.b = textureCube( tCube, vec3( -vRefract[2].x, vRefract[2].yz ) ).b;\nrefractedColor.a = 1.0;\ngl_FragColor = mix( refractedColor, reflectedColor, clamp( vReflectionFactor, 0.0, 1.0 ) );\n}",vertexShader:"uniform float mRefractionRatio;\nuniform float mFresnelBias;\nuniform float mFresnelScale;\nuniform float mFresnelPower;\nvarying vec3 vReflect;\nvarying vec3 vRefract[3];\nvarying float vReflectionFactor;\nvoid main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvec4 mPosition = objectMatrix * vec4( position, 1.0 );\nvec3 nWorld = normalize ( mat3( objectMatrix[0].xyz, objectMatrix[1].xyz, objectMatrix[2].xyz ) * normal );\nvec3 I = mPosition.xyz - cameraPosition;\nvReflect = reflect( I, nWorld );\nvRefract[0] = refract( normalize( I ), nWorld, mRefractionRatio );\nvRefract[1] = refract( normalize( I ), nWorld, mRefractionRatio * 0.99 );\nvRefract[2] = refract( normalize( I ), nWorld, mRefractionRatio * 0.98 );\nvReflectionFactor = mFresnelBias + mFresnelScale * pow( 1.0 + dot( normalize( I ), nWorld ), mFresnelPower );\ngl_Position = projectionMatrix * mvPosition;\n}"},normal:{uniforms:a.UniformsUtils.merge([a.UniformsLib.fog,a.UniformsLib.lights,a.UniformsLib.shadowmap,{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},tDiffuse:{type:"t",value:0,texture:null},tCube:{type:"t",value:1,texture:null},tNormal:{type:"t",value:2,texture:null},tSpecular:{type:"t",value:3,texture:null},tAO:{type:"t",value:4,texture:null},tDisplacement:{type:"t",value:5,texture:null},uNormalScale:{type:"f",value:1},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new a.Color(15658734)},uSpecularColor:{type:"c",value:new a.Color(1118481)},uAmbientColor:{type:"c",value:new a.Color(328965)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},uReflectivity:{type:"f",value:.5},uOffset:{type:"v2",value:new a.Vector2(0,0)},uRepeat:{type:"v2",value:new a.Vector2(1,1)}}]),fragmentShader:["uniform vec3 uAmbientColor;\nuniform vec3 uDiffuseColor;\nuniform vec3 uSpecularColor;\nuniform float uShininess;\nuniform float uOpacity;\nuniform bool enableDiffuse;\nuniform bool enableSpecular;\nuniform bool enableAO;\nuniform bool enableReflection;\nuniform sampler2D tDiffuse;\nuniform sampler2D tNormal;\nuniform sampler2D tSpecular;\nuniform sampler2D tAO;\nuniform samplerCube tCube;\nuniform float uNormalScale;\nuniform float uReflectivity;\nvarying vec3 vTangent;\nvarying vec3 vBinormal;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nuniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nvarying vec4 vPointLight[ MAX_POINT_LIGHTS ];\n#endif\nvarying vec3 vViewPosition;",a.ShaderChunk.shadowmap_pars_fragment,a.ShaderChunk.fog_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3( 1.0 ), uOpacity );\nvec3 specularTex = vec3( 1.0 );\nvec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;\nnormalTex.xy *= uNormalScale;\nnormalTex = normalize( normalTex );\nif( enableDiffuse )\ngl_FragColor = gl_FragColor * texture2D( tDiffuse, vUv );\nif( enableAO )\ngl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, vUv ).xyz;\nif( enableSpecular )\nspecularTex = texture2D( tSpecular, vUv ).xyz;\nmat3 tsb = mat3( vTangent, vBinormal, vNormal );\nvec3 finalNormal = tsb * normalTex;\nvec3 normal = normalize( finalNormal );\nvec3 viewPosition = normalize( vViewPosition );\n#if MAX_POINT_LIGHTS > 0\nvec3 pointDiffuse = vec3( 0.0 );\nvec3 pointSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec3 pointVector = normalize( vPointLight[ i ].xyz );\nvec3 pointHalfVector = normalize( vPointLight[ i ].xyz + viewPosition );\nfloat pointDistance = vPointLight[ i ].w;\nfloat pointDotNormalHalf = dot( normal, pointHalfVector );\nfloat pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );\nfloat pointSpecularWeight = 0.0;\nif ( pointDotNormalHalf >= 0.0 )\npointSpecularWeight = specularTex.r * pow( pointDotNormalHalf, uShininess );\npointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;\npointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight;\n}\n#endif\n#if MAX_DIR_LIGHTS > 0\nvec3 dirDiffuse = vec3( 0.0 );\nvec3 dirSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\nvec3 dirHalfVector = normalize( lDirection.xyz + viewPosition );\nfloat dirDotNormalHalf = dot( normal, dirHalfVector );\nfloat dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );\nfloat dirSpecularWeight = 0.0;\nif ( dirDotNormalHalf >= 0.0 )\ndirSpecularWeight = specularTex.r * pow( dirDotNormalHalf, uShininess );\ndirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight;\ndirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight;\n}\n#endif\nvec3 totalDiffuse = vec3( 0.0 );\nvec3 totalSpecular = vec3( 0.0 );\n#if MAX_DIR_LIGHTS > 0\ntotalDiffuse += dirDiffuse;\ntotalSpecular += dirSpecular;\n#endif\n#if MAX_POINT_LIGHTS > 0\ntotalDiffuse += pointDiffuse;\ntotalSpecular += pointSpecular;\n#endif\ngl_FragColor.xyz = gl_FragColor.xyz * totalDiffuse + totalSpecular + ambientLightColor * uAmbientColor;\nif ( enableReflection ) {\nvec3 wPos = cameraPosition - vViewPosition;\nvec3 vReflect = reflect( normalize( wPos ), normal );\nvec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );\ngl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, uReflectivity );\n}",a.ShaderChunk.shadowmap_fragment,a.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;\nuniform vec2 uOffset;\nuniform vec2 uRepeat;\n#ifdef VERTEX_TEXTURES\nuniform sampler2D tDisplacement;\nuniform float uDisplacementScale;\nuniform float uDisplacementBias;\n#endif\nvarying vec3 vTangent;\nvarying vec3 vBinormal;\nvarying vec3 vNormal;\nvarying vec2 vUv;\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\nvarying vec4 vPointLight[ MAX_POINT_LIGHTS ];\n#endif\nvarying vec3 vViewPosition;",a.ShaderChunk.shadowmap_pars_vertex,"void main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvViewPosition = -mvPosition.xyz;\nvNormal = normalize( normalMatrix * normal );\nvTangent = normalize( normalMatrix * tangent.xyz );\nvBinormal = cross( vNormal, vTangent ) * tangent.w;\nvBinormal = normalize( vBinormal );\nvUv = uv * uRepeat + uOffset;\n#if MAX_POINT_LIGHTS > 0\nfor( int i = 0; i < MAX_POINT_LIGHTS; i++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\nvPointLight[ i ] = vec4( lVector, lDistance );\n}\n#endif\n#ifdef VERTEX_TEXTURES\nvec3 dv = texture2D( tDisplacement, uv ).xyz;\nfloat df = uDisplacementScale * dv.x + uDisplacementBias;\nvec4 displacedPosition = vec4( vNormal.xyz * df, 0.0 ) + mvPosition;\ngl_Position = projectionMatrix * displacedPosition;\n#else\ngl_Position = projectionMatrix * mvPosition;\n#endif",a.ShaderChunk.shadowmap_vertex,"}"].join("\n")},cube:{uniforms:{tCube:{type:"t",value:1,texture:null}},vertexShader:"varying vec3 vViewPosition;\nvoid main() {\nvec4 mPosition = objectMatrix * vec4( position, 1.0 );\nvViewPosition = cameraPosition - mPosition.xyz;\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform samplerCube tCube;\nvarying vec3 vViewPosition;\nvoid main() {\nvec3 wPos = cameraPosition - vViewPosition;\ngl_FragColor = textureCube( tCube, vec3( - wPos.x, wPos.yz ) );\n}"}}}),a.Curve=function(){},a.Curve.prototype.getPoint=function(){return console.log("Warning, getPoint() not implemented!"),null},a.Curve.prototype.getPointAt=function(a){return this.getPoint(this.getUtoTmapping(a))},a.Curve.prototype.getPoints=function(a){a||(a=5);var b,c=[];for(b=0;b<=a;b++)c.push(this.getPoint(b/a));return c},a.Curve.prototype.getSpacedPoints=function(a){a||(a=5);var b,c=[];for(b=0;b<=a;b++)c.push(this.getPointAt(b/a));return c},a.Curve.prototype.getLength=function(){var a=this.getLengths();return a[a.length-1]},a.Curve.prototype.getLengths=function(a){a||(a=200);if(this.cacheArcLengths&&this.cacheArcLengths.length==a+1)return this.cacheArcLengths;var b=[],c,d=this.getPoint(0),e,f=0;b.push(0);for(e=1;e<=a;e++)c=this.getPoint(e/a),f+=c.distanceTo(d),b.push(f),d=c;return this.cacheArcLengths=b},a.Curve.prototype.getUtoTmapping=function(a,b){var c=this.getLengths(),d=0,e=c.length,f;f=b?b:a*c[e-1],time=Date.now();for(var g=0,h=e-1,i;g<=h;)if(d=Math.floor(g+(h-g)/2),i=c[d]-f,i<0)g=d+1;else if(i>0)h=d-1;else{h=d;break}return d=h,c[d]==f?d/(e-1):(g=c[d],c=(d+(f-g)/(c[d+1]-g))/(e-1))},a.Curve.prototype.getNormalVector=function(b){return b=this.getTangent(b),new a.Vector2(-b.y,b.x)},a.Curve.prototype.getTangent=function(b){var c=b-1e-4;b+=1e-4,c<0&&(c=0),b>1&&(b=1);var c=this.getPoint(c),b=this.getPoint(b),d=new a.Vector2;return d.sub(b,c),d.unit()},a.LineCurve=function(b,c){b instanceof a.Vector2?(this.v1=b,this.v2=c):a.LineCurve.oldConstructor.apply(this,arguments)},a.LineCurve.oldConstructor=function(b,c,d,e){this.constructor(new a.Vector2(b,c),new a.Vector2(d,e))},a.LineCurve.prototype=new a.Curve,a.LineCurve.prototype.constructor=a.LineCurve,a.LineCurve.prototype.getPoint=function(b){var c=new a.Vector2;return c.sub(this.v2,this.v1),c.multiplyScalar(b).addSelf(this.v1),c},a.LineCurve.prototype.getPointAt=function(a){return this.getPoint(a)},a.LineCurve.prototype.getTangent=function(){var b=new a.Vector2;return b.sub(this.v2,this.v1),b.normalize(),b},a.QuadraticBezierCurve=function(b,c,d){if(!(c instanceof a.Vector2))var e=Array.prototype.slice.call(arguments),b=new a.Vector2(e[0],e[1]),c=new a.Vector2(e[2],e[3]),d=new a.Vector2(e[4],e[5]);this.v0=b,this.v1=c,this.v2=d},a.QuadraticBezierCurve.prototype=new a.Curve,a.QuadraticBezierCurve.prototype.constructor=a.QuadraticBezierCurve,a.QuadraticBezierCurve.prototype.getPoint=function(b){var c;return c=a.Shape.Utils.b2(b,this.v0.x,this.v1.x,this.v2.x),b=a.Shape.Utils.b2(b,this.v0.y,this.v1.y,this.v2.y),new a.Vector2(c,b)},a.QuadraticBezierCurve.prototype.getTangent=function(b){var c;return c=a.Curve.Utils.tangentQuadraticBezier(b,this.v0.x,this.v1.x,this.v2.x),b=a.Curve.Utils.tangentQuadraticBezier(b,this.v0.y,this.v1.y,this.v2.y),c=new a.Vector2(c,b),c.normalize(),c},a.CubicBezierCurve=function(b,c,d,e){if(!(c instanceof a.Vector2))var f=Array.prototype.slice.call(arguments),b=new a.Vector2(f[0],f[1]),c=new a.Vector2(f[2],f[3]),d=new a.Vector2(f[4],f[5]),e=new a.Vector2(f[6],f[7]);this.v0=b,this.v1=c,this.v2=d,this.v3=e},a.CubicBezierCurve.prototype=new a.Curve,a.CubicBezierCurve.prototype.constructor=a.CubicBezierCurve,a.CubicBezierCurve.prototype.getPoint=function(b){var c;return c=a.Shape.Utils.b3(b,this.v0.x,this.v1.x,this.v2.x,this.v3.x),b=a.Shape.Utils.b3(b,this.v0.y,this.v1.y,this.v2.y,this.v3.y),new a.Vector2(c,b)},a.CubicBezierCurve.prototype.getTangent=function(b){var c;return c=a.Curve.Utils.tangentCubicBezier(b,this.v0.x,this.v1.x,this.v2.x,this.v3.x),b=a.Curve.Utils.tangentCubicBezier(b,this.v0.y,this.v1.y,this.v2.y,this.v3.y),c=new a.Vector2(c,b),c.normalize(),c},a.SplineCurve=function(a){this.points=a},a.SplineCurve.prototype=new a.Curve,a.SplineCurve.prototype.constructor=a.SplineCurve,a.SplineCurve.prototype.getPoint=function(b){var c=new a.Vector2,d=[],e=this.points,f;return f=(e.length-1)*b,b=Math.floor(f),f-=b,d[0]=b==0?b:b-1,d[1]=b,d[2]=b>e.length-2?b:b+1,d[3]=b>e.length-3?b:b+2,c.x=a.Curve.Utils.interpolate(e[d[0]].x,e[d[1]].x,e[d[2]].x,e[d[3]].x,f),c.y=a.Curve.Utils.interpolate(e[d[0]].y,e[d[1]].y,e[d[2]].y,e[d[3]].y,f),c},a.ArcCurve=function(a,b,c,d,e,f){this.aX=a,this.aY=b,this.aRadius=c,this.aStartAngle=d,this.aEndAngle=e,this.aClockwise=f},a.ArcCurve.prototype=new a.Curve,a.ArcCurve.prototype.constructor=a.ArcCurve,a.ArcCurve.prototype.getPoint=function(b){var c=this.aEndAngle-this.aStartAngle;return this.aClockwise||(b=1-b),b=this.aStartAngle+b*c,new a.Vector2(this.aX+this.aRadius*Math.cos(b),this.aY+this.aRadius*Math.sin(b))},a.Curve.Utils={tangentQuadraticBezier:function(a,b,c,d){return 2*(1-a)*(c-b)+2*a*(d-c)},tangentCubicBezier:function(a,b,c,d,e){return-3*b*(1-a)*(1-a)+3*c*(1-a)*(1-a)-6*a*c*(1-a)+6*a*d*(1-a)-3*a*a*d+3*a*a*e},tangentSpline:function(a){return 6*a*a-6*a+(3*a*a-4*a+1)+(-6*a*a+6*a)+(3*a*a-2*a)},interpolate:function(a,b,c,d,e){var a=(c-a)*.5,d=(d-b)*.5,f=e*e;return(2*b-2*c+a+d)*e*f+(-3*b+3*c-2*a-d)*f+a*e+b}},a.Curve.create=function(b,c){return b.prototype=new a.Curve,b.prototype.constructor=b,b.prototype.getPoint=c,b},a.LineCurve3=a.Curve.create(function(a,b){this.v1=a,this.v2=b},function(b){var c=new a.Vector3;return c.sub(v2,v1),c.multiplyScalar(b),c.addSelf(this.v1),c}),a.QuadraticBezierCurve3=a.Curve.create(function(a,b,c){this.v0=a,this.v1=b,this.v2=c},function(b){var c,d;return c=a.Shape.Utils.b2(b,this.v0.x,this.v1.x,this.v2.x),d=a.Shape.Utils.b2(b,this.v0.y,this.v1.y,this.v2.y),b=a.Shape.Utils.b2(b,this.v0.z,this.v1.z,this.v2.z),new a.Vector3(c,d,b)}),a.CubicBezierCurve3=a.Curve.create(function(a,b,c,d){this.v0=a,this.v1=b,this.v2=c,this.v3=d},function(b){var c,d;return c=a.Shape.Utils.b3(b,this.v0.x,this.v1.x,this.v2.x,this.v3.x),d=a.Shape.Utils.b3(b,this.v0.y,this.v1.y,this.v2.y,this.v3.y),b=a.Shape.Utils.b3(b,this.v0.z,this.v1.z,this.v2.z,this.v3.z),new a.Vector3(c,d,b)}),a.SplineCurve3=a.Curve.create(function(a){this.points=a},function(b){var c=new a.Vector3,d=[],e=this.points,f;return f=(e.length-1)*b,b=Math.floor(f),f-=b,d[0]=b==0?b:b-1,d[1]=b,d[2]=b>e.length-2?b:b+1,d[3]=b>e.length-3?b:b+2,c.x=a.Curve.Utils.interpolate(e[d[0]].x,e[d[1]].x,e[d[2]].x,e[d[3]].x,f),c.y=a.Curve.Utils.interpolate(e[d[0]].y,e[d[1]].y,e[d[2]].y,e[d[3]].y,f),c.z=a.Curve.Utils.interpolate(e[d[0]].z,e[d[1]].z,e[d[2]].z,e[d[3]].z,f),c}),a.CurvePath=function(){this.curves=[],this.bends=[]},a.CurvePath.prototype=new a.Curve,a.CurvePath.prototype.constructor=a.CurvePath,a.CurvePath.prototype.add=function(a){this.curves.push(a)},a.CurvePath.prototype.checkConnection=function(){},a.CurvePath.prototype.closePath=function(){},a.CurvePath.prototype.getPoint=function(a){for(var b=a*this.getLength(),c=this.getCurveLengths(),a=0;a<c.length;)if(c[a]<b)a++;else return b=c[a]-b,a=this.curves[a],b=1-b/a.getLength(),a.getPointAt(b);return null},a.CurvePath.prototype.getLength=function(){var a=this.getCurveLengths();return a[a.length-1]},a.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var a=[],b=0,c,d=this.curves.length;for(c=0;c<d;c++)b+=this.curves[c].getLength(),a.push(b);return this.cacheLengths=a},a.CurvePath.prototype.getBoundingBox=function(){var b=this.getPoints(),c,d,e,f;c=d=Number.NEGATIVE_INFINITY,e=f=Number.POSITIVE_INFINITY;var g,h,i,j;j=new a.Vector2,h=0;for(i=b.length;h<i;h++)g=b[h],g.x>c?c=g.x:g.x<e&&(e=g.x),g.y>d?d=g.y:g.y<d&&(f=g.y),j.addSelf(g.x,g.y);return{minX:e,minY:f,maxX:c,maxY:d,centroid:j.divideScalar(i)}},a.CurvePath.prototype.createPointsGeometry=function(a){return this.createGeometry(this.getPoints(a,!0))},a.CurvePath.prototype.createSpacedPointsGeometry=function(a){return this.createGeometry(this.getSpacedPoints(a,!0))},a.CurvePath.prototype.createGeometry=function(b){for(var c=new a.Geometry,d=0;d<b.length;d++)c.vertices.push(new a.Vertex(new a.Vector3(b[d].x,b[d].y,0)));return c},a.CurvePath.prototype.addWrapPath=function(a){this.bends.push(a)},a.CurvePath.prototype.getTransformedPoints=function(a,b){var c=this.getPoints(a),d,e;b||(b=this.bends),d=0;for(e=b.length;d<e;d++)c=this.getWrapPoints(c,b[d]);return c},a.CurvePath.prototype.getTransformedSpacedPoints=function(a,b){var c=this.getSpacedPoints(a),d,e;b||(b=this.bends),d=0;for(e=b.length;d<e;d++)c=this.getWrapPoints(c,b[d]);return c},a.CurvePath.prototype.getWrapPoints=function(a,b){var c=this.getBoundingBox(),d,e,f,g,h,i;d=0;for(e=a.length;d<e;d++)f=a[d],g=f.x,h=f.y,i=g/c.maxX,i=b.getUtoTmapping(i,g),g=b.getPoint(i),h=b.getNormalVector(i).multiplyScalar(h),f.x=g.x+h.x,f.y=g.y+h.y;return a},a.Path=function(b){a.CurvePath.call(this),this.actions=[],b&&this.fromPoints(b)},a.Path.prototype=new a.CurvePath,a.Path.prototype.constructor=a.Path,a.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc"},a.Path.prototype.fromPoints=function(a){this.moveTo(a[0].x,a[0].y);var b,c=a.length;for(b=1;b<c;b++)this.lineTo(a[b].x,a[b].y)},a.Path.prototype.moveTo=function(){var b=Array.prototype.slice.call(arguments);this.actions.push({action:a.PathActions.MOVE_TO,args:b})},a.Path.prototype.lineTo=function(b,c){var d=Array.prototype.slice.call(arguments),e=this.actions[this.actions.length-1].args;this.curves.push(new a.LineCurve(new a.Vector2(e[e.length-2],e[e.length-1]),new a.Vector2(b,c))),this.actions.push({action:a.PathActions.LINE_TO,args:d})},a.Path.prototype.quadraticCurveTo=function(b,c,d,e){var f=Array.prototype.slice.call(arguments),g=this.actions[this.actions.length-1].args;this.curves.push(new a.QuadraticBezierCurve(new a.Vector2(g[g.length-2],g[g.length-1]),new a.Vector2(b,c),new a.Vector2(d,e))),this.actions.push({action:a.PathActions.QUADRATIC_CURVE_TO,args:f})},a.Path.prototype.bezierCurveTo=function(b,c,d,e,f,g){var h=Array.prototype.slice.call(arguments),i=this.actions[this.actions.length-1].args;this.curves.push(new a.CubicBezierCurve(new a.Vector2(i[i.length-2],i[i.length-1]),new a.Vector2(b,c),new a.Vector2(d,e),new a.Vector2(f,g))),this.actions.push({action:a.PathActions.BEZIER_CURVE_TO,args:h})},a.Path.prototype.splineThru=function(b){var c=Array.prototype.slice.call(arguments),d=this.actions[this.actions.length-1].args,d=[new a.Vector2(d[d.length-2],d[d.length-1])];Array.prototype.push.apply(d,b),this.curves.push(new a.SplineCurve(d)),this.actions.push({action:a.PathActions.CSPLINE_THRU,args:c})},a.Path.prototype.arc=function(b,c,d,e,f,g){var h=Array.prototype.slice.call(arguments);this.curves.push(new a.ArcCurve(b,c,d,e,f,g)),this.actions.push({action:a.PathActions.ARC,args:h})},a.Path.prototype.getSpacedPoints=function(a){a||(a=40);for(var b=[],c=0;c<a;c++)b.push(this.getPoint(c/a));return b},a.Path.prototype.getPoints=function(b,c){var b=b||12,d=[],e,f,g,h,i,j,k,l,m,n,o,p,q;e=0;for(f=this.actions.length;e<f;e++)switch(g=this.actions[e],h=g.action,g=g.args,h){case a.PathActions.LINE_TO:d.push(new a.Vector2(g[0],g[1]));break;case a.PathActions.QUADRATIC_CURVE_TO:i=g[2],j=g[3],m=g[0],n=g[1],d.length>0?(h=d[d.length-1],o=h.x,p=h.y):(h=this.actions[e-1].args,o=h[h.length-2],p=h[h.length-1]);for(h=1;h<=b;h++)q=h/b,g=a.Shape.Utils.b2(q,o,m,i),q=a.Shape.Utils.b2(q,p,n,j),d.push(new a.Vector2(g,q));break;case a.PathActions.BEZIER_CURVE_TO:i=g[4],j=g[5],m=g[0],n=g[1],k=g[2],l=g[3],d.length>0?(h=d[d.length-1],o=h.x,p=h.y):(h=this.actions[e-1].args,o=h[h.length-2],p=h[h.length-1]);for(h=1;h<=b;h++)q=h/b,g=a.Shape.Utils.b3(q,o,m,k,i),q=a.Shape.Utils.b3(q,p,n,l,j),d.push(new a.Vector2(g,q));break;case a.PathActions.CSPLINE_THRU:h=this.actions[e-1].args,h=[new a.Vector2(h[h.length-2],h[h.length-1])],q=b*g[0].length,h=h.concat(g[0]),g=new a.SplineCurve(h);for(h=1;h<=q;h++)d.push(g.getPointAt(h/q));break;case a.PathActions.ARC:h=this.actions[e-1].args,i=g[0],j=g[1],k=g[2],m=g[3],q=g[4],n=!!g[5],l=h[h.length-2],o=h[h.length-1],h.length==0&&(l=o=0),p=q-m;var r=b*2;for(h=1;h<=r;h++)q=h/r,n||(q=1-q),q=m+q*p,g=l+i+k*Math.cos(q),q=o+j+k*Math.sin(q),d.push(new a.Vector2(g,q))}return c&&d.push(d[0]),d},a.Path.prototype.transform=function(a,b){return this.getBoundingBox(),this.getWrapPoints(this.getPoints(b),a)},a.Path.prototype.nltransform=function(a,b,c,d,e,f){var g=this.getPoints(),h,i,j,k,l;h=0;for(i=g.length;h<i;h++)j=g[h],k=j.x,l=j.y,j.x=a*k+b*l+c,j.y=d*l+e*k+f;return g},a.Path.prototype.debug=function(b){var c=this.getBoundingBox();b||(b=document.createElement("canvas"),b.setAttribute("width",c.maxX+100),b.setAttribute("height",c.maxY+100),document.body.appendChild(b)),c=b.getContext("2d"),c.fillStyle="white",c.fillRect(0,0,b.width,b.height),c.strokeStyle="black",c.beginPath();var d,e,f,b=0;for(d=this.actions.length;b<d;b++)e=this.actions[b],f=e.args,e=e.action,e!=a.PathActions.CSPLINE_THRU&&c[e].apply(c,f);c.stroke(),c.closePath(),c.strokeStyle="red",e=this.getPoints(),b=0;for(d=e.length;b<d;b++)f=e[b],c.beginPath(),c.arc(f.x,f.y,1.5,0,Math.PI*2,!1),c.stroke(),c.closePath()},a.Path.prototype.toShapes=function(){var b,c,d,e,f=[],g=new a.Path;b=0;for(c=this.actions.length;b<c;b++)d=this.actions[b],e=d.args,d=d.action,d==a.PathActions.MOVE_TO&&g.actions.length!=0&&(f.push(g),g=new a.Path),g[d].apply(g,e);g.actions.length!=0&&f.push(g);if(f.length==0)return[];var h,g=[];if(a.Shape.Utils.isClockWise(f[0].getPoints())){b=0;for(c=f.length;b<c;b++)e=f[b],a.Shape.Utils.isClockWise(e.getPoints())?(h&&g.push(h),h=new a.Shape,h.actions=e.actions,h.curves=e.curves):h.holes.push(e);g.push(h)}else{h=new a.Shape,b=0;for(c=f.length;b<c;b++)e=f[b],a.Shape.Utils.isClockWise(e.getPoints())?(h.actions=e.actions,h.curves=e.curves,g.push(h),h=new a.Shape):h.holes.push(e)}return g},a.Shape=function(){a.Path.apply(this,arguments),this.holes=[]},a.Shape.prototype=new a.Path,a.Shape.prototype.constructor=a.Path,a.Shape.prototype.extrude=function(b){return new a.ExtrudeGeometry(this,b)},a.Shape.prototype.getPointsHoles=function(a){var b,c=this.holes.length,d=[];for(b=0;b<c;b++)d[b]=this.holes[b].getTransformedPoints(a,this.bends);return d},a.Shape.prototype.getSpacedPointsHoles=function(a){var b,c=this.holes.length,d=[];for(b=0;b<c;b++)d[b]=this.holes[b].getTransformedSpacedPoints(a,this.bends);return d},a.Shape.prototype.extractAllPoints=function(a){return{shape:this.getTransformedPoints(a),holes:this.getPointsHoles(a)}},a.Shape.prototype.extractAllSpacedPoints=function(a){return{shape:this.getTransformedSpacedPoints(a),holes:this.getSpacedPointsHoles(a)}},a.Shape.Utils={removeHoles:function(b,c){var d=b.concat(),e=d.concat(),f,g,h,i,j,k,l,m,n,o,p=[];for(j=0;j<c.length;j++){k=c[j],Array.prototype.push.apply(e,k),g=Number.POSITIVE_INFINITY;for(f=0;f<k.length;f++){n=k[f],o=[];for(m=0;m<d.length;m++)l=d[m],l=n.distanceToSquared(l),o.push(l),l<g&&(g=l,h=f,i=m)}f=i-1<0?d.length-1:i-1,g=h-1<0?k.length-1:h-1;var q=[k[h],d[i],d[f]];m=a.FontUtils.Triangulate.area(q);var r=[k[h],k[g],d[i]];n=a.FontUtils.Triangulate.area(r),o=i,l=h,i+=1,h+=-1,i<0&&(i+=d.length),i%=d.length,h<0&&(h+=k.length),h%=k.length,f=i-1<0?d.length-1:i-1,g=h-1<0?k.length-1:h-1,q=[k[h],d[i],d[f]],q=a.FontUtils.Triangulate.area(q),r=[k[h],k[g],d[i]],r=a.FontUtils.Triangulate.area(r),m+n>q+r&&(i=o,h=l,i<0&&(i+=d.length),i%=d.length,h<0&&(h+=k.length),h%=k.length,f=i-1<0?d.length-1:i-1,g=h-1<0?k.length-1:h-1),m=d.slice(0,i),n=d.slice(i),o=k.slice(h),l=k.slice(0,h),g=[k[h],k[g],d[i]],p.push([k[h],d[i],d[f]]),p.push(g),d=m.concat(o).concat(l).concat(n)}return{shape:d,isolatedPts:p,allpoints:e}},triangulateShape:function(b,c){var d=a.Shape.Utils.removeHoles(b,c),e=d.allpoints,f=d.isolatedPts,d=a.FontUtils.Triangulate(d.shape,!1),g,h,i,j,k={};g=0;for(h=e.length;g<h;g++)j=e[g].x+":"+e[g].y,k[j]!==void 0&&console.log("Duplicate point",j),k[j]=g;g=0;for(h=d.length;g<h;g++){i=d[g];for(e=0;e<3;e++)j=i[e].x+":"+i[e].y,j=k[j],j!==void 0&&(i[e]=j)}g=0;for(h=f.length;g<h;g++){i=f[g];for(e=0;e<3;e++)j=i[e].x+":"+i[e].y,j=k[j],j!==void 0&&(i[e]=j)}return d.concat(f)},isClockWise:function(b){return a.FontUtils.Triangulate.area(b)<0},b2p0:function(a,b){var c=1-a;return c*c*b},b2p1:function(a,b){return 2*(1-a)*a*b},b2p2:function(a,b){return a*a*b},b2:function(a,b,c,d){return this.b2p0(a,b)+this.b2p1(a,c)+this.b2p2(a,d)},b3p0:function(a,b){var c=1-a;return c*c*c*b},b3p1:function(a,b){var c=1-a;return 3*c*c*a*b},b3p2:function(a,b){return 3*(1-a)*a*a*b},b3p3:function(a,b){return a*a*a*b},b3:function(a,b,c,d,e){return this.b3p0(a,b)+this.b3p1(a,c)+this.b3p2(a,d)+this.b3p3(a,e)}},a.TextPath=function(b,c){a.Path.call(this),this.parameters=c||{},this.set(b)},a.TextPath.prototype.set=function(b,c){this.text=b;var c=c||this.parameters,d=c.curveSegments!==void 0?c.curveSegments:4,e=c.font!==void 0?c.font:"helvetiker",f=c.weight!==void 0?c.weight:"normal",g=c.style!==void 0?c.style:"normal";a.FontUtils.size=c.size!==void 0?c.size:100,a.FontUtils.divisions=d,a.FontUtils.face=e,a.FontUtils.weight=f,a.FontUtils.style=g},a.TextPath.prototype.toShapes=function(){for(var b=a.FontUtils.drawText(this.text).paths,c=[],d=0,e=b.length;d<e;d++)Array.prototype.push.apply(c,b[d].toShapes());return c},a.AnimationHandler=function(){var b=[],c={},d={update:function(a){for(var c=0;c<b.length;c++)b[c].update(a)},addToUpdate:function(a){b.indexOf(a)===-1&&b.push(a)},removeFromUpdate:function(a){a=b.indexOf(a),a!==-1&&b.splice(a,1)},add:function(b){c[b.name]!==void 0&&console.log("THREE.AnimationHandler.add: Warning! "+b.name+" already exists in library. Overwriting."),c[b.name]=b;if(b.initialized!==!0){for(var d=0;d<b.hierarchy.length;d++){for(var e=0;e<b.hierarchy[d].keys.length;e++){b.hierarchy[d].keys[e].time<0&&(b.hierarchy[d].keys[e].time=0);if(b.hierarchy[d].keys[e].rot!==void 0&&!(b.hierarchy[d].keys[e].rot instanceof a.Quaternion)){var f=b.hierarchy[d].keys[e].rot;b.hierarchy[d].keys[e].rot=new a.Quaternion(f[0],f[1],f[2],f[3])}}if(b.hierarchy[d].keys[0].morphTargets!==void 0){f={};for(e=0;e<b.hierarchy[d].keys.length;e++)for(var g=0;g<b.hierarchy[d].keys[e].morphTargets.length;g++){var h=b.hierarchy[d].keys[e].morphTargets[g];f[h]=-1}b.hierarchy[d].usedMorphTargets=f;for(e=0;e<b.hierarchy[d].keys.length;e++){var i={};for(h in f){for(g=0;g<b.hierarchy[d].keys[e].morphTargets.length;g++)if(b.hierarchy[d].keys[e].morphTargets[g]===h){i[h]=b.hierarchy[d].keys[e].morphTargetsInfluences[g];break}g===b.hierarchy[d].keys[e].morphTargets.length&&(i[h]=0)}b.hierarchy[d].keys[e].morphTargetsInfluences=i}}for(e=1;e<b.hierarchy[d].keys.length;e++)b.hierarchy[d].keys[e].time===b.hierarchy[d].keys[e-1].time&&(b.hierarchy[d].keys.splice(e,1),e--);for(e=1;e<b.hierarchy[d].keys.length;e++)b.hierarchy[d].keys[e].index=e}e=parseInt(b.length*b.fps,10),b.JIT={},b.JIT.hierarchy=[];for(d=0;d<b.hierarchy.length;d++)b.JIT.hierarchy.push(Array(e));b.initialized=!0}},get:function(a){if(typeof a=="string")return c[a]?c[a]:(console.log("THREE.AnimationHandler.get: Couldn't find animation "+a),null)},parse:function(b){var c=[];if(b instanceof a.SkinnedMesh)for(var d=0;d<b.bones.length;d++)c.push(b.bones[d]);else e(b,c);return c}},e=function(a,b){b.push(a);for(var c=0;c<a.children.length;c++)e(a.children[c],b)};return d.LINEAR=0,d.CATMULLROM=1,d.CATMULLROM_FORWARD=2,d}(),a.Animation=function(b,c,d,e){this.root=b,this.data=a.AnimationHandler.get(c),this.hierarchy=a.AnimationHandler.parse(b),this.currentTime=0,this.timeScale=1,this.isPlaying=!1,this.loop=this.isPaused=!0,this.interpolationType=d!==void 0?d:a.AnimationHandler.LINEAR,this.JITCompile=e!==void 0?e:!0,this.points=[],this.target=new a.Vector3},a.Animation.prototype.play=function(b,c){if(!this.isPlaying){this.isPlaying=!0,this.loop=b!==void 0?b:!0,this.currentTime=c!==void 0?c:0;var d,e=this.hierarchy.length,f;for(d=0;d<e;d++){f=this.hierarchy[d],this.interpolationType!==a.AnimationHandler.CATMULLROM_FORWARD&&(f.useQuaternion=!0),f.matrixAutoUpdate=!0,f.animationCache===void 0&&(f.animationCache={},f.animationCache.prevKey={pos:0,rot:0,scl:0},f.animationCache.nextKey={pos:0,rot:0,scl:0},f.animationCache.originalMatrix=f instanceof a.Bone?f.skinMatrix:f.matrix);var g=f.animationCache.prevKey;f=f.animationCache.nextKey,g.pos=this.data.hierarchy[d].keys[0],g.rot=this.data.hierarchy[d].keys[0],g.scl=this.data.hierarchy[d].keys[0],f.pos=this.getNextKeyWith("pos",d,1),f.rot=this.getNextKeyWith("rot",d,1),f.scl=this.getNextKeyWith("scl",d,1)}this.update(0)}this.isPaused=!1,a.AnimationHandler.addToUpdate(this)},a.Animation.prototype.pause=function(){this.isPaused?a.AnimationHandler.addToUpdate(this):a.AnimationHandler.removeFromUpdate(this),this.isPaused=!this.isPaused},a.Animation.prototype.stop=function(){this.isPaused=this.isPlaying=!1,a.AnimationHandler.removeFromUpdate(this);for(var b=0;b<this.hierarchy.length;b++)this.hierarchy[b].animationCache!==void 0&&(this.hierarchy[b]instanceof a.Bone?this.hierarchy[b].skinMatrix=this.hierarchy[b].animationCache.originalMatrix:this.hierarchy[b].matrix=this.hierarchy[b].animationCache.originalMatrix,delete this.hierarchy[b].animationCache)},a.Animation.prototype.update=function(b){if(this.isPlaying){var c=["pos","rot","scl"],d,e,f,g,h,i,j,k,l=this.data.JIT.hierarchy,m,n;this.currentTime+=b*this.timeScale,n=this.currentTime,m=this.currentTime%=this.data.length,k=parseInt(Math.min(m*this.data.fps,this.data.length*this.data.fps),10);for(var o=0,p=this.hierarchy.length;o<p;o++)if(b=this.hierarchy[o],j=b.animationCache,this.JITCompile&&l[o][k]!==void 0)b instanceof a.Bone?(b.skinMatrix=l[o][k],b.matrixAutoUpdate=!1,b.matrixWorldNeedsUpdate=!1):(b.matrix=l[o][k],b.matrixAutoUpdate=!1,b.matrixWorldNeedsUpdate=!0);else{this.JITCompile&&(b instanceof a.Bone?b.skinMatrix=b.animationCache.originalMatrix:b.matrix=b.animationCache.originalMatrix);for(var q=0;q<3;q++){d=c[q],h=j.prevKey[d],i=j.nextKey[d];if(i.time<=n){if(m<n){if(!this.loop){this.stop();return}h=this.data.hierarchy[o].keys[0];for(i=this.getNextKeyWith(d,o,1);i.time<m;)h=i,i=this.getNextKeyWith(d,o,i.index+1)}else do h=i,i=this.getNextKeyWith(d,o,i.index+1);while(i.time<m);j.prevKey[d]=h,j.nextKey[d]=i}b.matrixAutoUpdate=!0,b.matrixWorldNeedsUpdate=!0,e=(m-h.time)/(i.time-h.time),f=h[d],g=i[d];if(e<0||e>1)console.log("THREE.Animation.update: Warning! Scale out of bounds:"+e+" on bone "+o),e=e<0?0:1;if(d==="pos"){if(d=b.position,this.interpolationType===a.AnimationHandler.LINEAR)d.x=f[0]+(g[0]-f[0])*e,d.y=f[1]+(g[1]-f[1])*e,d.z=f[2]+(g[2]-f[2])*e;else if(this.interpolationType===a.AnimationHandler.CATMULLROM||this.interpolationType===a.AnimationHandler.CATMULLROM_FORWARD)if(this.points[0]=this.getPrevKeyWith("pos",o,h.index-1).pos,this.points[1]=f,this.points[2]=g,this.points[3]=this.getNextKeyWith("pos",o,i.index+1).pos,e=e*.33+.33,f=this.interpolateCatmullRom(this.points,e),d.x=f[0],d.y=f[1],d.z=f[2],this.interpolationType===a.AnimationHandler.CATMULLROM_FORWARD)e=this.interpolateCatmullRom(this.points,e*1.01),this.target.set(e[0],e[1],e[2]),this.target.subSelf(d),this.target.y=0,this.target.normalize(),e=Math.atan2(this.target.x,this.target.z),b.rotation.set(0,e,0)}else d==="rot"?a.Quaternion.slerp(f,g,b.quaternion,e):d==="scl"&&(d=b.scale,d.x=f[0]+(g[0]-f[0])*e,d.y=f[1]+(g[1]-f[1])*e,d.z=f[2]+(g[2]-f[2])*e)}}if(this.JITCompile&&l[0][k]===void 0){this.hierarchy[0].update(void 0,!0);for(o=0;o<this.hierarchy.length;o++)l[o][k]=this.hierarchy[o]instanceof a.Bone?this.hierarchy[o].skinMatrix.clone():this.hierarchy[o].matrix.clone()}}},a.Animation.prototype.interpolateCatmullRom=function(a,b){var c=[],d=[],e,f,g,h,i,j;return e=(a.length-1)*b,f=Math.floor(e),e-=f,c[0]=f==0?f:f-1,c[1]=f,c[2]=f>a.length-2?f:f+1,c[3]=f>a.length-3?f:f+2,f=a[c[0]],h=a[c[1]],i=a[c[2]],j=a[c[3]],c=e*e,g=e*c,d[0]=this.interpolate(f[0],h[0],i[0],j[0],e,c,g),d[1]=this.interpolate(f[1],h[1],i[1],j[1],e,c,g),d[2]=this.interpolate(f[2],h[2],i[2],j[2],e,c,g),d},a.Animation.prototype.interpolate=function(a,b,c,d,e,f,g){return a=(c-a)*.5,d=(d-b)*.5,(2*(b-c)+a+d)*g+(-3*(b-c)-2*a-d)*f+a*e+b},a.Animation.prototype.getNextKeyWith=function(b,c,d){var e=this.data.hierarchy[c].keys;for(this.interpolationType===a.AnimationHandler.CATMULLROM||this.interpolationType===a.AnimationHandler.CATMULLROM_FORWARD?d=d<e.length-1?d:e.length-1:d%=e.length;d<e.length;d++)if(e[d][b]!==void 0)return e[d];return this.data.hierarchy[c].keys[0]},a.Animation.prototype.getPrevKeyWith=function(b,c,d){for(var e=this.data.hierarchy[c].keys,d=this.interpolationType===a.AnimationHandler.CATMULLROM||this.interpolationType===a.AnimationHandler.CATMULLROM_FORWARD?d>0?d:0:d<0?d+e.length:d;d>=0;d--)if(e[d][b]!==void 0)return e[d];return this.data.hierarchy[c].keys[e.length-1]},a.CubeCamera=function(b,c,d,e){this.cameraPX=new a.PerspectiveCamera(90,1,b,c),this.cameraNX=new a.PerspectiveCamera(90,1,b,c),this.cameraPY=new a.PerspectiveCamera(90,1,b,c),this.cameraNY=new a.PerspectiveCamera(90,1,b,c),this.cameraPZ=new a.PerspectiveCamera(90,1,b,c),this.cameraNZ=new a.PerspectiveCamera(90,1,b,c),this.cameraPXTarget=new a.Vector3(0,0,0),this.cameraNXTarget=new a.Vector3(0,0,0),this.cameraPYTarget=new a.Vector3(0,0,0),this.cameraNYTarget=new a.Vector3(0,0,0),this.cameraPZTarget=new a.Vector3(0,0,0),this.cameraNZTarget=new a.Vector3(0,0,0),this.height=d,this.position=new a.Vector3(0,d,0),this.cameraPX.position=this.position,this.cameraNX.position=this.position,this.cameraPY.position=this.position,this.cameraNY.position=this.position,this.cameraPZ.position=this.position,this.cameraNZ.position=this.position,this.cameraPY.up.set(0,0,1),this.cameraPZ.up.set(0,-1,0),this.cameraNZ.up.set(0,-1,0),this.renderTarget=new a.WebGLRenderTargetCube(e,e,{format:a.RGBFormat,magFilter:a.LinearFilter,minFilter:a.LinearFilter}),this.updatePosition=function(b){this.position.x=b.x,this.position.z=b.z,this.cameraPXTarget.add(this.position,new a.Vector3(-1,0,0)),this.cameraNXTarget.add(this.position,new a.Vector3(1,0,0)),this.cameraPYTarget.add(this.position,new a.Vector3(0,1,0)),this.cameraNYTarget.add(this.position,new a.Vector3(0,-1,0)),this.cameraPZTarget.add(this.position,new a.Vector3(0,0,1)),this.cameraNZTarget.add(this.position,new a.Vector3(0,0,-1)),this.cameraPX.lookAt(this.cameraPXTarget),this.cameraNX.lookAt(this.cameraNXTarget),this.cameraPY.lookAt(this.cameraPYTarget),this.cameraNY.lookAt(this.cameraNYTarget),this.cameraPZ.lookAt(this.cameraPZTarget),this.cameraNZ.lookAt(this.cameraNZTarget)},this.updateCubeMap=function(a,b){var c=this.renderTarget;a.setFaceCulling("back","cw"),b.scale.y=-1,b.position.y=2*this.height,b.updateMatrix(),c.activeCubeFace=0,a.render(b,this.cameraPX,c),c.activeCubeFace=1,a.render(b,this.cameraNX,c),b.scale.y=1,b.position.y=0,b.updateMatrix(),b.scale.x=-1,b.updateMatrix(),c.activeCubeFace=2,a.render(b,this.cameraPY,c),b.scale.x=1,b.updateMatrix(),a.setFaceCulling("back","ccw"),c.activeCubeFace=3,a.render(b,this.cameraNY,c),b.scale.x=-1,b.updateMatrix(),a.setFaceCulling("back","cw"),c.activeCubeFace=4,a.render(b,this.cameraPZ,c),c.activeCubeFace=5,a.render(b,this.cameraNZ,c),b.scale.x=1,b.updateMatrix(),a.setFaceCulling("back","ccw")}},a.FirstPersonCamera=function(){console.warn("DEPRECATED: FirstPersonCamera() is FirstPersonControls().")},a.PathCamera=function(){console.warn("DEPRECATED: PathCamera() is PathControls().")},a.FlyCamera=function(){console.warn("DEPRECATED: FlyCamera() is FlyControls().")},a.RollCamera=function(){console.warn("DEPRECATED: RollCamera() is RollControls().")},a.TrackballCamera=function(){console.warn("DEPRECATED: TrackballCamera() is TrackballControls().")},a.CombinedCamera=function(b,c,d,e,f,g,h){a.Camera.call(this),this.cameraO=new a.OrthographicCamera(b/-2,b/2,c/2,c/-2,g,h),this.cameraP=new a.PerspectiveCamera(d,b/c,e,f),this.toPerspective()},a.CombinedCamera.prototype=new a.Camera,a.CombinedCamera.prototype.constructor=a.CoolCamera,a.CombinedCamera.prototype.toPerspective=function(){this.near=this.cameraP.near,this.far=this.cameraP.far,this.projectionMatrix=this.cameraP.projectionMatrix},a.CombinedCamera.prototype.toOrthographic=function(){this.near=this.cameraO.near,this.far=this.cameraO.far,this.projectionMatrix=this.cameraO.projectionMatrix},a.CombinedCamera.prototype.setFov=function(a){this.cameraP.fov=a,this.cameraP.updateProjectionMatrix(),this.toPerspective()},a.CombinedCamera.prototype.setLens=function(a,b){b||(b=43.25);var c=2*Math.atan(b/(a*2));return c*=180/Math.PI,this.setFov(c),c},a.FirstPersonControls=function(b,c){function d(a,b){return function(){b.apply(a,arguments)}}this.object=b,this.target=new a.Vector3(0,0,0),this.domElement=c!==void 0?c:document,this.movementSpeed=1,this.lookSpeed=.005,this.noFly=!1,this.lookVertical=!0,this.autoForward=!1,this.activeLook=!0,this.heightSpeed=!1,this.heightCoef=1,this.heightMin=0,this.constrainVertical=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.lastUpdate=(new Date).getTime(),this.theta=this.phi=this.lon=this.lat=this.mouseY=this.mouseX=this.autoSpeedFactor=this.tdiff=0,this.mouseDragOn=this.freeze=this.moveRight=this.moveLeft=this.moveBackward=this.moveForward=!1,this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2,this.domElement.setAttribute("tabindex",-1)),this.onMouseDown=function(a){this.domElement!==document&&this.domElement.focus(),a.preventDefault(),a.stopPropagation();if(this.activeLook)switch(a.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0}this.mouseDragOn=!0},this.onMouseUp=function(a){a.preventDefault(),a.stopPropagation();if(this.activeLook)switch(a.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.mouseDragOn=!1},this.onMouseMove=function(a){this.domElement===document?(this.mouseX=a.pageX-this.viewHalfX,this.mouseY=a.pageY-this.viewHalfY):(this.mouseX=a.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=a.pageY-this.domElement.offsetTop-this.viewHalfY)},this.onKeyDown=function(a){switch(a.keyCode){case 38:case 87:this.moveForward=!0;break;case 37:case 65:this.moveLeft=!0;break;case 40:case 83:this.moveBackward=!0;break;case 39:case 68:this.moveRight=!0;break;case 82:this.moveUp=!0;break;case 70:this.moveDown=!0;break;case 81:this.freeze=!this.freeze}},this.onKeyUp=function(a){switch(a.keyCode){case 38:case 87:this.moveForward=!1;break;case 37:case 65:this.moveLeft=!1;break;case 40:case 83:this.moveBackward=!1;break;case 39:case 68:this.moveRight=!1;break;case 82:this.moveUp=!1;break;case 70:this.moveDown=!1}},this.update=function(){var a=(new Date).getTime();this.tdiff=(a-this.lastUpdate)/1e3,this.lastUpdate=a;if(!this.freeze){this.autoSpeedFactor=this.heightSpeed?this.tdiff*((this.object.position.y<this.heightMin?this.heightMin:this.object.position.y>this.heightMax?this.heightMax:this.object.position.y)-this.heightMin)*this.heightCoef:0;var b=this.tdiff*this.movementSpeed;(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(b+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(b),this.moveLeft&&this.object.translateX(-b),this.moveRight&&this.object.translateX(b),this.moveUp&&this.object.translateY(b),this.moveDown&&this.object.translateY(-b),b=this.tdiff*this.lookSpeed,this.activeLook||(b=0),this.lon+=this.mouseX*b,this.lookVertical&&(this.lat-=this.mouseY*b),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=(90-this.lat)*Math.PI/180,this.theta=this.lon*Math.PI/180;var a=this.target,c=this.object.position;a.x=c.x+100*Math.sin(this.phi)*Math.cos(this.theta),a.y=c.y+100*Math.cos(this.phi),a.z=c.z+100*Math.sin(this.phi)*Math.sin(this.theta)}a=1,this.constrainVertical&&(a=Math.PI/(this.verticalMax-this.verticalMin)),this.lon+=this.mouseX*b,this.lookVertical&&(this.lat-=this.mouseY*b*a),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=(90-this.lat)*Math.PI/180,this.theta=this.lon*Math.PI/180,this.constrainVertical&&(this.phi=(this.phi-0)*(this.verticalMax-this.verticalMin)/(Math.PI-0)+this.verticalMin),a=this.target,c=this.object.position,a.x=c.x+100*Math.sin(this.phi)*Math.cos(this.theta),a.y=c.y+100*Math.cos(this.phi),a.z=c.z+100*Math.sin(this.phi)*Math.sin(this.theta),this.object.lookAt(a)},this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1),this.domElement.addEventListener("mousemove",d(this,this.onMouseMove),!1),this.domElement.addEventListener("mousedown",d(this,this.onMouseDown),!1),this.domElement.addEventListener("mouseup",d(this,this.onMouseUp),!1),this.domElement.addEventListener("keydown",d(this,this.onKeyDown),!1),this.domElement.addEventListener("keyup",d(this,this.onKeyUp),!1)},a.PathControls=function(b,c){function d(a){return(a*=2)<1?.5*a*a:-0.5*(--a*(a-2)-1)}function e(a,b){return function(){b.apply(a,arguments)}}function f(b,c,d,e){var f={name:d,fps:.6,length:e,hierarchy:[]},g,h=c.getControlPointsArray(),i=c.getLength(),j=h.length,k=0;g=j-1,c={parent:-1,keys:[]},c.keys[0]={time:0,pos:h[0],rot:[0,0,0,1],scl:[1,1,1]},c.keys[g]={time:e,pos:h[g],rot:[0,0,0,1],scl:[1,1,1]};for(g=1;g<j-1;g++)k=e*i.chunks[g]/i.total,c.keys[g]={time:k,pos:h[g]};return f.hierarchy[0]=c,a.AnimationHandler.add(f),new a.Animation(b,d,a.AnimationHandler.CATMULLROM_FORWARD,!1)}function g(b,c){var d,e,f=new a.Geometry;for(d=0;d<b.points.length*c;d++)e=d/(b.points.length*c),e=b.getPoint(e),f.vertices[d]=new a.Vertex(new a.Vector3(e.x,e.y,e.z));return f}this.object=b,this.domElement=c!==void 0?c:document,this.id="PathControls"+a.PathControlsIdCounter++,this.duration=1e4,this.waypoints=[],this.useConstantSpeed=!0,this.resamplingCoef=50,this.debugPath=new a.Object3D,this.debugDummy=new a.Object3D,this.animationParent=new a.Object3D,this.lookSpeed=.005,this.lookHorizontal=this.lookVertical=!0,this.verticalAngleMap={srcRange:[0,2*Math.PI],dstRange:[0,2*Math.PI]},this.horizontalAngleMap={srcRange:[0,2*Math.PI],dstRange:[0,2*Math.PI]},this.target=new a.Object3D,this.theta=this.phi=this.lon=this.lat=this.mouseY=this.mouseX=0,this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2,this.domElement.setAttribute("tabindex",-1));var h=Math.PI*2,j=Math.PI/180;this.update=function(){var a,b;this.lookHorizontal&&(this.lon+=this.mouseX*this.lookSpeed),this.lookVertical&&(this.lat-=this.mouseY*this.lookSpeed),this.lon=Math.max(0,Math.min(360,this.lon)),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=(90-this.lat)*j,this.theta=this.lon*j,a=this.phi%h,this.phi=a<0?a+h:a,a=this.verticalAngleMap.srcRange,b=this.verticalAngleMap.dstRange;var c=b[1]-b[0];this.phi=d(((this.phi-a[0])*(b[1]-b[0])/(a[1]-a[0])+b[0]-b[0])/c)*c+b[0],a=this.horizontalAngleMap.srcRange,b=this.horizontalAngleMap.dstRange,c=b[1]-b[0],this.theta=d(((this.theta-a[0])*(b[1]-b[0])/(a[1]-a[0])+b[0]-b[0])/c)*c+b[0],a=this.target.position,a.x=100*Math.sin(this.phi)*Math.cos(this.theta),a.y=100*Math.cos(this.phi),a.z=100*Math.sin(this.phi)*Math.sin(this.theta),this.object.lookAt(this.target.position)},this.onMouseMove=function(a){this.domElement===document?(this.mouseX=a.pageX-this.viewHalfX,this.mouseY=a.pageY-this.viewHalfY):(this.mouseX=a.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=a.pageY-this.domElement.offsetTop-this.viewHalfY)},this.init=function(){this.spline=new a.Spline,this.spline.initFromArray(this.waypoints),this.useConstantSpeed&&this.spline.reparametrizeByArcLength(this.resamplingCoef);if(this.createDebugDummy){var b=new a.MeshLambertMaterial({color:30719}),c=new a.MeshLambertMaterial({color:65280}),d=new a.CubeGeometry(10,10,20),h=new a.CubeGeometry(2,2,10);this.animationParent=new a.Mesh(d,b),b=new a.Mesh(h,c),b.position.set(0,10,0),this.animation=f(this.animationParent,this.spline,this.id,this.duration),this.animationParent.add(this.object),this.animationParent.add(this.target),this.animationParent.add(b)}else this.animation=f(this.animationParent,this.spline,this.id,this.duration),this.animationParent.add(this.target),this.animationParent.add(this.object);if(this.createDebugPath){var b=this.debugPath,c=this.spline,d=g(c,10),h=g(c,10),j=new a.LineBasicMaterial({color:16711680,linewidth:3});lineObj=new a.Line(d,j),particleObj=new a.ParticleSystem(h,new a.ParticleBasicMaterial({color:16755200,size:3})),lineObj.scale.set(1,1,1),b.add(lineObj),particleObj.scale.set(1,1,1),b.add(particleObj),h=new a.SphereGeometry(1,16,8),j=new a.MeshBasicMaterial({color:65280});for(i=0;i<c.points.length;i++)d=new a.Mesh(h,j),d.position.copy(c.points[i]),b.add(d)}this.domElement.addEventListener("mousemove",e(this,this.onMouseMove),!1)}},a.PathControlsIdCounter=0,a.FlyControls=function(b,c){function d(a,b){return function(){b.apply(a,arguments)}}this.object=b,this.domElement=c!==void 0?c:document,c&&this.domElement.setAttribute("tabindex",-1),this.movementSpeed=1,this.rollSpeed=.005,this.autoForward=this.dragToLook=!1,this.object.useQuaternion=!0,this.tmpQuaternion=new a.Quaternion,this.mouseStatus=0,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.moveVector=new a.Vector3(0,0,0),this.rotationVector=new a.Vector3(0,0,0),this.lastUpdate=-1,this.tdiff=0,this.handleEvent=function(a){typeof this[a.type]=="function"&&this[a.type](a)},this.keydown=function(a){if(!a.altKey){switch(a.keyCode){case 16:this.movementSpeedMultiplier=.1;break;case 87:this.moveState.forward=1;break;case 83:this.moveState.back=1;break;case 65:this.moveState.left=1;break;case 68:this.moveState.right=1;break;case 82:this.moveState.up=1;break;case 70:this.moveState.down=1;break;case 38:this.moveState.pitchUp=1;break;case 40:this.moveState.pitchDown=1;break;case 37:this.moveState.yawLeft=1;break;case 39:this.moveState.yawRight=1;break;case 81:this.moveState.rollLeft=1;break;case 69:this.moveState.rollRight=1}this.updateMovementVector(),this.updateRotationVector()}},this.keyup=function(a){switch(a.keyCode){case 16:this.movementSpeedMultiplier=1;break;case 87:this.moveState.forward=0;break;case 83:this.moveState.back=0;break;case 65:this.moveState.left=0;break;case 68:this.moveState.right=0;break;case 82:this.moveState.up=0;break;case 70:this.moveState.down=0;break;case 38:this.moveState.pitchUp=0;break;case 40:this.moveState.pitchDown=0;break;case 37:this.moveState.yawLeft=0;break;case 39:this.moveState.yawRight=0;break;case 81:this.moveState.rollLeft=0;break;case 69:this.moveState.rollRight=0}this.updateMovementVector(),this.updateRotationVector()},this.mousedown=function(a){this.domElement!==document&&this.domElement.focus(),a.preventDefault(),a.stopPropagation();if(this.dragToLook)this.mouseStatus++;else switch(a.button){case 0:this.object.moveForward=!0;break;case 2:this.object.moveBackward=!0}},this.mousemove=function(a){if(!this.dragToLook||this.mouseStatus>0){var b=this.getContainerDimensions(),c=b.size[0]/2,d=b.size[1]/2;this.moveState.yawLeft=-(a.pageX-b.offset[0]-c)/c,this.moveState.pitchDown=(a.pageY-b.offset[1]-d)/d,this.updateRotationVector()}},this.mouseup=function(a){a.preventDefault(),a.stopPropagation();if(this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else switch(a.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.updateRotationVector()},this.update=function(){var a=(new Date).getTime();this.lastUpdate==-1&&(this.lastUpdate=a),this.tdiff=(a-this.lastUpdate)/1e3,this.lastUpdate=a;var a=this.tdiff*this.movementSpeed,b=this.tdiff*this.rollSpeed;this.object.translateX(this.moveVector.x*a),this.object.translateY(this.moveVector.y*a),this.object.translateZ(this.moveVector.z*a),this.tmpQuaternion.set(this.rotationVector.x*b,this.rotationVector.y*b,this.rotationVector.z*b,1).normalize(),this.object.quaternion.multiplySelf(this.tmpQuaternion),this.object.matrix.setPosition(this.object.position),this.object.matrix.setRotationFromQuaternion(this.object.quaternion),this.object.matrixWorldNeedsUpdate=!0},this.updateMovementVector=function(){var a=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-a+this.moveState.back},this.updateRotationVector=function(){this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},this.getContainerDimensions=function(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}},this.domElement.addEventListener("mousemove",d(this,this.mousemove),!1),this.domElement.addEventListener("mousedown",d(this,this.mousedown),!1),this.domElement.addEventListener("mouseup",d(this,this.mouseup),!1),this.domElement.addEventListener("keydown",d(this,this.keydown),!1),this.domElement.addEventListener("keyup",d(this,this.keyup),!1),this.updateMovementVector(),this.updateRotationVector()},a.RollControls=function(b,c){this.object=b,this.domElement=c!==void 0?c:document,this.mouseLook=!0,this.autoForward=!1,this.rollSpeed=this.movementSpeed=this.lookSpeed=1,this.constrainVertical=[-0.9,.9],this.object.matrixAutoUpdate=!1,this.forward=new a.Vector3(0,0,1),this.roll=0,this.lastUpdate=-1,this.delta=0;var d=new a.Vector3,e=new a.Vector3,f=new a.Vector3,g=new a.Matrix4,h=!1,i=1,j=0,k=0,l=0,m=0,n=0,o=window.innerWidth/2,p=window.innerHeight/2;this.update=function(){var a=(new Date).getTime();this.lastUpdate==-1&&(this.lastUpdate=a),this.delta=(a-this.lastUpdate)/1e3,this.lastUpdate=a,this.mouseLook&&(a=this.delta*this.lookSpeed,this.rotateHorizontally(a*m),this.rotateVertically(a*n)),a=this.delta*this.movementSpeed,this.object.translateZ(-a*(j>0||this.autoForward&&j>=0?1:j)),this.object.translateX(a*k),this.object.translateY(a*l),h&&(this.roll+=this.rollSpeed*this.delta*i),this.forward.y>this.constrainVertical[1]?(this.forward.y=this.constrainVertical[1],this.forward.normalize()):this.forward.y<this.constrainVertical[0]&&(this.forward.y=this.constrainVertical[0],this.forward.normalize()),f.copy(this.forward),e.set(0,1,0),d.cross(e,f).normalize(),e.cross(f,d).normalize(),this.object.matrix.n11=d.x,this.object.matrix.n12=e.x,this.object.matrix.n13=f.x,this.object.matrix.n21=d.y,this.object.matrix.n22=e.y,this.object.matrix.n23=f.y,this.object.matrix.n31=d.z,this.object.matrix.n32=e.z,this.object.matrix.n33=f.z,g.identity(),g.n11=Math.cos(this.roll),g.n12=-Math.sin(this.roll),g.n21=Math.sin(this.roll),g.n22=Math.cos(this.roll),this.object.matrix.multiplySelf(g),this.object.matrixWorldNeedsUpdate=!0,this.object.matrix.n14=this.object.position.x,this.object.matrix.n24=this.object.position.y,this.object.matrix.n34=this.object.position.z},this.translateX=function(a){this.object.position.x+=this.object.matrix.n11*a,this.object.position.y+=this.object.matrix.n21*a,this.object.position.z+=this.object.matrix.n31*a},this.translateY=function(a){this.object.position.x+=this.object.matrix.n12*a,this.object.position.y+=this.object.matrix.n22*a,this.object.position.z+=this.object.matrix.n32*a},this.translateZ=function(a){this.object.position.x-=this.object.matrix.n13*a,this.object.position.y-=this.object.matrix.n23*a,this.object.position.z-=this.object.matrix.n33*a},this.rotateHorizontally=function(a){d.set(this.object.matrix.n11,this.object.matrix.n21,this.object.matrix.n31),d.multiplyScalar(a),this.forward.subSelf(d),this.forward.normalize()},this.rotateVertically=function(a){e.set(this.object.matrix.n12,this.object.matrix.n22,this.object.matrix.n32),e.multiplyScalar(a),this.forward.addSelf(e),this.forward.normalize()},this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1),this.domElement.addEventListener("mousemove",function(a){m=(a.clientX-o)/window.innerWidth,n=(a.clientY-p)/window.innerHeight},!1),this.domElement.addEventListener("mousedown",function(a){a.preventDefault(),a.stopPropagation();switch(a.button){case 0:j=1;break;case 2:j=-1}},!1),this.domElement.addEventListener("mouseup",function(a){a.preventDefault(),a.stopPropagation();switch(a.button){case 0:j=0;break;case 2:j=0}},!1),this.domElement.addEventListener("keydown",function(a){switch(a.keyCode){case 38:case 87:j=1;break;case 37:case 65:k=-1;break;case 40:case 83:j=-1;break;case 39:case 68:k=1;break;case 81:h=!0,i=1;break;case 69:h=!0,i=-1;break;case 82:l=1;break;case 70:l=-1}},!1),this.domElement.addEventListener("keyup",function(a){switch(a.keyCode){case 38:case 87:j=0;break;case 37:case 65:k=0;break;case 40:case 83:j=0;break;case 39:case 68:k=0;break;case 81:h=!1;break;case 69:h=!1;break;case 82:l=0;break;case 70:l=0}},!1)},a.TrackballControls=function(b,c){function d(a,b){return function(){b.apply(a,arguments)}}this.object=b,this.domElement=c!==void 0?c:document,this.screen={width:window.innerWidth,height:window.innerHeight,offsetLeft:0,offsetTop:0},this.radius=(this.screen.width+this.screen.height)/4,this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.staticMoving=this.noPan=this.noZoom=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=Infinity,this.keys=[65,83,68],this.target=new a.Vector3(0,0,0);var e=!1,f=this.STATE.NONE,g=new a.Vector3,h=new a.Vector3,i=new a.Vector3,j=new a.Vector2,k=new a.Vector2,l=new a.Vector2,m=new a.Vector2;this.handleEvent=function(a){typeof this[a.type]=="function"&&this[a.type](a)},this.getMouseOnScreen=function(b,c){return new a.Vector2((b-this.screen.offsetLeft)/this.radius*.5,(c-this.screen.offsetTop)/this.radius*.5)},this.getMouseProjectionOnBall=function(b,c){var d=new a.Vector3((b-this.screen.width*.5-this.screen.offsetLeft)/this.radius,(this.screen.height*.5+this.screen.offsetTop-c)/this.radius,0),e=d.length();return e>1?d.normalize():d.z=Math.sqrt(1-e*e),g.copy(this.object.position).subSelf(this.target),e=this.object.up.clone().setLength(d.y),e.addSelf(this.object.up.clone().crossSelf(g).setLength(d.x)),e.addSelf(g.setLength(d.z)),e},this.rotateCamera=function(){var b=Math.acos(h.dot(i)/h.length()/i.length());if(b){var c=(new a.Vector3).cross(h,i).normalize(),d=new a.Quaternion;b*=this.rotateSpeed,d.setFromAxisAngle(c,-b),d.multiplyVector3(g),d.multiplyVector3(this.object.up),d.multiplyVector3(i),this.staticMoving?h=i:(d.setFromAxisAngle(c,b*(this.dynamicDampingFactor-1)),d.multiplyVector3(h))}},this.zoomCamera=function(){var a=1+(k.y-j.y)*this.zoomSpeed;a!==1&&a>0&&(g.multiplyScalar(a),this.staticMoving?j=k:j.y+=(k.y-j.y)*this.dynamicDampingFactor)},this.panCamera=function(){var a=m.clone().subSelf(l);if(a.lengthSq()){a.multiplyScalar(g.length()*this.panSpeed);var b=g.clone().crossSelf(this.object.up).setLength(a.x);b.addSelf(this.object.up.clone().setLength(a.y)),this.object.position.addSelf(b),this.target.addSelf(b),this.staticMoving?l=m:l.addSelf(a.sub(m,l).multiplyScalar(this.dynamicDampingFactor))}},this.checkDistances=function(){if(!this.noZoom||!this.noPan)this.object.position.lengthSq()>this.maxDistance*this.maxDistance&&this.object.position.setLength(this.maxDistance),g.lengthSq()<this.minDistance*this.minDistance&&this.object.position.add(this.target,g.setLength(this.minDistance))},this.update=function(){g.copy(this.object.position).subSelf(this.target),this.rotateCamera(),this.noZoom||this.zoomCamera(),this.noPan||this.panCamera(),this.object.position.add(this.target,g),this.checkDistances(),this.object.lookAt(this.target)},this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1),this.domElement.addEventListener("mousemove",d(this,function(a){e&&(h=i=this.getMouseProjectionOnBall(a.clientX,a.clientY),j=k=this.getMouseOnScreen(a.clientX,a.clientY),l=m=this.getMouseOnScreen(a.clientX,a.clientY),e=!1),f!==this.STATE.NONE&&(f===this.STATE.ROTATE?i=this.getMouseProjectionOnBall(a.clientX,a.clientY):f===this.STATE.ZOOM&&!this.noZoom?k=this.getMouseOnScreen(a.clientX,a.clientY):f===this.STATE.PAN&&!this.noPan&&(m=this.getMouseOnScreen(a.clientX,a.clientY)))}),!1),this.domElement.addEventListener("mousedown",d(this,function(a){a.preventDefault(),a.stopPropagation(),f===this.STATE.NONE&&(f=a.button,f===this.STATE.ROTATE?h=i=this.getMouseProjectionOnBall(a.clientX,a.clientY):f===this.STATE.ZOOM&&!this.noZoom?j=k=this.getMouseOnScreen(a.clientX,a.clientY):this.noPan||(l=m=this.getMouseOnScreen(a.clientX,a.clientY)))}),!1),this.domElement.addEventListener("mouseup",d(this,function(a){a.preventDefault(),a.stopPropagation(),f=this.STATE.NONE}),!1),window.addEventListener("keydown",d(this,function(a){f===this.STATE.NONE&&(a.keyCode===this.keys[this.STATE.ROTATE]?f=this.STATE.ROTATE:a.keyCode===this.keys[this.STATE.ZOOM]&&!this.noZoom?f=this.STATE.ZOOM:a.keyCode===this.keys[this.STATE.PAN]&&!this.noPan&&(f=this.STATE.PAN),f!==this.STATE.NONE&&(e=!0))}),!1),window.addEventListener("keyup",d(this,function(){f!==this.STATE.NONE&&(f=this.STATE.NONE)}),!1)},a.TrackballControls.prototype.STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},a.CubeGeometry=function(b,c,d,e,f,g,h,i){function j(b,c,d,h,i,j,l,m){var n,o,p=e||1,q=f||1,r=i/2,s=j/2,t=k.vertices.length;if(b=="x"&&c=="y"||b=="y"&&c=="x")n="z";else if(b=="x"&&c=="z"||b=="z"&&c=="x")n="y",q=g||1;else if(b=="z"&&c=="y"||b=="y"&&c=="z")n="x",p=g||1;var v=p+1,w=q+1;i/=p;var x=j/q;for(o=0;o<w;o++)for(j=0;j<v;j++){var y=new a.Vector3;y[b]=(j*i-r)*d,y[c]=(o*x-s)*h,y[n]=l,k.vertices.push(new a.Vertex(y))}for(o=0;o<q;o++)for(j=0;j<p;j++)k.faces.push(new a.Face4(j+v*o+t,j+v*(o+1)+t,j+1+v*(o+1)+t,j+1+v*o+t,null,null,m)),k.faceVertexUvs[0].push([new a.UV(j/p,o/q),new a.UV(j/p,(o+1)/q),new a.UV((j+1)/p,(o+1)/q),new a.UV((j+1)/p,o/q)])}a.Geometry.call(this);var k=this,l=b/2,m=c/2,n=d/2;if(h!==void 0)if(h instanceof Array)this.materials=h;else{this.materials=[];for(var o=0;o<6;o++)this.materials.push([h])}else this.materials=[];this.sides={px:!0,nx:!0,py:!0,ny:!0,pz:!0,nz:!0};if(i!=void 0)for(var p in i)this.sides[p]!=void 0&&(this.sides[p]=i[p]);this.sides.px&&j("z","y",-1,-1,d,c,l,this.materials[0]),this.sides.nx&&j("z","y",1,-1,d,c,-l,this.materials[1]),this.sides.py&&j("x","z",1,1,b,d,m,this.materials[2]),this.sides.ny&&j("x","z",1,-1,b,d,-m,this.materials[3]),this.sides.pz&&j("x","y",1,-1,b,c,n,this.materials[4]),this.sides.nz&&j("x","y",-1,-1,b,c,-n,this.materials[5]),this.mergeVertices(),this.computeCentroids(),this.computeFaceNormals()},a.CubeGeometry.prototype=new a.Geometry,a.CubeGeometry.prototype.constructor=a.CubeGeometry,a.CylinderGeometry=function(b,c,d,e,f,g){a.Geometry.call(this);var b=b!=null?b:20,c=c!=null?c:20,d=d||100,h=d/2,e=e||8,f=f||1,i,j,k=[],l=[];for(j=0;j<=f;j++){var m=[],n=[],o=j/f,p=o*(c-b)+b;for(i=0;i<=e;i++){var q=i/e;this.vertices.push(new a.Vertex(new a.Vector3(p*Math.sin(q*Math.PI*2),-o*d+h,p*Math.cos(q*Math.PI*2)))),m.push(this.vertices.length-1),n.push(new a.UV(q,o))}k.push(m),l.push(n)}for(j=0;j<f;j++)for(i=0;i<e;i++){var d=k[j][i],m=k[j+1][i],n=k[j+1][i+1],o=k[j][i+1],p=this.vertices[d].position.clone().setY(0).normalize(),q=this.vertices[m].position.clone().setY(0).normalize(),r=this.vertices[n].position.clone().setY(0).normalize(),s=this.vertices[o].position.clone().setY(0).normalize(),t=l[j][i].clone(),u=l[j+1][i].clone(),v=l[j+1][i+1].clone(),w=l[j][i+1].clone();this.faces.push(new a.Face4(d,m,n,o,[p,q,r,s])),this.faceVertexUvs[0].push([t,u,v,w])}if(!g&&b>0){this.vertices.push(new a.Vertex(new a.Vector3(0,h,0)));for(i=0;i<e;i++)d=k[0][i],m=k[0][i+1],n=this.vertices.length-1,p=new a.Vector3(0,1,0),q=new a.Vector3(0,1,0),r=new a.Vector3(0,1,0),t=l[0][i].clone(),u=l[0][i+1].clone(),v=new a.UV(u.u,0),this.faces.push(new a.Face3(d,m,n,[p,q,r])),this.faceVertexUvs[0].push([t,u,v])}if(!g&&c>0){this.vertices.push(new a.Vertex(new a.Vector3(0,-h,0)));for(i=0;i<e;i++)d=k[j][i+1],m=k[j][i],n=this.vertices.length-1,p=new a.Vector3(0,-1,0),q=new a.Vector3(0,-1,0),r=new a.Vector3(0,-1,0),t=l[j][i+1].clone(),u=l[j][i].clone(),v=new a.UV(u.u,1),this.faces.push(new a.Face3(d,m,n,[p,q,r])),this.faceVertexUvs[0].push([t,u,v])}this.computeCentroids(),this.computeFaceNormals()},a.CylinderGeometry.prototype=new a.Geometry,a.CylinderGeometry.prototype.constructor=a.CylinderGeometry,a.ExtrudeGeometry=function(b,c){if(typeof b!="undefined"){a.Geometry.call(this);var b=b instanceof Array?b:[b],d,e=b.length,f;this.shapebb=b[e-1].getBoundingBox();for(d=0;d<e;d++)f=b[d],this.addShape(f,c);this.computeCentroids(),this.computeFaceNormals()}},a.ExtrudeGeometry.prototype=new a.Geometry,a.ExtrudeGeometry.prototype.constructor=a.ExtrudeGeometry,a.ExtrudeGeometry.prototype.addShape=function(b,c){function d(a,b,c){return b||console.log("die"),b.clone().multiplyScalar(c).addSelf(a)}function e(b,c,d){var e=a.ExtrudeGeometry.__v1,f=a.ExtrudeGeometry.__v2,g=a.ExtrudeGeometry.__v3,h=a.ExtrudeGeometry.__v4,i=a.ExtrudeGeometry.__v5,j=a.ExtrudeGeometry.__v6;return e.set(b.x-c.x,b.y-c.y),f.set(b.x-d.x,b.y-d.y),e=e.normalize(),f=f.normalize(),g.set(-e.y,e.x),h.set(f.y,-f.x),i.copy(b).addSelf(g),j.copy(b).addSelf(h),i.equals(j)?h.clone():(i.copy(c).addSelf(g),j.copy(d).addSelf(h),g=e.dot(h),h=j.subSelf(i).dot(h),g==0&&(console.log("Either infinite or no solutions!"),h==0?console.log("Its finite solutions."):console.log("Too bad, no solutions.")),h/=g,h<0?(c=Math.atan2(c.y-b.y,c.x-b.x),b=Math.atan2(d.y-b.y,d.x-b.x),c>b&&(b+=Math.PI*2),anglec=(c+b)/2,new a.Vector2(-Math.cos(anglec),-Math.sin(anglec))):e.multiplyScalar(h).addSelf(i).subSelf(b).clone())}function f(b){for(C=b.length;--C>=0;){O=C,P=C-1,P<0&&(P=b.length-1);for(var c=0,d=o+l*2,c=0;c<d;c++){var e=I*c,f=I*(c+1),g=Q+O+e,h=Q+O+f,k=g,e=Q+P+e,f=Q+P+f,m=h;k+=B,e+=B,f+=B,m+=B,A.faces.push(new a.Face4(k,e,f,m,null,null,v)),v&&(k=c/d,e=(c+1)/d,f=i+j*2,g=(A.vertices[g].position.z+j)/f,h=(A.vertices[h].position.z+j)/f,A.faceVertexUvs[0].push([new a.UV(g,k),new a.UV(h,k),new a.UV(h,e),new a.UV(g,e)]))}}}function g(b,c,d){A.vertices.push(new a.Vertex(new a.Vector3(b,c,d)))}function h(b,c,d){b+=B,c+=B,d+=B,A.faces.push(new a.Face3(b,c,d,null,null,u));if(u){var e=w.maxY,f=w.maxX,g=A.vertices[c].position.x,c=A.vertices[c].position.y,h=A.vertices[d].position.x,d=A.vertices[d].position.y;A.faceVertexUvs[0].push([new a.UV(A.vertices[b].position.x/f,A.vertices[b].position.y/e),new a.UV(g/f,c/e),new a.UV(h/f,d/e)])}}var i=c.amount!==void 0?c.amount:100,j=c.bevelThickness!==void 0?c.bevelThickness:6,k=c.bevelSize!==void 0?c.bevelSize:j-2,l=c.bevelSegments!==void 0?c.bevelSegments:3,m=c.bevelEnabled!==void 0?c.bevelEnabled:!0,n=c.curveSegments!==void 0?c.curveSegments:12,o=c.steps!==void 0?c.steps:1,p=c.bendPath,q=c.extrudePath,r,s=!1,t=c.useSpacedPoints!==void 0?c.useSpacedPoints:!1,u=c.material,v=c.extrudeMaterial,w=this.shapebb;q&&(r=q.getPoints(n),o=r.length,s=!0,m=!1),m||(k=j=l=0);var x,y,z,A=this,B=this.vertices.length;p&&b.addWrapPath(p),n=t?b.extractAllSpacedPoints(n):b.extractAllPoints(n),p=n.shape,n=n.holes;if(q=!a.Shape.Utils.isClockWise(p)){p=p.reverse(),y=0;for(z=n.length;y<z;y++)x=n[y],a.Shape.Utils.isClockWise(x)&&(n[y]=x.reverse());q=!1}q=a.Shape.Utils.triangulateShape(p,n),t=p,y=0;for(z=n.length;y<z;y++)x=n[y],p=p.concat(x);var C,D,E,F,G,H,I=p.length,J=q.length,K=[];C=0,D=t.length,O=D-1;for(P=C+1;C<D;C++,O++,P++)O==D&&(O=0),P==D&&(P=0),K[C]=e(t[C],t[O],t[P]);var L=[],M,N=K.concat();y=0;for(z=n.length;y<z;y++){x=n[y],M=[],C=0,D=x.length,O=D-1;for(P=C+1;C<D;C++,O++,P++)O==D&&(O=0),P==D&&(P=0),M[C]=e(x[C],x[O],x[P]);L.push(M),N=N.concat(M)}for(E=0;E<l;E++){F=E/l,G=j*(1-F),F=k*Math.sin(F*Math.PI/2),C=0;for(D=t.length;C<D;C++)H=d(t[C],K[C],F),g(H.x,H.y,-G);y=0;for(z=n.length;y<z;y++){x=n[y],M=L[y],C=0;for(D=x.length;C<D;C++)H=d(x[C],M[C],F),g(H.x,H.y,-G)}}F=k;for(C=0;C<I;C++)H=m?d(p[C],N[C],F):p[C],s?g(H.x,H.y+r[0].y,r[0].x):g(H.x,H.y,0);for(E=1;E<=o;E++)for(C=0;C<I;C++)H=m?d(p[C],N[C],F):p[C],s?g(H.x,H.y+r[E-1].y,r[E-1].x):g(H.x,H.y,i/o*E);for(E=l-1;E>=0;E--){F=E/l,G=j*(1-F),F=k*Math.sin(F*Math.PI/2),C=0;for(D=t.length;C<D;C++)H=d(t[C],K[C],F),g(H.x,H.y,i+G);y=0;for(z=n.length;y<z;y++){x=n[y],M=L[y],C=0;for(D=x.length;C<D;C++)H=d(x[C],M[C],F),s?g(H.x,H.y+r[o-1].y,r[o-1].x+G):g(H.x,H.y,i+G)}}if(m){m=I*0;for(C=0;C<J;C++)k=q[C],h(k[2]+m,k[1]+m,k[0]+m);m=I*(o+l*2);for(C=0;C<J;C++)k=q[C],h(k[0]+m,k[1]+m,k[2]+m)}else{for(C=0;C<J;C++)k=q[C],h(k[2],k[1],k[0]);for(C=0;C<J;C++)k=q[C],h(k[0]+I*o,k[1]+I*o,k[2]+I*o)}var O,P,Q=0;f(t),Q+=t.length,y=0;for(z=n.length;y<z;y++)x=n[y],f(x),Q+=x.length},a.ExtrudeGeometry.__v1=new a.Vector2,a.ExtrudeGeometry.__v2=new a.Vector2,a.ExtrudeGeometry.__v3=new a.Vector2,a.ExtrudeGeometry.__v4=new a.Vector2,a.ExtrudeGeometry.__v5=new a.Vector2,a.ExtrudeGeometry.__v6=new a.Vector2,a.IcosahedronGeometry=function(b){function c(b,c,d){var e=Math.sqrt(b*b+c*c+d*d);return f.vertices.push(new a.Vertex(new a.Vector3(b/e,c/e,d/e)))-1}function d(b,c,d,e){e.faces.push(new a.Face3(b,c,d))}function e(a,b){var d=f.vertices[a].position,e=f.vertices[b].position;return c((d.x+e.x)/2,(d.y+e.y)/2,(d.z+e.z)/2)}var f=this,g=new a.Geometry;this.subdivisions=b||0,a.Geometry.call(this),b=(1+Math.sqrt(5))/2,c(-1,b,0),c(1,b,0),c(-1,-b,0),c(1,-b,0),c(0,-1,b),c(0,1,b),c(0,-1,-b),c(0,1,-b),c(b,0,-1),c(b,0,1),c(-b,0,-1),c(-b,0,1),d(0,11,5,g),d(0,5,1,g),d(0,1,7,g),d(0,7,10,g),d(0,10,11,g),d(1,5,9,g),d(5,11,4,g),d(11,10,2,g),d(10,7,6,g),d(7,1,8,g),d(3,9,4,g),d(3,4,2,g),d(3,2,6,g),d(3,6,8,g),d(3,8,9,g),d(4,9,5,g),d(2,4,11,g),d(6,2,10,g),d(8,6,7,g),d(9,8,1,g);for(var h=0;h<this.subdivisions;h++){var b=new a.Geometry,i;for(i in g.faces){var j=e(g.faces[i].a,g.faces[i].b),k=e(g.faces[i].b,g.faces[i].c),l=e(g.faces[i].c,g.faces[i].a);d(g.faces[i].a,j,l,b),d(g.faces[i].b,k,j,b),d(g.faces[i].c,l,k,b),d(j,k,l,b)}g.faces=b.faces}f.faces=g.faces,this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},a.IcosahedronGeometry.prototype=new a.Geometry,a.IcosahedronGeometry.prototype.constructor=a.IcosahedronGeometry,a.LatheGeometry=function(b,c,d){a.Geometry.call(this),this.steps=c||12,this.angle=d||2*Math.PI;for(var c=this.angle/this.steps,d=[],e=[],f=[],g=[],h=(new a.Matrix4).setRotationZ(c),i=0;i<b.length;i++)this.vertices.push(new a.Vertex(b[i])),d[i]=b[i].clone(),e[i]=this.vertices.length-1;for(var j=0;j<=this.angle+.001;j+=c){for(i=0;i<d.length;i++)j<this.angle?(d[i]=h.multiplyVector3(d[i].clone()),this.vertices.push(new a.Vertex(d[i])),f[i]=this.vertices.length-1):f=g;j==0&&(g=e);for(i=0;i<e.length-1;i++)this.faces.push(new a.Face4(f[i],f[i+1],e[i+1],e[i])),this.faceVertexUvs[0].push([new a.UV(1-j/this.angle,i/b.length),new a.UV(1-j/this.angle,(i+1)/b.length),new a.UV(1-(j-c)/this.angle,(i+1)/b.length),new a.UV(1-(j-c)/this.angle,i/b.length)]);e=f,f=[]}this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},a.LatheGeometry.prototype=new a.Geometry,a.LatheGeometry.prototype.constructor=a.LatheGeometry,a.OctahedronGeometry=function(b,c){function d(c){var d=c.clone().normalize(),d=new a.Vertex(d.clone().multiplyScalar(b));return d.index=h.vertices.push(d)-1,d.uv=new a.UV(Math.atan2(c.z,-c.x)/2/Math.PI+.5,Math.atan2(-c.y,Math.sqrt(c.x*c.x+c.z*c.z))/Math.PI+.5),d}function e(b,c,d,i){i<1?(i=new a.Face3(b.index,c.index,d.index,[b.position,c.position,d.position]),i.centroid.addSelf(b.position).addSelf(c.position).addSelf(d.position).divideScalar(3),i.normal=i.centroid.clone().normalize(),h.faces.push(i),i=Math.atan2(i.centroid.z,-i.centroid.x),h.faceVertexUvs[0].push([g(b.uv,b.position,i),g(c.uv,c.position,i),g(d.uv,d.position,i)])):(i-=1,e(b,f(b,c),f(b,d),i),e(f(b,c),c,f(c,d),i),e(f(b,d),f(c,d),d,i),e(f(b,c),f(c,d),f(b,d),i))}function f(b,c){i[b.index]||(i[b.index]=[]),i[c.index]||(i[c.index]=[]);var e=i[b.index][c.index];return e===void 0&&(i[b.index][c.index]=i[c.index][b.index]=e=d((new a.Vector3).add(b.position,c.position).divideScalar(2))),e}function g(b,c,d){return d<0&&b.u===1&&(b=new a.UV(b.u-1,b.v)),c.x===0&&c.z===0&&(b=new a.UV(d/2/Math.PI+.5,b.v)),b}a.Geometry.call(this);var c=isFinite(c)?c:3,h=this;d(new a.Vector3(1,0,0)),d(new a.Vector3(-1,0,0)),d(new a.Vector3(0,1,0)),d(new a.Vector3(0,-1,0)),d(new a.Vector3(0,0,1)),d(new a.Vector3(0,0,-1));var i=[],j=this.vertices;e(j[0],j[2],j[4],c),e(j[0],j[4],j[3],c),e(j[0],j[3],j[5],c),e(j[0],j[5],j[2],c),e(j[1],j[2],j[5],c),e(j[1],j[5],j[3],c),e(j[1],j[3],j[4],c),e(j[1],j[4],j[2],c),this.boundingSphere={radius:b}},a.OctahedronGeometry.prototype=new a.Geometry,a.OctahedronGeometry.prototype.constructor=a.OctahedronGeometry,a.PlaneGeometry=function(b,c,d,e){a.Geometry.call(this);var f,g=b/2,h=c/2,d=d||1,e=e||1,i=d+1,j=e+1;b/=d;var k=c/e;for(f=0;f<j;f++)for(c=0;c<i;c++)this.vertices.push(new a.Vertex(new a.Vector3(c*b-g,-(f*k-h),0)));for(f=0;f<e;f++)for(c=0;c<d;c++)this.faces.push(new a.Face4(c+i*f,c+i*(f+1),c+1+i*(f+1),c+1+i*f)),this.faceVertexUvs[0].push([new a.UV(c/d,f/e),new a.UV(c/d,(f+1)/e),new a.UV((c+1)/d,(f+1)/e),new a.UV((c+1)/d,f/e)]);this.computeCentroids(),this.computeFaceNormals()},a.PlaneGeometry.prototype=new a.Geometry,a.PlaneGeometry.prototype.constructor=a.PlaneGeometry,a.SphereGeometry=function(b,c,d){a.Geometry.call(this);for(var b=b||50,e,f=Math.PI,g=Math.max(3,c||8),h=Math.max(2,d||6),c=[],d=0;d<h+1;d++){e=d/h;var i=b*Math.cos(e*f),j=b*Math.sin(e*f),k=[],l=0;for(e=0;e<g;e++){var m=2*e/g,n=j*Math.sin(m*f),m=j*Math.cos(m*f);(d==0||d==h)&&e>0||(l=this.vertices.push(new a.Vertex(new a.Vector3(m,i,n)))-1),k.push(l)}c.push(k)}for(var o,p,q,f=c.length,d=0;d<f;d++)if(g=c[d].length,d>0)for(e=0;e<g;e++){k=e==g-1,h=c[d][k?0:e+1],i=c[d][k?g-1:e],j=c[d-1][k?g-1:e],k=c[d-1][k?0:e+1],n=d/(f-1),o=(d-1)/(f-1),p=(e+1)/g;var m=e/g,l=new a.UV(1-p,n),n=new a.UV(1-m,n),m=new a.UV(1-m,o),r=new a.UV(1-p,o);d<c.length-1&&(o=this.vertices[h].position.clone(),p=this.vertices[i].position.clone(),q=this.vertices[j].position.clone(),o.normalize(),p.normalize(),q.normalize(),this.faces.push(new a.Face3(h,i,j,[new a.Vector3(o.x,o.y,o.z),new a.Vector3(p.x,p.y,p.z),new a.Vector3(q.x,q.y,q.z)])),this.faceVertexUvs[0].push([l,n,m])),d>1&&(o=this.vertices[h].position.clone(),p=this.vertices[j].position.clone(),q=this.vertices[k].position.clone(),o.normalize(),p.normalize(),q.normalize(),this.faces.push(new a.Face3(h,j,k,[new a.Vector3(o.x,o.y,o.z),new a.Vector3(p.x,p.y,p.z),new a.Vector3(q.x,q.y,q.z)])),this.faceVertexUvs[0].push([l,m,r]))}this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals(),this.boundingSphere={radius:b}},a.SphereGeometry.prototype=new a.Geometry,a.SphereGeometry.prototype.constructor=a.SphereGeometry,a.TextGeometry=function(b,c){var d=(new a.TextPath(b,c)).toShapes();c.amount=c.height!==void 0?c.height:50,c.bevelThickness===void 0&&(c.bevelThickness=10),c.bevelSize===void 0&&(c.bevelSize=8),c.bevelEnabled===void 0&&(c.bevelEnabled=!1);if(c.bend){var e=d[d.length-1].getBoundingBox().maxX;c.bendPath=new a.QuadraticBezierCurve(new a.Vector2(0,0),new a.Vector2(e/2,120),new a.Vector2(e,0))}a.ExtrudeGeometry.call(this,d,c)},a.TextGeometry.prototype=new a.ExtrudeGeometry,a.TextGeometry.prototype.constructor=a.TextGeometry,a.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},getTextShapes:function(a,b){return(new TextPath(a,b)).toShapes()},loadFace:function(a){var b=a.familyName.toLowerCase();return this.faces[b]=this.faces[b]||{},this.faces[b][a.cssFontWeight]=this.faces[b][a.cssFontWeight]||{},this.faces[b][a.cssFontWeight][a.cssFontStyle]=a,this.faces[b][a.cssFontWeight][a.cssFontStyle]=a},drawText:function(b){for(var c=this.getFace(),d=this.size/c.resolution,e=0,f=String(b).split(""),g=f.length,h=[],b=0;b<g;b++){var i=new a.Path,i=this.extractGlyphPoints(f[b],c,d,e,i);e+=i.offset,h.push(i.path)}return{paths:h,offset:e/2}},extractGlyphPoints:function(b,c,d,e,f){var g=[],h,i,j,k,l,m,n,o,p,q,r=c.glyphs[b]||c.glyphs[ctxt.options.fallbackCharacter];if(r){if(r.o){c=r._cachedOutline||(r._cachedOutline=r.o.split(" ")),j=c.length;for(b=0;b<j;)switch(i=c[b++],i){case"m":i=c[b++]*d+e,k=c[b++]*d,g.push(new a.Vector2(i,k)),f.moveTo(i,k);break;case"l":i=c[b++]*d+e,k=c[b++]*d,g.push(new a.Vector2(i,k)),f.lineTo(i,k);break;case"q":i=c[b++]*d+e,k=c[b++]*d,n=c[b++]*d+e,o=c[b++]*d,f.quadraticCurveTo(n,o,i,k);if(h=g[g.length-1]){l=h.x,m=h.y,h=1;for(divisions=this.divisions;h<=divisions;h++){var s=h/divisions,t=a.Shape.Utils.b2(s,l,n,i),s=a.Shape.Utils.b2(s,m,o,k);g.push(new a.Vector2(t,s))}}break;case"b":if(i=c[b++]*d+e,k=c[b++]*d,n=c[b++]*d+e,o=c[b++]*-d,p=c[b++]*d+e,q=c[b++]*-d,f.bezierCurveTo(i,k,n,o,p,q),h=g[g.length-1]){l=h.x,m=h.y,h=1;for(divisions=this.divisions;h<=divisions;h++)s=h/divisions,t=a.Shape.Utils.b3(s,l,n,p,i),s=a.Shape.Utils.b3(s,m,o,q,k),g.push(new a.Vector2(t,s))}}}return{offset:r.ha*d,points:g,path:f}}}},function(a){var b=function(a){for(var b=a.length,c=0,d=b-1,e=0;e<b;d=e++)c+=a[d].x*a[e].y-a[e].x*a[d].y;return c*.5};return a.Triangulate=function(a,d){var e=a.length;if(e<3)return null;var f=[],g=[],h=[],i,j,k;if(b(a)>0)for(j=0;j<e;j++)g[j]=j;else for(j=0;j<e;j++)g[j]=e-1-j;var l=2*e;for(j=e-1;e>2;){if(l--<=0)return console.log("Warning, unable to triangulate polygon!"),d?h:f;i=j,e<=i&&(i=0),j=i+1,e<=j&&(j=0),k=j+1,e<=k&&(k=0);var m;n:{m=a;var o=i,p=j,q=k,r=e,s=g,t=void 0,u=void 0,v=void 0,w=void 0,x=void 0,y=void 0,z=void 0,A=void 0,B=void 0,u=m[s[o]].x,v=m[s[o]].y,w=m[s[p]].x,x=m[s[p]].y,y=m[s[q]].x,z=m[s[q]].y;if(1e-10>(w-u)*(z-v)-(x-v)*(y-u))m=!1;else{for(t=0;t<r;t++)if(t!=o&&t!=p&&t!=q){var A=m[s[t]].x,B=m[s[t]].y,C=void 0,D=void 0,E=void 0,F=void 0,G=void 0,H=void 0,I=void 0,J=void 0,K=void 0,L=void 0,M=void 0,N=void 0,C=E=G=void 0,C=y-w,D=z-x,E=u-y,F=v-z,G=w-u,H=x-v,I=A-u,J=B-v,K=A-w,L=B-x,M=A-y,N=B-z,C=C*L-D*K,G=G*J-H*I,E=E*N-F*M;if(C>=0&&E>=0&&G>=0){m=!1;break n}}m=!0}}if(m){f.push([a[g[i]],a[g[j]],a[g[k]]]),h.push([g[i],g[j],g[k]]),i=j;for(k=j+1;k<e;i++,k++)g[i]=g[k];e--,l=2*e}}return d?h:f},a.Triangulate.area=b,a}(a.FontUtils),self._typeface_js={faces:a.FontUtils.faces,loadFace:a.FontUtils.loadFace},a.TorusGeometry=function(b,c,d,e,f){a.Geometry.call(this),this.radius=b||100,this.tube=c||40,this.segmentsR=d||8,this.segmentsT=e||6,this.arc=f||Math.PI*2,f=new a.Vector3,b=[],c=[];for(d=0;d<=this.segmentsR;d++)for(e=0;e<=this.segmentsT;e++){var g=e/this.segmentsT*this.arc,h=d/this.segmentsR*Math.PI*2;f.x=this.radius*Math.cos(g),f.y=this.radius*Math.sin(g);var i=new a.Vector3;i.x=(this.radius+this.tube*Math.cos(h))*Math.cos(g),i.y=(this.radius+this.tube*Math.cos(h))*Math.sin(g),i.z=this.tube*Math.sin(h),this.vertices.push(new a.Vertex(i)),b.push(new a.UV(e/this.segmentsT,1-d/this.segmentsR)),c.push(i.clone().subSelf(f).normalize())}for(d=1;d<=this.segmentsR;d++)for(e=1;e<=this.segmentsT;e++){var f=(this.segmentsT+1)*d+e-1,g=(this.segmentsT+1)*(d-1)+e-1,h=(this.segmentsT+1)*(d-1)+e,i=(this.segmentsT+1)*d+e,j=new a.Face4(f,g,h,i,[c[f],c[g],c[h],c[i]]);j.normal.addSelf(c[f]),j.normal.addSelf(c[g]),j.normal.addSelf(c[h]),j.normal.addSelf(c[i]),j.normal.normalize(),this.faces.push(j),this.faceVertexUvs[0].push([b[f].clone(),b[g].clone(),b[h].clone(),b[i].clone()])}this.computeCentroids()},a.TorusGeometry.prototype=new a.Geometry,a.TorusGeometry.prototype.constructor=a.TorusGeometry,a.TorusKnotGeometry=function(b,c,d,e,f,g,h){function i(b,c,d,e,f,g){return c=d/e*b,d=Math.cos(c),new a.Vector3(f*(2+d)*.5*Math.cos(b),f*(2+d)*Math.sin(b)*.5,g*f*Math.sin(c)*.5)}a.Geometry.call(this),this.radius=b||200,this.tube=c||40,this.segmentsR=d||64,this.segmentsT=e||8,this.p=f||2,this.q=g||3,this.heightScale=h||1,this.grid=Array(this.segmentsR),d=new a.Vector3,e=new a.Vector3,g=new a.Vector3;for(b=0;b<this.segmentsR;++b){this.grid[b]=Array(this.segmentsT);for(c=0;c<this.segmentsT;++c){var j=b/this.segmentsR*2*this.p*Math.PI,h=c/this.segmentsT*2*Math.PI,f=i(j,h,this.q,this.p,this.radius,this.heightScale),j=i(j+.01,h,this.q,this.p,this.radius,this.heightScale);d.x=j.x-f.x,d.y=j.y-f.y,d.z=j.z-f.z,e.x=j.x+f.x,e.y=j.y+f.y,e.z=j.z+f.z,g.cross(d,e),e.cross(g,d),g.normalize(),e.normalize(),j=-this.tube*Math.cos(h),h=this.tube*Math.sin(h),f.x+=j*e.x+h*g.x,f.y+=j*e.y+h*g.y,f.z+=j*e.z+h*g.z,this.grid[b][c]=this.vertices.push(new a.Vertex(new a.Vector3(f.x,f.y,f.z)))-1}}for(b=0;b<this.segmentsR;++b)for(c=0;c<this.segmentsT;++c){var e=(b+1)%this.segmentsR,g=(c+1)%this.segmentsT,f=this.grid[b][c],d=this.grid[e][c],e=this.grid[e][g],g=this.grid[b][g],h=new a.UV(b/this.segmentsR,c/this.segmentsT),j=new a.UV((b+1)/this.segmentsR,c/this.segmentsT),k=new a.UV((b+1)/this.segmentsR,(c+1)/this.segmentsT),l=new a.UV(b/this.segmentsR,(c+1)/this.segmentsT);this.faces.push(new a.Face4(f,d,e,g)),this.faceVertexUvs[0].push([h,j,k,l])}this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},a.TorusKnotGeometry.prototype=new a.Geometry,a.TorusKnotGeometry.prototype.constructor=a.TorusKnotGeometry,a.SubdivisionModifier=function(a){this.subdivisions=a===void 0?1:a,this.useOldVertexColors=!1,this.supportUVs=!0},a.SubdivisionModifier.prototype.constructor=a.SubdivisionModifier,a.SubdivisionModifier.prototype.modify=function(a){for(var b=this.subdivisions;b-->0;)this.smooth(a)},a.SubdivisionModifier.prototype.smooth=function(b){function c(b,c,d,e,i,j){var k=new a.Face4(b,c,d,e,null,i.color,i.material);if(h.useOldVertexColors){k.vertexColors=[];for(var l,n,o,p=0;p<4;p++){o=j[p],l=new a.Color,l.setRGB(0,0,0);for(var q=0;q<o.length;q++)n=i.vertexColors[o[q]-1],l.r+=n.r,l.g+=n.g,l.b+=n.b;l.r/=o.length,l.g/=o.length,l.b/=o.length,k.vertexColors[p]=l}}f.push(k),(!h.supportUVs||m.length!=0)&&g.push([m[b],m[c],m[d],m[e]])}function d(a,b){return Math.min(a,b)+"_"+Math.max(a,b)}var e=[],f=[],g=[],h=this,i=b.vertices,e=b.faces,j=i.concat(),k=[],l={},m=[],n,o,p,q,r,s=b.faceVertexUvs[0];n=0;for(o=s.length;n<o;n++){p=0;for(q=s[n].length;p<q;p++)r=e[n]["abcd".charAt(p)],m[r]||(m[r]=s[n][p])}var t;n=0;for(o=e.length;n<o;n++)if(r=e[n],k.push(r.centroid),j.push(new a.Vertex(r.centroid)),h.supportUVs&&m.length!=0)t=new a.UV,r instanceof a.Face3?(t.u=m[r.a].u+m[r.b].u+m[r.c].u,t.v=m[r.a].v+m[r.b].v+m[r.c].v,t.u/=3,t.v/=3):r instanceof a.Face4&&(t.u=m[r.a].u+m[r.b].u+m[r.c].u+m[r.d].u,t.v=m[r.a].v+m[r.b].v+m[r.c].v+m[r.d].v,t.u/=4,t.v/=4),m.push(t);q=function(b){function c(a,b,c){a[b]===void 0&&(a[b]=[]),a[b].push(c)}var e,f,g,h,i={};e=0;for(f=b.faces.length;e<f;e++)g=b.faces[e],g instanceof a.Face3?(h=d(g.a,g.b),c(i,h,e),h=d(g.b,g.c),c(i,h,e),h=d(g.c,g.a),c(i,h,e)):g instanceof a.Face4&&(h=d(g.a,g.b),c(i,h,e),h=d(g.b,g.c),c(i,h,e),h=d(g.c,g.d),c(i,h,e),h=d(g.d,g.a),c(i,h,e));return i}(b);var u,v,w=0,s=i.length,x;for(n in q)if(r=q[n],t=r[0],u=r[1],x=n.split("_"),o=x[0],x=x[1],v=new a.Vector3,r.length!=2?(v.addSelf(i[o].position),v.addSelf(i[x].position),v.multiplyScalar(.5)):(v.addSelf(k[t]),v.addSelf(k[u]),v.addSelf(i[o].position),v.addSelf(i[x].position),v.multiplyScalar(.25)),l[n]=s+e.length+w,j.push(new a.Vertex(v)),w++,h.supportUVs&&m.length!=0)t=new a.UV,t.u=m[o].u+m[x].u,t.v=m[o].v+m[x].v,t.u/=2,t.v/=2,m.push(t);n=0;for(o=k.length;n<o;n++)r=e[n],t=s+n,r instanceof a.Face3?(u=d(r.a,r.b),x=d(r.b,r.c),w=d(r.c,r.a),c(t,l[u],r.b,l[x],r,["123","12","2","23"]),c(t,l[x],r.c,l[w],r,["123","23","3","31"]),c(t,l[w],r.a,l[u],r,["123","31","1","12"])):r instanceof a.Face4?(u=d(r.a,r.b),x=d(r.b,r.c),w=d(r.c,r.d),v=d(r.d,r.a),c(t,l[u],r.b,l[x],r,["1234","12","2","23"]),c(t,l[x],r.c,l[w],r,["1234","23","3","34"]),c(t,l[w],r.d,l[v],r,["1234","34","4","41"]),c(t,l[v],r.a,l[u],r,["1234","41","1","12"])):console.log("face should be a face!",r);var e=j,y={},z={},j=function(a,b){y[a]===void 0&&(y[a]=[]),y[a].push(b)},l=function(a,b){z[a]===void 0&&(z[a]={}),z[a][b]=null};for(n in q)r=q[n],x=n.split("_"),o=x[0],x=x[1],j(o,[o,x]),j(x,[o,x]),t=r[0],u=r[1],l(o,t),u?l(o,u):l(o,t),l(x,t),u?l(x,u):l(x,t);j=new a.Vector3,l=new a.Vector3,n=0;for(o=i.length;n<o;n++)if(y[n]!==void 0){j.set(0,0,0),l.set(0,0,0),q=new a.Vector3(0,0,0),s=0;for(p in z[n])j.addSelf(k[p]),s++;j.divideScalar(s),s=y[n].length;for(p=0;p<s;p++)r=y[n][p],r=i[r[0]].position.clone().addSelf(i[r[1]].position).divideScalar(2),l.addSelf(r);l.divideScalar(s),q.addSelf(i[n].position),q.multiplyScalar(s-3),q.addSelf(j),q.addSelf(l.multiplyScalar(2)),q.divideScalar(s),e[n].position=q}b.vertices=e,b.faces=f,b.faceVertexUvs[0]=g,delete b.__tmpVertices,b.computeCentroids(),b.computeFaceNormals(),b.computeVertexNormals()},a.Loader=function(b){this.statusDomElement=(this.showStatus=b)?a.Loader.prototype.addStatusElement():null,this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}},a.Loader.prototype={constructor:a.Loader,addStatusElement:function(){var a=document.createElement("div");return a.style.position="absolute",a.style.right="0px",a.style.top="0px",a.style.fontSize="0.8em",a.style.textAlign="left",a.style.background="rgba(0,0,0,0.25)",a.style.color="#fff",a.style.width="120px",a.style.padding="0.5em 0.5em 0.5em 0.5em",a.style.zIndex=1e3,a.innerHTML="Loading ...",a},updateProgress:function(a){var b="Loaded ";b+=a.total?(100*a.loaded/a.total).toFixed(0)+"%":(a.loaded/1e3).toFixed(2)+" KB",this.statusDomElement.innerHTML=b},extractUrlbase:function(a){return a=a.split("/"),a.pop(),a.length<1?"":a.join("/")+"/"},init_materials:function(b,c,d){b.materials=[];for(var e=0;e<c.length;++e)b.materials[e]=[a.Loader.prototype.createMaterial(c[e],d)]},hasNormals:function(b){var c,d,e=b.materials.length;for(d=0;d<e;d++)if(c=b.materials[d][0],c instanceof a.ShaderMaterial)return!0;return!1},createMaterial:function(b,c){function d(a){return a=Math.log(a)/Math.LN2,Math.floor(a)==a}function e(a,b){var c=new Image;c.onload=function(){if(!d(this.width)||!d(this.height)){var b=Math.pow(2,Math.round(Math.log(this.width)/Math.LN2)),c=Math.pow(2,Math.round(Math.log(this.height)/Math.LN2));a.image.width=b,a.image.height=c,a.image.getContext("2d").drawImage(this,0,0,b,c)}else a.image=this;a.needsUpdate=!0},c.src=b}function f(b,d,f,g,h,i){var j=document.createElement("canvas");b[d]=new a.Texture(j),b[d].sourceFile=f,g&&(b[d].repeat.set(g[0],g[1]),g[0]!=1&&(b[d].wrapS=a.RepeatWrapping),g[1]!=1&&(b[d].wrapT=a.RepeatWrapping)),h&&b[d].offset.set(h[0],h[1]),i&&(g={repeat:a.RepeatWrapping,mirror:a.MirroredRepeatWrapping},g[i[0]]!==void 0&&(b[d].wrapS=g[i[0]]),g[i[1]]!==void 0&&(b[d].wrapT=g[i[1]])),e(b[d],c+"/"+f)}function g(a){return(a[0]*255<<16)+(a[1]*255<<8)+a[2]*255}var h,i,j;i="MeshLambertMaterial",h={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,wireframe:b.wireframe},b.shading&&(b.shading=="Phong"?i="MeshPhongMaterial":b.shading=="Basic"&&(i="MeshBasicMaterial")),b.blending&&(b.blending=="Additive"?h.blending=a.AdditiveBlending:b.blending=="Subtractive"?h.blending=a.SubtractiveBlending:b.blending=="Multiply"&&(h.blending=a.MultiplyBlending));if(b.transparent!==void 0||b.opacity<1)h.transparent=b.transparent;b.depthTest!==void 0&&(h.depthTest=b.depthTest),b.vertexColors!==void 0&&(b.vertexColors=="face"?h.vertexColors=a.FaceColors:b.vertexColors&&(h.vertexColors=a.VertexColors)),b.colorDiffuse?h.color=g(b.colorDiffuse):b.DbgColor&&(h.color=b.DbgColor),b.colorSpecular&&(h.specular=g(b.colorSpecular)),b.colorAmbient&&(h.ambient=g(b.colorAmbient)),b.transparency&&(h.opacity=b.transparency),b.specularCoef&&(h.shininess=b.specularCoef),b.mapDiffuse&&c&&f(h,"map",b.mapDiffuse,b.mapDiffuseRepeat,b.mapDiffuseOffset,b.mapDiffuseWrap),b.mapLight&&c&&f(h,"lightMap",b.mapLight,b.mapLightRepeat,b.mapLightOffset,b.mapLightWrap),b.mapNormal&&c&&f(h,"normalMap",b.mapNormal,b.mapNormalRepeat,b.mapNormalOffset,b.mapNormalWrap),b.mapSpecular&&c&&f(h,"specularMap",b.mapSpecular,b.mapSpecularRepeat,b.mapSpecularOffset,b.mapSpecularWrap);if(b.mapNormal){var k=a.ShaderUtils.lib.normal,l=a.UniformsUtils.clone(k.uniforms),m=h.color;i=h.specular,j=h.ambient;var n=h.shininess;l.tNormal.texture=h.normalMap,b.mapNormalFactor&&(l.uNormalScale.value=b.mapNormalFactor),h.map&&(l.tDiffuse.texture=h.map,l.enableDiffuse.value=!0),h.specularMap&&(l.tSpecular.texture=h.specularMap,l.enableSpecular.value=!0),h.lightMap&&(l.tAO.texture=h.lightMap,l.enableAO.value=!0),l.uDiffuseColor.value.setHex(m),l.uSpecularColor.value.setHex(i),l.uAmbientColor.value.setHex(j),l.uShininess.value=n,h.opacity&&(l.uOpacity.value=h.opacity),h=new a.ShaderMaterial({fragmentShader:k.fragmentShader,vertexShader:k.vertexShader,uniforms:l,lights:!0,fog:!0})}else h=new a[i](h);return h}},a.BinaryLoader=function(b){a.Loader.call(this,b)},a.BinaryLoader.prototype=new a.Loader,a.BinaryLoader.prototype.constructor=a.BinaryLoader,a.BinaryLoader.prototype.supr=a.Loader.prototype,a.BinaryLoader.prototype.load=function(b){var c=b.model,d=b.callback,e=b.texture_path?b.texture_path:a.Loader.prototype.extractUrlbase(c),f=b.bin_path?b.bin_path:a.Loader.prototype.extractUrlbase(c),b=(new Date).getTime(),c=new Worker(c),g=this.showProgress?a.Loader.prototype.updateProgress:null;c.onmessage=function(b){a.BinaryLoader.prototype.loadAjaxBuffers(b.data.buffers,b.data.materials,d,f,e,g)},c.onerror=function(a){alert("worker.onerror: "+a.message+"\n"+a.data),a.preventDefault()},c.postMessage(b)},a.BinaryLoader.prototype.loadAjaxBuffers=function(b,c,d,e,f,g){var h=new XMLHttpRequest,i=e+"/"+b,j=0;h.onreadystatechange=function(){h.readyState==4?h.status==200||h.status==0?a.BinaryLoader.prototype.createBinModel(h.responseText,d,f,c):alert("Couldn't load ["+i+"] ["+h.status+"]"):h.readyState==3?g&&(j==0&&(j=h.getResponseHeader("Content-Length")),g({total:j,loaded:h.responseText.length})):h.readyState==2&&(j=h.getResponseHeader("Content-Length"))},h.open("GET",i,!0),h.overrideMimeType("text/plain; charset=x-user-defined"),h.setRequestHeader("Content-Type","text/plain"),h.send(null)},a.BinaryLoader.prototype.createBinModel=function(b,c,d,e){var f=function(c){function d(a,b){var c=i(a,b),d=i(a,b+1),e=i(a,b+2),f=i(a,b+3),g=(f<<1&255|e>>7)-127;return c|=(e&127)<<16|d<<8,c==0&&g==-127?0:(1-2*(f>>7))*(1+c*Math.pow(2,-23))*Math.pow(2,g)}function f(a,b){var c=i(a,b),d=i(a,b+1),e=i(a,b+2);return(i(a,b+3)<<24)+(e<<16)+(d<<8)+c}function g(a,b){var c=i(a,b);return(i(a,b+1)<<8)+c}function h(a,b){var c=i(a,b);return c>127?c-256:c}function i(a,b){return a.charCodeAt(b)&255}function j(c){var d,e,h;d=f(b,c),e=f(b,c+u),h=f(b,c+v),c=g(b,c+w),p.faces.push(new a.Face3(d,e,h,null,null,p.materials[c]))}function k(c){var d,e,h,i,j,k;d=f(b,c),e=f(b,c+u),h=f(b,c+v),i=g(b,c+w),j=f(b,c+x),k=f(b,c+y),c=f(b,c+z),i=p.materials[i];var l=s[k*3],m=s[k*3+1];k=s[k*3+2];var n=s[c*3],o=s[c*3+1],c=s[c*3+2];p.faces.push(new a.Face3(d,e,h,[new a.Vector3(s[j*3],s[j*3+1],s[j*3+2]),new a.Vector3(l,m,k),new a.Vector3(n,o,c)],null,i))}function l(c){var d,e,h,i;d=f(b,c),e=f(b,c+A),h=f(b,c+B),i=f(b,c+C),c=g(b,c+D),p.faces.push(new a.Face4(d,e,h,i,null,null,p.materials[c]))}function m(c){var d,e,h,i,j,k,l,m;d=f(b,c),e=f(b,c+A),h=f(b,c+B),i=f(b,c+C),j=g(b,c+D),k=f(b,c+E),l=f(b,c+F),m=f(b,c+G),c=f(b,c+H),j=p.materials[j];var n=s[l*3],o=s[l*3+1];l=s[l*3+2];var q=s[m*3],r=s[m*3+1];m=s[m*3+2];var t=s[c*3],u=s[c*3+1],c=s[c*3+2];p.faces.push(new a.Face4(d,e,h,i,[new a.Vector3(s[k*3],s[k*3+1],s[k*3+2]),new a.Vector3(n,o,l),new a.Vector3(q,r,m),new a.Vector3(t,u,c)],null,j))}function n(c){var d,e,g,h;d=f(b,c),e=f(b,c+I),g=f(b,c+J),c=t[d*2],h=t[d*2+1],d=t[e*2];var i=p.faceVertexUvs[0];e=t[e*2+1];var j=t[g*2];g=t[g*2+1];var k=[];k.push(new a.UV(c,h)),k.push(new a.UV(d,e)),k.push(new a.UV(j,g)),i.push(k)}function o(c){var d,e,g,h,i,j;d=f(b,c),e=f(b,c+K),g=f(b,c+L),h=f(b,c+M),c=t[d*2],i=t[d*2+1],d=t[e*2],j=t[e*2+1],e=t[g*2];var k=p.faceVertexUvs[0];g=t[g*2+1];var l=t[h*2];h=t[h*2+1];var m=[];m.push(new a.UV(c,i)),m.push(new a.UV(d,j)),m.push(new a.UV(e,g)),m.push(new a.UV(l,h)),k.push(m)}var p=this,q=0,r,s=[],t=[],u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S;a.Geometry.call(this),a.Loader.prototype.init_materials(p,e,c),r={signature:b.substr(q,8),header_bytes:i(b,q+8),vertex_coordinate_bytes:i(b,q+9),normal_coordinate_bytes:i(b,q+10),uv_coordinate_bytes:i(b,q+11),vertex_index_bytes:i(b,q+12),normal_index_bytes:i(b,q+13),uv_index_bytes:i(b,q+14),material_index_bytes:i(b,q+15),nvertices:f(b,q+16),nnormals:f(b,q+16+4),nuvs:f(b,q+16+8),ntri_flat:f(b,q+16+12),ntri_smooth:f(b,q+16+16),ntri_flat_uv:f(b,q+16+20),ntri_smooth_uv:f(b,q+16+24),nquad_flat:f(b,q+16+28),nquad_smooth:f(b,q+16+32),nquad_flat_uv:f(b,q+16+36),nquad_smooth_uv:f(b,q+16+40)},q+=r.header_bytes,u=r.vertex_index_bytes,v=r.vertex_index_bytes*2,w=r.vertex_index_bytes*3,x=r.vertex_index_bytes*3+r.material_index_bytes,y=r.vertex_index_bytes*3+r.material_index_bytes+r.normal_index_bytes,z=r.vertex_index_bytes*3+r.material_index_bytes+r.normal_index_bytes*2,A=r.vertex_index_bytes,B=r.vertex_index_bytes*2,C=r.vertex_index_bytes*3,D=r.vertex_index_bytes*4,E=r.vertex_index_bytes*4+r.material_index_bytes,F=r.vertex_index_bytes*4+r.material_index_bytes+r.normal_index_bytes,G=r.vertex_index_bytes*4+r.material_index_bytes+r.normal_index_bytes*2,H=r.vertex_index_bytes*4+r.material_index_bytes+r.normal_index_bytes*3,I=r.uv_index_bytes,J=r.uv_index_bytes*2,K=r.uv_index_bytes,L=r.uv_index_bytes*2,M=r.uv_index_bytes*3,c=r.vertex_index_bytes*3+r.material_index_bytes,S=r.vertex_index_bytes*4+r.material_index_bytes,N=r.ntri_flat*c,O=r.ntri_smooth*(c+r.normal_index_bytes*3),P=r.ntri_flat_uv*(c+r.uv_index_bytes*3),Q=r.ntri_smooth_uv*(c+r.normal_index_bytes*3+r.uv_index_bytes*3),R=r.nquad_flat*S,c=r.nquad_smooth*(S+r.normal_index_bytes*4),S=r.nquad_flat_uv*(S+r.uv_index_bytes*4),q+=function(c){for(var e,f,g,h=r.vertex_coordinate_bytes*3,i=c+r.nvertices*h;c<i;c+=h)e=d(b,c),f=d(b,c+r.vertex_coordinate_bytes),g=d(b,c+r.vertex_coordinate_bytes*2),p.vertices.push(new a.Vertex(new a.Vector3(e,f,g)));return r.nvertices*h}(q),q+=function(a){for(var c,d,e,f=r.normal_coordinate_bytes*3,g=a+r.nnormals*f;a<g;a+=f)c=h(b,a),d=h(b,a+r.normal_coordinate_bytes),e=h(b,a+r.normal_coordinate_bytes*2),s.push(c/127,d/127,e/127);return r.nnormals*f}(q),q+=function(a){for(var c,e,f=r.uv_coordinate_bytes*2,g=a+r.nuvs*f;a<g;a+=f)c=d(b,a),e=d(b,a+r.uv_coordinate_bytes),t.push(c,e);return r.nuvs*f}(q),N=q+N,O=N+O,P=O+P,Q=P+Q,R=Q+R,c=R+c,S=c+S,function(a){var b,c=r.vertex_index_bytes*3+r.material_index_bytes,d=c+r.uv_index_bytes*3,e=a+r.ntri_flat_uv*d;for(b=a;b<e;b+=d)j(b),n(b+c);return e-a}(O),function(a){var b,c=r.vertex_index_bytes*3+r.material_index_bytes+r.normal_index_bytes*3,d=c+r.uv_index_bytes*3,e=a+r.ntri_smooth_uv*d;for(b=a;b<e;b+=d)k(b),n(b+c);return e-a}(P),function(a){var b,c=r.vertex_index_bytes*4+r.material_index_bytes,d=c+r.uv_index_bytes*4,e=a+r.nquad_flat_uv*d;for(b=a;b<e;b+=d)l(b),o(b+c);return e-a}(c),function(a){var b,c=r.vertex_index_bytes*4+r.material_index_bytes+r.normal_index_bytes*4,d=c+r.uv_index_bytes*4,e=a+r.nquad_smooth_uv*d;for(b=a;b<e;b+=d)m(b),o(b+c);return e-a}(S),function(a){var b,c=r.vertex_index_bytes*3+r.material_index_bytes,d=a+r.ntri_flat*c;for(b=a;b<d;b+=c)j(b);return d-a}(q),function(a){var b,c=r.vertex_index_bytes*3+r.material_index_bytes+r.normal_index_bytes*3,d=a+r.ntri_smooth*c;for(b=a;b<d;b+=c)k(b);return d-a}(N),function(a){var b,c=r.vertex_index_bytes*4+r.material_index_bytes,d=a+r.nquad_flat*c;for(b=a;b<d;b+=c)l(b);return d-a}(Q),function(a){var b,c=r.vertex_index_bytes*4+r.material_index_bytes+r.normal_index_bytes*4,d=a+r.nquad_smooth*c;for(b=a;b<d;b+=c)m(b);return d-a}(R),this.computeCentroids(),this.computeFaceNormals(),a.Loader.prototype.hasNormals(this)&&this.computeTangents()};f.prototype=new a.Geometry,f.prototype.constructor=f,c(new f(d))},a.ColladaLoader=function(){function b(a,b,c){for(var a=S.evaluate(a,S,L,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),d={},e=a.iterateNext(),f=0;e;)e=(new b).parse(e),e.id.length==0&&(e.id=c+f++),d[e.id]=e,e=a.iterateNext();return d}function c(){var a=1e6,b=-a,c=0,d;for(d in Y)for(var e=Y[d],f=0;f<e.sampler.length;f++){var g=e.sampler[f];g.create(),a=Math.min(a,g.startTime),b=Math.max(b,g.endTime),c=Math.max(c,g.input.length)}return{start:a,end:b,frames:c}}function d(b,c,e,f){b.world=b.world||new a.Matrix4,b.world.copy(b.matrix);if(b.channels&&b.channels.length){var g=b.channels[0].sampler.output[e];g instanceof a.Matrix4&&b.world.copy(g)}f&&b.world.multiply(f,b.world),c.push(b);for(f=0;f<b.nodes.length;f++)d(b.nodes[f],c,e,b.world)}function e(b,e,f){var g=Z[e.url];if(!g||!g.skin)console.log("ColladaLoader: Could not find skin controller.");else if(!e.skeleton||!e.skeleton.length)console.log("ColladaLoader: Could not find the skeleton for the skin. ");else{var h=c(),e=U.getChildById(e.skeleton[0],!0)||U.getChildBySid(e.skeleton[0],!0),i,j,k,l,m=new a.Vector3,n;for(i=0;i<b.vertices.length;i++)g.skin.bindShapeMatrix.multiplyVector3(b.vertices[i].position);for(f=0;f<h.frames;f++){var o=[],p=[];for(i=0;i<b.vertices.length;i++)p.push(new a.Vertex(new a.Vector3));d(e,o,f),i=o,j=g.skin;for(l=0;l<i.length;l++)if(k=i[l],n=-1,k.type=="JOINT"){for(var q=0;q<j.joints.length;q++)if(k.sid==j.joints[q]){n=q;break}if(n<0)throw"ColladaLoader: Could not find joint '"+k.sid+"'.";q=j.invBindMatrices[n],k.invBindMatrix=q,k.skinningMatrix=new a.Matrix4,k.skinningMatrix.multiply(k.world,q),k.weights=[];for(q=0;q<j.weights.length;q++)for(var r=0;r<j.weights[q].length;r++){var s=j.weights[q][r];s.joint==n&&k.weights.push(s)}}for(i=0;i<o.length;i++)if(o[i].type=="JOINT")for(j=0;j<o[i].weights.length;j++)k=o[i].weights[j],l=k.index,k=k.weight,n=b.vertices[l],l=p[l],m.x=n.position.x,m.y=n.position.y,m.z=n.position.z,o[i].skinningMatrix.multiplyVector3(m),l.position.x+=m.x*k,l.position.y+=m.y*k,l.position.z+=m.z*k;b.morphTargets.push({name:"target_"+f,vertices:p})}}}function f(b){var c=new a.Object3D,d,g,h;c.name=b.id||"",c.matrixAutoUpdate=!1,c.matrix=b.matrix;for(h=0;h<b.controllers.length;h++){var i=Z[b.controllers[h].url];switch(i.type){case"skin":if($[i.skin.source]){var k=new r;k.url=i.skin.source,k.instance_material=b.controllers[h].instance_material,b.geometries.push(k),d=b.controllers[h]}else Z[i.skin.source]&&(g=i=Z[i.skin.source],i.morph&&$[i.morph.source])&&(k=new r,k.url=i.morph.source,k.instance_material=b.controllers[h].instance_material,b.geometries.push(k));break;case"morph":$[i.morph.source]&&(k=new r,k.url=i.morph.source,k.instance_material=b.controllers[h].instance_material,b.geometries.push(k),g=b.controllers[h]),console.log("ColladaLoader: Morph-controller partially supported.")}}for(h=0;h<b.geometries.length;h++){var i=b.geometries[h],k=i.instance_material,i=$[i.url],l={},m=0,n;if(i&&i.mesh&&i.mesh.primitives){c.name.length==0&&(c.name=i.id);if(k)for(j=0;j<k.length;j++){n=k[j];var o=ba[_[n.target].instance_effect.url].shader;o.material.opacity=o.material.opacity?o.material.opacity:1,n=l[n.symbol]=o.material,m++}k=n||new a.MeshLambertMaterial({color:14540253,shading:a.FlatShading}),i=i.mesh.geometry3js;if(m>1){k=new a.MeshFaceMaterial;for(j=0;j<i.faces.length;j++)m=i.faces[j],m.materials=[l[m.daeMaterial]]}if(d!==void 0)e(i,d),k.morphTargets=!0,k=new a.SkinnedMesh(i,k),k.skeleton=d.skeleton,k.skinController=Z[d.url],k.skinInstanceController=d,k.name="skin_"+be.length,be.push(k);else if(g!==void 0){l=i,m=g instanceof p?Z[g.url]:g;if(!m||!m.morph)console.log("could not find morph controller!");else{m=m.morph;for(o=0;o<m.targets.length;o++){var q=$[m.targets[o]];q.mesh&&q.mesh.primitives&&q.mesh.primitives.length&&(q=q.mesh.primitives[0].geometry,q.vertices.length===l.vertices.length&&l.morphTargets.push({name:"target_1",vertices:q.vertices}))}l.morphTargets.push({name:"target_Z",vertices:l.vertices})}k.morphTargets=!0,k=new a.Mesh(i,k),k.name="morph_"+bd.length,bd.push(k)}else k=new a.Mesh(i,k);c.add(k)}}for(h=0;h<b.nodes.length;h++)c.add(f(b.nodes[h],b));return c}function g(){this.init_from=this.id=""}function h(){this.type=this.name=this.id="",this.morph=this.skin=null}function k(){this.weights=this.targets=this.source=this.method=null}function l(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function m(){this.name=this.id="",this.nodes=[],this.scene=new a.Object3D}function n(){this.sid=this.name=this.id="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new a.Matrix4}function o(){this.type=this.sid="",this.data=[],this.matrix=new a.Matrix4}function p(){this.url="",this.skeleton=[],this.instance_material=[]}function q(){this.target=this.symbol=""}function r(){this.url="",this.instance_material=[]}function s(){this.id="",this.mesh=null}function t(a){this.geometry=a.id,this.primitives=[],this.geometry3js=this.vertices=null}function u(){}function v(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new a.Geometry}function w(){this.source="",this.stride=this.count=0,this.params=[]}function x(){this.input={}}function y(){this.semantic="",this.offset=0,this.source="",this.set=0}function z(a){this.id=a,this.type=null}function A(){this.name=this.id="",this.instance_effect=null}function B(){this.color=new a.Color(0),this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texcoord=this.texture=null}function C(a,b){this.type=a,this.effect=b,this.material=null}function D(a){this.effect=a,this.format=this.init_from=null}function E(a){this.effect=a,this.mipfilter=this.magfilter=this.minfilter=this.wrap_t=this.wrap_s=this.source=null}function F(){this.name=this.id="",this.sampler=this.surface=this.shader=null}function G(){this.url=""}function H(){this.name=this.id="",this.source={},this.sampler=[],this.channel=[]}function I(a){this.animation=a,this.target=this.source="",this.member=this.arrIndices=this.arrSyntax=this.dotSyntax=this.sid=null}function J(a){this.id="",this.animation=a,this.inputs=[],this.endTime=this.startTime=this.interpolation=this.output=this.input=null,this.duration=0}function K(a){var b=a.getAttribute("id");return W[b]!=void 0?W[b]:(W[b]=(new z(b)).parse(a),W[b])}function L(a){return a=="dae"?"http://www.collada.org/2005/11/COLLADASchema":null}function M(a){for(var a=O(a),b=[],c=0;c<a.length;c++)b.push(parseFloat(a[c]));return b}function N(a){for(var a=O(a),b=[],c=0;c<a.length;c++)b.push(parseInt(a[c],10));return b}function O(a){return a.replace(/^\s+/,"").replace(/\s+$/,"").split(/\s+/)}function P(a,b,c){return a.hasAttribute(b)?parseInt(a.getAttribute(b),10):c}function Q(a,b){if(a===void 0){for(var c="0.";c.length<b+2;)c+="0";return c}b=b||2,c=a.toString().split(".");for(c[1]=c.length>1?c[1].substr(0,b):"0";c[1].length<b;)c[1]+="0";return c.join(".")}function R(a,b){var c="";return c+=Q(a.x,b)+",",c+=Q(a.y,b)+",",c+=Q(a.z,b),c}var S=null,T=null,U,V=null,W={},X={},Y={},Z={},$={},_={},ba={},bb,bc,bd,be,bf=a.SmoothShading;return g.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];c.nodeName=="init_from"&&(this.init_from=c.textContent)}return this},h.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.type="none";for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"skin":this.skin=(new l).parse(c),this.type=c.nodeName;break;case"morph":this.morph=(new k).parse(c),this.type=c.nodeName}}return this},k.prototype.parse=function(a){var b={},c=[],d;this.method=a.getAttribute("method"),this.source=a.getAttribute("source").replace(/^#/,"");for(d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];if(e.nodeType==1)switch(e.nodeName){case"source":e=(new z).parse(e),b[e.id]=e;break;case"targets":c=this.parseInputs(e);break;default:console.log(e.nodeName)}}for(d=0;d<c.length;d++)switch(a=c[d],e=b[a.source],a.semantic){case"MORPH_TARGET":this.targets=e.read();break;case"MORPH_WEIGHT":this.weights=e.read()}return this},k.prototype.parseInputs=function(a){for(var b=[],c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(d.nodeType==1)switch(d.nodeName){case"input":b.push((new y).parse(d))}}return b},l.prototype.parse=function(b){var c={},d,e;this.source=b.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var f=0;f<b.childNodes.length;f++){var g=b.childNodes[f];if(g.nodeType==1)switch(g.nodeName){case"bind_shape_matrix":g=M(g.textContent),this.bindShapeMatrix=new a.Matrix4,this.bindShapeMatrix.set(g[0],g[1],g[2],g[3],g[4],g[5],g[6],g[7],g[8],g[9],g[10],g[11],g[12],g[13],g[14],g[15]);break;case"source":g=(new z).parse(g),c[g.id]=g;break;case"joints":d=g;break;case"vertex_weights":e=g;break;default:console.log(g.nodeName)}}return this.parseJoints(d,c),this.parseWeights(e,c),this},l.prototype.parseJoints=function(a,b){for(var c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(d.nodeType==1)switch(d.nodeName){case"input":var d=(new y).parse(d),e=b[d.source];d.semantic=="JOINT"?this.joints=e.read():d.semantic=="INV_BIND_MATRIX"&&(this.invBindMatrices=e.read())}}},l.prototype.parseWeights=function(a,b){for(var c,d,e=[],f=0;f<a.childNodes.length;f++){var g=a.childNodes[f];if(g.nodeType==1)switch(g.nodeName){case"input":e.push((new y).parse(g));break;case"v":c=N(g.textContent);break;case"vcount":d=N(g.textContent)}}for(f=g=0;f<d.length;f++){for(var h=d[f],i=[],j=0;j<h;j++){for(var k={},l=0;l<e.length;l++){var m=e[l],n=c[g+m.offset];switch(m.semantic){case"JOINT":k.joint=n;break;case"WEIGHT":k.weight=b[m.source].data[n]}}i.push(k),g+=e.length}for(j=0;j<i.length;j++)i[j].index=f;this.weights.push(i)}},m.prototype.getChildById=function(a,b){for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildById(a,b);if(d)return d}return null},m.prototype.getChildBySid=function(a,b){for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildBySid(a,b);if(d)return d}return null},m.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.nodes=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(c.nodeType==1)switch(c.nodeName){case"node":this.nodes.push((new n).parse(c))}}return this},n.prototype.getChannelForTransform=function(a){for(var b=0;b<this.channels.length;b++){var c=this.channels[b],d=c.target.split("/");d.shift();var e=d.shift(),f=e.indexOf(".")>=0,g=e.indexOf("(")>=0,h;if(f)d=e.split("."),e=d.shift(),d.shift();else if(g){h=e.split("("),e=h.shift();for(d=0;d<h.length;d++)h[d]=parseInt(h[d].replace(/\)/,""))}if(e==a)return c.info={sid:e,dotSyntax:f,arrSyntax:g,arrIndices:h},c}return null},n.prototype.getChildById=function(a,b){if(this.id==a)return this;if(b)for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildById(a,b);if(d)return d}return null},n.prototype.getChildBySid=function(a,b){if(this.sid==a)return this;if(b)for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildBySid(a,b);if(d)return d}return null},n.prototype.getTransformBySid=function(a){for(var b=0;b<this.transforms.length;b++)if(this.transforms[b].sid==a)return this.transforms[b];return null},n.prototype.parse=function(b){var c;this.id=b.getAttribute("id"),this.sid=b.getAttribute("sid"),this.name=b.getAttribute("name"),this.type=b.getAttribute("type"),this.type=this.type=="JOINT"?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.controllers=[],this.matrix=new a.Matrix4;for(var d=0;d<b.childNodes.length;d++)if(c=b.childNodes[d],c.nodeType==1)switch(c.nodeName){case"node":this.nodes.push((new n).parse(c));break;case"instance_camera":break;case"instance_controller":this.controllers.push((new p).parse(c));break;case"instance_geometry":this.geometries.push((new r).parse(c));break;case"instance_light":break;case"instance_node":c=c.getAttribute("url").replace(/^#/,""),(c=S.evaluate(".//dae:library_nodes//dae:node[@id='"+c+"']",S,L,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext())&&this.nodes.push((new n).parse(c));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new o).parse(c));break;case"extra":break;default:console.log(c.nodeName)}b=[],d=1e6,c=-1e6;for(var e in Y)for(var f=Y[e],g=0;g<f.channel.length;g++){var h=f.channel[g],j=f.sampler[g];e=h.target.split("/")[0],e==this.id&&(j.create(),h.sampler=j,d=Math.min(d,j.startTime),c=Math.max(c,j.endTime),b.push(h))}b.length&&(this.startTime=d,this.endTime=c);if((this.channels=b)&&this.channels.length){e=1e7;for(i=0;i<this.channels.length;i++){b=this.channels[i].sampler;for(d=0;d<b.input.length-1;d++)e=Math.min(e,b.input[d+1]-b.input[d])}d=[];for(b=this.startTime;b<this.endTime;b+=e){c=b;for(var f={},k=g=void 0,g=0;g<this.channels.length;g++)k=this.channels[g],f[k.sid]=k;h=new a.Matrix4;for(g=0;g<this.transforms.length;g++)if(j=this.transforms[g],k=f[j.sid],k!==void 0){for(var l=k.sampler,m,k=0;k<l.input.length-1;k++)if(l.input[k+1]>c){m=l.output[k];break}h=m!==void 0?m instanceof a.Matrix4?h.multiply(h,m):h.multiply(h,j.matrix):h.multiply(h,j.matrix)}else h=h.multiply(h,j.matrix);c=h,d.push({time:b,pos:[c.n14,c.n24,c.n34],rotq:[0,0,0,1],scl:[1,1,1]})}this.keys=d}return this.updateMatrix(),this},n.prototype.updateMatrix=function(){this.matrix.identity();for(var a=0;a<this.transforms.length;a++)this.matrix.multiply(this.matrix,this.transforms[a].matrix)},o.prototype.parse=function(a){return this.sid=a.getAttribute("sid"),this.type=a.nodeName,this.data=M(a.textContent),this.updateMatrix(),this},o.prototype.updateMatrix=function(){var b=0;this.matrix.identity();switch(this.type){case"matrix":this.matrix.set(this.data[0],this.data[1],this.data[2],this.data[3],this.data[4],this.data[5],this.data[6],this.data[7],this.data[8],this.data[9],this.data[10],this.data[11],this.data[12],this.data[13],this.data[14],this.data[15]);break;case"translate":this.matrix.setTranslation(this.data[0],this.data[1],this.data[2]);break;case"rotate":b=this.data[3]*(Math.PI/180),this.matrix.setRotationAxis(new a.Vector3(this.data[0],this.data[1],this.data[2]),b);break;case"scale":this.matrix.setScale(this.data[0],this.data[1],this.data[2])}return this.matrix},p.prototype.parse=function(a){this.url=a.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(c.nodeType==1)switch(c.nodeName){case"skeleton":this.skeleton.push(c.textContent.replace(/^#/,""));break;case"bind_material":if(c=S.evaluate(".//dae:instance_material",c,L,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null))for(var d=c.iterateNext();d;)this.instance_material.push((new q).parse(d)),d=c.iterateNext()}}return this},q.prototype.parse=function(a){return this.symbol=a.getAttribute("symbol"),this.target=a.getAttribute("target").replace(/^#/,""),this},r.prototype.parse=function(a){this.url=a.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(c.nodeType==1&&c.nodeName=="bind_material"){if(a=S.evaluate(".//dae:instance_material",c,L,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null))for(b=a.iterateNext();b;)this.instance_material.push((new q).parse(b)),b=a.iterateNext();break}}return this},s.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"mesh":this.mesh=(new t(this)).parse(c)}}return this},t.prototype.parse=function(b){function c(a,b){var c=R(a.position);return f[c]===void 0&&(f[c]={v:a,index:b}),f[c]}this.primitives=[];var d;for(d=0;d<b.childNodes.length;d++){var e=b.childNodes[d];switch(e.nodeName){case"source":K(e);break;case"vertices":this.vertices=(new x).parse(e);break;case"triangles":this.primitives.push((new v).parse(e));break;case"polygons":console.warn("polygon holes not yet supported!");case"polylist":this.primitives.push((new u).parse(e))}}var f={};this.geometry3js=new a.Geometry,e=W[this.vertices.input.POSITION.source].data;for(b=d=0;d<e.length;d+=3,b++){var g=new a.Vertex(new a.Vector3(e[d],e[d+1],e[d+2]));c(g,b),this.geometry3js.vertices.push(g)}for(d=0;d<this.primitives.length;d++)primitive=this.primitives[d],primitive.setVertices(this.vertices),this.handlePrimitive(primitive,this.geometry3js,f);return this.geometry3js.computeCentroids(),this.geometry3js.computeFaceNormals(),this.geometry3js.computeVertexNormals(),this.geometry3js.computeBoundingBox(),this},t.prototype.handlePrimitive=function(b,c,d){var e=0,f,g,h=b.p,i=b.inputs,j,k,l,m=0,n=3,o=[];for(f=0;f<i.length;f++)switch(j=i[f],j.semantic){case"TEXCOORD":o.push(j.set)}for(;e<h.length;){var p=[],q=[],r={},s=[];b.vcount&&(n=b.vcount[m++]);for(f=0;f<n;f++)for(g=0;g<i.length;g++)switch(j=i[g],source=W[j.source],k=h[e+f*i.length+j.offset],numParams=source.accessor.params.length,l=k*numParams,j.semantic){case"VERTEX":j=R(c.vertices[k].position),p.push(d[j].index);break;case"NORMAL":q.push(new a.Vector3(source.data[l],source.data[l+1],source.data[l+2]));break;case"TEXCOORD":r[j.set]===void 0&&(r[j.set]=[]),r[j.set].push(new a.UV(source.data[l],source.data[l+1]));break;case"COLOR":s.push((new a.Color).setRGB(source.data[l],source.data[l+1],source.data[l+2]))}var t;n==3?t=new a.Face3(p[0],p[1],p[2],[q[0],q[1],q[2]],s.length?s:new a.Color):n==4&&(t=new a.Face4(p[0],p[1],p[2],p[3],[q[0],q[1],q[2],q[3]],s.length?s:new a.Color)),t.daeMaterial=b.material,c.faces.push(t);for(g=0;g<o.length;g++)f=r[o[g]],c.faceVertexUvs[g].push([f[0],f[1],f[2]]);e+=i.length*n}},u.prototype=new v,u.prototype.constructor=u,v.prototype.setVertices=function(a){for(var b=0;b<this.inputs.length;b++)this.inputs[b].source==a.id&&(this.inputs[b].source=a.input.POSITION.source)},v.prototype.parse=function(a){this.inputs=[],this.material=a.getAttribute("material"),this.count=P(a,"count",0);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"input":this.inputs.push((new y).parse(a.childNodes[b]));break;case"vcount":this.vcount=N(c.textContent);break;case"p":this.p=N(c.textContent)}}return this},w.prototype.parse=function(a){this.params=[],this.source=a.getAttribute("source"),this.count=P(a,"count",0),this.stride=P(a,"stride",0);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(c.nodeName=="param"){var d={};d.name=c.getAttribute("name"),d.type=c.getAttribute("type"),this.params.push(d)}}return this},x.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++)a.childNodes[b].nodeName=="input"&&(input=(new y).parse(a.childNodes[b]),this.input[input.semantic]=input);return this},y.prototype.parse=function(a){return this.semantic=a.getAttribute("semantic"),this.source=a.getAttribute("source").replace(/^#/,""),this.set=P(a,"set",-1),this.offset=P(a,"offset",0),this.semantic=="TEXCOORD"&&this.set<0&&(this.set=0),this},z.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"bool_array":for(var d=O(c.textContent),e=[],f=0;f<d.length;f++)e.push(d[f]=="true"||d[f]=="1"?!0:!1);this.data=e,this.type=c.nodeName;break;case"float_array":this.data=M(c.textContent),this.type=c.nodeName;break;case"int_array":this.data=N(c.textContent),this.type=c.nodeName;break;case"IDREF_array":case"Name_array":this.data=O(c.textContent),this.type=c.nodeName;break;case"technique_common":for(d=0;d<c.childNodes.length;d++)if(c.childNodes[d].nodeName=="accessor"){this.accessor=(new w).parse(c.childNodes[d]);break}}}return this},z.prototype.read=function(){var b=[],c=this.accessor.params[0];switch(c.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(c=0;c<this.data.length;c+=16){var d=this.data.slice(c,c+16),e=new a.Matrix4;e.set(d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9],d[10],d[11],d[12],d[13],d[14],d[15]),b.push(e)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+c.type+".")}return b},A.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++)if(a.childNodes[b].nodeName=="instance_effect"){this.instance_effect=(new G).parse(a.childNodes[b]);break}return this},B.prototype.isColor=function(){return this.texture==null},B.prototype.isTexture=function(){return this.texture!=null},B.prototype.parse=function(b){for(var c=0;c<b.childNodes.length;c++){var d=b.childNodes[c];if(d.nodeType==1)switch(d.nodeName){case"color":d=M(d.textContent),this.color=new a.Color(0),this.color.setRGB(d[0],d[1],d[2]),this.color.a=d[3];break;case"texture":this.texture=d.getAttribute("texture"),this.texcoord=d.getAttribute("texcoord")}}return this},C.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(c.nodeType==1)switch(c.nodeName){case"ambient":case"emission":case"diffuse":case"specular":case"transparent":this[c.nodeName]=(new B).parse(c);break;case"shininess":case"reflectivity":case"transparency":var d;d=S.evaluate(".//dae:float",c,L,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);for(var e=d.iterateNext(),f=[];e;)f.push(e),e=d.iterateNext();d=f,d.length>0&&(this[c.nodeName]=parseFloat(d[0].textContent))}}return this.create(),this},C.prototype.create=function(){var b={},c=this.transparency!==void 0&&this.transparency<1,d;for(d in this)switch(d){case"ambient":case"emission":case"diffuse":case"specular":var e=this[d];e instanceof B&&(e.isTexture()?this.effect.sampler&&this.effect.surface&&this.effect.sampler.source==this.effect.surface.sid&&(e=X[this.effect.surface.init_from])&&(b.map=a.ImageUtils.loadTexture(bc+e.init_from),b.map.wrapS=a.RepeatWrapping,b.map.wrapT=a.RepeatWrapping,b.map.repeat.x=1,b.map.repeat.y=-1):d=="diffuse"?b.color=e.color.getHex():c||(b[d]=e.color.getHex()));break;case"shininess":case"reflectivity":b[d]=this[d];break;case"transparency":c&&(b.transparent=!0,b.opacity=this[d],c=!0)}return b.shading=bf,this.material=new a.MeshLambertMaterial(b)},D.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(c.nodeType==1)switch(c.nodeName){case"init_from":this.init_from=c.textContent;break;case"format":this.format=c.textContent;break;default:console.log("unhandled Surface prop: "+c.nodeName)}}return this},E.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(c.nodeType==1)switch(c.nodeName){case"source":this.source=c.textContent;break;case"minfilter":this.minfilter=c.textContent;break;case"magfilter":this.magfilter=c.textContent;break;case"mipfilter":this.mipfilter=c.textContent;break;case"wrap_s":this.wrap_s=c.textContent;break;case"wrap_t":this.wrap_t=c.textContent;break;default:console.log("unhandled Sampler2D prop: "+c.nodeName)}}return this},F.prototype.create=function(){if(this.shader==null)return null},F.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.shader=null;for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(c.nodeType==1)switch(c.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(c))}}return this},F.prototype.parseNewparam=function(a){for(var b=a.getAttribute("sid"),c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(d.nodeType==1)switch(d.nodeName){case"surface":this.surface=(new D(this)).parse(d),this.surface.sid=b;break;case"sampler2D":this.sampler=(new E(this)).parse(d),this.sampler.sid=b;break;case"extra":break;default:console.log(d.nodeName)}}},F.prototype.parseProfileCOMMON=function(a){for(var b,c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(d.nodeType==1)switch(d.nodeName){case"profile_COMMON":this.parseProfileCOMMON(d);break;case"technique":b=d;break;case"newparam":this.parseNewparam(d);break;case"extra":break;default:console.log(d.nodeName)}}return b},F.prototype.parseTechnique=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(c.nodeType==1)switch(c.nodeName){case"lambert":case"blinn":case"phong":this.shader=(new C(c.nodeName,this)).parse(c)}}},G.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},H.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.source={};for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(c.nodeType==1)switch(c.nodeName){case"source":c=(new z).parse(c),this.source[c.id]=c;break;case"sampler":this.sampler.push((new J(this)).parse(c));break;case"channel":this.channel.push((new I(this)).parse(c))}}return this},I.prototype.parse=function(a){this.source=a.getAttribute("source").replace(/^#/,""),this.target=a.getAttribute("target");var b=this.target.split("/");b.shift();var a=b.shift(),c=a.indexOf(".")>=0,d=a.indexOf("(")>=0,e,f;if(c)b=a.split("."),a=b.shift(),f=b.shift();else if(d){e=a.split("("),a=e.shift();for(b=0;b<e.length;b++)e[b]=parseInt(e[b].replace(/\)/,""))}return this.sid=a,this.dotSyntax=c,this.arrSyntax=d,this.arrIndices=e,this.member=f,this},J.prototype.parse=function(a){this.id=a.getAttribute("id"),this.inputs=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(c.nodeType==1)switch(c.nodeName){case"input":this.inputs.push((new y).parse(c))}}return this},J.prototype.create=function(){for(var a=0;a<this.inputs.length;a++){var b=this.inputs[a],c=this.animation.source[b.source];switch(b.semantic){case"INPUT":this.input=c.read();break;case"OUTPUT":this.output=c.read();break;case"INTERPOLATION":this.interpolation=c.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(b.semantic)}}this.duration=this.endTime=this.startTime=0;if(this.input.length){this.startTime=1e8,this.endTime=-1e8;for(a=0;a<this.input.length;a++)this.startTime=Math.min(this.startTime,this.input[a]),this.endTime=Math.max(this.endTime,this.input[a]);this.duration=this.endTime-this.startTime}},{load:function(d,e){if(document.implementation&&document.implementation.createDocument){document.implementation.createDocument("http://www.collada.org/2005/11/COLLADASchema","COLLADA",null),d+="?rnd="+Math.random();var i=new XMLHttpRequest;i.overrideMimeType&&i.overrideMimeType("text/xml"),i.onreadystatechange=function(){if(i.readyState==4&&(i.status==0||i.status==200)){V=e;var j,k=d;S=i.responseXML,j=V,k!==void 0&&(k=k.split("/"),k.pop(),bc=k.length<1?"":k.join("/")+"/"),X=b("//dae:library_images/dae:image",g,"image"),_=b("//dae:library_materials/dae:material",A,"material"),ba=b("//dae:library_effects/dae:effect",F,"effect"),$=b("//dae:library_geometries/dae:geometry",s,"geometry"),Z=b("//dae:library_controllers/dae:controller",h,"controller"),Y=b("//dae:library_animations/dae:animation",H,"animation"),bb=b(".//dae:library_visual_scenes/dae:visual_scene",m,"visual_scene"),bd=[],be=[],(k=S.evaluate(".//dae:scene/dae:instance_visual_scene",S,L,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).iterateNext())?(k=k.getAttribute("url").replace(/^#/,""),U=bb[k]):U=null,T=new a.Object3D;for(k=0;k<U.nodes.length;k++)T.add(f(U.nodes[k]));c();for(var l in Y);l={scene:T,morphs:bd,skins:be,dae:{images:X,materials:_,effects:ba,geometries:$,controllers:Z,animations:Y,visualScenes:bb,scene:U}},j&&j(l)}},i.open("GET",d,!0),i.send(null)}else alert("Don't know how to parse XML!")},setPreferredShading:function(a){bf=a},applySkin:e,geometries:$}},a.JSONLoader=function(b){a.Loader.call(this,b)},a.JSONLoader.prototype=new a.Loader,a.JSONLoader.prototype.constructor=a.JSONLoader,a.JSONLoader.prototype.supr=a.Loader.prototype,a.JSONLoader.prototype.load=function(a){var b=this,c=a.model,d=a.callback,e=a.texture_path?a.texture_path:this.extractUrlbase(c),a=new Worker(c);a.onmessage=function(a){b.createModel(a.data,d,e),b.onLoadComplete()},this.onLoadStart(),a.postMessage((new Date).getTime())},a.JSONLoader.prototype.createModel=function(b,c,d){var e=new a.Geometry,f=b.scale!==void 0?1/b.scale:1;this.init_materials(e,b.materials,d),function(c){if(b.version===void 0||b.version!=2)console.error("Deprecated file format.");else{var d,f,g,h,i,j,k,l,m,n,o,p,q,r,s=b.faces;j=b.vertices;var t=b.normals,u=b.colors,v=0;for(d=0;d<b.uvs.length;d++)b.uvs[d].length&&v++;for(d=0;d<v;d++)e.faceUvs[d]=[],e.faceVertexUvs[d]=[];h=0;for(i=j.length;h<i;)k=new a.Vertex,k.position.x=j[h++]*c,k.position.y=j[h++]*c,k.position.z=j[h++]*c,e.vertices.push(k);h=0;for(i=s.length;h<i;){c=s[h++],j=c&1,g=c&2,d=c&4,f=c&8,l=c&16,k=c&32,n=c&64,c&=128,j?(o=new a.Face4,o.a=s[h++],o.b=s[h++],o.c=s[h++],o.d=s[h++],j=4):(o=new a.Face3,o.a=s[h++],o.b=s[h++],o.c=s[h++],j=3),g&&(g=s[h++],o.materials=e.materials[g]),g=e.faces.length;if(d)for(d=0;d<v;d++)p=b.uvs[d],m=s[h++],r=p[m*2],m=p[m*2+1],e.faceUvs[d][g]=new a.UV(r,m);if(f)for(d=0;d<v;d++){p=b.uvs[d],q=[];for(f=0;f<j;f++)m=s[h++],r=p[m*2],m=p[m*2+1],q[f]=new a.UV(r,m);e.faceVertexUvs[d][g]=q}l&&(l=s[h++]*3,f=new a.Vector3,f.x=t[l++],f.y=t[l++],f.z=t[l],o.normal=f);if(k)for(d=0;d<j;d++)l=s[h++]*3,f=new a.Vector3,f.x=t[l++],f.y=t[l++],f.z=t[l],o.vertexNormals.push(f);n&&(k=s[h++],k=new a.Color(u[k]),o.color=k);if(c)for(d=0;d<j;d++)k=s[h++],k=new a.Color(u[k]),o.vertexColors.push(k);e.faces.push(o)}}}(f),function(){var c,d,f,g;if(b.skinWeights){c=0;for(d=b.skinWeights.length;c<d;c+=2)f=b.skinWeights[c],g=b.skinWeights[c+1],e.skinWeights.push(new a.Vector4(f,g,0,0))}if(b.skinIndices){c=0;for(d=b.skinIndices.length;c<d;c+=2)f=b.skinIndices[c],g=b.skinIndices[c+1],e.skinIndices.push(new a.Vector4(f,g,0,0))}e.bones=b.bones,e.animation=b.animation}(),function(c){if(b.morphTargets!==void 0){var d,f,g,h,i,j,k,l,m;d=0;for(f=b.morphTargets.length;d<f;d++){e.morphTargets[d]={},e.morphTargets[d].name=b.morphTargets[d].name,e.morphTargets[d].vertices=[],l=e.morphTargets[d].vertices,m=b.morphTargets[d].vertices,g=0;for(h=m.length;g<h;g+=3)i=m[g]*c,j=m[g+1]*c,k=m[g+2]*c,l.push(new a.Vertex(new a.Vector3(i,j,k)))}}if(b.morphColors!==void 0){d=0;for(f=b.morphColors.length;d<f;d++){e.morphColors[d]={},e.morphColors[d].name=b.morphColors[d].name,e.morphColors[d].colors=[],h=e.morphColors[d].colors,i=b.morphColors[d].colors,c=0;for(g=i.length;c<g;c+=3)j=new a.Color(16755200),j.setRGB(i[c],i[c+1],i[c+2]),h.push(j)}}}(f),e.computeCentroids(),e.computeFaceNormals(),this.hasNormals(e)&&e.computeTangents(),c(e)},a.SceneLoader=function(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){},this.callbackSync=function(){},this.callbackProgress=function(){}},a.SceneLoader.prototype={load:function(b,c){var e=this,f=new Worker(b);f.postMessage(0);var g=a.Loader.prototype.extractUrlbase(b);f.onmessage=function(b){function f(a,b){return b=="relativeToHTML"?a:g+"/"+a}function i(){for(o in G.objects)if(!M.objects[o])if(w=G.objects[o],w.geometry!==void 0){if(A=M.geometries[w.geometry]){var b=!1;E=[];for(O=0;O<w.materials.length;O++)E[O]=M.materials[w.materials[O]],b=E[O]instanceof a.ShaderMaterial;b&&A.computeTangents(),x=w.position,r=w.rotation,q=w.quaternion,s=w.scale,q=0,E.length==0&&(E[0]=new a.MeshFaceMaterial),E.length>1&&(E=[new a.MeshFaceMaterial]),object=new a.Mesh(A,E),object.name=o,object.position.set(x[0],x[1],x[2]),q?(object.quaternion.set(q[0],q[1],q[2],q[3]),object.useQuaternion=!0):object.rotation.set(r[0],r[1],r[2]),object.scale.set(s[0],s[1],s[2]),object.visible=w.visible,M.scene.add(object),M.objects[o]=object,w.meshCollider&&(b=a.CollisionUtils.MeshColliderWBox(object),M.scene.collisions.colliders.push(b)),w.castsShadow&&(b=new a.ShadowVolume(A),M.scene.add(b),b.position=object.position,b.rotation=object.rotation,b.scale=object.scale),w.trigger&&w.trigger.toLowerCase()!="none"&&(b={type:w.trigger,object:w},M.triggers[object.name]=b)}}else x=w.position,r=w.rotation,q=w.quaternion,s=w.scale,q=0,object=new a.Object3D,object.name=o,object.position.set(x[0],x[1],x[2]),q?(object.quaternion.set(q[0],q[1],q[2],q[3]),object.useQuaternion=!0):object.rotation.set(r[0],r[1],r[2]),object.scale.set(s[0],s[1],s[2]),object.visible=w.visible!==void 0?w.visible:!1,M.scene.add(object),M.objects[o]=object,M.empties[o]=object,w.trigger&&w.trigger.toLowerCase()!="none"&&(b={type:w.trigger,object:w},M.triggers[object.name]=b)}function j(a){return function(b){M.geometries[a]=b,i(),I-=1,e.onLoadComplete(),l()}}function k(a){return function(b){M.geometries[a]=b}}function l(){e.callbackProgress({totalModels:K,totalTextures:L,loadedModels:K-I,loadedTextures:L-J},M),e.onLoadProgress(),I==0&&J==0&&c(M)}var m,n,o,p,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M;G=b.data,D=new a.BinaryLoader,H=new a.JSONLoader,J=I=0,M={scene:new a.Scene,geometries:{},materials:{},textures:{},objects:{},cameras:{},lights:{},fogs:{},triggers:{},empties:{}},b=!1;for(o in G.objects)if(w=G.objects[o],w.meshCollider){b=!0;break}b&&(M.scene.collisions=new a.CollisionSystem);if(G.transform){b=G.transform.position,y=G.transform.rotation;var N=G.transform.scale;b&&M.scene.position.set(b[0],b[1],b[2]),y&&M.scene.rotation.set(y[0],y[1],y[2]),N&&M.scene.scale.set(N[0],N[1],N[2]),(b||y||N)&&M.scene.updateMatrix()}b=function(){J-=1,l(),e.onLoadComplete()};for(t in G.cameras)y=G.cameras[t],y.type=="perspective"?B=new a.PerspectiveCamera(y.fov,y.aspect,y.near,y.far):y.type=="ortho"&&(B=new a.OrthographicCamera(y.left,y.right,y.top,y.bottom,y.near,y.far)),x=y.position,y=y.target,B.position.set(x[0],x[1],x[2]),B.target=new a.Vector3(y[0],y[1],y[2]),M.cameras[t]=B;for(p in G.lights)t=G.lights[p],B=t.color!==void 0?t.color:16777215,y=t.intensity!==void 0?t.intensity:1,t.type=="directional"?(x=t.direction,F=new a.DirectionalLight(B,y),F.position.set(x[0],x[1],x[2]),F.position.normalize()):t.type=="point"?(x=t.position,d=t.distance,F=new a.PointLight(B,y,d),F.position.set(x[0],x[1],x[2])):t.type=="ambient"&&(F=new a.AmbientLight(B)),M.scene.add(F),M.lights[p]=F;for(u in G.fogs)p=G.fogs[u],p.type=="linear"?C=new a.Fog(0,p.near,p.far):p.type=="exp2"&&(C=new a.FogExp2(0,p.density)),y=p.color,C.color.setRGB(y[0],y[1],y[2]),M.fogs[u]=C;M.cameras&&G.defaults.camera&&(M.currentCamera=M.cameras[G.defaults.camera]),M.fogs&&G.defaults.fog&&(M.scene.fog=M.fogs[G.defaults.fog]),y=G.defaults.bgcolor,M.bgColor=new a.Color,M.bgColor.setRGB(y[0],y[1],y[2]),M.bgColorAlpha=G.defaults.bgalpha;for(m in G.geometries)if(u=G.geometries[m],u.type=="bin_mesh"||u.type=="ascii_mesh")I+=1,e.onLoadStart();K=I;for(m in G.geometries)u=G.geometries[m],u.type=="cube"?(A=new a.CubeGeometry(u.width,u.height,u.depth,u.segmentsWidth,u.segmentsHeight,u.segmentsDepth,null,u.flipped,u.sides),M.geometries[m]=A):u.type=="plane"?(A=new a.PlaneGeometry(u.width,u.height,u.segmentsWidth,u.segmentsHeight),M.geometries[m]=A):u.type=="sphere"?(A=new a.SphereGeometry(u.radius,u.segmentsWidth,u.segmentsHeight),M.geometries[m]=A):u.type=="cylinder"?(A=new a.CylinderGeometry(u.topRad,u.botRad,u.height,u.radSegs,u.heightSegs),M.geometries[m]=A):u.type=="torus"?(A=new a.TorusGeometry(u.radius,u.tube,u.segmentsR,u.segmentsT),M.geometries[m]=A):u.type=="icosahedron"?(A=new a.IcosahedronGeometry(u.subdivisions),M.geometries[m]=A):u.type=="bin_mesh"?D.load({model:f(u.url,G.urlBaseType),callback:j(m)}):u.type=="ascii_mesh"?H.load({model:f(u.url,G.urlBaseType),callback:j(m)}):u.type=="embedded_mesh"&&(u=G.embeds[u.id])&&H.createModel(u,k(m),"");for(v in G.textures)if(m=G.textures[v],m.url instanceof Array){J+=m.url.length;for(D=0;D<m.url.length;D++)e.onLoadStart()}else J+=1,e.onLoadStart();L=J;for(v in G.textures){m=G.textures[v],m.mapping!=void 0&&a[m.mapping]!=void 0&&(m.mapping=new a[m.mapping]);if(m.url instanceof Array){D=[];for(var O=0;O<m.url.length;O++)D[O]=f(m.url[O],G.urlBaseType);D=a.ImageUtils.loadTextureCube(D,m.mapping,b)}else D=a.ImageUtils.loadTexture(f(m.url,G.urlBaseType),m.mapping,b),a[m.minFilter]!=void 0&&(D.minFilter=a[m.minFilter]),a[m.magFilter]!=void 0&&(D.magFilter=a[m.magFilter]),m.repeat&&(D.repeat.set(m.repeat[0],m.repeat[1]),m.repeat[0]!=1&&(D.wrapS=a.RepeatWrapping),m.repeat[1]!=1&&(D.wrapT=a.RepeatWrapping)),m.offset&&D.offset.set(m.offset[0],m.offset[1]),m.wrap&&(H={repeat:a.RepeatWrapping,mirror:a.MirroredRepeatWrapping},H[m.wrap[0]]!==void 0&&(D.wrapS=H[m.wrap[0]]),H[m.wrap[1]]!==void 0&&(D.wrapT=H[m.wrap[1]]));M.textures[v]=D}for(n in G.materials){v=G.materials[n];for(z in v.parameters)z=="envMap"||z=="map"||z=="lightMap"?v.parameters[z]=M.textures[v.parameters[z]]:z=="shading"?v.parameters[z]=v.parameters[z]=="flat"?a.FlatShading:a.SmoothShading:z=="blending"?v.parameters[z]=a[v.parameters[z]]?a[v.parameters[z]]:a.NormalBlending:z=="combine"?v.parameters[z]=v.parameters[z]=="MixOperation"?a.MixOperation:a.MultiplyOperation:z=="vertexColors"&&(v.parameters[z]=="face"?v.parameters[z]=a.FaceColors:v.parameters[z]&&(v.parameters[z]=a.VertexColors));v.parameters.opacity!==void 0&&v.parameters.opacity<1&&(v.parameters.transparent=!0),v.parameters.normalMap?(m=a.ShaderUtils.lib.normal,b=a.UniformsUtils.clone(m.uniforms),D=v.parameters.color,H=v.parameters.specular,u=v.parameters.ambient,C=v.parameters.shininess,b.tNormal.texture=M.textures[v.parameters.normalMap],v.parameters.normalMapFactor&&(b.uNormalScale.value=v.parameters.normalMapFactor),v.parameters.map&&(b.tDiffuse.texture=v.parameters.map,b.enableDiffuse.value=!0),v.parameters.lightMap&&(b.tAO.texture=v.parameters.lightMap,b.enableAO.value=!0),v.parameters.specularMap&&(b.tSpecular.texture=M.textures[v.parameters.specularMap],b.enableSpecular.value=!0),b.uDiffuseColor.value.setHex(D),b.uSpecularColor.value.setHex(H),b.uAmbientColor.value.setHex(u),b.uShininess.value=C,v.parameters.opacity&&(b.uOpacity.value=v.parameters.opacity),v=new a.ShaderMaterial({fragmentShader:m.fragmentShader,vertexShader:m.vertexShader,uniforms:b,lights:!0,fog:!0})):v=new a[v.type](v.parameters),M.materials[n]=v}i(),e.callbackSync(M)}},constructor:a.SceneLoader},a.UTF8Loader=function(){},a.UTF8Loader.prototype=new a.UTF8Loader,a.UTF8Loader.prototype.constructor=a.UTF8Loader,a.UTF8Loader.prototype.load=function(b){var c=new XMLHttpRequest,d=b.model,e=b.callback,f=b.scale!==void 0?b.scale:1,g=b.offsetX!==void 0?b.offsetX:0,h=b.offsetY!==void 0?b.offsetY:0,i=b.offsetZ!==void 0?b.offsetZ:0;c.onreadystatechange=function(){c.readyState==4?c.status==200||c.status==0?a.UTF8Loader.prototype.createModel(c.responseText,e,f,g,h,i):alert("Couldn't load ["+d+"] ["+c.status+"]"):c.readyState!=3&&c.readyState==2&&c.getResponseHeader("Content-Length")},c.open("GET",d,!0),c.send(null)},a.UTF8Loader.prototype.decompressMesh=function(a){var b=a.charCodeAt(0);b>=57344&&(b-=2048),b++;for(var c=new Float32Array(8*b),d=1,e=0;e<8;e++){for(var f=0,g=0;g<b;++g){var h=a.charCodeAt(g+d);f+=h>>1^-(h&1),c[8*g+e]=f}d+=b}b=a.length-d,f=new Uint16Array(b);for(e=g=0;e<b;e++)h=a.charCodeAt(e+d),f[e]=g-h,h==0&&g++;return[c,f]},a.UTF8Loader.prototype.createModel=function(b,c,d,e,f,g){var h=function(){var c=this;c.materials=[],a.Geometry.call(this);var h=a.UTF8Loader.prototype.decompressMesh(b),i=[],j=[];(function(b,h,i){for(var j,l,m,n=b.length;i<n;i+=h)j=b[i],l=b[i+1],m=b[i+2],j=j/16383*d,l=l/16383*d,m=m/16383*d,j+=e,l+=f,m+=g,c.vertices.push(new a.Vertex(new a.Vector3(j,l,m)))})(h[0],8,0),function(a,b,c){for(var d,e,f=a.length;c<f;c+=b)d=a[c],e=a[c+1],d/=1023,e/=1023,j.push(d,1-e)}(h[0],8,3),function(a,b,c){for(var d,e,f,g=a.length;c<g;c+=b)d=a[c],e=a[c+1],f=a[c+2],d=(d-512)/511,e=(e-512)/511,f=(f-512)/511,i.push(d,e,f)}(h[0],8,5),function(b){var d,e,f,g,h,k,l,m,n,o=b.length;for(d=0;d<o;d+=3){e=b[d],f=b[d+1],g=b[d+2],h=c,m=e,n=f,k=g,l=e;var p=f,q=g,r=h.materials[0],s=i[p*3],t=i[p*3+1],p=i[p*3+2],w=i[q*3],x=i[q*3+1],q=i[q*3+2];l=new a.Vector3(i[l*3],i[l*3+1],i[l*3+2]),p=new a.Vector3(s,t,p),q=new a.Vector3(w,x,q),h.faces.push(new a.Face3(m,n,k,[l,p,q],null,r)),h=j[e*2],e=j[e*2+1],k=j[f*2],l=j[f*2+1],m=j[g*2],n=j[g*2+1],g=c.faceVertexUvs[0],f=k,k=l,l=[],l.push(new a.UV(h,e)),l.push(new a.UV(f,k)),l.push(new a.UV(m,n)),g.push(l)}}(h[1]),this.computeCentroids(),this.computeFaceNormals()};h.prototype=new a.Geometry,h.prototype.constructor=h,c(new h)},a.Axes=function(){a.Object3D.call(this);var b=new a.Geometry;b.vertices.push(new a.Vertex),b.vertices.push(new a.Vertex(new a.Vector3(0,100,0)));var c=new a.CylinderGeometry(0,5,25,5,1),d=new a.Line(b,new a.LineBasicMaterial({color:16711680}));d.rotation.z=-Math.PI/2,this.add(d),d=new a.Mesh(c,new a.MeshBasicMaterial({color:16711680})),d.position.x=100,d.rotation.z=-Math.PI/2,this.add(d),d=new a.Line(b,new a.LineBasicMaterial({color:65280})),this.add(d),d=new a.Mesh(c,new a.MeshBasicMaterial({color:65280})),d.position.y=100,this.add(d),d=new a.Line(b,new a.LineBasicMaterial({color:255})),d.rotation.x=Math.PI/2,this.add(d),d=new a.Mesh(c,new a.MeshBasicMaterial({color:255})),d.position.z=100,d.rotation.x=Math.PI/2,this.add(d)},a.Axes.prototype=new a.Object3D,a.Axes.prototype.constructor=a.Axes,a.MarchingCubes=function(b,c){a.Object3D.call(this),this.materials=c instanceof Array?c:[c],this.init=function(a){this.isolation=80,this.size=a,this.size2=this.size*this.size,this.size3=this.size2*this.size,this.halfsize=this.size/2,this.delta=2/this.size,this.yd=this.size,this.zd=this.size2,this.field=new Float32Array(this.size3),this.normal_cache=new Float32Array(this.size3*3),this.vlist=new Float32Array(36),this.nlist=new Float32Array(36),this.firstDraw=!0,this.maxCount=4096,this.count=0,this.hasNormal=this.hasPos=!1,this.positionArray=new Float32Array(this.maxCount*3),this.normalArray=new Float32Array(this.maxCount*3)},this.lerp=function(a,b,c){return a+(b-a)*c},this.VIntX=function(a,b,c,d,e,f,g,h,i,j){e=(e-i)/(j-i),i=this.normal_cache,b[d]=f+e*this.delta,b[d+1]=g,b[d+2]=h,c[d]=this.lerp(i[a],i[a+3],e),c[d+1]=this.lerp(i[a+1],i[a+4],e),c[d+2]=this.lerp(i[a+2],i[a+5],e)},this.VIntY=function(a,b,c,d,e,f,g,h,i,j){e=(e-i)/(j-i),i=this.normal_cache,b[d]=f,b[d+1]=g+e*this.delta,b[d+2]=h,b=a+this.yd*3,c[d]=this.lerp(i[a],i[b],e),c[d+1]=this.lerp(i[a+1],i[b+1],e),c[d+2]=this.lerp(i[a+2],i[b+2],e)},this.VIntZ=function(a,b,c,d,e,f,g,h,i,j){e=(e-i)/(j-i),i=this.normal_cache,b[d]=f,b[d+1]=g,b[d+2]=h+e*this.delta,b=a+this.zd*3,c[d]=this.lerp(i[a],i[b],e),c[d+1]=this.lerp(i[a+1],i[b+1],e),c[d+2]=this.lerp(i[a+2],i[b+2],e)},this.compNorm=function(a){var b=a*3;this.normal_cache[b]==0&&(this.normal_cache[b]=this.field[a-1]-this.field[a+1],this.normal_cache[b+1]=this.field[a-this.yd]-this.field[a+this.yd],this.normal_cache[b+2]=this.field[a-this.zd]-this.field[a+this.zd])},this.polygonize=function(b,c,d,e,f,g){var h=e+1,i=e+this.yd,j=e+this.zd,k=h+this.yd,l=h+this.zd,m=e+this.yd+this.zd,n=h+this.yd+this.zd,o=0,p=this.field[e],q=this.field[h],r=this.field[i],s=this.field[k],t=this.field[j],u=this.field[l],v=this.field[m],w=this.field[n];p<f&&(o|=1),q<f&&(o|=2),r<f&&(o|=8),s<f&&(o|=4),t<f&&(o|=16),u<f&&(o|=32),v<f&&(o|=128),w<f&&(o|=64);var x=a.edgeTable[o];if(x==0)return 0;var y=this.delta,z=b+y,A=c+y,y=d+y;x&1&&(this.compNorm(e),this.compNorm(h),this.VIntX(e*3,this.vlist,this.nlist,0,f,b,c,d,p,q)),x&2&&(this.compNorm(h),this.compNorm(k),this.VIntY(h*3,this.vlist,this.nlist,3,f,z,c,d,q,s)),x&4&&(this.compNorm(i),this.compNorm(k),this.VIntX(i*3,this.vlist,this.nlist,6,f,b,A,d,r,s)),x&8&&(this.compNorm(e),this.compNorm(i),this.VIntY(e*3,this.vlist,this.nlist,9,f,b,c,d,p,r)),x&16&&(this.compNorm(j),this.compNorm(l),this.VIntX(j*3,this.vlist,this.nlist,12,f,b,c,y,t,u)),x&32&&(this.compNorm(l),this.compNorm(n),this.VIntY(l*3,this.vlist,this.nlist,15,f,z,c,y,u,w)),x&64&&(this.compNorm(m),this.compNorm(n),this.VIntX(m*3,this.vlist,this.nlist,18,f,b,A,y,v,w)),x&128&&(this.compNorm(j),this.compNorm(m),this.VIntY(j*3,this.vlist,this.nlist,21,f,b,c,y,t,v)),x&256&&(this.compNorm(e),this.compNorm(j),this.VIntZ(e*3,this.vlist,this.nlist,24,f,b,c,d,p,t)),x&512&&(this.compNorm(h),this.compNorm(l),this.VIntZ(h*3,this.vlist,this.nlist,27,f,z,c,d,q,u)),x&1024&&(this.compNorm(k),this.compNorm(n),this.VIntZ(k*3,this.vlist,this.nlist,30,f,z,A,d,s,w)),x&2048&&(this.compNorm(i),this.compNorm(m),this.VIntZ(i*3,this.vlist,this.nlist,33,f,b,A,d,r,v)),o<<=4;for(f=e=0;a.triTable[o+f]!=-1;)b=o+f,c=b+1,d=b+2,this.posnormtriv(this.vlist,this.nlist,3*a.triTable[b],3*a.triTable[c],3*a.triTable[d],g),f+=3,e++;return e},this.posnormtriv=function(a,b,c,d,e,f){var g=this.count*3;this.positionArray[g]=a[c],this.positionArray[g+1]=a[c+1],this.positionArray[g+2]=a[c+2],this.positionArray[g+3]=a[d],this.positionArray[g+4]=a[d+1],this.positionArray[g+5]=a[d+2],this.positionArray[g+6]=a[e],this.positionArray[g+7]=a[e+1],this.positionArray[g+8]=a[e+2],this.normalArray[g]=b[c],this.normalArray[g+1]=b[c+1],this.normalArray[g+2]=b[c+2],this.normalArray[g+3]=b[d],this.normalArray[g+4]=b[d+1],this.normalArray[g+5]=b[d+2],this.normalArray[g+6]=b[e],this.normalArray[g+7]=b[e+1],this.normalArray[g+8]=b[e+2],this.hasNormal=this.hasPos=!0,this.count+=3,this.count>=this.maxCount-3&&f(this)},this.begin=function(){this.count=0,this.hasNormal=this.hasPos=!1},this.end=function(a){if(this.count!=0){for(var b=this.count*3;b<this.positionArray.length;b++)this.positionArray[b]=0;a(this)}},this.addBall=function(a,b,c,d,e){var f=this.size*Math.sqrt(d/e),g=c*this.size,h=b*this.size,i=a*this.size,j=Math.floor(g-f);j<1&&(j=1),g=Math.floor(g+f),g>this.size-1&&(g=this.size-1);var k=Math.floor(h-f);k<1&&(k=1),h=Math.floor(h+f),h>this.size-1&&(h=this.size-1);var l=Math.floor(i-f);l<1&&(l=1),f=Math.floor(i+f),f>this.size-1&&(f=this.size-1);for(var m,n,o,p,q,r;j<g;j++){i=this.size2*j,n=j/this.size-c,q=n*n;for(n=k;n<h;n++){o=i+this.size*n,m=n/this.size-b,r=m*m;for(m=l;m<f;m++)p=m/this.size-a,p=d/(1e-6+p*p+r+q)-e,p>0&&(this.field[o+m]+=p)}}},this.addPlaneX=function(a,b){var c,d,e,f,g,h=this.size,i=this.yd,j=this.zd,k=this.field,l=h*Math.sqrt(a/b);l>h&&(l=h);for(c=0;c<l;c++)if(d=c/h,d*=d,f=a/(1e-4+d)-b,f>0)for(d=0;d<h;d++){g=c+d*i;for(e=0;e<h;e++)k[j*e+g]+=f}},this.addPlaneY=function(a,b){var c,d,e,f,g,h,i=this.size,j=this.yd,k=this.zd,l=this.field,m=i*Math.sqrt(a/b);m>i&&(m=i);for(d=0;d<m;d++)if(c=d/i,c*=c,f=a/(1e-4+c)-b,f>0){g=d*j;for(c=0;c<i;c++){h=g+c;for(e=0;e<i;e++)l[k*e+h]+=f}}},this.addPlaneZ=function(a,b){var c,d,e,f,g,h;size=this.size,yd=this.yd,zd=this.zd,field=this.field,dist=size*Math.sqrt(a/b),dist>size&&(dist=size);for(e=0;e<dist;e++)if(c=e/size,c*=c,f=a/(1e-4+c)-b,f>0){g=zd*e;for(d=0;d<size;d++){h=g+d*yd;for(c=0;c<size;c++)field[h+c]+=f}}},this.reset=function(){var a;for(a=0;a<this.size3;a++)this.normal_cache[a*3]=0,this.field[a]=0},this.render=function(a){this.begin();var b,c,d,e,f,g,h,i,j,k=this.size-2;for(e=1;e<k;e++){j=this.size2*e,h=(e-this.halfsize)/this.halfsize;for(d=1;d<k;d++){i=j+this.size*d,g=(d-this.halfsize)/this.halfsize;for(c=1;c<k;c++)f=(c-this.halfsize)/this.halfsize,b=i+c,this.polygonize(f,g,h,b,this.isolation,a)}}this.end(a)},this.generateGeometry=function(){var b=0,c=new a.Geometry,d=[];return this.render(function(e){var f,g,i,j,k,l,m,n;for(f=0;f<e.count;f++)m=f*3,k=m+1,n=m+2,g=e.positionArray[m],i=e.positionArray[k],j=e.positionArray[n],l=new a.Vector3(g,i,j),g=e.normalArray[m],i=e.normalArray[k],j=e.normalArray[n],m=new a.Vector3(g,i,j),m.normalize(),k=new a.Vertex(l),c.vertices.push(k),d.push(m);nfaces=e.count/3;for(f=0;f<nfaces;f++)m=(b+f)*3,k=m+1,n=m+2,l=d[m],g=d[k],i=d[n],m=new a.Face3(m,k,n,[l,g,i]),c.faces.push(m);b+=nfaces,e.count=0}),c},this.init(b)},a.MarchingCubes.prototype=new a.Object3D,a.MarchingCubes.prototype.constructor=a.MarchingCubes,a.edgeTable=new Int32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0]),a.triTable=new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),a.PlaneCollider=function(a,b){this.point=a,this.normal=b},a.SphereCollider=function(a,b){this.center=a,this.radius=b,this.radiusSq=b*b},a.BoxCollider=function(b,c){this.min=b,this.max=c,this.dynamic=!0,this.normal=new a.Vector3},a.MeshCollider=function(b,c){this.mesh=b,this.box=c,this.numFaces=this.mesh.geometry.faces.length,this.normal=new a.Vector3},a.CollisionSystem=function(){this.collisionNormal=new a.Vector3,this.colliders=[],this.hits=[]},a.Collisions=new a.CollisionSystem,a.CollisionSystem.prototype.merge=function(a){Array.prototype.push.apply(this.colliders,a.colliders),Array.prototype.push.apply(this.hits,a.hits)},a.CollisionSystem.prototype.rayCastAll=function(a){a.direction.normalize(),this.hits.length=0;var b,c,d,e,f=0;b=0;for(c=this.colliders.length;b<c;b++)if(e=this.colliders[b],d=this.rayCast(a,e),d<Number.MAX_VALUE)e.distance=d,d>f?this.hits.push(e):this.hits.unshift(e),f=d;return this.hits},a.CollisionSystem.prototype.rayCastNearest=function(b){var c=this.rayCastAll(b);if(c.length==0)return null;for(var d=0;c[d]instanceof a.MeshCollider;){var e=this.rayMesh(b,c[d]);if(e.dist<Number.MAX_VALUE){c[d].distance=e.dist,c[d].faceIndex=e.faceIndex;break}d++}return d>c.length?null:c[d]},a.CollisionSystem.prototype.rayCast=function(b,c){if(c instanceof a.PlaneCollider)return this.rayPlane(b,c);if(c instanceof a.SphereCollider)return this.raySphere(b,c);if(c instanceof a.BoxCollider)return this.rayBox(b,c);if(c instanceof a.MeshCollider&&c.box)return this.rayBox(b,c.box)},a.CollisionSystem.prototype.rayMesh=function(b,c){for(var d=this.makeRayLocal(b,c.mesh),e=Number.MAX_VALUE,f,g=0;g<c.numFaces;g++){var h=c.mesh.geometry.faces[g],i=c.mesh.geometry.vertices[h.a].position,j=c.mesh.geometry.vertices[h.b].position,k=c.mesh.geometry.vertices[h.c].position,l=h instanceof a.Face4?c.mesh.geometry.vertices[h.d].position:null;h instanceof a.Face3?(h=this.rayTriangle(d,i,j,k,e,this.collisionNormal,c.mesh),h<e&&(e=h,f=g,c.normal.copy(this.collisionNormal),c.normal.normalize())):h instanceof a.Face4&&(h=this.rayTriangle(d,i,j,l,e,this.collisionNormal,c.mesh),h<e&&(e=h,f=g,c.normal.copy(this.collisionNormal),c.normal.normalize()),h=this.rayTriangle(d,j,k,l,e,this.collisionNormal,c.mesh),h<e&&(e=h,f=g,c.normal.copy(this.collisionNormal),c.normal.normalize()))}return{dist:e,faceIndex:f}},a.CollisionSystem.prototype.rayTriangle=function(b,c,d,e,f,g,h){var i=a.CollisionSystem.__v1,j=a.CollisionSystem.__v2;g.set(0,0,0),i.sub(d,c),j.sub(e,d),g.cross(i,j),i=g.dot(b.direction);if(i>=0)if(h.doubleSided||h.flipSided)g.multiplyScalar(-1),i*=-1;else return Number.MAX_VALUE;return h=g.dot(c)-g.dot(b.origin),h>0?Number.MAX_VALUE:h<i*f?Number.MAX_VALUE:(h/=i,i=a.CollisionSystem.__v3,i.copy(b.direction),i.multiplyScalar(h),i.addSelf(b.origin),Math.abs(g.x)>Math.abs(g.y)?Math.abs(g.x)>Math.abs(g.z)?(b=i.y-c.y,g=d.y-c.y,f=e.y-c.y,i=i.z-c.z,d=d.z-c.z,e=e.z-c.z):(b=i.x-c.x,g=d.x-c.x,f=e.x-c.x,i=i.y-c.y,d=d.y-c.y,e=e.y-c.y):Math.abs(g.y)>Math.abs(g.z)?(b=i.x-c.x,g=d.x-c.x,f=e.x-c.x,i=i.z-c.z,d=d.z-c.z,e=e.z-c.z):(b=i.x-c.x,g=d.x-c.x,f=e.x-c.x,i=i.y-c.y,d=d.y-c.y,e=e.y-c.y),c=g*e-d*f,c==0?Number.MAX_VALUE:(c=1/c,e=(b*e-i*f)*c,e<0?Number.MAX_VALUE:(c*=g*i-d*b,c<0?Number.MAX_VALUE:1-e-c<0?Number.MAX_VALUE:h)))},a.CollisionSystem.prototype.makeRayLocal=function(b,c){var d=a.CollisionSystem.__m;a.Matrix4.makeInvert(c.matrixWorld,d);var e=a.CollisionSystem.__r;return e.origin.copy(b.origin),e.direction.copy(b.direction),d.multiplyVector3(e.origin),d.rotateAxis(e.direction),e.direction.normalize(),e},a.CollisionSystem.prototype.rayBox=function(b,c){var d;c.dynamic&&c.mesh&&c.mesh.matrixWorld?d=this.makeRayLocal(b,c.mesh):(d=a.CollisionSystem.__r,d.origin.copy(b.origin),d.direction.copy(b.direction));var e=0,f=0,g=0,h=0,i=0,j=0,k=!0;d.origin.x<c.min.x?(e=c.min.x-d.origin.x,e/=d.direction.x,k=!1,h=-1):d.origin.x>c.max.x&&(e=c.max.x-d.origin.x,e/=d.direction.x,k=!1,h=1),d.origin.y<c.min.y?(f=c.min.y-d.origin.y,f/=d.direction.y,k=!1,i=-1):d.origin.y>c.max.y&&(f=c.max.y-d.origin.y,f/=d.direction.y,k=!1,i=1),d.origin.z<c.min.z?(g=c.min.z-d.origin.z,g/=d.direction.z,k=!1,j=-1):d.origin.z>c.max.z&&(g=c.max.z-d.origin.z,g/=d.direction.z,k=!1,j=1);if(k)return-1;k=0,f>e&&(k=1,e=f),g>e&&(k=2,e=g);switch(k){case 0:i=d.origin.y+d.direction.y*e;if(i<c.min.y||i>c.max.y)return Number.MAX_VALUE;d=d.origin.z+d.direction.z*e;if(d<c.min.z||d>c.max.z)return Number.MAX_VALUE;c.normal.set(h,0,0);break;case 1:h=d.origin.x+d.direction.x*e;if(h<c.min.x||h>c.max.x)return Number.MAX_VALUE;d=d.origin.z+d.direction.z*e;if(d<c.min.z||d>c.max.z)return Number.MAX_VALUE;c.normal.set(0,i,0);break;case 2:h=d.origin.x+d.direction.x*e;if(h<c.min.x||h>c.max.x)return Number.MAX_VALUE;i=d.origin.y+d.direction.y*e;if(i<c.min.y||i>c.max.y)return Number.MAX_VALUE;c.normal.set(0,0,j)}return e},a.CollisionSystem.prototype.rayPlane=function(a,b){var c=a.direction.dot(b.normal),d=b.point.dot(b.normal);if(c<0)c=(d-a.origin.dot(b.normal))/c;else return Number.MAX_VALUE;return c>0?c:Number.MAX_VALUE},a.CollisionSystem.prototype.raySphere=function(a,b){var c=b.center.clone().subSelf(a.origin);if(c.lengthSq<b.radiusSq)return-1;var d=c.dot(a.direction.clone());return d>0?(c=b.radiusSq-(c.lengthSq()-d*d),c<0?Number.MAX_VALUE:Math.abs(d)-Math.sqrt(c)):Number.MAX_VALUE},a.CollisionSystem.__v1=new a.Vector3,a.CollisionSystem.__v2=new a.Vector3,a.CollisionSystem.__v3=new a.Vector3,a.CollisionSystem.__nr=new a.Vector3,a.CollisionSystem.__m=new a.Matrix4,a.CollisionSystem.__r=new a.Ray,a.CollisionUtils={},a.CollisionUtils.MeshOBB=function(b){b.geometry.computeBoundingBox();var c=b.geometry.boundingBox,d=new a.Vector3(c.x[0],c.y[0],c.z[0]),c=new a.Vector3(c.x[1],c.y[1],c.z[1]),d=new a.BoxCollider(d,c);return d.mesh=b,d},a.CollisionUtils.MeshAABB=function(b){var c=a.CollisionUtils.MeshOBB(b);return c.min.addSelf(b.position),c.max.addSelf(b.position),c.dynamic=!1,c},a.CollisionUtils.MeshColliderWBox=function(b){return new a.MeshCollider(b,a.CollisionUtils.MeshOBB(b))},a.WebGLRenderer&&(a.AnaglyphWebGLRenderer=function(b){a.WebGLRenderer.call(this,b);var c=this,d=this.setSize,e=this.render,f=new a.PerspectiveCamera,g=new a.PerspectiveCamera,h=new a.Matrix4,i=new a.Matrix4,j,k,l;f.matrixAutoUpdate=g.matrixAutoUpdate=!1;var b={minFilter:a.LinearFilter,magFilter:a.NearestFilter,format:a.RGBAFormat},m=new a.WebGLRenderTarget(512,512,b),n=new a.WebGLRenderTarget(512,512,b),o=new a.PerspectiveCamera(53,1,1,1e4);o.position.z=2,_material=new a.ShaderMaterial({uniforms:{mapLeft:{type:"t",value:0,texture:m},mapRight:{type:"t",value:1,texture:n}},vertexShader:"varying vec2 vUv;\nvoid main() {\nvUv = vec2( uv.x, 1.0 - uv.y );\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D mapLeft;\nuniform sampler2D mapRight;\nvarying vec2 vUv;\nvoid main() {\nvec4 colorL, colorR;\nvec2 uv = vUv;\ncolorL = texture2D( mapLeft, uv );\ncolorR = texture2D( mapRight, uv );\ngl_FragColor = vec4( colorL.g * 0.7 + colorL.b * 0.3, colorR.g, colorR.b, colorL.a + colorR.a ) * 1.1;\n}"});var p=new a.Scene;p.add(new a.Mesh(new a.PlaneGeometry(2,2),_material)),this.setSize=function(a,b){d.call(c,a,b),m.width=a,m.height=b,n.width=a,n.height=b},this.render=function(a,b){b.update(null,!0);if(j!==b.aspect||k!==b.near||l!==b.fov){j=b.aspect,k=b.near,l=b.fov;var d=b.projectionMatrix.clone(),q=125/30*.5,r=q*k/125,s=k*Math.tan(l*Math.PI/360),y;h.n14=q,i.n14=-q,q=-s*j+r,y=s*j+r,d.n11=2*k/(y-q),d.n13=(y+q)/(y-q),f.projectionMatrix=d.clone(),q=-s*j-r,y=s*j-r,d.n11=2*k/(y-q),d.n13=(y+q)/(y-q),g.projectionMatrix=d.clone()}f.matrix=b.matrixWorld.clone().multiplySelf(i),f.update(null,!0),f.position.copy(b.position),f.near=k,f.far=b.far,e.call(c,a,f,m,!0),g.matrix=b.matrixWorld.clone().multiplySelf(h),g.update(null,!0),g.position.copy(b.position),g.near=k,g.far=b.far,e.call(c,a,g,n,!0),e.call(c,p,o)}}),a.WebGLRenderer&&(a.CrosseyedWebGLRenderer=function(b){a.WebGLRenderer.call(this,b),this.autoClear=!1;var c=this,d=this.setSize,e=this.render,f,g,h=new a.PerspectiveCamera;h.target=new a.Vector3(0,0,0);var i=new a.PerspectiveCamera;i.target=new a.Vector3(0,0,0),c.separation=10,b&&b.separation!==void 0&&(c.separation=b.separation),this.setSize=function(a,b){d.call(c,a,b),f=a/2,g=b},this.render=function(a,b){this.clear(),h.fov=b.fov,h.aspect=.5*b.aspect,h.near=b.near,h.far=b.far,h.updateProjectionMatrix(),h.position.copy(b.position),h.target.copy(b.target),h.translateX(c.separation),h.lookAt(h.target),i.projectionMatrix=h.projectionMatrix,i.position.copy(b.position),i.target.copy(b.target),i.translateX(-c.separation),i.lookAt(i.target),this.setViewport(0,0,f,g),e.call(c,a,h),this.setViewport(f,0,f,g),e.call(c,a,i,!1)}}),a}),define("classes/AbstractObject",[],function(){function a(a,b,c,d){this.pos={x:a||0,y:b||0,z:c||0},this.vel={x:0,y:0,z:0}}return a.prototype.setBounds=function(a,b){this.bounds={},this.bounds.top=b/2,this.bounds.left=-a/2,this.bounds.right=a/2,this.bounds.bottom=-b/2},a.prototype.update=function(){this.pos.x+=this.vel.x,this.pos.y+=this.vel.y,this.pos.z+=this.vel.z,this.bounds&&(this.pos.y>this.bounds.top&&(this.pos.y=this.bounds.top),this.pos.x>this.bounds.right&&(this.pos.x=this.bounds.right),this.pos.y<this.bounds.bottom&&(this.pos.y=this.bounds.bottom),this.pos.x<this.bounds.left&&(this.pos.x=this.bounds.left))},a}),define("classes/Player",["classes/AbstractObject"],function(a){function b(){}return b.prototype=new a,b}),define("utils/requestAnimationFrame",[],function(){return function(){window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}())}}),require(["libs/three","classes/Player","utils/requestAnimationFrame","https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"],function(a,b,c){$(function(){function r(){container=document.getElementById("content"),l=new a.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,1e4),l.position.z=1e3,m=new a.Scene,m.fog=new a.FogExp2(0,.001),x(),y(),n=new a.WebGLRenderer({clearAlpha:1}),n.setSize(window.innerWidth,window.innerHeight),n.sortObjects=!1,container.appendChild(n.domElement)}function s(){o=new b,o.setBounds(window.innerWidth*1.4,window.innerHeight*1.4)}function t(){requestAnimationFrame(t),w()}function u(){i=io.connect(),i.on("new connection",function(){i.emit("new game",function(a){$("#gameid").html(a)})}),i.on("controller connected",function(){$("#status").html("Controller Connected").css("color","#3f3"),j=!0;var a=$("#how-popup");k&&a.data("open")=="true"&&a.fadeOut(function(){a.data("open","false"),k=!1})}),i.on("controller closed",function(){$("#status").html("Controller Disconnected").css("color","#f33"),j=!1}),i.on("update",function(a){e&&d++,v(a.x,a.y,a.z)})}function v(a,b,c){a-=15,g.x=a/h,g.z=c/h,o.vel.x=-c*.5,o.vel.y=a*.5}function w(){j&&!k&&(o.update(),p.rotation.x+=(g.x-p.rotation.x)*.05,p.rotation.z+=(g.z*.8-p.rotation.z)*.05,p.rotation.y=p.rotation.z*.8,p.position.x+=(o.pos.x-p.position.x)*.05,p.position.y+=(o.pos.y-p.position.y)*.05);for(var a=0;a<3;a++){var b=q[a];b.position.z+=8,b.position.z>2e3&&(b.position.z=-1e3)}n.render(m,l)}function x(){var b=60,c=new a.CubeGeometry(30,30,30);material=new a.MeshNormalMaterial,p=new a.Object3D;for(var d=0;d<3;d++){var e=new a.Mesh(c,material);switch(d){case 0:e.position.z=-b;break;case 1:e.position.x=-b*Math.sin(Math.PI/3),e.position.z=b*Math.cos(Math.PI/3);break;case 2:e.position.x=b*Math.sin(Math.PI/3),e.position.z=b*Math.cos(Math.PI/3);break;default:}e.matrixAutoUpdate=!1,e.updateMatrix(),p.add(e),m.add(p)}}function y(){var b=new a.ParticleBasicMaterial({size:5});for(var c=0;c<3;c++){var d=new a.Geometry;for(var e=0;e<500;e++){var f=new a.Vector3(Math.random()*3e3-1500,Math.random()*3e3-1500,Math.random()*-1e3);d.vertices.push(new a.Vertex(f))}var g=new a.ParticleSystem(d,b);g.position.z=-c*1e3+1e3,q.push(g),m.add(g)}}function z(){$("#about").click(function(){$("#about-popup").data("open")!="true"&&(k=!0,i.emit("pause"),$(".popup:visible").data("open","false").fadeOut(),$("#about-popup").data("open","true").fadeIn())}),$("#how").click(function(){$("#how-popup").data("open")!="true"&&(k=!0,i.emit("pause"),$(".popup:visible").data("open","false").fadeOut(),$("#how-popup").data("open","true").fadeIn())}).trigger("click"),$(".resume").click(function(){var a=$(this.parentNode);a.is(".popup")||(a=$(this.parentNode.parentNode)),a.fadeOut(function(){a.data("open","false"),k=!1,i.emit("resume")})})}c();var d=0,e=!1;if(e){f(),$("#updates").html('<span id="ups"></span> Updates/Sec');function f(){$("#ups").text(d),d=0,setTimeout(f,1e3)}}var g={x:0,y:0,z:0},h=360/Math.PI,i,j=!1,k=!1,l,m,n,o,p,q=[];r(),s(),t(),u(),z()})}),define("app-dev",function(){})